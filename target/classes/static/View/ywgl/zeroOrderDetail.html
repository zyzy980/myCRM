<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link id="CustomTheme" type="text/css" rel="stylesheet" href="../../Resource/css/index/customLightBlue.css" />
	<link id="EasyuiTheme" type="text/css" rel="stylesheet"
		href="../../Resource/js/easyUI/themes/easyuiLightBlue.css" />
	<link id="JqgridTheme" type="text/css" rel="stylesheet"
		href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/icon.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/fileUpload/css/fileUpload.css" />
	<link type="text/css" rel="stylesheet" href="../../View/ywgl/css/planExec.css" />
	<style type="text/css">

	</style>
	<title>#{supplier.detail.thisPage}</title>
</head>

<body style="overflow:hidden">
	<div id="orderDetailChild">
		<div id="childBtn"
			style="border-top:1px dotted #c5dbec;border-left:1px dotted #c5dbec;border-right:1px dotted #c5dbec;width:99.5%">
			<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add'" width="15"
				height="15" onclick="addChild('detailChildTableId')"><label data-locale="addRow"/></a>
			<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save'"
				onclick="saveChildTable()"><label data-locale="saveDetail"/></a>
			<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:''" onclick="addNew()">新增</a>
			<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:''" onclick="copy()">复制</a>
			<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-cancel'"
				onclick="removn()"><label data-locale="closeTable"/></a>
		</div>
		<table id="detailChildTableId"></table>

	</div>
	<div id="toolbar" class="easyui-panel" style="padding: 4px; border-width:0; border-bottom-width:1px;">
		#{PAGE_TOOLBAR_BUTTONROLE}
	</div>
	<form id="detailForm" class="easyui-form" method="post" data-options="novalidate:true">
		<div class="searchParamesPanel">

			<input type="hidden" id="sn" name="sn" />
			<input type="hidden" id="guid" name="guid" />
			<table class="editTable" style="margin-top:0px;">
				<tr>
					<td rowspan="1" style="text-align:center;"><label data-locale="cusNo"/></td>
					<td class="editTitle">
						<label data-locale="cusNo"/> :
					</td>
					<td class="editControl">
						<input id="cusNo" name="cusNo" class="easyui-combobox" style="width:153px;"
							data-options="panelWidth:'300'" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
						<!--     			<span style="color:red;font-size:16px;text-align:center;">*</span>  data-locale-missingmessage="clientCannoBeEmpty"-->
					</td>
					<td class="editTitle">
						<label data-locale="customerWeituoDate"/>
					</td>
					<td class="editControl">
						<input id="businessDate" name="businessDate" class="easyui-datetimebox" style="width:153px;"
							data-options="panelWidth:'180'" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="customerYwId"/>
					</td>
					<td class="editControl">
						<input id="businessYwId" name="businessYwId" class="easyui-textbox" style="width:153px;" />
					</td>
				</tr>
				<tr>
					<td rowspan="3" style="text-align:center;"><img src="../../View/ywgl/images/icon2.png" />
						<p><label data-locale="outGoods"/></p>
					</td>
					<td class="editTitle">
						<label data-locale="planshipmentData"/>:
					</td>
					<td class="editControl">
						<input id="planshipmentData" class="easyui-datetimebox" name="planshipmentData"
							style="width: 153px;" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="transportType"/>
					</td>
					<td class="editControl">
						<input id="transportTypePlan" name="transportTypePlan"
							data-locale-missingmessage="modeOfTransportCannotBeEmpty" class="easyui-combobox"
							style="width:153px;" data-options="panelWidth:'180'" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>

					<td class="editTitle">
						<label data-locale="orderType"/>
					</td>
					<td class="editControl">
						<input id="orderType" name="orderType" class="easyui-combobox" style="width:153px;"
							data-options="valueField:'id',textField:'text'" />
					</td>

				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="beginLocalAddress2"/>:
					</td>
					<td class="editControl">
						<input name="beginLocalAddressCode" id="historybeginAddress" class="easyui-combobox"
							style="width: 200px;" data-options="panelWidth:'300'" />
						<input name="beginLocalAddress" style="width:198px;height:20px;display:none;"
							id="tipinputbeginAddress" />
						<input name="beginLocalCode" id="beginLocalCode" type="hidden" />
						<input name="isNewBeginAddress" style="display: none;" id="isNewBeginAddress" value="0" />
						<a href="javascript:void(0)" style="color:blue" id="newBeginAddress"><label data-locale="newAddress"/></a>
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="addressDetail"/>:
					</td>
					<td class="editControl">
						<input id='begin_district' name="beginDistrict" class='easyui-combobox'
							data-locale-missingmessage="shippingProvinceCannotBeEmpty" data-options="panelWidth:'180'"
							style='width:100px' />
						<input id='begin_city' name="beginCity" class='easyui-combobox'
							data-locale-missingmessage="shippingMarketCannotBeEmpty" data-options="panelWidth:'180'"
							style='width:100px' />
						<input id='begin_area' name="beginArea" class='easyui-combobox'
							data-locale-missingmessage="loadingAreaCannotBeEmpty" data-options="panelWidth:'180'"
							style='width:100px' />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="zeroOrderDetail_nameOfLine"/>:
					</td>
					<td class="editControl">
						<input class="easyui-combobox" id="routeCode" name="routeCode" style="width: 153px;" />
					</td>
				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="beginLocalAddressDetail"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" id="beginLocalRemark" name="beginLocalRemark"
							style="width: 80%;" />
					</td>
					<td class="editTitle">
						<label data-locale="beginLocalMan"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" id="beginLocalMan"
							data-locale-missingmessage="shippingContactCannotBeEmpty" name="beginLocalMan" autocomplete="off"
							style="width: 153px;" data-options="required:true" /><span
							style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="beginLocalPhone"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" id="beginLocalPhone"
							data-locale-missingmessage="phoneNumberOfTheDeliveryContactCannotBeEmtpy" name="beginLocalPhone"
							style="width: 153px;" data-options="required:true,validType:'telNum'" /><span
							style="color:red;font-size:16px;text-align:center;">*</span>
					</td>

				</tr>
				<tr>
					<td rowspan="3" style="text-align:center;"><img src="../../View/ywgl/images/icon3.png" />
						<p><label data-locale="recipientGoods"/></p>
					</td>
					<td class="editTitle">
						<label data-locale="receiveGoodsDate"/>
					</td>
					<td class="editControl" colspan="5">
						<input id="planjiaofuData" class="easyui-datetimebox"
							data-locale-missingmessage="plannedDeliveryTimeCannotBeEmpty" name="planjiaofuData"
							style="width: 153px;" data-options="required:true" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="endLocalAddress2"/>:
					</td>
					<td class="editControl">
						<input name="endLocalAddressCode" id="historyendAddress" class="easyui-combobox"
							style="width: 200px;" data-options="panelWidth:'300'" />
						<input name="endLocalAddress" id="tipinputendAddress" autocomplete="off"
							style="width: 198px;height: 20px;display:none;" />
						<input name="endLocalSiteCode" id="endLocalSiteCode" type="hidden" />
						<input name="isNewEndAddress" id="isNewEndAddress" style="display:none;" value="0" />
						<a href="javascript:void(0)" style="color:blue" id="newEndAddress"><label data-locale="newAddress"/></a>
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="addressDetail"/>:
					</td>
					<td class="editControl">
						<input id='end_district' name="endDistrict" class='easyui-combobox'
							data-locale-missingmessage="destinationProvinceCannotBeEmpty" data-options="panelWidth:'180'"
							style='width:100px' />
						<input id='end_city' name="endCity" class='easyui-combobox'
							data-locale-missingmessage="destinationCityCannotBeEmpty" data-options="panelWidth:'180'"
							style='width:100px' />
						<input id='end_area' name="endArea" class='easyui-combobox'
							data-locale-missingmessage="destinationMustNotBeEmpty" data-options="panelWidth:'180'"
							style='width:100px' />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle"><label data-locale="v.detail.state"/>:</td>
					<td class="editControl">
						<input class="easyui-textbox" id="state" data-options="editable:false" name="state"
							style="width: 154px;" />
					</td>
					<!--<td class="editTitle" >
            	业务地点:
            </td>
            <td class="editControl">
               	<input class="easyui-combobox" id="ywLocation" name="ywLocation" style="width:153px;"/>
            </td>-->
				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="endLocalAddressDetail"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" id="endLocalRemark" name="endLocalRemark" style="width: 80%" />
					</td>
					<td class="editTitle">
						<label data-locale="endLocalMan"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" name="endLocalMan" id="endLocalMan"
							data-locale-missingmessage="receivintContactCannotBeEmpty" autocomplete="off" style="width: 153px;"
							data-options="required:true" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="endLocalPhone"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" name="endLocalPhone"
							data-options="required:true,validType:'telNum'"
							missingmessage="#{receiver'sContactNumberCannotBeEmpty}" style="width: 153px;"
							id="endLocalPhone" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>

				</tr>
				<tr>
					<td style="text-align:center;" rowspan="3"><img src="../../View/ywgl/images/icon4.png" />
						<p><label data-locale="cost"/></p>
					</td>
					<td class="editTitle">
						<label data-locale="vol"/>(m³)
					</td>
					<td class="editControl">
						<input id="vol" name="vol" class="easyui-textbox" style="width:153px;"
							data-options="editable:false,panelWidth:'180'" />
					</td>
					<td class="editTitle">
						<label data-locale="gwt"/>(KG)
					</td>
					<td class="editControl">
						<input id="gwt" name="gwt" class="easyui-textbox" style="width:153px;"
							data-options="editable:false,panelWidth:'180'" />
					</td>
					<td class="editTitle">
						<label data-locale="qty"/>
					</td>
					<td class="editControl">
						<input id="qty" name="qty" class="easyui-textbox" style="width:153px;"
							data-options="editable:false,panelWidth:'180'" />
					</td>
				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="shoukuan"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" name="shoukuan" style="width: 153px;" id="shoukuan"
							data-options="editable:false,panelWidth:'180'" />
						<input type="radio" name="getMode" id="getModeForInvoice" value="0" checked /><label
							for="getModeForInvoice"><label data-locale="receiptsAreInvoiced"/></label>
						<input type="radio" name="getMode" id="getModeForFree" value="2" /><label
							for="getModeForFree"><label data-locale="zeroOrderDetail_free"/></label>
					</td>
					<td class="editTitle">
						<label data-locale="fukuan"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" name="fukuan" style="width: 153px;" id="fukuan"
							data-options="editable:false,panelWidth:'180'" />
						<input type="radio" name="payMode" id="payModeForInvoice" value="0" checked /><label
							for="payModeForInvoice"><label data-locale="paymentIsInvoice"/></label>
						<input type="radio" name="payMode" id="payModeForFree" value="2" /><label
							for="payModeForFree"><label data-locale="zeroOrderDetail_free"/></label>
					</td>
					<td class="editTitle">
						运单号:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" name="ywId" id="ywId" data-options="editable:false"
							style="width:153px" />
					</td>
				</tr>
			</table>

		</div>
	</form>
	<div id="gridControl">
		<table id="gridTableZero"></table>
	</div>
	<script type="text/javascript" src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
	<script type="text/javascript" src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
	<script type="text/javascript" src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
	<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
	<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyuiExtend.min.js"></script>
	<script type="text/javascript" src="../../Resource/js/base/commonControl.js"></script>
	<script type="text/javascript" src="../../Resource/js/base/globalVariable.js"></script>
	<script type="text/javascript" src="../../Resource/js/base/commonBusiness.js"></script>
	<script type="text/javascript" src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
	<script type="text/javascript" src="../../Resource/js/jqueryUI/jquery.jqGrid.min.js"></script>
	<script type="text/javascript" src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
	<script type="text/javascript" src="../../Resource/js/fileUpload/js/upload.js"></script>
	<script type="text/javascript" src="../../Resource/js/fileUpload/js/file.js"></script>
	<script type="text/javascript" src="API/AMap/js/maps.js"></script>
	<script type="text/javascript" src="../../Resource/js/cookie/jquery.cookie.js"></script>
	<script src="https://webapi.amap.com/maps?v=1.3&key=7defcebd378d7fcd05dbcb9298d20d2e"></script>
	<script type="text/javascript" src="https://cache.amap.com/lbs/static/addToolbar.js"></script>
	<script type="text/javascript" src="https://webapi.amap.com/demos/js/liteToolbar.js"></script>
	<script language="javascript" type="text/javascript">
		var detailRowNumber = null;
		var child = [];
		var mostlyGuid = null;
		var detailGuid = null;
		var moduleId = 0;
		var valve = 0;//用于判断增加还是修改的阀门值。0代表修改操���，1代表增加操作。
		var savedRow1 = null;
		var savedCol1 = null;
		var savedChildRow1 = null;
		var savedChildCol1 = null;
		var trainNo = null;
		var sumVol = 0;  //保存体积的和
		var sumGwt = 0; // 保存重量的和
		var sumQty = 0; //保存件数的和
		var orderDetailList = []; //订单明细数组全局变量，保存订单明细，一次性提交后台
		var orderDetail = []; //订单明细全局变量，用于在车次明细页面回显
		var pleaseChoose = $.i18n.prop('please.choose');
		var addressChoose = $.i18n.prop('switchAddress');
		var newAddress = $.i18n.prop('newAddress');
		var confirm = $.i18n.prop('confirm');
		var historyAddress = $.i18n.prop('historyAddress');
		var guid = null;
		var state = "";
		var businessYwId = "";
		var ywId = null;
		var unitInnerHtml = [];
		var unitValueObj = [];
		var unitTextObj = [];
		var cusNoTextObj = [];
		var cusNoValuObj = [];
		var beginidObj = {
			id: "begin",
			historyAddress: "historybeginAddress",
			tipinputAddress: "tipinputbeginAddress",
			district: "begin_district",
			city: "begin_city",
			area: "begin_area",
			localRemark: "beginLocalRemark"
		};
		var endidObj = {
			id: "end",
			historyAddress: "historyendAddress",
			tipinputAddress: "tipinputendAddress",
			district: "end_district",
			city: "end_city",
			area: "end_area",
			localRemark: "endLocalRemark"
		};
		var planBeginCityObj = {
			district: "tipinputbegin_district",
			city: "tipinputbegin_city",
		}

		var planEndCityObj = {
			district: "tipinputend_district",
			city: "tipinputend_city",
		}
		var curDate = null;
		$(function () {
			var parms = getUrlParms();
			var jsonList = [];
			var orderDetailGuid = null;
			guid = parent.guid;
			state = parent.state;

			// loadYwLocation();
			loadLocation();
			loadTransType();
			loadCus();
			getOrderType();
			initData();
			initStyle();


			loadZeroList();
			// curDate = myformatter(new Date);
			curDate = new Date().Format('yyyy-MM-dd hh:mm');
			// curDate = new Date();
			$("#planshipmentData").datetimebox("setValue", curDate);
			$("#planjiaofuData").datetimebox("setValue", curDate);
			$("#businessDate").datetimebox("setValue", curDate);
			//给默认值，用于zdlocation表的修改和增加
			$("#isNewBeginAddress").val("0");
			$("#isNewEndAddress").val("0");

			if (guid == "" || guid == null) {
				$("#planBeginDate").datetimebox("setValue", curDate);
				$("#payModeForInvoice").attr("checked", true);
				$("#getModeForInvoice").attr("checked", true);
			} else {

				loadDetailMostly(guid);
				searchData();

			}

			setTimeout(() => {
                $("#planshipmentData").datetimebox({
                    value: $("#planshipmentData").datetimebox('getValue'),
                    required: true,
                    showSeconds: false
                });

                $("#planjiaofuData").datetimebox({
                    value: $("#planjiaofuData").datetimebox('getValue'),
                    required: true,
                    showSeconds: false
                });

                $("#businessDate").datetimebox({
                    value: $("#businessDate").datetimebox('getValue'),
                    required: true,
                    showSeconds: false
                });
			}, 50);
			// $('#cusNo').combobox('textbox').focus();
		});

		//从客户数据字典获取订单状态
		var getOrderType = function () {

			var parmsArray = [
				{ name: 'typeCode', value: 'orderType' }
			];
			var filters = formatSearchParames(parmsArray);

			$.ajax({
				method: 'post',
				url: '../../sysInfo/dictionary/getZdDicData?t=' + Math.random() + '&customSearchFilters=' + encodeURI(filters),
				success: function (objectData) {
					var list = objectData.rows;
					var dataList = [];

					for (let i = 0; i < list.length; i++) {
						const element = list[i];

						var data = {
							id: null,
							text: null
						};

						data.id = element.dicvalue;
						data.text = element.dictext;

						dataList.push(data);
					}

					$('#orderType').combobox('loadData', dataList);
				}
			})
		}


		$("#planshipmentData").datetimebox({
			onSelect: function (planshipmentDate) {
				$("#planjiaofuData").datetimebox().datetimebox("calendar").calendar({
					validator: function (jiaofudate) {
						return planshipmentDate <= jiaofudate;
					}
				});
			}
		});

		$(window).load(function () { hideLoading(); });
		//清空
		var add = function () {
			$("#addForm").form("clear");

		}
		//清空明细主表
		var clearDetail = function () {
			$.messager.confirm($.i18n.prop('zeroOrderDetail_tip'), "#{zeroOrderDetail_empty}?", function (r) {
				if (r) {
					$("#detailForm").form("clear");
					mostlyGuid = "";
					detailGuid = "";
					$("#gridTableZero").jqGrid('GridUnload')
					loadZeroList();
				}
			})
		}
		//新增表体
		var addTableRow = function (name) {
			loseGridFocus();
			var ids = $("#" + name).jqGrid('getDataIDs');
			var rowid = Math.max.apply(Math, ids);
			if (rowid == "-Infinity") {
				rowid = 0;
			}
			var newrowid = rowid + 1;
			var dataRow = {
				rowid: newrowid,
			};
			$("#" + name).jqGrid("addRowData", newrowid, dataRow, "last");
		}
		var loseGridChindFocus = function () {
			if (savedChildRow1 && savedChildCol1) {
				$('#detailChildTableId').jqGrid('saveCell', savedChildRow1, savedChildCol1);
			}
		}

		//设置日期
		var time = function (date) {
			$("[name=planBeginDate]").val(date);
		}

		var initStyle = function () {
			enterTriggerEvent('searchParamesTable', 'searchData');
		};
		var oldSetGridHeightWidth = setGridHeightWidth;
		var setGridHeightWidth = function () {
			oldSetGridHeightWidth(5, 228);
			oldSetGridHeightWidth(5, 445, "gridTableZero");
		};
		var initScript = function () {
		};

		// 查询数据
		function searchData() {
			$('#gridTableZero').jqGrid('setGridParam', {
				url: getSearchGridUrl(),
				datatype: 'json',
				postData: { 'filters': '' },
				page: 1
			}).trigger('reloadGrid');
		}

		// 获取查询访问路径
		var getSearchGridUrl = function () {
			return '../../order/findOrderDetial?t=' + Math.random() + '&customSearchFilters=' + encodeURI(getSearchFilters()) + "&mostlyGuid=" + guid;
		};

		// 获取查询条件
		var getSearchFilters = function () {
			var parmsArray = [
				{
					name: 'o.mostly_guid', value: guid, op: "eq"
				}
			];
			return formatSearchParames(parmsArray);
		};

		// 保存新增车次信息
		var save = function () {
			insert();
		};

		var insert = function () {
			loseGridFocus();
			if (!validate()) {
				return;
			}

			var orderMostlyVo = FormUtils.toJSONObject($("#detailForm"));
			var detailAllData = $("#gridTableZero").jqGrid("getRowData");
			if (orderMostlyVo.transportTypePlan == pleaseChoose) {
				errorNotification({ SimpleMessage: $.i18n.prop('trainTypeRequired') });
				$("#transportTypePlan").combobox('textbox').focus();
				return;
			}
			// if(orderMostlyVo.ywLocation == pleaseChoose || orderMostlyVo.ywLocation == "") {
			// 	errorNotification({ SimpleMessage: "业务地点必填" });
			// 	return ;
			// }
			var ids = $("#gridTableZero").jqGrid("getDataIDs");
			if (ids.length == 0) {
				errorNotification({ SimpleMessage: $.i18n.prop('zeroOrderDetail_detailCannotBeEmpty') });
				return;
			}
			orderMostlyVo.details = [];
			for (var i = 0; i < detailAllData.length; i++) {
				var detail = {};
				detail.row = ids[i];
				detail.sn = detailAllData[i].rowId;
				detail.guid = detailAllData[i].guid;
				detail.goodsName = detailAllData[i].goodsName;
				detail.unit = unitValueObj[detailAllData[i].unit];
				detail.vol = detailAllData[i].vol;
				detail.gwt = detailAllData[i].gwt;
				detail.qty = detailAllData[i].qty;
				detail.contId = detailAllData[i].contId;
				detail.extend1 = detailAllData[i].extend1;
				detail.extend2 = detailAllData[i].extend2;
				orderMostlyVo.details.push(detail);
			}
			orderMostlyVo.child = child;
			orderMostlyVo.weituoType = 1;
			orderMostlyVo.trainNo = null;
			orderMostlyVo.beginLocalName = $("#historybeginAddress").combobox('getText');
			orderMostlyVo.endLocalName = $("#historyendAddress").combobox('getText');
			orderMostlyVo.ywId = $("#ywId").textbox("getValue");

			$.messager.confirm($.i18n.prop('planExec_Prompt'), '#{business.message.saveQuestion}?', function (r) {// 提示, 确定保存数据项吗
				if (r) {
					showLoading();
					$.ajax({
						url: "../../order/addmostly?t=" + Math.random(),
						type: 'POST',
						data: "jsonData=" + encodeURI(JSON.stringify(orderMostlyVo)),
						success: function (dataObj) {
							hideLoading();
							if (isServerResultDataPass(dataObj)) {
								correctNotification({ SimpleMessage: $.i18n.prop('zeroOrderDetail_saveSuccess') });
								guid = dataObj.resultDataFull;
								loadDetailMostly(guid);
								searchData();
								parent.guid = guid;
								parent.extendTab(guid);
								//刷新父页面
								getCurrentTab().searchData();
							} else {
								FailResultDataToTip(dataObj);
							}
						},
						error: function (message) {
							hideLoading();
						}
					});
				}
			});
		}
		//修改车次信息
		var edit = function () {
			if (state != 0) {
				errorNotification({ SimpleMessage: $.i18n.prop('onlyTheWaybillUnderNormalConditionCanBeModified') });
				return;
			}
			loseGridFocus();
			var planExecVO = FormUtils.toJSONObject($("#detailForm"));
			var detailAllData = $("#gridTableZero").jqGrid("getRowData");
			var ids = $("#gridTableZero").jqGrid("getDataIDs");
			planExecVO.detail = [];
			for (var i = 0; i < detailAllData.length; i++) {
				var detail = {};
				detail.row = ids[i];
				detail.sn = detailAllData[i].rowId;
				detail.guid = detailAllData[i].guid;
				detail.goodsName = detailAllData[i].goodsName;
				detail.vol = detailAllData[i].vol;
				detail.gwt = detailAllData[i].gwt;
				detail.qty = detailAllData[i].qty;
				detail.contId = detailAllData[i].contId;
				planExecVO.detail.push(detail);
			}
			planExecVO.child = child;
			if (planExecVO.state >= 3) {
				errorNotification({ SimpleMessage: $.i18n.prop('planExec_edit_stateError') });
				return;
			}
			planExecVO.orderMostly = orderDetailList;
			$.messager.confirm($.i18n.prop('planExec_Prompt'), '#{business.message.saveQuestion}?', function (r) {// 提示, 确定保存数据项吗
				if (r) {
					showLoading();
					$.ajax({
						url: "../../order/updateZoreOrderMostly?t=" + Math.random(),
						type: 'POST',
						data: "jsonData=" + JSON.stringify(planExecVO),
						success: function (dataObj) {
							hideLoading();
							if (isServerResultDataPass(dataObj)) {
								correctNotification(dataObj.resultDataFull);
								//刷新父页面
								getCurrentTab().searchData();
							} else {
								FailResultDataToTip(dataObj);
							}
						},
						error: function (message) {
							hideLoading();
						}
					});
				}
			});
		}

		var validate = function () {
			var validated = $("#detailForm").form('enableValidation').form('validate');
			if (!validated) {
				errorNotification({ SimpleMessage: $.i18n.prop('SomeDataVerificationFailsDuringTheSaveOperation') });
				return false;
			}
			let vol = $("#vol").textbox("getValue");
			let gwt = $("#gwt").textbox("getValue");
			if (vol == "" && gwt == "") {
				errorNotification({ SimpleMessage: $.i18n.prop('zeroOrderDetail_mustBeOne') });
				return false;
			}
			let isNewBeginAddress = $("#isNewBeginAddress").val();
			let isNewEndAddress = $("#isNewEndAddress").val();
			// 如果为1 是新增，这是发货
			if (isNewBeginAddress == 1) {
				let beginLocalAddress = $("#tipinputbeginAddress").val();
				if (beginLocalAddress == "") {
					errorNotification({ SimpleMessage: $.i18n.prop('zeroOrderDetail_shipmentMustBe') });
					return false;
				}
			} else {
				let historybeginAddress = $("#historybeginAddress").combobox("getValue");
				if (historybeginAddress == "") {
					errorNotification({ SimpleMessage: $.i18n.prop('zeroOrderDetail_shipmentMustBe') });
					return false;
				}
			}
			if (isNewEndAddress == 1) {
				let historyendAddress = $("#tipinputendAddress").val();
				if (historyendAddress == "") {
					errorNotification({ SimpleMessage: $.i18n.prop('zeroOrderDetail_receivingMustBe') });
					return;
				}
			} else {
				let historyendAddress = $("#historyendAddress").combobox("getValue");
				if (historyendAddress == "") {
					errorNotification({ SimpleMessage: $.i18n.prop('zeroOrderDetail_receivingMustBe') });
					return;
				}
			}

			//计划发运日期应大于客户委托日期
			var businessDate = new Date($("#businessDate").datetimebox("getValue")).Format('yyyy-MM-dd hh:mm');
			var planshipmentData = new Date($("#planshipmentData").datetimebox("getValue")).Format('yyyy-MM-dd hh:mm');
			var planjiaofuData = new Date($("#planjiaofuData").datetimebox("getValue")).Format('yyyy-MM-dd hh:mm');

			if (planshipmentData < businessDate) {
				errorNotification({ SimpleMessage: $.i18n.prop('plan must greater than business') });
				return;
			}

			if (planjiaofuData < planshipmentData) {
				errorNotification({ SimpleMessage: $.i18n.prop('jiaofu must greater than kaishi') });
				return;
			}


			//极速达要求交付时间不能超过委托时间2小时
			if ($('#orderType').combobox('getValue') === '1') {
				var jiaofuTime = Date.parse(planjiaofuData);
				var weituoTime = Date.parse(businessDate);

				//特殊情况
				//当前16点-第二天9点之间下的单 预计交付时间范围在第二天早上9点到11点半之间
				var spileStart = new Date(weituoTime).Format('yyyy-MM-dd');
				spileStart = spileStart + " 16:00:00";
				//当前下午16点
				spileStart = Date.parse(spileStart);
				//第二天早上09点
				var spileEnd = spileStart + (60 * 60 * 17 * 1000);

				if (spileStart <= weituoTime && weituoTime <= spileEnd) {

					// 预计交付时间范围在第二天早上9点到11点半之间
					var spileJiaoFu = spileEnd + (60 * 60 * 2 * 1000);

					if(spileEnd > jiaofuTime || jiaofuTime > spileJiaoFu){
						errorNotification({ SimpleMessage: $.i18n.prop('jiaofu not in scope') });
						return;
					}

				} else {
					//其他情况 交付时间不能超过委托时间2小时
					var dif = jiaofuTime - weituoTime;
					var twoH = 60 * 60 * 2 * 1000;
					if (dif > twoH) {
						errorNotification({ SimpleMessage: $.i18n.prop('jiaofu  dont must greater than two') });
						return;
					}
				}
			}

			return true;
		}


		//明细删除
		var delText = $.i18n.prop('order_detail_del');
		var deleteRow = function (index, name) {
			$.messager.confirm($.i18n.prop('planExec_mostly_detail_prompt'), '#{planExec_mostly_detail_message_deleteQuestion}?', function (r) {
				if (r) {
					var rowData = $("#" + name).jqGrid('getRowData', index);
					var ids = $("#gridTableZero").jqGrid("getDataIDs");
					if (ids.length == 1) {
						var mainGuid = mostlyGuid
					}
					if (rowData.guid != '' && rowData.guid != undefined && rowData.guid != null) {
						showLoading($.i18n.prop('order.detail.loading'));
						$.ajax({
							url: "../../order/deleteOrderDetail?t=" + Math.random(),
							data: { mostlyGuid: mainGuid, guid: rowData.guid },
							type: "POST",
							success: function (data) {
								if (isServerResultDataPass(data)) {
									correctNotification({
										SimpleMessage: data.resultDataFull.simpleMessage
									});
									$("#" + name).delRowData(index);

									if ($("#" + name).jqGrid("getRowData").length <= 0) {
										savedRow1 = null;
										savedCol1 = null;
									}
								} else {
									FailResultDataToTip(data);
								}
								hideLoading();
							}
						});
					} else {
						$("#" + name).delRowData(index);
						if ($("#" + name).jqGrid("getRowData").length <= 0) {
							savedRow1 = null;
							savedCol1 = null;
						}
					}
				}
			});
		}
		//子明细删除
		var childDeleteRow = function (index, name) {
			$.messager.confirm($.i18n.prop('planExec_mostly_detail_prompt'), '#{planExec_mostly_detail_message_deleteQuestion}?', function (r) {
				if (r) {
					var rowData = $("#" + name).jqGrid('getRowData', index);
					if (rowData.guid != '' && rowData.guid != undefined && rowData.guid != null) {
						showLoading($.i18n.prop('order.detail.loading'));
						$.ajax({
							url: "../../order/deleteOrderDetailChildBySn?t=" + Math.random(),
							data: { guid: rowData.guid },
							type: "POST",
							success: function (data) {
								if (isServerResultDataPass(data)) {
									correctNotification({
										SimpleMessage: data.resultDataFull.simpleMessage
									});
									$("#" + name).delRowData(index);

									if ($("#" + name).jqGrid("getRowData").length <= 0) {
										savedRow1 = null;
										savedCol1 = null;
									}
								} else {
									FailResultDataToTip(data);
								}
								hideLoading();
							}
						});
					} else {
						$("#" + name).delRowData(index);

						if ($("#" + name).jqGrid("getRowData").length <= 0) {
							savedRow1 = null;
							savedCol1 = null;
						}
					}
				}
			});
		}
		// 加载列表数据
		var loadZeroList = function () {
			$('#gridTableZero').jqGrid({
				url: getSearchGridUrl(),
				datatype: 'local',
				width: 'none',
				colNames: [
					"<a href='#' onclick='addTableRow(\"gridTableZero\")'><img src='../../Index/images/add.png' style='width: 15px;margin-right: 2px;'>#{addRow}</a>", $.i18n.prop('sn'), $.i18n.prop('guid'), $.i18n.prop('withinCode'), $.i18n.prop('createBy'), $.i18n.prop('createDate'),
					$.i18n.prop('updateBy'), $.i18n.prop('updateDate'), $.i18n.prop('goodsName'), $.i18n.prop('qty'), $.i18n.prop('mostlyGuid'),
					$.i18n.prop('unit'), $.i18n.prop('vol'), $.i18n.prop('gwt'), $.i18n.prop('zeroOrderDetail_barCode'), $.i18n.prop('mostlyExtendOne'), $.i18n.prop('mostlyExtendTwo')
				],
				colModel: [
					{ name: 'delete', width: 50, index: 'delete', search: false, sortable: false, align: 'center', formatter: function (value, row, rowIndex) { return "<a style='text-decoration:underline;color:blue;' href='javascript:deleteRow(" + row.rowId + ",\"gridTableZero\")'>" + delText + "</a>"; "<a style='text-decoration:underline;color:blue;' href='javascript:deleteRow(" + row.rowId + ",\"gridTableZero\")'>" + delText + "</a>"; } },
					{ name: 'sn', index: 'o.sn', key: true, align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'guid', index: 'o.guid', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'withinCode', index: 'o.within_Code', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'createBy', index: 'o.create_By', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'createDate', index: 'o.CREATE_DATE', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'updateBy', index: 'o.UPDATE_BY', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'updateDate', index: 'o.UPDATE_DATE', align: 'center', search: true, type: 'string', hidden: true },
					{ name: 'goodsName', index: 'o.goods_name', editable: true, align: 'center', width: 100 },
					{
						name: 'qty', index: 'o.qty', editable: true, align: 'center', width: 80,
						editrules: {
							integer: true,
						}
					},
					{ name: 'mostlyGuid', index: 'o.MOSTLY_GUID', align: 'center', search: true, type: 'string', hidden: true },
					{
						name: 'unit', index: 'o.UNIT', editable: true, align: 'center', width: 80, edittype: 'select', editoptions: { value: unitInnerHtml },
						formatter: function (value, grid, rows) {
							if (value == undefined) {
								return "";
							} else {
								return unitTextObj[value];
							}
						}
					},
					{
						name: 'vol', index: 'o.VOL', editable: true, align: 'center', width: 80,
						editrules: {
							number: true,
							custom: true,
							custom_func: function (value, name) {
								var reg = '^(([1-9]{1}\\d*)|([0]{1}))(\\.(\\d){0,2})?$';
								var re = new RegExp(reg);
								if (re.test(value)) {
									return [true, ''];
								} else {
									return [false, name + '#{zeroOrderDetail_error}!']
								}
							}
						}
					},
					{
						name: 'gwt', index: 'o.GWT', editable: true, align: 'center', width: 80,
						editrules: {
							number: true,
							custom: true,
							custom_func: function (value, name) {
								var reg = '^(([1-9]{1}\\d*)|([0]{1}))(\\.(\\d){0,2})?$';
								var re = new RegExp(reg);
								if (re.test(value)) {
									return [true, ''];
								} else {
									return [false, name + '#{zeroOrderDetail_error}!']
								}
							}
						}
					},
					{ name: 'contId', index: 'o.cont_id', search: false, sortable: false, editable: true, width: 150, align: 'center' },
					{ name: 'extend1', width: 150, index: 'o.extend1', search: false, sortable: false, editable: true, align: 'center' },
					{ name: 'extend2', width: 150, index: 'o.extend2', search: false, sortable: false, editable: true, align: 'center' }
				],
				cellEdit: true,
				cellsubmit: 'clientArray',
				shrinkToFit: false,
				altRows: true,
				altclass: 'gridSpacingClass',
				forceFit: true,
				cellLayout: 0,
				scroll: true,
				autowidth: true,
				loadonce: false,
				mtype: "POST",
				viewrecords: true,
				rownumbers: true,
				rowNum: 100,
				height: "100%",
				rowList: [15, 20, 30, 50, 100],
				pager: "#gridPager",
				jsonReader: {
					root: "rows",
					total: "total",
					page: "page",
					records: "records",
					repeatitems: false
				},
				gridComplete: function () {
					$('.cbox').shiftSelect();
				},

				loadComplete: function (xhr) {
					//$("#gbox_gridTableZero").find(".ui-jqgrid-bdiv").css("height","254px");
				},
				afterSaveCell: function (rowid, cellname, value, iRow, iCol) {
					var list = $(this).jqGrid("getRowData");
					var sumVol = 0;
					var sumGwt = 0;
					var sumQty = 0;

					for (var i = 0; i < list.length; i++) {
						sumVol += Number(list[i].vol);
						sumGwt += Number(list[i].gwt);
						sumQty += Number(list[i].qty);
					}
					if (cellname == "vol") {
						//sumVol += parseInt(value);
						$("#vol").textbox('setValue', sumVol);
					} else if (cellname == "gwt") {
						//sumGwt += parseInt(value);
						$("#gwt").textbox('setValue', sumGwt);
					} else if (cellname == "qty") {
						// sumQty += parseInt(value);
						$("#qty").textbox('setValue', sumQty);
					}
				}
			});
			$('#gridTableZero').setGridParam({
				beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
					savedRow1 = iRow;
					savedCol1 = iCol;
				}
			});
			setGridHeightWidth();
		};
		//订单详情
		var showPlanDetail = function (trainno) {
			var href = '../View/ywgl/orderDetail.html?moduleId=' + moduleId + '&trainno=' + trainno;
		}

		// 用户双击跳转车次物品清单
		var showChildModule = function (trainno) { showPlanDetail(trainno); };


		// 新增、修改操作完成后调用的刷新方法
		var refreshCallerData_List = function () {
			searchData();
		};

		var initData = function () {
			// 		clearDetail();
			loadUnit();

			readProvince();
		};

		$.extend($.fn.validatebox.defaults.rules, {
			telNum: { //既验证手机号，又验证座机号
				validator: function (value, param) {
					return /(^(0[0-9]{2,3}\-)?([2-9][0-9]{6,7})+(\-[0-9]{1,4})?$)|(^(()|(\d{3}\-))?(1[345678]\d{9})$)/.test(value);
				},
				message: $.i18n.prop('tel is incorrect format')
			},
		});

		function chinese(state) {
			var chinese = "";
			switch (state) {
				case $.i18n.prop('normal'):
					chinese = "0"
					break;
				case $.i18n.prop('toExamine'):
					chinese = "1"
					break;
				case $.i18n.prop('dispatched'):
					chinese = "2"
					break;
				case $.i18n.prop('transportation'):
					chinese = "3"
					break;
				case $.i18n.prop('transportationCompletion'):
					chinese = "4"
					break;
				case $.i18n.prop('alreadyWrittenOff'):
					chinese = "5"
					break;
				case $.i18n.prop('halfwayOff'):
					chinese = "6"
					break;
				default:
					break;
			}
			return chinese;
		}
		function english(state) {
			var english = "";
			switch (state) {
				case 0:
					english = $.i18n.prop('normal')
					break;
				case 1:
					english = $.i18n.prop('toExamine')
					break;
				case 2:
					english = $.i18n.prop('dispatched')
					break;
				case 3:
					english = $.i18n.prop('transportation')
					break;
				case 4:
					english = $.i18n.prop('transportationCompletion')
					break;
				case 5:
					english = $.i18n.prop('alreadyWrittenOff')
					break;
				case 6:
					english = $.i18n.prop('halfwayOff')
					break;
				default:
					break;
			}
			return english;
		}

		// 获取查询条件
		var getSearchMostlyFilters = function () {
			var parameter = { trainNo: trainNo };
			return parameter;
		};
		// 获取查询访问路径
		var getSearchMostlyGridUrl = function () {
			return '../../bussiness/planExec/findMostlyList?t=' + Math.random() + '&trainNo=' + encodeURI(trainNo);
		};
		//获取mostly列表信息
		//保存订单主表信息
		var saveDetail = function () {
			loseGridFocus();
			var orderMostlyVo = FormUtils.toJSONObject($("#detailForm"));
			var detailAllData = $("#gridTableZero").jqGrid("getRowData");
			if (detailAllData.length == 0) {
				alert($.i18n.prop('orderDetailOneSave'))
				return;
			}
			var ids = $("#gridTableZero").jqGrid("getDataIDs");
			orderMostlyVo.child = child;
			orderMostlyVo.details = [];
			for (var i = 0; i < detailAllData.length; i++) {
				var detail = {};
				detail.row = ids[i];
				detail.sn = detailAllData[i].rowId;
				detail.guid = detailAllData[i].guid;
				detail.goodsName = detailAllData[i].goodsName;
				detail.vol = detailAllData[i].vol;
				detail.gwt = detailAllData[i].gwt;
				detail.qty = detailAllData[i].qty;
				detail.extend1 = detailAllData[i].extend1;
				detail.extend2 = detailAllData[i].extend2;
				orderMostlyVo.details.push(detail);
			}
			orderMostlyVo.trainNo = trainNo;
			orderDetail = orderMostlyVo;
			orderDetailList.push(orderMostlyVo);
			clearDetail();

		}

		function MouseOver(name) {
			var rowData = $("#gridTableZero").jqGrid('getRowData', name);
			detailRowNumber = name;
			detailGuid = rowData.guid;
			$("#orderDetailChild").show();
			listChild();
		}

		//加载订单详情子明细
		var listChild = function () {
			$("#detailChildTableId").jqGrid('GridUnload')
			$('#detailChildTableId').jqGrid({
				url: getDetailChild(),
				datatype: 'json',
				width: 'none',
				colNames: ['', 'sn',
					$.i18n.prop('createBy'),
					$.i18n.prop('createDate'),
					$.i18n.prop('updateBy'),
					$.i18n.prop('updateDate'),
					$.i18n.prop('planExec_mostly_detailChild_Guid'), $.i18n.prop('planExec_mostly_detailChild_detailGuid'),
					$.i18n.prop('planExec_mostly_detailChild_goodCode'), $.i18n.prop('planExec_mostly_detailChild_goodName'),
					$.i18n.prop('planExec_mostly_detailChild_vol'),
					$.i18n.prop('planExec_mostly_detailChild_gwt'), $.i18n.prop('planExec_mostly_detailChild_qty')
				],
				colModel: [
					{ name: 'delete', width: 40, index: 'delete', align: 'center', formatter: function (value, row, rowIndex) { return "<a style='text-decoration:underline;color:blue;' href='javascript:childDeleteRow(" + row.rowId + ",\"detailChildTableId\")'>" + delText + "</a>"; } },
					{ name: 'sn', index: 'sn', key: true, align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'createBy', index: 'odc.create_By', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'createDate', index: 'odc.CREATE_DATE', lign: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'updateBy', index: 'odc.UPDATE_BY', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'updateDate', index: 'odc.UPDATE_DATE', align: 'center', search: true, type: 'string', hidden: true },
					{ name: 'guid', index: 'guid', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'detailGuid', index: 'odc.DETAIL_GUID', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'goodCode', index: 'odc.GOOD_CODE', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'goodName', index: 'odc.GOOD_NAME', align: 'center', editable: true, edittype: 'text', width: 150, },
					{ name: 'vol', index: 'odc.VOL', align: 'center', editable: true, edittype: 'text', width: 70, },
					{ name: 'gwt', index: 'odc.GWT', align: 'center', editable: true, edittype: 'text', width: 70, },
					{ name: 'qty', index: 'odc.QTY', align: 'center', editable: true, edittype: 'text', width: 80, },
				],
				cellEdit: true,
				cellsubmit: 'clientArray',
				shrinkToFit: false,
				altRows: true,
				altclass: 'gridSpacingClass',
				forceFit: true,
				cellLayout: 0,
				scroll: false,
				autowidth: true,
				loadonce: false,
				mtype: "POST",
				viewrecords: true,
				rownumbers: true,
				rowNum: 100,
				height: "100%",
				rowList: [15, 20, 30, 50, 100],
				pager: "#gridPager",
				jsonReader: {
					root: "rows",
					total: "total",
					page: "page",
					records: "records",
					repeatitems: false
				},
				gridComplete: function () {
					$('.cbox').shiftSelect();
				},
				loadComplete: function (xhr) {

					FailResultDataToTip(xhr);
					hideLoading();
				}
			});

			$('#detailChildTableId').setGridParam({
				beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
					savedChildRow1 = iRow;
					savedChildCol1 = iCol;
				}
			});
			$("#gview_detailChildTableId").find(".ui-jqgrid-bdiv").css("height", "100px");
			setGridHeightWidth();
		}

		var getSearchOrderDetialFilters = function () {
			var parmsArray = [
				{ name: 'odc.detail_Guid', value: detailGuid, op: "eq" },
			];
			return formatSearchParames(parmsArray);
		}

		var getDetailChild = function () {
			return url = "../../order/findOrderChildBydetailGuid?t=" + Math.random() + "&customSearchFilters=" + encodeURI(getSearchOrderDetialFilters());
		}

		var addChild = function (name) {
			loseChildGridFocus();
			var ids = $("#" + name).jqGrid('getDataIDs');
			var rowid = Math.max.apply(Math, ids);
			if (rowid == "-Infinity") {
				rowid = 0;
			}
			var newrowid = rowid + 1;
			var dataRow = {
				rowid: newrowid,
			};
			$("#" + name).jqGrid("addRowData", newrowid, dataRow, "last");
		}
		//订单明细添加后，在车次明细页面回显。
		var i = 0;
		var loseChildGridFocus = function () {
			if (savedRow1 && savedCol1) {
				$('#detailChildTableId').jqGrid('saveCell', savedRow1, savedCol1);
			}
		}
		function removn() {
			$("#orderDetailChild").hide();
		}

		//占存子明细表的数据在域中
		var saveChildTable = function () {
			loseGridChindFocus();
			var childAllData = $("#detailChildTableId").jqGrid("getRowData");
			if (childAllData.length == 0) {
				alert($.i18n.prop('orderDetailOneSave'))
				return;
			} else {
				child.splice(0, child.length);//清空数组 
				for (var i = 0; i < childAllData.length; i++) {
					var childs = {};
					childs.detailRow = detailRowNumber;
					childs.sn = childAllData[i].sn;
					childs.guid = childAllData[i].guid;
					childs.goodName = childAllData[i].goodName;
					childs.vol = childAllData[i].vol;
					childs.gwt = childAllData[i].gwt;
					childs.qty = childAllData[i].qty;
					child.push(childs);
				}
			}
		}

		//绑定订单主表信息，作为修改的初始值
		var loadDetailMostly = function (guid) {
			$.ajax({
				url: '../../order/findOrderMostly?t=' + Math.random() + '&guid=' + guid,
				type: 'POST',
				data: "",
				success: function (dataObj) {
					if (isServerResultDataPass(dataObj)) {
						var mostlyJson = dataObj.resultDataFull;

						$("#routeCode").combobox("setValue", mostlyJson.ROUTECODE);
						$("#routeCode").combobox("setText", mostlyJson.ROUTENAME);

						$("#cusNo").combobox('setValue', mostlyJson.CUS_NO);
						$("#cusNo").combobox('setText', mostlyJson.CUS_NAME);
						$("#cusNo").combobox("options").onSelect({
							code: mostlyJson.CUS_NO
						});

						$("#state").textbox("setValue", english(parseInt(mostlyJson.STATE)));

						$("#historybeginAddress").combobox("setValue", mostlyJson.BEGIN_LOCAL_CODE);
						$("#historyendAddress").combobox("setValue", mostlyJson.END_LOCAL_CODE);
						$("#beginLocalRemark").textbox("setValue", mostlyJson.BEGIN_LOCAL_ADDRESS);
						$("#endLocalRemark").textbox("setValue", mostlyJson.END_LOCAL_ADDRESS);
						readDistrictCityArea("begin", mostlyJson.BEGIN_LOCAL_PROVINCE, mostlyJson.BEGIN_LOCAL_CITY, mostlyJson.BEGIN_LOCAL_DISTRICT);
						readDistrictCityArea("end", mostlyJson.END_LOCAL_PROVINCE, mostlyJson.END_LOCAL_CITY, mostlyJson.END_LOCAL_DISTRICT);


						$("#businessDate").datetimebox("setValue", mostlyJson.BUSINESS_DATE);
						$("#businessYwId").textbox("setValue", mostlyJson.BUSINESS_YW_ID);
						$("#planshipmentData").datetimebox("setValue", mostlyJson.PLANSHIPMENT_DATA);
						$("#beginLocalMan").textbox("setValue", mostlyJson.BEGIN_LOCAL_MAN);
						$("#beginLocalPhone").textbox("setValue", mostlyJson.BEGIN_LOCAL_PHONE);
						$("#planjiaofuData").datetimebox("setValue", mostlyJson.PLANJIAOFU_DATA);
						$("#endLocalMan").textbox("setValue", mostlyJson.END_LOCAL_MAN);
						$("#endLocalPhone").textbox("setValue", mostlyJson.END_LOCAL_PHONE);
						$("#shoukuan").textbox("setValue", mostlyJson.SHOUKUAN);
						$("#fukuan").textbox("setValue", mostlyJson.FUKUAN);
						$("#vol").textbox("setValue", mostlyJson.VOL);
						$("#gwt").textbox("setValue", mostlyJson.GWT);
						$("#qty").textbox("setValue", mostlyJson.QTY);
						$("#transportTypePlan").combobox("setValue", mostlyJson.TRANSPORT_TYPE_PLAN);
						// $("#ywLocation").combobox("setValue",mostlyJson.YW_LOCATION);
						$("#guid").val(mostlyJson.GUID);
						$("#omlGuid").val(mostlyJson.omlGuid);
						$("input[name='getMode'][value='" + mostlyJson.GET_MODE + "']").attr("checked", true);
						$("input[name='payMode'][value='" + mostlyJson.PAY_MODE + "']").attr("checked", true);
						$("#ywId").textbox("setValue", mostlyJson.YW_ID);
						$("#orderType").combobox("setValue", mostlyJson.ORDERTYPE);
						sumVol = mostlyJson.VOL;
						sumGwt = mostlyJson.GWT;
						sumQty = mostlyJson.QTY;
						businessYwId = $("#businessYwId").val();
						ywId = mostlyJson.YW_ID;

                        /*$("#cusNo").combobox('disable');
                        $("#businessYwId").textbox('disable');
                        $("#routeCode").combobox('disable');
                        $("#businessDate").datetimebox('disable');
                        $("#transportTypePlan").combobox('disable');
                        $("#begin_district").combobox('disable');
                        $("#orderType").combobox('disable');
						$("#begin_city").combobox('disable');
						$("#begin_area").combobox('disable');
						$("#historybeginAddress").combobox('disable');
						$("#beginLocalRemark").textbox('disable');
						$("#historyendAddress").combobox('disable');
						$("#end_district").combobox('disable');
						$("#end_city").combobox('disable');
						$("#end_area").combobox('disable');
						$("#endLocalRemark").combobox('disable');*/
					} else {
						FailResultDataToTip(dataObj);
					}
					hideLoading();
				},
				error: function (message) {
					hideLoading();
				}
			});
		}


		var currentAddress = {};

		var loadTransType = function () {
			$("#transportTypePlan").combobox({
				valueField: "code",
				textField: "name",
				loader: function (param, success, error) {
					$.ajax({
						url: "../../jcda/ZdCus/queryDictionary?t=" + Math.random() + "&kind=transportType",
						method: "GET",
						dataType: 'json',
						success: function (dataObj) {
							let data = dataObj.resultDataFull;
							var supArr = [];
							supArr.unshift({ code: '', name: pleaseChoose });
							data.forEach(function (item) {
								if (item.isDefault == '1') {
									$("#transportTypePlan").combobox("setValue", item.dicValue);
								}
								supArr.push({ code: item.dicValue, name: item.dicText });
							});
							success(supArr);

						}
					});
				}
			});
		}

		function loadCus() {
			$("#cusNo").combobox({
				valueField: 'code',
				textField: 'name',
				data: [],
				onSelect: function (row) {
					$("#historybeginAddress").combobox("setValue", "");
					$("#historyendAddress").combobox("setValue", "");
					loadLocationByCus(row.code);
				}
			});
			//初始化客户数据
			$.ajax({
				url: "../../bussiness/planExec/findCusWithCurrentWithinCode?t=" + Math.random(),
				dataType: 'json',
				method: "GET",
				success: function (data) {
					for (var i = 0; i < data.length; i++) {
						cusNoTextObj[data[i].code] = data[i].name;
						cusNoValuObj[data[i].name] = data[i].code;
						data[i].name = data[i].shortname + "-" + data[i].name;
					}
					$("#cusNo").combobox("loadData", data);
					/* data = data.resultDataFull;
					data.unshift({code:'',name:pleaseChoose});
					$("#cusNo").combobox("loadData",data);*/
				}
			});

		};


		var beginCode = "";
		var endCode = "";
		var loadLocation = function () {
			$("#historybeginAddress").combobox({
				valueField: "code",
				textField: "name",
				onSelect: function (row) {
					beginCode = row.code;
					loadRoute()
					$("#beginLocalMan").textbox("setValue", row.linkman);
					$("#beginLocalPhone").textbox("setValue", row.linktel);
					$("#beginLocalRemark").textbox("setValue", row.address);
					$("#beginLocalCode").val(row.addressCode);
					readDistrictCityArea("begin", row.province, row.city, row.district);
				}
			});
			$("#historyendAddress").combobox({
				valueField: "code",
				textField: "name",
				onSelect: function (row) {
					endCode = row.code;
					loadRoute();
					$("#endLocalSiteCode").val(row.addressCode);
					$("#endLocalMan").textbox("setValue", row.linkman);
					$("#endLocalPhone").textbox("setValue", row.linktel);
					$("#endLocalRemark").textbox("setValue", row.address);
					readDistrictCityArea("end", row.province, row.city, row.district);
				}
			});
		}


		var loadLocationByCus = function (cusNo) {
			$.ajax({
				url: "../../bussiness/planExec/findLocationByCus?cusNo=" + cusNo + "&t=" + Math.random(),
				dataType: 'json',
				method: "GET",
				success: function (data) {
					var beginAddress = [];
					var endAddress = [];
					for (let i = 0; i < data.length; i++) {
						// 获取收发货的type
						let dataObj = data[i];
						let sfKind = dataObj.sfKind;
						if (sfKind == 1) {
							beginAddress.push(dataObj);
						} else if (sfKind == 2) {
							endAddress.push(dataObj);
						} else if (sfKind == 3) {
							beginAddress.push(dataObj);
							endAddress.push(dataObj);
						}
					}
					$("#historybeginAddress").combobox("loadData", beginAddress);
					$("#historyendAddress").combobox("loadData", endAddress);
					// $("#historybeginAddress,#historyendAddress").combobox("loadData",data);
					/* if(data.length == 0){
						if($("#tipinputbeginAddress").is(":hidden")){
							$("#newBeginAddress,#newEndAddress").click();
						}
				  } */
				}
			});
		}

		var comboDefault = function () {
			$(this).combobox("setValue", pleaseChoose);
		}

		function addressDefault(data) {
			if (data.length != 1) {
				$(this).combobox("setValue", pleaseChoose);
			} else if (data.length == 1) {
				$(this).combobox("select", data[0].code);
			}
		}

		function addDetail() {
			$('#tabLocation').tabs('select', $.i18n.prop('supplier.detail.tab.title2'))
			clearDetail();
		}

		tipinput("tipinputbeginAddress", beginidObj, $("#beginLocalRemark"));
		tipinput("tipinputendAddress", endidObj, $("#endLocalRemark"));

		function tipinput(tipinput, obj, remark) {
			AMap.plugin(['AMap.Autocomplete', 'AMap.PlaceSearch'], function () {
				var autoOptions = {
					// 使用联想输入的input的id
					input: tipinput
				};
				var autocomplete = new AMap.Autocomplete(autoOptions);

				AMap.event.addListener(autocomplete, "select", function (e) {
					var placeSearch = new AMap.PlaceSearch({
						city: e.poi.adcode,
						children: 1
					});

					placeSearch.getDetails(e.poi.id, function (status, result) {
						//获取匹配度最高的地址
						var poi = result.poiList.pois[0];
						var district = poi.pname;
						var city = poi.cityname;
						var area = poi.adname;
						remark.textbox("setValue", poi.name);
						if (remark.attr("id") == "beginLocalRemark") {
							readDistrictCityArea("begin", district, city, area);
						} else {
							readDistrictCityArea("end", district, city, area);
						}
					});

				});
			});
		}

		function readProvince() {

			//初始化省
			$("#begin_district").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					$("#begin_city").combobox("setValue", "");
					$("#begin_area").combobox("setValue", "");
					readCity($("#begin_city"), row.name);
				},
				onLoadSuccess: function () {
				}
			});
			$("#end_district").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					$("#end_city").combobox("setValue", "");
					$("#end_area").combobox("setValue", "");
					readCity($("#end_city"), row.name);
				},
				onLoadSuccess: function () {
				}
			});

			//初始化市
			$("#begin_city").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					$("#begin_area").combobox("setValue", "");
					readArea($("#begin_area"), row.name);
				},
				onLoadSuccess: function () {
				}
			});
			$("#end_city").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					$("#end_area").combobox("setValue", "");
					readArea($("#end_area"), row.name);
				},
				onLoadSuccess: function () {
				}
			});

			//初始化区
			$("#begin_area").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					//
				},
				onLoadSuccess: function () {
				}
			});
			$("#end_area").combobox({
				valueField: "name",
				textField: "name",
				onSelect: function (row) {
					//
				},
				onLoadSuccess: function () {
				}
			});

			var opts = {
				subdistrict: 1,//返回下一级行政区
				showbiz: false  //最后一级返回街道信息
			};
            AMap.plugin(['AMap.DistrictSearch'], function () {
                var district = new AMap.DistrictSearch(opts);
                district.search("", function (status, result) {
                    if (result.info != undefined) {
                        var list = result.districtList[0].districtList;
                        $("#begin_district,#end_district").combobox("loadData", list);
                    }
                });
            });
		};

		var readCity = function (toObj, province) {
			var opts = {
				subdistrict: 2,   //返回下一级行政区
				showbiz: false  //最后一级返回街道信息
			};
            AMap.plugin(['AMap.DistrictSearch'], function () {
                var district = new AMap.DistrictSearch(opts);
                district.search(province, function (status, result) {
                    if (result.info != undefined) {
                        var cityList = result.districtList[0].districtList;
                        toObj.combobox("loadData", cityList);
                    }
                });
            })

		};

		var readArea = function (toObj, city) {
			var opts = {
				subdistrict: 3,   //返回下一级行政区
				showbiz: false  //最后一级返回街道信息
			};
            AMap.plugin(['AMap.DistrictSearch'], function () {
                var district = new AMap.DistrictSearch(opts);
                district.search(city, function (status, result) {
                    if (result.info != undefined) {
                        var list = [];
                        list = result.districtList[0].districtList;
                        toObj.combobox("loadData", list);
                    }
                });
            });
		};

		var readDistrictCityArea = function (id, district, city, area) {
			if (id == "begin") {
				$("#begin_district").combobox("setValue", district);
				$("#begin_district").combobox("options").onSelect({
					name: district
				});
				$("#begin_city").combobox("setValue", city);
				$("#begin_city").combobox("options").onSelect({
					name: city
				});
				$("#begin_area").combobox("setValue", area);
			} else {
				$("#end_district").combobox("setValue", district);
				$("#end_district").combobox("options").onSelect({
					name: district
				});
				$("#end_city").combobox("setValue", city);
				$("#end_city").combobox("options").onSelect({
					name: city
				});
				$("#end_area").combobox("setValue", area);
			}
		};

		// 自定义窗体
		var map = new AMap.Map('container', {
			resizeEnable: true,
			zoom: 12,
			center: [118.756376, 32.052573]
		});
		var infowindow;
		map.plugin('AMap.AdvancedInfoWindow', function () {
			infowindow = new AMap.AdvancedInfoWindow({
				panel: 'panel',
				placeSearch: true,
				asOrigin: true,
				asDestination: true
			});
		});

		function cancellation() {
			if (!(state >= 1 && state < 3)) {
				errorNotification({ SimpleMessage: $.i18n.prop('onlyTheWaybillBeforeShipmentCanBeCanceled') });
				return;
			}
			$.messager.confirm($.i18n.prop('planExec_Prompt'), "#{areYouSureYouWantToCancel}？", function (r) {
				if (r) {
					showLoading();
					$.ajax({
						url: '../../order/cancel?t=' + Math.random() + "&guid=" + guid,
						type: 'POST',
						success: function (dataObj) {
							if (isServerResultDataPass(dataObj)) {
								correctNotification(dataObj.resultDataFull);
								close();
							} else {
								FailResultDataToTip(dataObj);
							}
							hideLoading();
						},
						error: function (message) {
							hideLoading();
						}
					});
				}
			});
		}

		$("#newBeginAddress").toggle(function (param) {
			$("#" + param.currentTarget.id).text(historyAddress);
			$('#tipinputbeginAddress').val("");
			$('#historybeginAddress').next(".combo").hide();
			$('#tipinputbeginAddress').show();
			$('#isNewBeginAddress').val("1");
		}, function (param) {
			$("#" + param.currentTarget.id).text(addressChoose);
			$('#historybeginAddress').next(".combo").show();
			$('#historybeginAddress').combobox("setValue", pleaseChoose);
			$('#tipinputbeginAddress').hide();
			$('#isNewBeginAddress').val("0");
		});

		$("#newEndAddress").toggle(function (param) {
			$("#" + param.currentTarget.id).text(historyAddress);
			$('#tipinputendAddress').val("");
			$('#historyendAddress').next(".combo").hide();
			$('#tipinputendAddress').show();
			$("#isNewEndAddress").val("1");
		}, function (param) {
			$("#" + param.currentTarget.id).text(addressChoose);
			$('#historyendAddress').next(".combo").show();
			$('#historyendAddress').combobox("setValue", pleaseChoose);
			$('#tipinputendAddress').hide();
			$("#isNewEndAddress").val("0");
		});

		function close() {
			$.messager.confirm('提示', '确定要关闭吗?', function (r) {
				if (r) {
					closeDialog("orderDetailTable");
				}
			})
		}


		function loadUnit() {
			$.ajax({
				// url: '../../bussiness/planExec/getunit?t=' + Math.random(),
				url: '../../sysInfo/dictionary/getZdDicData?t=' + Math.random()
					+ '&customSearchFilters=%7B%22groupOp%22:%22AND%22,%22rules%22:%5B%7B%22field%22:%22typeCode%22,%22op%22:%22eq%22,%22data%22:%22orderDetailUnit%22%7D%5D%7D',
				type: 'POST',
				async: false,
				success: function (dataObj) {

					for (let i = 0; i < dataObj.rows.length; i++) {
						const element = dataObj.rows[i];
						unitInnerHtml += element.dictext + ":" + element.dictext + ";";
						unitValueObj[element.dictext] = element.dictext;
						unitTextObj[element.dictext] = element.dictext;
					}

					// dataObj.resultDataFull.forEach(function (item) {
					// 	unitInnerHtml += item.UNITCODE + ":" + item.UNITNAME + ";";
					// 	unitValueObj[item.UNITNAME] = item.UNITCODE;
					// 	unitTextObj[item.UNITCODE] = item.UNITNAME;
					// });
					unitInnerHtml = unitInnerHtml.substr(0, unitInnerHtml.length - 1);
				}
			});
		}

		var addNew = function () {
			$("#detailForm").form("clear");
			$("#businessDate").datetimebox("setValue", curDate);
			$("#planshipmentData").datetimebox("setValue", curDate);
			$("#planjiaofuData").datetimebox("setValue", curDate);
			$("#gridTableZero").jqGrid("clearGridData");
			$("#isNewBeginAddress").val("0");
			$("#isNewEndAddress").val("0");
			$("input[name='payMode'][value='0']").attr("checked", true);
			$("input[name='getMode'][value='0']").attr("checked", true);
			//loadCus();
			//loadTransType();
			//loadYwLocation();
			parent.extendTab($("#guid").val());
		}

		var copy = function () {

			// 清空 表格
			removeTable();
			// 清空表单
			$("#guid").val("");
			$("#omlGuid").val("");
			$("#ywId").textbox("setValue", "");
		}

		var removeTable = function () {
			// 复制的时候，不进入后台，直接去掉一些关联关系，只保留页面上面的文件框的内容
			var rowData = $("#gridTableZero").jqGrid("getRowData");
			console.log(rowData);
			for (let i = 0; i < rowData.length; i++) {
				// 清空 sn和guid
				rowData[i].sn = "";
				rowData[i].guid = "";
				rowData[i].contId = "";
				rowData[i].mostlyGuid = "";
				rowData[i].unit = unitValueObj[rowData[i].unit];
			}
			searchDataForLocal(rowData);
		}

		function searchDataForLocal(rowData) {
			$('#gridTableZero').jqGrid('setGridParam', {
				// url : getSearchGridUrl(),
				datatype: 'local',
				postData: { 'filters': '' },
				data: rowData,
				page: 1
			}).trigger('reloadGrid');
		}

		function print() {
			var href = "../View/ywgl/printZeroOrderDetail.html?guid=" + guid;
			openDialog({ title: /* 委托明细列表 */"打印运单明细", id: 'printZeroOrderDetail', width: 1000, height: 630, isResize: true, href: href, closable: true });
		}

		/**
		 * @Description 通过 地址的guid去查询线路
		 * @param
		 * @Author lao li
		 * @Date
		 * @return
		*/
		function loadRoute() {
			// 如果都为空，不去请求后台查询
			if (beginCode == "" || endCode == "") {
				return;
			}

			$.ajax({
				url: '../../order/queryZdRoute?t=' + Math.random(),
				type: 'POST',
				data: {
					'beginCode': beginCode,
					'endCode': endCode
				},
				success: function (dataObj) {
					let data = dataObj.resultDataFull;
					if (data == null) {
						return;
					}

					$("#routeCode").combobox({
						valueField: 'route_code',
						textField: 'route_name',
						loader: function (params, success, error) {
							success(data);
						}
					})
					// 塞默认值的方法放到最后
					if (data.length == 1) {
						$("#routeCode").combobox("setValue", data[0].route_code);
						return;
					}
				}
			})

		}

		Date.prototype.Format = function (fmt) { //author: meizz 
			var o = {
				"M+": this.getMonth() + 1, //月份 
				"d+": this.getDate(), //日 
				"h+": this.getHours(), //小时 
				"m+": this.getMinutes(), //分 
				"s+": this.getSeconds(), //秒 
				"q+": Math.floor((this.getMonth() + 3) / 3), //季度 
				"S": this.getMilliseconds() //毫秒 
			};
			if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
			for (var k in o)
				if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
			return fmt;
		}
	</script>
</body>

</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link id="CustomTheme" type="text/css" rel="stylesheet"
	href="../../Resource/css/index/customLightBlue.css" />
<link id="EasyuiTheme" type="text/css" rel="stylesheet"
	href="../../Resource/js/easyUI/themes/easyuiLightBlue.css" />
<link id="JqgridTheme" type="text/css" rel="stylesheet"
	href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css" />
<link type="text/css" rel="stylesheet"
	href="../../Resource/js/easyUI/themes/icon.css" />
<link type="text/css" rel="stylesheet"
	href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
    <title></title>
    <style type="">
   
#orderDetailChild { position:relative;  display:none; background-color:#FFEE99;position: fixed;float: right;
width:450px;height:200px; 
left:51%;
top:55%;
z-index: 999;
margin-left:10px;} 

</style>
    
</head>

<body>
<div id="toolbar" class="easyui-panel" style="padding:4px;border-width:0; border-bottom-width:1px;">
	 #{PAGE_TOOLBAR_BUTTONROLE}
</div>
<div class="searchParamesPanel">


	<form id="addForm" class="easyui-form" method="post"  data-options="novalidate:true">
    <input type="hidden" id="sn" name="sn" />
    <input type="hidden" id="guid" name="guid" />
    <input type="hidden" id="omlGuid" name="omlGuid" />
    <div id="orderDetailChild">
   <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add'" width="15" height="15" onclick="addChild('detailChildTableId')"><label data-locale="addRow"/></a>
	<a href="#" class="easyui-linkbutton" data-options="iconCls:'icon-save'" onclick="saveChildTable()"><label data-locale="saveDetail"/></a> 
    <a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" onclick="removn()" style="margin-left:139px;"><label data-locale="closeTable"/></a>
    <table id="detailChildTableId"></table>
    </div>
    <table class="editTable">
        <tr>
        <td rowspan="2" style="text-align:center;"><img   src="../../View/ywgl/images/icon2.png"/><p><label data-locale="sendGoods"/></p></td>
            <td class="editRequiredTitle" style="color: black;"><label data-locale="sendGoodsDate"/>:</td>
            <td class="editControl">
            	<input id="planshipmentData" class="easyui-datebox"  name="planshipmentData"  data-options="editable:false"  />
            </td>
            <td class="editRequiredTitle" style="color: black;"><label data-locale="sendGoodsPerson"/>:</td>
            <td class="editControl">
            	<input class="easyui-textbox" id="beginLocalMan"  name="beginLocalMan" autocomplete="off"/>
            </td>
        </tr>
        <tr>
            <td class="editRequiredTitle" style="color: black;"><label data-locale="sendGoodsAddress"/>:</td>
            <td class="editControl">
                <input type="text" name="beginLocalAddress" id="tipinputbegin" autocomplete="off" style="width: 100px"/>  
                <input type="text" name="beginLocalAddressP" id="tipinputbeginp" style="width:100px;"/>
                <input type="text" name="beginLocalAddressC" id="tipinputbeginc" style="width:100ox;"/>
                <input type="text" name="beginLocalAddressA" id="tipinputbegina" style="width:100px;"/>
            </td>
            <td class="editRequiredTitle" style="color: black;"><label data-locale="sendGoodsTelephone"/>:</td>
            <td class="editControl">
            	<input class="easyui-textbox" id="beginLocalPhone"  name="beginLocalPhone"   data-options="onChange:time,panelHeight:'150'"  />
            </td>
        </tr>
        <tr>
        <td rowspan="2" style="text-align:center;"><img   src="../../View/ywgl/images/icon3.png" /><p><label data-locale="receiveGoods"/></p></td>
           <td class="editRequiredTitle" style="color: black;"><label data-locale="receiveGoodsDate"/>:</td>
            <td class="editControl">
           		<input id="planjiaofuData" class="easyui-datebox"  name="planjiaofuData"  data-options="editable:false"  />
            </td>
            <td class="editRequiredTitle" style="color: black;"><label data-locale="receiveGoodsPerson"/>:</td>
            <td class="editControl">
                <input class="easyui-textbox" name="endLocalMan" id="endLocalMan" autocomplete="off" />  
            </td>
        </tr>
         <tr>
           <td class="editRequiredTitle" style="color: black;"><label data-locale="receiveGoodsAddress"/>:</td>
            <td class="editControl">
                <input type="text" name="endLocalAddress" id="tipinputend" autocomplete="off"  style="width: 100px"/> 
                <input type="text" name="endLocalAddressP" id="tipinputendp" style="width:100px;"/>
                <input type="text" name="endLocalAddressC" id="tipinputendc" style="width:100px;"/>
                <input type="text" name="endLocalAddressA" id="tipinputenda" style="width:100px;"/>
            </td>
            <td class="editRequiredTitle" style="color: black;"><label data-locale="receiveGoodsTelephone"/>:</td>
            <td class="editControl">
                <input class="easyui-textbox"  name="endLocalPhone"   id="endLocalPhone"  />
            </td>
        </tr>
        <tr>
        <td  style="text-align:center;"><img   src="../../View/ywgl/images/icon4.png"/><p><label data-locale="cost"/></p></td>
        	 <td class="editRequiredTitle" style="color: black;"><label data-locale="receiptsMoney"/>:</td>
            <td class="editControl">
                <input class="easyui-textbox"  name="shoukuan"   id="shoukuan"  />
            </td>
            <td class="editRequiredTitle" style="color: black;"><label data-locale="paymentMoney"/>:</td>
            <td class="editControl">
                <input class="easyui-textbox"  name="fukuan"   id="fukuan"  />
            </td>
        </tr>
    </table>
    </form>
    </div>
<div id="gridControl">
<h1><img onclick="add('gridTable')" src="../../Resource/images/btn_bg_edit.png" width="20" height="20"/></h1> 
 <table id="gridTable"> </table>
 <!--  <div id="gridPager"></div> -->
</div >



<div id="fileUpload" style="position:absolute;left:50%;top:50%;width:600px;height:400px;margin-left:-300px;margin-top:-200px;display:none;"></div>

<form id="formExportFile" target="_blank"  method="post" style="display: none"></form>

<script type="text/javascript"
	src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
<script type="text/javascript"
	src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript"
	src="../../View/ddgl/js/jquery.easyui.min.js"></script>
<script type="text/javascript"
	src="../../Resource/js/easyUI/jquery.easyuiExtend.min.js"></script>
<script type="text/javascript"
	src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
<script type="text/javascript"
	src="../../Resource/js/base/commonControl.js"></script>
<script type="text/javascript"
	src="../../Resource/js/base/globalVariable.js"></script>
<script type="text/javascript"
	src="../../Resource/js/base/commonBusiness.js"></script>
<script type="text/javascript"
	src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
<script type="text/javascript"
	src="../../View/ddgl/js/jquery.jqGrid.min.js"></script>
<script type="text/javascript"
	src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript"
	src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
<script type="text/javascript" src="../../View/ddgl/js/util.js"></script>
<script type="text/javascript" src="../../Resource/js/regex/regex.js"></script>
<script type="text/javascript" src="API/AMap/js/maps.js"></script>
<script language="javascript" type="text/javascript">
var child=[];
var moduleId = 0;
var valve = 0;//用于判断增加还是修改的阀门值。0代表修改操作，1代表增加操作。
var savedRow1 = null;
var savedCol1 = null;
var savedChildRow1=null;
var savedChildCol1=null;
var child = [];
var detailRowNumber = null;
$(function() {
    var parms = getUrlParms();
    var sn = parms["sn"];
    mostly_guid = parms["mostly_guid"];
    //trainno = parms["trainno"];
    //cusNo = parms["cusNo"];
    //moduleId = parms['moduleId'];
    var jsonList = [];
    var orderDetailGuid = null;
    initScript();
    initStyle();
	initData();
    if (mostly_guid == undefined || mostly_guid==null || mostly_guid=="") {
    	$("#addForm").form("clear");
	}else {
    	loadMostly();//绑定订单主表数据(作为修改的初始值)
		
	}
});

$(window).load(function() { hideLoading(); });


// 自定义窗体
var map = new AMap.Map('container', {
    		resizeEnable : true,
    		zoom : 12,
    		center : [ 118.756376, 32.052573 ]
    	});
    	var infowindow;
    	map.plugin('AMap.AdvancedInfoWindow', function() {
    		infowindow = new AMap.AdvancedInfoWindow({
    			panel : 'panel',
    			placeSearch : true,
    			asOrigin : true,
    			asDestination : true
    		});
    	});

    	// 起运城市与目的城市分别绑定高德地图城市查询API
    	$("#tipinputbegin").focus(function() {
    		tipinput("tipinputbegin",$("#tipinputbeginp"),$("#tipinputbeginc"),$("#tipinputbegina"));
    	});

    	$("#tipinputend").focus(function() {
    		tipinput("tipinputend",$("#tipinputendp"),$("#tipinputendc"),$("#tipinputenda"));
    	});
    	var time = function(date){
			$("[name=planBeginDate]").val(date);
		}
    	
    	function tipinput(tipinput,inputp,inputc,inputa) {
    		AMap.plugin(['AMap.Autocomplete','AMap.PlaceSearch'],function(){
    			var autoOptions = {
				    // 使用联想输入的input的id
				    input: tipinput
			  	};
    			var autocomplete = new AMap.Autocomplete(autoOptions);
    			
    			AMap.event.addListener(autocomplete,"select",function(e){
    				console.log(e);
    				var placeSearch = new AMap.PlaceSearch({
    					  city: e.poi.adcode,
    					  children : 1
    				});

   					placeSearch.getDetails(e.poi.id, function (status, result) {
   						console.log(result);
   					})
    				placeSearch.search(e.poi.name);
    				inputp.val(e.poi.address);
    				inputc.val(e.poi.district);
    				inputa.val(e.poi.name)
    			});
    		});
    	}



var initStyle = function() {
	$(':radio').click(function() { searchData(); });
    enterTriggerEvent('searchParamesTable', 'searchData');
};
var oldSetGridHeightWidth = setGridHeightWidth;
var setGridHeightWidth = function() {
	oldSetGridHeightWidth(40,170);
	oldSetGridHeightWidth(5, 128);
	$(".ui-jqgrid-bdiv").css("height","300px");
    $("#gview_gridTable").css("height","323px");
};
var initScript = function() {
	var v = 0;
	$(window).resize(function() {
		if (v == 0) {
			setTimeout(function() { setGridHeightWidth(); v = 0; }, 200)
			v = 1;
		}
		setGridHeightWidth();
		setToolbarHeightWidth();
	});	
};
var initData = function() {

   loadList();// 加载列表数据
};

// 查询数据
function searchData() {
    $('#gridTable').jqGrid('setGridParam', {
    	url : getSearchGridUrl(),
    	datatype : 'json',
    	postData : { 'filters' : '' },
    	page : 1
    }).trigger('reloadGrid');
}

// 获取查询访问路径
var getSearchGridUrl = function() {
    return '../../order/findZeroOrderDetial?t=' + Math.random() + '&customSearchFilters=' + encodeURI(getSearchFilters());
};

	// 获取查询条件
var getSearchFilters = function() {
	var parmsArray = [
	{ name: 'o.mostly_guid', value: mostly_guid, op: "eq" }
    ];
    return formatSearchParames(parmsArray);
};

// 修改或新增订单
var save = function() {
	loseGridFocus();
	var parameter = FormUtils.toJSONObject($("#addForm"));
    var gridAllData = $("#gridTable").jqGrid("getRowData");
    parameter.detail = [];
  
    for (var i = 0; i < gridAllData.length; i++) {
    	var details = {};
    	details.sn = gridAllData[i].SN;
    	details.guid = gridAllData[i].guid;
    	details.goodsName = gridAllData[i].goodsName;
    	details.vol = gridAllData[i].vol;
    	details.gwt=gridAllData[i].gwt;
    	details.qty = gridAllData[i].qty;
    	parameter.detail.push(details);
    }
    
    parameter.child = child;
   
    /* var orderMostlyVo = FormUtils.toJSONObject($("#detailForm"));
	  var detailAllData = $("#gridTable").jqGrid("getRowData");
	  alert(detailAllData.length)
	  if (detailAllData.length == 0) {
		  alert($.i18n.prop('orderDetailOneSave'))
		  return;
	}
	  var ids = $("#gridTable").jqGrid("getDataIDs");
	  orderMostlyVo.child =child;
	  orderMostlyVo.details = [];
	    for (var i = 0; i < detailAllData.length; i++) {
	    	var detail = {};
	    	detail.row=ids[i];
	    	detail.sn = detailAllData[i].rowId;
	    	detail.guid = detailAllData[i].guid;
	    	detail.goodsName = detailAllData[i].goodsName;
	    	detail.vol = detailAllData[i].vol;
	    	detail.gwt= detailAllData[i].gwt;
	    	detail.qty = detailAllData[i].qty;
	    	detail.mostlyGuid=mostly_guid;
	    	orderMostlyVo.details.push(detail);
	    } */
	    
	var url="";
	if(mostly_guid=="" || mostly_guid==undefined){
		//执行新增操作
		url = "../../order/addZoreOrderMostly?t="+Math.random();
		} else{
		// 执行修改���作
		url="../../order/updateZoreOrderMostly?t="+Math.random();
	} 
		$(function(){
			$.messager.confirm($.i18n.prop('orderList_Prompt'), $.i18n.prop('orderList_save'), function(r) {// 提示, 确定保存数据项吗
    			if (r) {
    				showLoading();
    				
    				if(mostly_guid !=""){
    					parameter.guid = mostly_guid
    				}
    				$.ajax({
    					url : url,
    					type : 'POST',
    					/* contentType : 'application/json;charset=utf-8', */
    					data :"jsonData="+encodeURI(JSON.stringify(parameter)),
    					success : function(dataObj) {
    						if (isServerResultDataPass(dataObj)) {
    							correctNotification(dataObj.resultDataFull);
    							//$("#addForm").form("clear");
    							searchData(); // 重新加载数据
    						} else {
    							FailResultDataToTip(dataObj);
    						}
    						hideLoading();
    					},
    					error : function(message) {
    						hideLoading();
    					}
    				});
    			}
    		});
		})
    //openDetail(rowData.sn);
};


// 修改车次信息
/* var openDetail = function(sn) {
    showLoading();
    var href = '../View/ywgl/planExecManage.html?moduleId=' + moduleId + '&sn=' + sn;
    openDialog({ title : $.i18n.prop('planExec_Title_Detail'), id : 'planExecDetail', width : 1000, height : 300, isResize : true, href : href, closable : true });
}; */


//绑定订单主表信息，作为修改的初始值
var loadMostly = function(){
	$.ajax({
		url : '../../order/findOrderMostly?t='+ Math.random()+'&guid='+mostly_guid,
		type : 'POST',
		data :"",
		success : function(dataObj) {
			if (isServerResultDataPass(dataObj)) {
				var mostlyJson = dataObj.resultDataFull;
				$("#planshipmentData").datebox("setValue",mostlyJson.PLANSHIPMENT_DATA);
				$("#beginLocalMan").textbox("setValue",mostlyJson.BEGIN_LOCAL_MAN);
				$("#beginLocalPhone").textbox("setValue",mostlyJson.BEGIN_LOCAL_PHONE);
				$("[name=beginLocalAddress]").val(mostlyJson.BEGIN_LOCAL_ADDRESS);
				$("#planjiaofuData").datebox("setValue",mostlyJson.PLANJIAOFU_DATA);
				$("#endLocalMan").textbox("setValue",mostlyJson.END_LOCAL_MAN);
				$("[name=endLocalAddress]").val(mostlyJson.END_LOCAL_ADDRESS);
				$("#endLocalPhone").textbox("setValue",mostlyJson.END_LOCAL_PHONE);
				$("#shoukuan").textbox("setValue",mostlyJson.SHOUKUAN);
				$("#fukuan").textbox("setValue",mostlyJson.FUKUAN);
				$("#guid").val(mostlyJson.GUID);
				$("#omlGuid").val(mostlyJson.omlGuid);
				//correctNotification(dataObj.resultDataFull);
			} else {
				FailResultDataToTip(dataObj);
			}
			hideLoading();
		},
		error : function(message) {
			hideLoading();
		}
	});
}
//获取某一条明细中的信息
var addText = $.i18n.prop('order_detail_add');
var addOpen = function(index,name){
	var guid = $("#guid").val();
	var rowData = $("#"+name).jqGrid('getRowData',index);
	var detail_guid = rowData.guid;
 	var href = '../View/ywgl/zeroOrderDetailChild.html?mostly_guid=' + guid+'&detail_guid='+detail_guid;
 	openDialog({ title : $.i18n.prop('zoreOrderDetialList_Title'), id : 'orderDetailChild', width : 1000, height : 500, isResize : true, href : href, closable : true });
}
//删除某一条明细
var delText = $.i18n.prop('order_detail_del');
var deleteRow = function(index,name){
	$.messager.confirm($.i18n.prop('orderList_Prompt'), '#{planExec_mostly_detail_message_deleteQuestion}?', function (r) {
		if(r){
			var rowData = $("#"+name).jqGrid('getRowData',index);
			if(rowData.sn!='' && rowData.sn!=undefined && rowData.sn!=null){
				showLoading($.i18n.prop('order.detail.loading'));
            	$.ajax({
            		url : "../../order/deleteOrderDetail?t="+Math.random(),
            		data:{sn:rowData.sn,guid:rowData.guid},
            		type:"POST",
            		success:function(data){
            			  if (isServerResultDataPass(data)) {
            	                correctNotification({
            	                    SimpleMessage: data.resultDataFull.simpleMessage
            	                });
            	                $("#"+name).delRowData(index);
            	    	    	
            	    	    	if($("#"+name).jqGrid("getRowData").length<=0){
           	    	    			savedRow1 = null;
           	    	                savedCol1 = null;
            	    	    	}
            	            } else {
            	                FailResultDataToTip(data);
            	            }
            	            hideLoading();
            		}
            	});
			}else {
				$("#"+name).delRowData(index);
    	    	
    	    	if($("#"+name).jqGrid("getRowData").length<=0){
   	    			savedRow1 = null;
   	                savedCol1 = null;
    	    	}
			}
		}
	});
}
// 加载列表数据
var loadList = function() {
	 $('#gridTable').jqGrid({
         url : getSearchGridUrl(),
         datatype : 'json',
         width : 'none',
         colNames : [
        	'',$.i18n.prop('sn'),$.i18n.prop('guid'),$.i18n.prop('withinCode'),$.i18n.prop('createBy'),$.i18n.prop('createDate'),
         	$.i18n.prop('updateBy'),$.i18n.prop('updateDate'),$.i18n.prop('goodsName'),$.i18n.prop('mostlyGuid'),
         	$.i18n.prop('unit'),$.i18n.prop('vol'), $.i18n.prop('gwt'), $.i18n.prop('qty'),'编辑子明细'
         ],
         colModel : [
			{ name :'delete',width:40 , index : 'delete' ,align:'center',formatter:function(value,row,rowIndex){return "<a style='text-decoration:underline;color:blue;' href='javascript:deleteRow("+row.rowId+",\"gridTable\")'>"+delText+"</a>";"<a style='text-decoration:underline;color:blue;' href='javascript:deleteRow("+row.rowId+",\"gridTable\")'>"+delText+"</a>";}},
            { name : 'sn', index: 'sn',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            { name : 'guid', index: 'guid',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            { name : 'withinCode', index: 'within_Code', key : true, align : 'center', sorttype: 'string', sortable : false,hidden: true},
         	{ name : 'createBy', index: 'create_By', align : 'center', sorttype: 'string',sortable : false,hidden: true},
         	{ name : 'createDate', index: 'CREATE_DATE',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
         	{ name : 'updateBy', index: 'UPDATE_BY',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
         	{ name : 'updateDate', index : 'UPDATE_DATE', align : 'center', isSort : false,search : true, type : 'string',hidden: true, searchoptions : { sopt : ['cn', 'eq', 'ne']} },
         	{ name : 'goodsName', index : 'goods_name', editable: true, edittype: 'text', align: 'center', fixed: true, width: 100, search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }},
         	{ name : 'mostlyGuid', index : 'MOSTLY_GUID', align : 'center', isSort : false,search : true, type : 'string', searchoptions : { sopt : ['cn', 'eq', 'ne']},hidden: true },
         	{ name : 'unit', index : 'UNIT', editable: true, edittype: 'text', align: 'center', fixed: true, width: 70, search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }},
         	{ name : 'vol', index : 'VOL', editable: true, edittype: 'text', align: 'center', fixed: true, width: 70, search: true, searchoptions: { sopt: ['cn', 'eq', 'ne']  }},
	        { name : 'gwt', index : 'GWT', editable: true, edittype: 'text', align: 'center', fixed: true, width: 70, search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }},
	        { name : 'qty', index : 'qty', editable: true, edittype: 'text', align: 'center', fixed: true, width: 50, search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }},
         	{ name : 'edit', index: 'edit',  align: 'center', width: 80,formatter:function(value,row,rowIndex){return "<a href='javascript:void(0)' onmouseover='MouseOver("+row.rowId+")'>"+'添加/修改'+"</a>";}}
         ],
         cellEdit: true,
         cellsubmit: 'clientArray',
         shrinkToFit: false,
         altRows: true,
         altclass: 'gridSpacingClass',
         forceFit: true,
         cellLayout: 0,
         scroll: false,
         autowidth: true,
         loadonce: false,
         mtype: "POST",
         viewrecords: true,
         rownumbers: true,
         rowNum: 100,
         height: "20%",
         rowList: [15, 20, 30, 50, 100],
         pager: "#gridPager",
         jsonReader: {
             root: "rows",
             total: "total",
             page: "page",
             records: "records",
             repeatitems: false
         },
         gridComplete : function() {
             $('.cbox').shiftSelect();
         },
        
         loadComplete : function(xhr) {
             $('.gridViewPicLink').tooltip({
                 position : 'bottom',
                 content : $(this).attr('title'),
                 onShow : function() {
                     $(this).tooltip('tip').css({ backgroundColor: '#FCF8E3', borderColor: '#FAEBCC' });
                 }
             });
             FailResultDataToTip(xhr);
         }
        
    });
    
    var getSearchOrderDetialFilters = function(){
    	alert(orderDetailGuid)
		var parmsArray = [
		          		{ name: 'od.guid', value: orderDetailGuid, op: "eq" },
		                  ];
		                  return formatSearchParames(parmsArray);
	}

    $('#gridTable').jqGrid('navGrid', '#gridPager',
    		{ add: false, edit: false, del: false, refresh: true }, {}, {}, {},
    		{ multipleSearch: true, closeOnEscape: true, closeAfterSearch: true });
    $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
        caption: $.i18n.prop('OrderList_ReorderColumns'),// 设置列
        title: 'Reorder Columns',
        onClickButton: toggleGridColumns
    });

    $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
        caption: $.i18n.prop('OrderList_QuickSearch'),// 快捷搜索
        title: 'Quick Search',
        onClickButton: toggleGridSearchToolbar
    });
    $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
   		caption: $.i18n.prop('OrderList_ExportDatas'),// 导出数据
        title: 'Export Datas',
        buttonicon: 'ui-icon-disk',
        onClickButton: function() {
      		ExportToExcel.call(this, { title:$.i18n.prop('OrderList_ExportDatas')});
        }
    });
    setGridHeightWidth();
};
//订单详情
var showPlanDetail = function(trainno){
	var href = '../View/ywgl/orderDetail.html?moduleId=' + moduleId + '&trainno=' + trainno;
}

// 用户双击跳转车次物品清单
var showChildModule = function (trainno) { showPlanDetail(trainno); };


// 新增、修改操作完成后调用的刷新方法
var refreshCallerData_List = function () {
    searchData();
};

var add = function (name) {
	loseGridFocus();
    var ids = $("#"+name).jqGrid('getDataIDs');
    var rowid = Math.max.apply(Math, ids);
    if (rowid == "-Infinity"){
        rowid = 0;
    }
    var newrowid = rowid + 1;
    var dataRow = {
    	rowid: newrowid,
    };
    $("#"+name).jqGrid("addRowData", newrowid, dataRow, "last");
}

var loseGridFocus = function () {
    if (savedRow1 && savedCol1) {
        $('#gridTable').jqGrid('saveCell', savedRow1, savedCol1);
    }
}

$("#gridTable").setGridParam({
	   beforeEditCell : function (rowid, cellname , value , iRow, iCol){
		   savedRow1 = iRow;
		   savedCol1 = iCol;
	   }
});


function MouseOver(name)
{
	var rowData = $("#gridTable").jqGrid('getRowData', name);
	detailRowNumber = name;
	detailGuid = rowData.guid;	
    $("#orderDetailChild").show();
    listChild(name);
    $("#gview_detailChildTableId").find(".ui-jqgrid-bdiv").css("height","200px");
  
}
 




//加载订单详情子明细
var listChild = function () {
	$('#detailChildTableId').jqGrid({
        url : getSearchGridUrl(),
        datatype : 'json',
        width : 'none',
        colNames : ['','sn',$.i18n.prop('planExec_mostly_detailChild_Guid'),$.i18n.prop('planExec_mostly_detailChild_detailGuid'),$.i18n.prop('planExec_mostly_detailChild_goodCode'),$.i18n.prop('planExec_mostly_detailChild_goodName'),$.i18n.prop('planExec_mostly_detailChild_vol'), 
            $.i18n.prop('planExec_mostly_detailChild_gwt'), $.i18n.prop('planExec_mostly_detailChild_qty')
        ],
        colModel : [
			{ name :'delete',width:40 , index : 'delete' ,align:'center',formatter:function(value,row,rowIndex){return "<a style='text-decoration:underline;color:blue;' href='javascript:deleteRow("+row.rowId+",\"detailChildTableId\")'>"+delText+"</a>";"<a style='text-decoration:underline;color:blue;' href='javascript:deleteRow("+row.rowId+",\"gridTable\")'>"+delText+"</a>";}},
           { name : 'sn', index: 'sn',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
           { name : 'odcguid', index: 'ODCGUID',  align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
           { name : 'detailGuid', index: 'DETAIL_GUID',  align : 'center', sorttype: 'string', sortable : false,hidden: true},
        	{ name : 'goodCode', index: 'GOOD_CODE', align : 'center', sorttype: 'string',sortable : false,hidden: true},
        	{ name : 'goodName', index: 'GOOD_NAME',  align: 'center', editable: true, edittype: 'text',  fixed: true, width: 150, },
        	{ name : 'vol', index: 'VOL',  align: 'center', editable: true, edittype: 'text',  fixed: true, width: 70, },
        	{ name : 'gwt', index : 'GWT', align : 'center', editable: true, edittype: 'text',  fixed: true, width: 70,},
        	{ name : 'qty', index : 'QTY', align : 'center',editable: true, edittype: 'text',  fixed: true, width: 60,},
        ],
        cellEdit: true,
        cellsubmit: 'clientArray',
        shrinkToFit: false,
        altRows: true,
        altclass: 'gridSpacingClass',
        forceFit: true,
        cellLayout: 0,
        scroll: false,
        autowidth: true,
        loadonce: false,
        mtype: "POST",
        viewrecords: true,
        rownumbers: true,
        rowNum: 100,
        height: "20%",
        rowList: [15, 20, 30, 50, 100],
        pager: "#gridPager",
        jsonReader: {
            root: "rows",
            total: "total",
            page: "page",
            records: "records",
            repeatitems: false
        },
        gridComplete : function() {
            $('.cbox').shiftSelect();
        },
       
        loadComplete : function(xhr) {
            $('.gridViewPicLink').tooltip({
                position : 'bottom',
                content : $(this).attr('title'),
                onShow : function() {
                    $(this).tooltip('tip').css({ backgroundColor: '#FCF8E3', borderColor: '#FAEBCC' });
                }
            });
            FailResultDataToTip(xhr);
        }
       
       
   });
   
   var getSearchOrderDetialFilters = function(){
   	alert(orderDetailGuid)
		var parmsArray = [
		          		{ name: 'od.guid', value: orderDetailGuid, op: "eq" },
		                  ];
		                  return formatSearchParames(parmsArray);
	}

   $('#detailChildTableId').setGridParam({
       beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
           savedChildRow1 = iRow;
           savedChildCol1 = iCol;
       }
   });
   
   setGridHeightWidth();
}


var getDetailChild = function(detail_guid){
	if(detail_guid!=null&&detail_guid!=undefined){
		var url = "../../order/findZoreOrderChildBydetailGuid?t="+ Math.random()+"&customSearchFilters=" + encodeURI(getSearchFilters(detail_guid));
		return url;  
	}
	return;
}

var addChild = function (name) {
	loseGridChindFocus();
    var ids = $("#"+name).jqGrid('getDataIDs');
    var rowid = Math.max.apply(Math, ids);
    if (rowid == "-Infinity"){
        rowid = 0;
    }
    var newrowid = rowid + 1;
    var dataRow = {
    	rowid: newrowid,
    };
    $("#"+name).jqGrid("addRowData", newrowid, dataRow, "last");
}
function removn(){
	 $("#orderDetailChild").hide();
}


var loseGridChindFocus = function () {
    if (savedChildRow1 && savedChildCol1) {
        $('#detailChildTableId').jqGrid('saveCell', savedChildRow1, savedChildCol1);
    }
}
//占存子明细表的数据在域中
var saveChildTable =function (){
	loseGridChindFocus();
	var childAllData = $("#detailChildTableId").jqGrid("getRowData");
	if (childAllData.length ==0) {
		alert($.i18n.prop('orderDetailOneSave'))
		return;
	}else {
		//清空数组
		child.splice(0,child.length);//清空数组 
		console.log(child); 
	    for (var i = 0; i < childAllData.length; i++) {
	    	var childs = {};
	    	childs.detailRow=detailRowNumber;
	    	childs.sn = childAllData[i].sn;
	    	childs.guid = childAllData[i].guid;
	    	childs.goodName = childAllData[i].goodName;
	    	childs.vol = childAllData[i].vol;
	    	childs.gwt= childAllData[i].gwt;
	    	childs.qty = childAllData[i].qty;
	    	child.push(childs);
	    }
	}
}
</script>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<link id="CustomTheme" type="text/css" rel="stylesheet" href="../../Resource/css/index/customLightBlue.css" />
	<link id="EasyuiTheme" type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/easyuiLightBlue.css" />
	<link id="JqgridTheme" type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/icon.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/moment/css/daterangepicker.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/fileUpload/css/fileUpload.css" />
	<title>付款计划</title>
</head>
<body>
<div id="toolbar" class="easyui-panel" style="padding:4px;border-width:0;border-bottom-width:1px;">
	#{PAGE_TOOLBAR_BUTTONROLE}
</div>
<div class="searchParamesPanel">
	<table id="searchParamesTable">
		<tr class="searchParamesTrShow">
			<td class="searchParamesTdTitle">
				起运时间:
			</td>
			<td class="searchParamesTdControl">
				<input type="text" name="begin_date_start" id="begin_date_start" class="easyui-datebox" style="width: 100px" />
			</td>
			<td class="searchParamesTdTitle">
				-
			</td>
			<td class="searchParamesTdControl">
				<input type="text" name="begin_date_end" id="begin_date_end" class="easyui-datebox" style="width: 100px" />
			</td>
			<td width="20px;"></td>
			<td class="searchParamesTdTitle">
				起运地
			</td>
			<td class="searchParamesTdControl">
				<input type="text" name="begin_city" id="begin_city" class="easyui-combobox" style="width: 100px" />
			</td>
			<td width="20px;"></td>
			<td class="searchParamesTdTitle">状态:</td>
			<td class="searchParamesTdControl">
				<input type="text" name="state" id="state" class="easyui-combobox"/>
			</td>
			<td width="20px;"></td>
			<td class="searchParamesTdTitle">类型:</td>
			<td class="searchParamesTdControl">
				<input type="text" name="type" id="type" class="easyui-combobox"/>
			</td>
		</tr>
		<tr class="searchParamesTrShow">
			<td class="searchParamesTdTitle">
				收车时间:
			</td>
			<td class="searchParamesTdControl">
				<input type="text" name="end_date_start" id="end_date_start" class="easyui-datebox" style="width: 100px" />
			</td>
			<td class="searchParamesTdTitle">
				-
			</td>
			<td class="searchParamesTdControl">
				<input type="text" name="end_date_end" id="end_date_end" class="easyui-datebox" style="width: 100px" />
			</td>
			<td width="20px;"></td>
			<td class="searchParamesTdTitle">
				目的地
			</td>
			<td class="searchParamesTdControl">
				<input type="text" name="end_city" id="end_city" class="easyui-combobox" style="width: 100px" />
			</td>
			<td width="20px;"></td>
			<td class="searchParamesTdTitle">
				承运商:
			</td>
			<td class="searchParamesTdControl">
				<input type="text" name="carrier_no" id="carrier_no" class="easyui-combobox" />
			</td>
			<td width="20px;"></td>
			<td class="searchParamesTdTitle">付款类型:</td>
			<td class="searchParamesTdControl">
				<input type="text" name="data_type" id="data_type" class="easyui-combobox"/>
			</td>
			<td class="searchParamesTdControl">
				<input type="text" id="common_sheet_title" class="easyui-textbox" style="width: 240px" />
			</td>
		</tr>
	</table>
</div>
<div id="gridControl">
	<table id="gridTable"></table>
	<div id="gridPager"></div>
</div>
<div id="fileUpload" style="position: absolute; left: 50%; top: 50%;width: 600px; height: 400px; margin-left: -300px; margin-top: -200px; display: none;"></div>
<form id="formExportFile" class="formExportFile" target="_blank" action="../../dz/payplan/exportData" method="post" style="display: none">
    <input type="text" id="id" name="id" value="" />
</form>

<form id="sumFormExportFile" class="sumFormExportFile" target="_blank" action="../../dz/payplan/paysheet" method="post" style="display: none">
	<input type="text" id="sum_id" name="id" value="" />
</form>
<script type="text/javascript" src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonControl.js"></script>
<script type="text/javascript" src="../../Resource/js/base/globalVariable.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonBusiness.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/jquery.jqGrid.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
<script type="text/javascript" src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../../Resource/js/moment/js/moment.min.js"></script>
<script type="text/javascript" src="../../Resource/js/moment/js/jquery.daterangepicker.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/upload.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/file.js"></script>
<script language="javascript" type="text/javascript">
	$(function() {
		var parms = getUrlParms();
		initScript();
		initData();
		initStyle();
	});

	$(window).load(function() {
		hideLoading();
	});

	var initStyle = function() {
        $("#common_sheet_title").textbox({
            prompt: 'VIN/运单号/结算号/发票号'
        });
		enterTriggerEvent('searchParamesTable', 'searchData');
	};

	var initScript = function() {


		$(window).resize(function() {
			setGridHeightWidth();
			setToolbarHeightWidth();
		});
	};

	// 加载数据
	var initData = function() {
		getDictionaryData([{
			//初始化结算状态数据字典
			dicTypeCode: Global_DicType.baobiao_payplan_state,
			ADD_ALL: true,
			callback: function (callbackData) {
				window.JS_STATEMap = {};
				for (var i = 0; i < callbackData.length; i++) {
					JS_STATEMap[callbackData[i].dicvalue] = callbackData[i].dictext;
				}
				$("#state").combobox({
					valueField: 'dicvalue',
					textField: 'dictext',
					panelHeight: 150,
					editable: true,
                    onSelect:function(){
                        searchData();
                    }
				});
				$("#state").combobox("loadData", callbackData);
			}
		},
		{
				dicTypeCode: Global_DicType.baobiao_payplan_type,
				ADD_ALL: true,
				callback: function (callbackData) {
					window.baobiao_payplan_typeMap = {};
					for (var i = 0; i < callbackData.length; i++) {
						baobiao_payplan_typeMap[callbackData[i].dicvalue] = callbackData[i].dictext;
					}
                    $("#type").combobox({
                        valueField: 'dicvalue',
                        textField: 'dictext',
                        panelHeight: 120,
                        editable: true,
                        onSelect:function(){
                            searchData();
                        }
                    });
                    $("#type").combobox("loadData", callbackData);
				}
		},
		{
				dicTypeCode: Global_DicType.baobiao_payplan_data_type,
				ADD_ALL: true,
				callback: function (callbackData) {
					window.JS_DATA_TYPEMap = {};
					for (var i = 0; i < callbackData.length; i++) {
						JS_DATA_TYPEMap[callbackData[i].dicvalue] = callbackData[i].dictext;
					}
                    $("#data_type").combobox({
                        valueField: 'dicvalue',
                        textField: 'dictext',
                        panelHeight: 120,
                        editable: true,
                        onSelect:function(){
                            searchData();
                        }
                    });
                    $("#data_type").combobox("loadData", callbackData);
				}
		}, {
				//起运地 - 数据字典
				dicTypeCode: Global_DicType.CITY_ARCHIVE,
				ADD_ALL: true,
				callback: function (callbackData) {
					window.BEGIN_ADDRESSMap = {};
					window.END_ADDRESSMap = {};
					for (var i = 0; i < callbackData.length; i++) {
						BEGIN_ADDRESSMap[callbackData[i].dicvalue] = callbackData[i].dictext;
						END_ADDRESSMap[callbackData[i].dicvalue] = callbackData[i].dictext;
					}
					$("#begin_city,#end_city").combobox({
						valueField: 'dicvalue',
						textField: 'dictext',
						panelHeight: 200,
						editable: true,
                        onSelect:function(){
                            searchData();
                        }
					});
					$("#begin_city,#end_city").combobox("loadData", callbackData);
				}
			}
		]);

        getBaseData([{
            //初始化承运商档案
            dicTypeCode : Global_BaseDataKey.ZD_CARRIER,
            callback : function(callbackData) {
                $("#carrier_no").combobox({
                    valueField: 'code',
                    textField: 'name',
                    panelWidth: 250,
                    panelHeight: 150,
                    editable: true,
                    onSelect:function () {
                        searchData();
                    }
                });
                callbackData.unshift({code: "", name: "所有"});
                $("#carrier_no").combobox("loadData", callbackData);
            }
        }]);

		loadList();// 加载数据列表
	};

	// 查询数据
	function searchData() {
		$('#gridTable').jqGrid('setGridParam', {
			url: getSearchGridUrl(),
			datatype: 'json',
			postData: { 'filters': '' },
			page: 1
		}).trigger('reloadGrid');
	};

	// 获取查询URL
	var getSearchGridUrl = function() {
		return '../../dz/payplan/getListForGrid?t=' + Math.random() + '&customSearchFilters=' + encodeURI(getSearchFilters());
	};
	// 获取查询条件
	var getSearchFilters = function() {
        var end_date_end=$('#end_date_end').datebox('getValue');
        if(end_date_end!="")
            end_date_end=addDate(end_date_end,1);
        var begin_date_end=$('#begin_date_end').datebox('getValue');
        if(begin_date_end!="")
            begin_date_end=addDate(begin_date_end,1);
		var parmsArray = [
            [
                { name: 'vdr_no', value: $('#common_sheet_title').textbox('getValue'), op: 'cn' },
                { name: 'vin', value: $('#common_sheet_title').textbox('getValue'), op: 'cn' },
                { name: 'js_no', value: $('#common_sheet_title').textbox('getValue'), op: 'cn' },
                { name: 'invoice_no', value: $('#common_sheet_title').textbox('getValue'), op: 'cn' }
            ],
            { name: 'carrier_no', value: $('#carrier_no').combobox('getValue'), op: 'eq' },
            { name: 'receipt_date', value: $('#end_date_start').datebox('getValue'), op: 'ge'},
            { name: 'receipt_date', value: end_date_end, op: 'le'},
            { name: 'begin_date', value: $('#begin_date_start').datebox('getValue'), op: 'ge'},
            { name: 'begin_date', value: begin_date_end, op: 'le'},
			{ name: 'begin_address', value: $('#begin_city').combobox('getValue'), op: 'eq'},
			{ name: 'end_address', value: $('#end_city').combobox('getValue'), op: 'eq'},
            { name: 'type', value: $('#type').combobox('getValue'), op: 'eq' },
            { name: 'data_type', value: $('#data_type').combobox('getValue'), op: 'eq' },
            { name: 'state', value: $('#state').combobox('getValue'), op: 'eq' }
		];
		return formatSearchParames(parmsArray);
	};

	// 加载数据列表
	var loadList = function() {
		$('#gridTable').jqGrid({
			url: getSearchGridUrl(),
			datatype: 'json',
			width: 'none',
			colNames: [
				"id"/*id*/
				,"类型"/*type*/
				,"状态"/*state*/
				,"付款类型"/*data_type*/
				,"付款申请"/*pay_apply*/
				,"承运商编号"/*carrier_no*/
				,"承运商名称"/*carrier_name*/
				,"合同号"/*contract_no*/
				,"发票号"/*invoice_no*/
				,"交接单号"/*handover_no*/
				,"VIN码"/*vin*/
				,"发运单号"/*vdr_no*/
				,"经销商名称"/*dealer_name*/
				,"发运时间"/*begin_date*/
				,"收车时间"/*receipt_date*/
				,"收单日期"/*receipt_sheet_date*/
				,"运输方式"/*trans_mode*/
				,"起点"/*begin_address*/
				,"终点"/*end_address*/
				,"运输车型"/*car_type*/
				,"承运数量"/*chengyun_qty*/
				,"对下单价"/*down_price*/
				,"开票金额含税"/*tax_amount*/
				,"开票金额不含税"/*not_tax_amount*/
				,"发票税率"/*invoice_tax*/
				,"合同价含税"/*tax_ht_amount*/
				,"合同价不含税"/*not_tax_ht_amount*/
				,"差额含税"/*tax_difference*/
				,"差额不含税"/*not_tax_difference*/
				,"结算号"/*js_no*/
				,"vin_id"/*vin_id*/
				,"备注"/*remark*/
				,"操作人"/*operator_by*/
				,"操作时间"/*operator_date*/
			],
			colModel:[
						{ name: "id", index: "id", /**/ align: "left", sorttype: "string", search: false, sortable: false, width: 40, frozen: false, hidden: true },
						{ name:  "type", index:  "type",/*类型*/ align: "center", isSort: false, width: 70, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]}
							,formatter:function(value,grid,rows)
							{
								return window.baobiao_payplan_typeMap[rows.type];
							}
						},
						{ name:  "state", index:  "state",/*状态*/ align: "center", isSort: false, width: 60, type: "string", search: true, frozen: false, searchoptions: { sopt: ["eq"]}
							,formatter:function(value,grid,rows)
							{
								return window.JS_STATEMap[rows.state];
							}
						},
						{ name:  "data_type", index:  "data_type",/*数据类型*/ align: "center", isSort: false, width: 60, type: "string", search: true, frozen: false, searchoptions: { sopt: ["eq"]}
							,formatter:function(value,grid,rows)
							{
								return window.JS_DATA_TYPEMap[rows.data_type];
							}
						},
						{ name:  "pay_apply", index:  "pay_apply",/*付款申请*/ align: "center", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },

						{ name:  "carrier_no", index:  "carrier_no",/*承运商编号*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "carrier_name", index:  "carrier_name",/*承运商名称*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "contract_no", index:  "contract_no",/*合同号*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "invoice_no", index:  "invoice_no",/*发票号*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "handover_no", index:  "handover_no",/*交接单号*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "vin", index:  "vin",/*vin码*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "vdr_no", index:  "vdr_no",/*发运单号*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "dealer_name", index:  "dealer_name",/*经销商名称*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "begin_date", index:  "begin_date",/*发运时间*/ align: "left", isSort: false, width: 120, type: "string", search: true, frozen: false, searchoptions: { sopt: ["eq"]} },
						{ name:  "receipt_date", index:  "receipt_date",/*收车时间*/ align: "left", isSort: false, width: 120, type: "string", search: true, frozen: false, searchoptions: { sopt: ["eq"]} },
						{ name:  "receipt_sheet_date", index:  "receipt_sheet_date",/*收单日期*/ align: "left", isSort: false, width: 120, type: "string", search: true, frozen: false, searchoptions: { sopt: ["eq"]} },
						{ name:  "trans_mode", index:  "trans_mode",/*运输方式*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "begin_address", index:  "begin_address",/*起点*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "end_address", index:  "end_address",/*终点*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "car_type", index:  "car_type",/*运输车型*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "chengyun_qty", index:  "chengyun_qty",/*承运数量*/ align: "right", isSort: false, width: 80, type: "string", search: true, frozen: false, searchoptions: { sopt: ["eq"]} },
						{ name:  "down_price", index:  "down_price",/*对下单价*/ align: "right", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "tax_amount", index:  "tax_amount",/*开票金额含税*/ align: "right", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "not_tax_amount", index:  "not_tax_amount",/*开票金额不含税*/ align: "right", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "invoice_tax", index:  "invoice_tax",/*发票税率*/ align: "right", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]}
							,formatter:function(value,grid,rows)
							{
								if(rows.invoice_tax!=null){
									return (rows.invoice_tax*100) +"%";
								}
								else {
									return "";
								}
							}
						},
						{ name:  "tax_ht_amount", index:  "tax_ht_amount",/*合同价含税*/ align: "right", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "not_tax_ht_amount", index:  "not_tax_ht_amount",/*合同价不含税*/ align: "right", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "tax_difference", index:  "tax_difference",/*差额含税*/ align: "right", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "not_tax_difference", index:  "not_tax_difference",/*差额不含税*/ align: "right", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "js_no", index:  "js_no",/*结算号*/ align: "center", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "vin_id", index:  "vin_id",/*结算ID*/ align: "center", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]},hidden : true },
						{ name:  "remark", index:  "remark",/*备注*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "operator_by", index:  "operator_by",/*操作人*/ align: "left", isSort: false, width: 100, type: "string", search: true, frozen: false, searchoptions: { sopt: ["cn", "eq", "ne"]} },
						{ name:  "operator_date", index:  "operator_date",/*操作时间*/ align: "left", isSort: false, width: 120, type: "string", search: true, frozen: false, searchoptions: { sopt: ["eq"]} }
			],
			shrinkToFit: false,
			altRows: true,
			altclass: 'gridSpacingClass',
			forceFit: true,
			cellLayout: 0,
			scroll: false,
			autowidth: true,
			sortname: 'id',
			sortorder: 'desc',
			loadonce: false,
			mtype: 'POST',
			viewrecords: true,
			rownumbers: true,
			multiselect: true,
			rowNum: 15,
			height: '100%',
			rowList: [15, 20, 30, 50],
			pager: '#gridPager',
			jsonReader: {
				root: 'rows',
				total: 'total',
				page: 'page',
				records: 'records',
				repeatitems: false
			},
			gridComplete: function() {
				$('.cbox').shiftSelect();
			},
			loadComplete: function(xhr) {
				FailResultDataToTip(xhr);
			}
		});
		$('#gridTable').jqGrid('navGrid', '#gridPager',{
			add : false,
			edit : false,
			del : false,
			refresh : true
		}, {}, {}, {}, {
			multipleSearch : true,
			closeOnEscape : true,
			closeAfterSearch : true
		});
		$('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
			caption : '设置列',
			title : 'Set Columns',
			onClickButton : toggleGridColumns
		});
		$('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
			caption : '快速搜索',
			title : 'Quick Search',
			onClickButton : toggleGridSearchToolbar
		});
		$('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
			caption: '导出数据',
			title: 'Export Datas',
			buttonicon: 'ui-icon-disk',
			onClickButton: function () {
				exportData();
			}
		});
		setGridHeightWidth();
	};

	//LTJ:2019-07-22
	function GetSelArrrow()
	{
		var selectRowItems = $("#gridTable").jqGrid("getGridParam", "selarrrow");
		if (selectRowItems.length == 0) {
			errorNotification({
				SimpleMessage : "请至少选择一行数据行进行操作。"
			});
			return null;
		}
		return selectRowItems;
	}
	function GetSelDataList(selectRowItems,stateStr)
	{
		var dataList="";
		var dataList_error="";
		for(var i=0;i<selectRowItems.length;i++)
		{
			var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
			if(rowData.state!=stateStr){
				dataList_error+=rowData.vin+",";
			}else{
				dataList+=rowData.id+",";
			}
		}
		if (dataList_error != "") {
			errorNotification({
				SimpleMessage : "选中数据不是“"+stateStr+"”状态；VIN码:"+dataList_error
			});
			return null;
		}
		dataList=dataList.substring(0,dataList.length-1);
		return dataList;
	}

	function check_data_type(selectRowItems)
	{
		var dataList_error="";
		for(var i=0;i<selectRowItems.length;i++)
		{
			var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
			if(rowData.data_type=="冲预付"){
				dataList_error+=(i+1).toString()+",";
			}
		}
		if (dataList_error != "") {
			errorNotification({
				SimpleMessage : "选中“数据类型”不能是冲预付；选中行:"+dataList_error
			});
			return false;
		}
		return true;
	}

	//提报
	function tibiao()
	{
		var selectRowItems = GetSelArrrow();
		if(selectRowItems==null)
			return;

		if(!check_data_type(selectRowItems))
			return;

		var dataList=GetSelDataList(selectRowItems,"正常");
		if(dataList==null)
			return;

		data_check(dataList,"2");
	}
	//审核
	function check()
	{
		var selectRowItems = GetSelArrrow();
		if(selectRowItems==null)
			return;
		if(!check_data_type(selectRowItems))
			return;

		var dataList=GetSelDataList(selectRowItems,"已提报");
		if(dataList==null)
			return;
		data_check(dataList,"3");
	}
	//撤回
	function uncheck()
	{
		var selectRowItems = GetSelArrrow();
		if(selectRowItems==null)
			return;
		var dataList="";
		var dataList_error="";
		for(var i=0;i<selectRowItems.length;i++)
		{
			var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
			if(rowData.state!="已提报" && rowData.state!="已完成"){
				dataList_error+=rowData.vin+",";
			}else{
				dataList+=rowData.id+",";
			}
		}
		if (dataList_error != "") {
			errorNotification({
				SimpleMessage : "选中数据不是“已提报”或“已完成”状态；VIN码:"+dataList_error
			});
			return null;
		}
		data_check(dataList,"0");
	}

	//提交数据
	function data_check(data,state){
		var confirmStr="";
		var simpleMessage="";
		if(state=='2'){
			confirmStr='确认提报选中数据吗?';
			simpleMessage="提报数据成功";
		}else if(state=='3'){
			confirmStr='确认审核选中数据吗?';
			simpleMessage="审核数据成功";
		}else  if(state=='1' || state=='0'){
			confirmStr="确认撤回选中数据吗?";
			simpleMessage="撤回数据成功";
		}

		$.messager.confirm('提示', confirmStr , function (r) {
			if (r) {
				showLoading();
				$.ajax({
					url :"../../dz/payplan/data_check?t=" + Math.random(),
					type:"POST",
					contentType:'application/json;charset=utf-8',
					data:JSON.stringify({"id":encodeURI(data),"state":state}),
					success : function(dataObj){
						hideLoading();
						if (isServerResultDataPass(dataObj)) {
							correctNotification({
								SimpleMessage : simpleMessage
							});
							searchData();
						} else {
							FailResultDataToTip(dataObj);
						}
					}
				});
			}
		});
	}

    //导出
    function exportData()
    {
        var selectRowItems = GetSelArrrow();
        if(selectRowItems==null)
            return;
        var data="";
        for(var i=0;i<selectRowItems.length;i++)
        {
            var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
            data+=rowData.id+",";
        }
		data=data.substring(0,data.length-1);
        $.messager.confirm('提示', "确认导出选中数据吗？" , function (r) {
            if (r) {
                $("#formExportFile #id").val(data);
                $("#formExportFile").submit();
            }
        });
    }


    //生成付款申请单
    function paysheet()
	{
		var selectRowItems = GetSelArrrow();
		if(selectRowItems==null)
			return;
		var errorString="";
		//是否 同一个数据类型
		var data_type="";
		for(var i=0;i<selectRowItems.length;i++) {
			var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
			if (data_type == "") {
				data_type = rowData.data_type;
			}
			else {
				if (data_type != rowData.data_type) {
					errorString=(i+1)+",";
				}
			}
		}
		if(errorString!="")
		{
			errorNotification({
				SimpleMessage : "选中“数据类型”列不是同一种值。"
			});
			return;
		}
		//是否 同一个承运商
		var carrier_no="";
		for(var i=0;i<selectRowItems.length;i++) {
			var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
			if (carrier_no == "") {
				carrier_no = rowData.carrier_no;
			}
			else {
				if (carrier_no != rowData.carrier_no) {
					errorString=(i+1)+",";
				}
			}
		}
		if(errorString!="")
		{
			errorNotification({
				SimpleMessage : "选中“承运商编号”列不是同一种值。"
			});
			return;
		}
		//是否 同一个付款申请 = N
		var pay_apply="N";
		for(var i=0;i<selectRowItems.length;i++) {
			var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
			if (pay_apply != rowData.pay_apply) {
				errorString = (i + 1) + ",";
			}
		}
		if(errorString!="")
		{
			errorNotification({
				SimpleMessage : "选中数据“付款申请”列需要全部为N"
			});
			return;
		}

		var data="";
		for(var i=0;i<selectRowItems.length;i++)
		{
			var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
			data+=rowData.id+",";
		}
		data=data.substring(0,data.length-1);
		$.messager.confirm('提示', "确认生成付款申请单吗？" , function (r) {
			if (r) {
				$("#sum_id").val(data);
				$("#sumFormExportFile").submit();
			}
		});
	}


</script>
</body>
</html>

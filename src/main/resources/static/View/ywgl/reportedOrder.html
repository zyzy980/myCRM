<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
   <link id="CustomTheme" type="text/css" rel="stylesheet" href="../../Resource/css/index/customLightBlue.css" />
    <link id="EasyuiTheme" type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/easyuiLightBlue.css" />    
    <link id="JqgridTheme" type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/icon.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/moment/css/daterangepicker.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/fileUpload/css/fileUpload.css" />
    <link type="text/css" rel="stylesheet" href="css/tyle.css"/>
    <title></title>
</head>
<body>
      <div id="toolbar" class="easyui-panel" style="padding: 4px; border-width: 0; border-bottom-width: 1px;">
       #{PAGE_TOOLBAR_BUTTONROLE}
    </div>
    <div class="searchParamesPanel">
        <table id="searchParamesTable">
          <tr class="searchParamesTrShow">
            <td class="editRequiredTitle"><label data-locale="timeAndStop"/>：</td>
         	<td class="editControl">
     			<input name="beginTime" id="beginTime" class="easyui-datebox" data-options="editable:false" style="width:114px;"/>
       		</td>
       		<td class="editRequiredTitle" style="text-align:center">-</td>
         	<td class="editControl">
             	<input  name="endTime" id="endTime" class="easyui-datebox" data-options="editable:false" style="width:114px;" />
       		</td>
       		<td class="editRequiredTitle"><label data-locale="startAddress"/>：</td>
            <td class="editControl in_cityDiv">
            	<input class="easyui-textbox" style="width:114px;" name="tipinputbegin" id="tipinputbegin"/>
<!--                 <input name="beginLocalAddress" id="tipinputbegin" class="easyui-combobox" style="width:114px;"data-options="panelWidth:'114'" /> -->
            </td>
            <td class="editRequiredTitle"><label data-locale="StopAddress"/>：</td>
            <td class="editControl in_cityDiv">
            	<input class="easyui-textbox" type="input" name="tipinputend" id="tipinputend" style="width:114px;"/>
<!--                 <input name="endLocalAddress" data-options="panelWidth:'114'"  id="tipinputend" class="easyui-combobox" style="width:114px;"/>    -->
            </td>
            <!--<td class="searchParamesTdTitle"><label data-locale="businessAddress"/></td>
       		<td>
       			<input class="easyui-combobox"  name="ywLocation" id="ywLocation" style="width:114px;" data-options="panelWidth:'114'"/>
       		</td>-->
       	</tr>
       	<tr>
       		<td class="searchParamesTdTitle"><label data-locale="orderNumber"/>：</td>
       		<td>
       			<input  type="text" name="ywId" id="ywId" class="easyui-textbox" style="width:114px;" />
       		</td>
       		<td class="searchParamesTdTitle"><label data-locale="costomer"/>：</td>
       		<td>
       			<input  name="cusNo" id="cusNo" class="easyui-combobox" data-options="panelWidth:'114'" style="width:114px;"/>
            </td>
            <td class="searchParamesTdTitle"><label data-locale="state"/>：</td>
       		<td>
       			<input name="searchState" id="searchState" class="easyui-combobox" data-options="panelWidth:'114',multiple:true" style="width:114px;"/>
            </td>
          </tr>
        </table>
    </div>
    <div id="in_city" style="display: none"></div>
    <div id="gridControl">
        <table id="gridTable">
        </table>
        <div id="gridPager">
        </div>
    </div>
    <div id="fileUpload" style="position: absolute; left: 50%; top: 50%; width: 600px;
        height: 400px; margin-left: -300px; margin-top: -200px; display: none;">
    </div>
    <form id="formExportFile" target="_blank"  method="post" style="display: none">
    </form>
    <script type="text/javasctipt" src="../../Resource/js/base/cityTemplate.js"></script>
<script type="text/javascript"	src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyuiExtend.min.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonControl.js"></script>
<script type="text/javascript" src="../../Resource/js/base/globalVariable.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonBusiness.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/jquery.jqGrid.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/upload.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/file.js"></script>
<script type="text/javascript" src="../../Resource/js/cookie/jquery.cookie.js"></script>
<!-- <script type="text/javascript" src="API/AMap/js/maps.js"></script>
 --><script language="javascript" type="text/javascript">
    var moduleId = 0;
    var globalStateArray=null; // 全局状态变量
	var nowDate = new Date();
    var cusInnerHtml = {};
    var stateInnerHtml = {};
    var mostlyGuid = null;
    var cityInnerHtml = [];
    var transportTypeInnerHtml = [];
	var stateTextObj = {
   	    '0':"开立中",
   	    '1':$.i18n.prop('toExamine'),
   		'2': $.i18n.prop('dispatched'),
   		'3':$.i18n.prop('transportation'), 
   		'4':$.i18n.prop('transportationCompletion'),
   		'5':$.i18n.prop('alreadyWrittenOff'),
   		'6':$.i18n.prop('halfwayOff')
   };
   var stateValueObj = {
   		'开立中':"0",
   	    $.i18n.prop('toExamine'):"1",
   		$.i18n.prop('dispatched'):"2",
   		$.i18n.prop('transportation'):"3", 
   		$.i18n.prop('transportationCompletion'):"4",
   		$.i18n.prop('alreadyWrittenOff'):"5",
   		$.i18n.prop('halfwayOff'):"6"
   };
   var weituoTypeTextObj = {
		   '0' : "整车",
		   '1' : "零担"
   };
   var weituoTypeValueObj = {
		   '整车':"0",
		   '零担':"1"
   }
   var getStateTextObj = [];
   var getStateValueObj = [];
   var payStateTextObj = [];
   var payStateValueObj = [];
    $(function() {
        var parms = getUrlParms();
        moduleId = parms['moduleId'];
        var planExecVO = {};
        var sn = null;
        var trainno = null;
        getPayState();
        getState();
//         loadAddress();
		loadCitySelector();
        // loadYwLocation();
        loadTransportType();
        initScript();
        iniCodekeyDown();
        initData();
        
    });

    /* $(window).load(function() { hideLoading(); });

     var initStyle = function() {
        enterTriggerEvent('searchParamesTable', 'searchData');
    }; */
   
    //设置table样式
    var initScript = function() {
    	var v = 0;
    	$(window).resize(function() {
    		if (v == 0) {
    			setTimeout(function() { setGridHeightWidth(); v = 0; }, 200)
    			v = 1;
    		}
    		setGridHeightWidth();
    		setToolbarHeightWidth();
    	});	
    };
    var oldSetGridHeightWidth = setGridHeightWidth;
    var setGridHeightWidth = function() {
    	oldSetGridHeightWidth(40,190);
    	oldSetGridHeightWidth(5, 148);
    };
    
    var initData = function() {
        loadState();
    	loadList();

    };
    
    var defaultTime = function(){
    	$("#beginTime").datebox("setValue",nowDate.toLocaleDateString());
    	$("#endTime").datebox("setValue",nowDate.toLocaleDateString());
    }
	// 查询数据
    function searchData() {
        $('#gridTable').jqGrid('setGridParam', {
        	url : getSearchGridUrl(),
        	datatype : 'json',
        	postData : { 'filters' : '' },
        	page : 1
        }).trigger('reloadGrid');
    }
	
	var loadState = function() {
		$.ajax({
	   		url : "../../sysInfo/dictionary/getstate?t=" + Math.random(),
	   		type : "POST",
	   		async : false,
            data : "tableName=" + "sheet_yw_sale_detail_state",
	   		success : function(dataObj){
	   			var data = dataObj.resultDataFull;
	   			data.unshift({ dicText : '--所有--', dicValue : ''});
					data.forEach(function(item){
						stateInnerHtml[item.dicValue] = item.dicText;
						stateTextObj[item.dicValue] = item.dicText;
						stateValueObj[item.dicText] = item.dicValue;
					});
					
					$("#searchState").combobox({
						valueField : 'dicValue',
						textField : 'dicText',
						multiple : true,
						labelSeparator : ',',
						displaySeparator : ',',
						valueSeparator : ',',
						loader : function(params, success, error) {
							success(data);
							$("#searchState").combobox("setValue", '0');
						},
						formatter : function(row) {
							var opts = $(this).combobox("options");
							return '<input type="checkbox" class="combobox-checkbox">' + row[opts.textField];
						},
						onLoadSuccess : function() {
							$("#searchState").combobox("setValue", '');
							var opts = $(this).combobox("options");
							var target = this;
							var values = $(target).combobox("getValues");
							$.map(values, function(value) {
								var el = opts.finder.getEl(target,value);
								el.find('input.combobox-checkbox')._propAttr("checked", true);
							})
						},
						onSelect : function(row) {
							var opts = $(this).combobox('options');
							$("#searchState").val($(this).combobox("getValues"));
							
							var comboList = $(this).combobox("getValues");
							var comboText = $(this).combobox("getText").split(",");
							var newComboList = [];
							if (comboList != null && comboList != undefined) {
								for(var i = 0 ; i < comboList.length ; i ++){
									var code = comboList[i];
									if(code == "") {
										var el = opts.finder.getEl(this,code);
									    el.find('input.combobox-checkbox')._propAttr('checked', false);
									}
								}
								for (var i = 0; i < comboList.length; i++) {
									if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
										newComboList.push(comboList[i]);
									} else {
										if (i != 0) {
											var selectData = $(this).combobox("getData");
											for(var i = 0 ; i < selectData.length; i++) {
												var code = selectData[i].dicValue;
												if(code != '') {
													var el = opts.finder.getEl(this, code);  
						                            el.find('input.combobox-checkbox')._propAttr('checked', false);
												}
											}
											newComboList = [ "" ];
											break;
										} 
									}
								}
							}
							if (newComboList.length <= 0) {
								newComboList = [ "" ];
							}
							$(this).combobox('setValues', newComboList);
							var el = opts.finder.getEl(this, row[opts.valueField]);
			                el.find('input.combobox-checkbox')._propAttr('checked', true);
							searchData();
							
						},
						onUnselect : function(row){
							var opts = $(this).combobox('options');
							$(this).val($(this).combobox("getValues"));
							
							var comboList = $(this).combobox("getValues");
							var comboText = $(this).combobox("getText").split(",");
							var newComboList = [];
							if (comboList != null && comboList != undefined) {
								for (var i = 0; i < comboList.length; i++) {
									if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
										newComboList.push(comboList[i]);
									} else {
										if (i != 0) {
											newComboList = [ "" ];
											
											break;
										}
									}
								}
							}
							if (newComboList.length <= 0) {
								newComboList = [ "" ];
							}
							$(this).combobox('setValues', newComboList);
							var el = opts.finder.getEl(this, row[opts.valueField]);
			                el.find('input.combobox-checkbox')._propAttr('checked', false);
			                searchData();
						}
					});
	   		}
	   	});
	}
	
	var comboChange = function(){
    	var comboList = $(this).combobox("getValues");
        var comboText = $(this).combobox("getText").split(",");
        var newComboList = [];
        if(comboList!=null && comboList!=undefined){
      	  for(var i = 0 ; i < comboList.length ; i++){
      		  if(comboList[i].indexOf("--")==-1 && comboList[i]!=""){
    		  	newComboList.push(comboList[i]);  
      		  } else {
      			  if(i!=0){
      				  newComboList = [""];
      				  break;
      			  }
      		  }
      	  }
        }
        if(newComboList.length<=0){
        	newComboList = [""];
        }
        $(this).combobox('setValues', newComboList);
        searchData();
    }
	
	function isInArray(arr,value){
	    for(var i = 0; i < arr.length; i++){
	        if(value === arr[i].lifnr){
	            return true;
	        }
	    }
	    return false;
	}

	 var defaultSelect = function (){
    	 $(this).combobox("setValue", $.i18n.prop('all'));
    }
	// 获取查询访问路径
    var getSearchGridUrl = function() {
        return '../../order/findZeroOrder?t=' + Math.random() + '&customSearchFilters=' + encodeURI(getSearchFilters());
    };

    
 	// 获取查询条件
    var getSearchFilters = function() {
 		//客户
    	var cusNo = $('#cusNo').combobox('getValue');
 		if (cusNo==$.i18n.prop('all')) {
			cusNo="";
		}
 		//运单号
 		var ywId = $("#ywId").val();
 		/*//业务地点
 		var ywLocation = $("#ywLocation").combobox("getValues");
 		if(ywLocation == $.i18n.prop('all')) {
 			ywLocation = "";
 		}*/
 		
 		//地点
 		var beginCity = $("#tipinputbegin").textbox('getValue');
 		if(beginCity == "所有") {
 			beginCity = "";
 		}
 		
 		var endCity = $("#tipinputend").textbox('getValue');
 		if(endCity == "所有") {
 			endCity = "";
 		}

 		//状态
    	var searchState = $("#searchState").combobox('getValues');
    	if (searchState == $.i18n.prop('all')) {
    		searchState="";
		}
    	
    	var ywId = $("#ywId").val();
    	
        var plan_begin_date = "";
    	var plan_end_date = "";
    		plan_begin_date = $.trim($("#beginTime").textbox("getText"));// + " 00:00:00";
        	plan_end_date = $.trim($("#endTime").textbox("getText"));// + " 23:59:59";
		var parmsArray = [
		{ name: 'm.cus_no', value: cusNo, op: "cn" },
		{ name: 'm.business_yw_id', value: ywId, op: "cn" },
		{ name: 'm.state', value: searchState, op : "eq"},
		// { name: 'm.yw_location', value: ywLocation, op : "eq"},
		{ name: 'zl.begin_local_city', value: beginCity, op : "cn"},
		{ name: 'zl.end_local_city', value: endCity, op : "cn"},
		{ name: 'm.create_date', value: plan_begin_date,op : "ge" },
		{ name: 'm.create_date', value: plan_end_date,op: "le" }
        ];
        return formatSearchParames(parmsArray);
    };
	//新增
    var add = function(){
    	 showLoading($.i18n.prop('order_detail'));
         var href = "../View/ywgl/zeroOrderList.html";
         openDialog({ title: /* 委托明细列表 */$.i18n.prop('order_detail_table'), id: 'orderDetailTable', width: $(window.top).width() * 0.9, height: 650, isResize: true, href: href, closable: true ,align: 'center'});
    }
   //查询
   var search= function (){
	   searchData();
   }
 
    // 保存
    var save = function() {
    	planExecVO = FormUtils.toJSONObject($("#addForm"));
    	/* if(planExecVO.sn==null||planExecVO.sn==undefined||planExecVO.sn==""){
    		insert();
    	}else{
    		planExecVO.sn = sn;
    		edit();
    	} */
    	if ($("#state").val()==null || $("#state").val()=="") {
    		insert();
		}else {
    		edit();
		}
    };
	
    var afterSaveOperate = function () {
        switch (afterSave) {
            case "edit":
			code = $("#code").textbox("getValue");
			refreshCallerData();
			//openDetail(code);
			break;
            case "close":
                refreshCallerData();
                close();
                break;
            case "clear":
                $('form').form('clear');
                $("#sn").val("0");
                $("input", $("#code").next("span")).removeAttr("readonly");
                refreshCallerData();
                break;
            case "copy":
                $("#sn").val("0");
                $("input", $("#code").next("span")).removeAttr("readonly");
                $("#code").textbox('setValue', '');
                refreshCallerData();
                break;
        }
    }

   /*  var refreshCallerData_zdTruckType = function () {
        searchData();
    } */
    
	// 加载列表数据
    var loadList = function() {
        $('#gridTable').jqGrid({
            url : getSearchGridUrl(),
            datatype : 'json',
            width : 'none',
            colNames : [
            	$.i18n.prop('state'),$.i18n.prop('sn'),$.i18n.prop('guid'),$.i18n.prop('createBy'),$.i18n.prop('createDate'),$.i18n.prop('updateBy'),$.i18n.prop('withinCode'),
            	$.i18n.prop('updateDate'),$.i18n.prop('cusNo'),$.i18n.prop('cusNo'),'订单号',$.i18n.prop('businessType'),$.i18n.prop('businessYwId'),
            	$.i18n.prop('businessDate'),$.i18n.prop('planshipmentData'), $.i18n.prop('shipmentData'), $.i18n.prop('planjiaofuData'),$.i18n.prop('jiaofuData'), 
            	'起运城市','目的城市','线路',$.i18n.prop('nextLocalCode'),$.i18n.prop('contractorCode'),
            	$.i18n.prop('contractorName'),'#{vol} /m³','#{gwt} /KG','#{qty} /件',$.i18n.prop('weituoType'),$.i18n.prop('transportTypePlan'),
            	$.i18n.prop('transportTypeActual'),$.i18n.prop('isAbnormal'),$.i18n.prop('isDelay'),$.i18n.prop('currentLocalLng'),$.i18n.prop('currentLocalLat'),
            	$.i18n.prop('currentLocalDate'),$.i18n.prop('currentLocalAddr'),$.i18n.prop('getState'),$.i18n.prop('payState'),
            	$.i18n.prop('getMode'),$.i18n.prop('payMode'),$.i18n.prop('shoukuan'),$.i18n.prop('fukuan'),$.i18n.prop('ywLocation'),
            	$.i18n.prop('existDetailChild'),$.i18n.prop('existMultipleTruck')
            ],
            colModel : [
            	{ name: 'state', index: 'm.state',align: 'center', sorttype: 'string', stype: 'select', search: true, width: 40,
            		formatter : function(value, grid, rows){
	           			return stateTextObj[value];
            		},
            		searchoptions : { value : stateInnerHtml, sopt : ['cn', 'eq', 'ne']} 
            	},
                { name: 'sn', index: 'm.sn',  key: true,align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
                { name: 'guid', index: 'm.guid',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
                { name : 'createBy', index: 'm.create_by',  align : 'center', width: 40, sorttype: 'string', search: true, sortable : false, hidden: true },
            	{ name : 'createDate', index: "to_char(m.create_date,'yyyy-mm-dd')", align : 'center', width: 70, stype: 'text',search: true, hidden: true,
                	searchoptions: {
            			dataInit: function(elem){
	            			jQuery(elem).click(function(){
	            				WdatePicker({
	            					onpicked:function(){jQuery(elem).change();searchData()},
	            					onclearing:function(){jQuery(elem).val("");searchData();}
	            				});
	            			});
            			},attr:{title:'Select Date'},sopt:['cn']
           			},
           			formatter:'date',
           			formatoptions:{srcformat:'Y-m-d',newformat:'Y-m-d'},
           		},
            	{ name : 'updateBy', index: 'm.update_by', align : 'center', sorttype: 'string', width: 40,search: true, sortable : false,hidden: true },
            	{ name: 'withinCode', index: 'm.within_code',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'updateDate', index: "to_char(m.update_date,'yyyy-mm-dd')",  align: 'center', stype: 'text', sorttype: 'string', search: true, sortable: false, width: 80, hidden: true, 
            		searchoptions: {
            			dataInit: function(elem){
	            			jQuery(elem).click(function(){
	            				WdatePicker({
	            					onpicked:function(){jQuery(elem).change();searchData()},
	            					onclearing:function(){jQuery(elem).val("");searchData();}
	            				});
	            			});
            			},attr:{title:'Select Date'},sopt:['cn']
           			},
           			formatter:'date',
           			formatoptions:{srcformat:'Y-m-d',newformat:'Y-m-d'},
            	},
            	{ name : 'cusName', index : 'm.cus_no', align : 'center', isSort : false,search : true, width: 150, stype: 'select',  type : 'string', searchoptions : { value : cusInnerHtml, sopt : ['cn', 'eq', 'ne']} },
            	{ name : 'cusNo', index : 'm.cus_no', align : 'center', isSort : false,search : true, width: 100, stype: 'select',hidden: true,  type : 'string', searchoptions : { value : cusInnerHtml, sopt : ['cn', 'eq', 'ne']} },
            	{ name : 'ywId', index : 'm.yw_id', align : 'center', isSort : false,search : true, type : 'string', width: 100, searchoptions : { sopt : ['cn', 'eq', 'ne']}},
            	{ name : 'businessType', index : 'm.business_type', align : 'center', isSort : false,search : true, type : 'string', searchoptions : { sopt : ['cn', 'eq', 'ne']},hidden: true},
            	{ name: 'businessYwId', index: 'm.business_yw_id',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 120},
            	{ name: 'businessDate', index: "to_char(m.business_data,'yyyy-mm-dd')",  align: 'center', stype: 'text', sorttype: 'string', search: true, sortable: false, width: 80,
            		searchoptions: {
            			dataInit: function(elem){
	            			jQuery(elem).click(function(){
	            				WdatePicker({
	            					onpicked:function(){jQuery(elem).change();searchData()},
	            					onclearing:function(){jQuery(elem).val("");searchData();}
	            				});
	            			});
            			},attr:{title:'Select Date'},sopt:['cn']
           			},
           			formatter:'date',
           			formatoptions:{srcformat:'Y-m-d',newformat:'Y-m-d'},
            	},
            	{ name : 'planshipmentData', index : "to_char(m.planshipment_data,'yyyy-mm-dd')", align : 'center', width : 120, search : true,type : 'string', stype: 'text', hidden: false,
            		searchoptions: {
            			dataInit: function(elem){
	            			jQuery(elem).click(function(){
	            				WdatePicker({
	            					onpicked:function(){jQuery(elem).change();searchData()},
	            					onclearing:function(){jQuery(elem).val("");searchData();}
	            				});
	            			});
            			},attr:{title:'Select Date'},sopt:['cn']
           			},
           			formatter:'date',
           			formatoptions:{srcformat:'Y-m-d',newformat:'Y-m-d'},	
            	},
	            { name : 'shipmentData', index : "to_char(m.shipment_data,'yyyy-mm-dd')", align : 'center', width : 80, stype : 'text', search : true,hidden: true,
            		searchoptions: {
            			dataInit: function(elem){
	            			jQuery(elem).click(function(){
	            				WdatePicker({
	            					onpicked:function(){jQuery(elem).change();searchData()},
	            					onclearing:function(){jQuery(elem).val("");searchData();}
	            				});
	            			});
            			},attr:{title:'Select Date'},sopt:['cn']
           			},
           			formatter:'date',
           			formatoptions:{srcformat:'Y-m-d',newformat:'Y-m-d'},	
	            },
            	{ name : 'planjiaofuData', index : "to_char(m.planjiaofu_data,'yyyy-mm-dd')", align : 'center', width : 100, search : true,stype : 'text', hidden: true,
	            	searchoptions: {
            			dataInit: function(elem){
	            			jQuery(elem).click(function(){
	            				WdatePicker({
	            					onpicked:function(){jQuery(elem).change();searchData()},
	            					onclearing:function(){jQuery(elem).val("");searchData();}
	            				});
	            			});
            			},attr:{title:'Select Date'},sopt:['cn']
           			},
           			formatter:'date',
           			formatoptions:{srcformat:'Y-m-d',newformat:'Y-m-d'},
            	},
            	{ name: 'jiaofuData', index: "to_char(m.jiaofu_data,'yyyy-mm-dd')",  align: 'center', sorttype: 'string',stype: 'text', search: true, sortable: false, width: 40, hidden: true, 
            		searchoptions: {
            			dataInit: function(elem){
	            			jQuery(elem).click(function(){
	            				WdatePicker({
	            					onpicked:function(){jQuery(elem).change();searchData()},
	            					onclearing:function(){jQuery(elem).val("");searchData();}
	            				});
	            			});
            			},attr:{title:'Select Date'},sopt:['cn']
           			},
           			formatter:'date',
           			formatoptions:{srcformat:'Y-m-d',newformat:'Y-m-d'},
            	},
            	{ name : 'beginLocalCity', index : 'zl.begin_local_city', align : 'center', isSort : false,width: 120, search : true,type : 'string', stype: 'select',
            		searchoptions : { 
            			value : cityInnerHtml, sopt : ['eq']
            		}
            	},
            	{ name: 'endLocalCity', index: 'zl.end_local_city', align: 'center', sorttype: 'string',width: 120, search: true, sortable: false, type: 'string', stype: 'select',
            		searchoptions : {
            			value : cityInnerHtml, sopt : ['eq']
            		}	
            	},
                { name: 'routeCode', index: 'm.route_code', align: 'center', sorttype: 'string', width: 120, search: false, sortable: false, type: 'string'},
            	{ name: 'nextLocalCode', index: 'm.next_local_code',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'contractorCode', index: 'm.contractor_code',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'contractorName', index: 'm.contractor_name',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'vol', index: 'm.vol', align: 'center', sorttype: 'string', search: true, sortable: false, width: 60},
            	{ name: 'gwt', index: 'm.gwt',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 60},
            	{ name: 'qty', index: 'm.qty',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 60},
            	{ name: 'weituoType', index: 'm.weituoT_type',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true,
            		formatter : function(value, grid, rows){
	           			return weituoTypeTextObj[value];
            		},
            	},
            	{ name: 'transportTypePlan', index: 'm.transport_type_plan',  align: 'center', sorttype: 'string', search: true, sortable: false,width: 100,stype: 'select',
            		formatter : function(value,grid,rows) {
            			switch(value){
            			case "0":
            				return $.i18n.prop('Steam transportation');
            			case "1":
                			return $.i18n.prop('Express');
            			case "2":
                			return $.i18n.prop('Railway transportation');
            			case "3":
                			return $.i18n.prop('waterway');
            			case "4":
                			return $.i18n.prop('Intermodal transport');
            			}
            		},
            		searchoptions : {
            			value : transportTypeInnerHtml , sopt : ['eq']
            		}
            	},
            	{ name: 'transportTypeActual', index: 'm.transport_type-actual', align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'currentLocalAddr', index: 'm.current_local_addr',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'isDelay', index: 'm.isdelay', align: 'center', sorttype: 'string', search: true, sortable: true, width: 40, hidden: true },
            	{ name: 'currentLocalLng', index: 'm.current_local_lng',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'currentLocalLat', index: 'm.current_local_lat',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'currentLocalDate', index: 'm.current_local_late',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'isabnormal', index: 'm.isabnormal',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'getState', index: 'm.get_state',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 70,
            		formatter : function(value,grid,rows) {
            			return getStateTextObj[value];
            		}	
            	},
            	{ name: 'payState', index: 'm.pay_state',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 70,
            		formatter : function(value,grid, rows) {
            			return  payStateTextObj[value];
            		}	
            	},
            	{ name: 'getMode', index: 'm.get_mode',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 60,hidden: true},
            	{ name: 'payMode', index: 'm.pay_mode',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 60,hidden: true},
            	{ name: 'shoukuan', index: 'm.shoukuan',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 80, hidden: true },
            	{ name: 'fukuan', index: 'm.fukuan',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 80, hidden: true },
            	{ name: 'ywLocation', index: 'm.yw_location',  align: 'center', sorttype: 'string', search: true, sortable: false,hidden: true},
            	{ name: 'existDetailChild', index: 'm.exist_detail_child',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true },
            	{ name: 'existMultipleTruck', index: 'm.exist_multiple_truck',  align: 'center', sorttype: 'string', search: true, sortable: false, width: 40, hidden: true }
            	
            ],
            shrinkToFit: false,
            altRows: true,
            altclass: 'gridSpacingClass',
            forceFit: true,
            cellLayout: 0,
            scroll: false,
            autoScroll: true, 
            autowidth: true,
            sortname: 'm.sn',
            sortorder: "desc",
            loadonce: false,
            mtype: "POST",
            viewrecords: true,
            rownumbers: true,
            multiselect: true,
            subGrid : true,
            rowNum: 15,
            height: "100%",
            rowList: [100, 200, 300, 500],
            pager: "#gridPager",
            jsonReader: {
                root: "rows",
                total: "total",
                page: "page",
                records: "records",
                repeatitems: false
            },
            gridComplete: function () {
                $(".cbox").shiftSelect();
            },
            ondblClickRow: function (code) {
            	var rowData = $("#gridTable").jqGrid('getRowData', code);
            	console.log(rowData);
            	var state = rowData.state = stateValueObj[rowData.state];
                openDetail(rowData.guid,state,rowData.ywId,rowData.cusName,rowData.cusNo,rowData.ywLocation);
            },
            loadComplete: function (xhr) {
                $('.gridViewPicLink').tooltip({
                    position: 'bottom',
                    content: $(this).attr("title"),
                    onShow: function () {
                        $(this).tooltip('tip').css({
                            backgroundColor: '#FCF8E3',
                            borderColor: '#FAEBCC'
                        });
                    }
                });
                FailResultDataToTip(xhr);
                hideLoading();
            },
            subGridRowExpanded : function(subgrid_id,row_id) {
            	var rowData = $("#gridTable").jqGrid('getRowData',row_id);
            	mostlyGuid = rowData.guid;
            	var subgrid_table_id = subgrid_id + "_t";
            	var subgrid_paper_id = subgrid_id + "_pgr";
            	$("#"+subgrid_id).html("<table id='"+subgrid_table_id+"' class='scroll'></table><div id='"+subgrid_paper_id+"' class='scroll'></div>");
            	
            	$("#" + subgrid_table_id).jqGrid({
            		 url : getSearchGridUrlChild(),
	       	         datatype : 'json',
	       	         colNames : [
	       	        	$.i18n.prop('sn'),$.i18n.prop('guid'),$.i18n.prop('withinCode'),$.i18n.prop('createBy'),$.i18n.prop('createDate'),
	       	         	$.i18n.prop('updateBy'),$.i18n.prop('updateDate'),$.i18n.prop('goodsDetail'),$.i18n.prop('goodsName'),$.i18n.prop('mostlyGuid'),
	       	         	$.i18n.prop('unit'),'#{vol} /m³', '#{gwt} /KG', '#{qty} /件'
	       	         ],
	       	         colModel : [
	       	            { name : 'sn', index: 'o.sn', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40 , hidden: true },
	       	            { name : 'guid', index: 'o.guid',  align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
	       	            { name : 'withinCode', index: 'o.within_Code',  align : 'center', sorttype: 'string', sortable : false,hidden: true},
	       	         	{ name : 'createBy', index: 'o.create_By', align : 'center', sorttype: 'string',sortable : false,hidden: true},
	       	         	{ name : 'createDate', index: 'o.CREATE_DATE',  align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
	       	         	{ name : 'updateBy', index: 'o.UPDATE_BY',  align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
	       	         	{ name : 'updateDate', index : 'o.UPDATE_DATE', align : 'center', isSort : false,search : true, type : 'string',hidden: true},
	       				{ name : 'contId',width: 150, index : 'o.cont_id', search: false, sortable: false, editable:false, align: 'center',},
	       	         	{ name : 'goodsName', index : 'o.goods_name', editable: true, align: 'center',  width: 100},
	       	         	{ name : 'mostlyGuid', index : 'o.MOSTLY_GUID', align : 'center', isSort : false,search : true, type : 'string', hidden: true },
	       	         	{ name : 'unit', index : 'o.UNIT', editable: true, align: 'center',  width: 80},
	       	         	{ name : 'vol', index : 'o.VOL', editable: true,  align: 'center',  width: 80},
	       		        { name : 'gwt', index : 'o.GWT', editable: true,  align: 'center',  width: 80},
	       		        { name : 'qty', index : 'o.qty', editable: true,  align: 'center', width: 80}
	       	         ],
	       	         jsonReader : {
	       	        	 root : "rows",
	       	        	 records : "record",
	       	        	 repeatitems : false
	       	         },
	       	         prmNames : {search : "search"},
	       	         paper : subgrid_paper_id,
		       	     height: "100%",  
		             rowNum: 5,
            	});
            }
        });

        $("#gridTable").jqGrid('navGrid', '#gridPager', { add: false, edit: false, del: false, refresh: true }, {}, {}, {}, { multipleSearch: true, closeOnEscape: true, closeAfterSearch: true });
        $("#gridTable").jqGrid('navButtonAdd', '#gridPager', {
            caption: /* "设置列" */$.i18n.prop('order_set column'),
            title: "Reorder Columns",
            onClickButton: toggleGridColumns
        });

        $("#gridTable").jqGrid('navButtonAdd', '#gridPager', {
            caption: /* "快捷搜索" */$.i18n.prop('order_quick search'),
            title: "",
            onClickButton: toggleGridSearchToolbar
        });
        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
       		caption: $.i18n.prop('order_Export data'),// 导出数据
            title: 'Export Datas',
            buttonicon: 'ui-icon-disk',
            onClickButton: function() {
          		ExportToExcel.call(this, { title:$.i18n.prop('all.vehicle.depute')});
            }
        });
        setGridHeightWidth();
    };
    //跳转明细页面
    var openDetail = function (guid,state,ywId,cusName,cusNo,ywLocation) {
        showLoading($.i18n.prop('order_detail'));
        var href = "../View/ywgl/zeroOrderList.html?mostly_guid=" + guid + "&state="+state + "&ywId="+ywId + "&cusNo=" + cusNo + "&cusName=" + cusName + "&ywLocation=" + ywLocation;
        openDialog({ title: /* 委托明细列表 */$.i18n.prop('order_detail_table'), id: 'orderDetailTable', width: $(window.top).width() * 0.9, height: 650, isResize: true, href: href, closable: true});
    }
    
    var getSearchGridUrlChild = function() {
        return '../../order/findOrderDetial?t=' + Math.random() + '&customSearchFilters=' + encodeURI(getSearchFiltersChild()) + "&mostlyGuid=" + mostlyGuid;
    };
    
    var getSearchFiltersChild = function() {
    	var parmsArray = [
		{ 
		  	name: 'o.mostly_guid', value: mostlyGuid, op: "eq" }
        ];
        return formatSearchParames(parmsArray);
    };
    
   
    
 

	    	var time = function(date){
				$("[name=planBeginDate]").val(date);
			}
	    	
	    	// var ywlocation = $.cookie("OSUN_whcenter");
	    	// function loadYwLocation(){
	    	// 	$.ajax({
	    	// 		url : '../../bussiness/planExec/getywlocation?t=' + Math.random(),
	    	// 		type : 'POST',
	    	// 		async : false,
	    	// 		success : function(data){
	    	// 			var data = data.resultDataFull;
	    	// 			data.unshift({CODE:'','NAME':$.i18n.prop('all')});
	    	// 			$("#ywLocation").combobox({
	    	//     			valueField : "CODE",
	    	//     			textField : "NAME",
	    	//     			multiple : true,
	    	//     			labelSeparator : ',',
	    	// 				displaySeparator : ',',
	    	// 				valueSeparator : ',',
	    	// 				loader : function(params,success,error){
	    	// 					var cookLocation = ywlocation.split(",");
	    	// 					var dataLocation = [];
	    	// 					for(var i = 0 ; i < cookLocation.length; i++) {
	    	// 						for(var j = 0 ; j < data.length; j++) {
	    	// 							if(cookLocation[i] == data[j].CODE) {
	    	// 								dataLocation[i] = data[j];
	    	// 							}
	    	// 						}
	    	// 					}
	    	// 					dataLocation.unshift({'CODE': '', 'NAME': $.i18n.prop('all')});
	    	// 					success(dataLocation);
	    	// 				},
	    	//     			onLoadSuccess : function(){
	    	//     				var currentYwLocation = ywlocation.split(",");
	    	//     				if(currentYwLocation.length == 1) {
	    	//     					$("#ywLocation").combobox("select",currentYwLocation[0]);
	    	//     				} else {
	    	//     					$("#ywLocation").combobox("select","");
	    	//     				}
	    	//     				var opts = $(this).combobox("options");
	    	// 					var target = this;
	    	// 					var values = $(target).combobox("getValues");
	    	// 					$.map(values, function(value) {
	    	// 						var el = opts.finder.getEl(target,value);
	    	// 						el.find('input.combobox-checkbox')._propAttr("checked", true);
	    	// 					});
	    	//     			},
	    	//     			formatter : function(row) {
	    	//     				var opts = $(this).combobox("options");
	    	//     				return '<input type="checkbox" class="combobox-checkbox">' + row[opts.textField];
	    	//     			},
	    	//     			onSelect : function(row) {
	    	//     				var opts = $(this).combobox('options');
	    	// 					$(this).combobox("getValues");
	    	//
	    	// 					var comboList = $(this).combobox("getValues");
	    	// 					var comboText = $(this).combobox("getText").split(",");
	    	// 					var newComboList = [];
	    	// 					if (comboList != null && comboList != undefined) {
	    	// 						for(var i = 0 ; i < comboList.length ; i ++){
	    	// 							var code = comboList[i];
	    	// 							if(code == "") {
	    	// 								var el = opts.finder.getEl(this,code);
	    	// 							    el.find('input.combobox-checkbox')._propAttr('checked', false);
	    	// 							}
	    	// 						}
	    	// 						for (var i = 0; i < comboList.length; i++) {
	    	// 							if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
	    	// 								newComboList.push(comboList[i]);
	    	// 							} else {
	    	// 								if (i != 0) {
	    	// 									var selectData = $(this).combobox("getData");
	    	// 									for(var i = 0 ; i < selectData.length; i++) {
	    	// 										var code = selectData[i].CODE;
	    	// 										if(code != '') {
	    	// 											var el = opts.finder.getEl(this, code);
	    	// 				                            el.find('input.combobox-checkbox')._propAttr('checked', false);
	    	// 										}
	    	// 									}
	    	// 									newComboList = [ "" ];
	    	// 									break;
	    	// 								}
	    	// 							}
	    	// 						}
	    	// 					}
	    	// 					if (newComboList.length <= 0) {
	    	// 						newComboList = [ "" ];
	    	// 					}
	    	// 					$(this).combobox('setValues', newComboList);
	    	// 					var el = opts.finder.getEl(this, row[opts.valueField]);
	    	//                     el.find('input.combobox-checkbox')._propAttr('checked', true);
	    	// 					searchData();
	    	//     			},
	    	//     			onUnselect : function(row){
	    	// 					var opts = $(this).combobox('options');
	    	// 					$(this).val($(this).combobox("getValues"));
	    	//
	    	// 					var comboList = $(this).combobox("getValues");
	    	// 					var comboText = $(this).combobox("getText").split(",");
	    	// 					var newComboList = [];
	    	// 					if (comboList != null && comboList != undefined) {
	    	// 						for (var i = 0; i < comboList.length; i++) {
	    	// 							if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
	    	// 								newComboList.push(comboList[i]);
	    	// 							} else {
	    	// 								if (i != 0) {
	    	// 									newComboList = [ "" ];
	    	//
	    	// 									break;
	    	// 								}
	    	// 							}
	    	// 						}
	    	// 					}
	    	// 					if (newComboList.length <= 0) {
	    	// 						newComboList = [ "" ];
	    	// 					}
	    	// 					$(this).combobox('setValues', newComboList);
	    	// 					var el = opts.finder.getEl(this, row[opts.valueField]);
	    	//                     el.find('input.combobox-checkbox')._propAttr('checked', false);
	    	// 					searchData();
	    	// 				}
	    	// 			});
	    	//
	    	// 		}
	    	// 	});
	    	// }
    
   	    	$("#cusNo").combobox({
   	    		valueField : "code",
   	    		textField : "name",
   	    		loader:function(param,success,error){  
   	                $.ajax({  
   	                    url:"../../ztgl/detailinroad/getcus?t=" + Math.random(),
   	                    dataType: 'json',  
   	                    method:"POST",
   	                    async : false,
   	                    success: function(data){
   	                    	var data = data.resultDataFull;
   	                    	cusInnerHtml = {'': $.i18n.prop('all') };
    	                   	data.unshift({code:'','name':$.i18n.prop('all')});
    	                   	data.forEach(function(item){
    	                   		cusInnerHtml[item.code] = item.name;
    	                    });
   	                    	success(data); 
   	                    } 
   	                }); 
   	            },
   	            onChange:searchData
   	    	});
	       	    	
   	 var edit = function () {
   	        var selectRowItems = $("#gridTable").jqGrid("getGridParam", "selarrrow");
   	        if (selectRowItems.length > 1 || selectRowItems.length == 0) {
   	            errorNotification({
   	                SimpleMessage: /* "请选择一行数据行进行操作" */$.i18n.prop('trucktype_selectrow')
   	            });
   	            return;
   	        }
   	       var rowData = $("#gridTable").jqGrid('getRowData', selectRowItems);
   	       sn1= rowData.sn;
   	       var state = rowData.state = stateValueObj[rowData.state];
   	        openDetail(rowData.guid,state,rowData.businessYwId,rowData.cusName,rowData.cusNo,rowData.ywLocation);
   	  }
   	 
  	  var remove = function() {
  	       	var selectRowItems = $("#gridTable").jqGrid("getGridParam", "selarrrow");
  	       	if (selectRowItems.length == 0) {
  	       		errorNotification({
  	       			SimpleMessage : /* "请至少选择一行数据行进行操作" */$.i18n.prop('trucktype_selectrow')
  	       		});
  	       		return;
  	       	}
  	      var jsonData = [];
  	       	for ( var i = 0; i < selectRowItems.length; i++) {
  	       		var rowData = $("#gridTable").jqGrid('getRowData',selectRowItems[i]);
  	       	jsonData.push(rowData.guid);
  	       	
  	       	}
  	       	$.messager.confirm(/* '提示','确定删除选中的数据项吗?' */$.i18n.prop('roder_alert'),$.i18n.prop('is_delete'),function(r) {
  	   					if (r) {
  	   						showLoading($.i18n.prop('roderDetele'));
  	   						$.ajax({
  	   						        	url : "../../order/deleteAllMostly?t="+ Math.random(),
	  	   						       data : JSON.stringify(jsonData), 
										type : "POST",
										contentType : 'application/json;charset=utf-8',
  	   									success : function(dataObj) {
  	   										if (isServerResultDataPass(dataObj)) {
  	   											correctNotification(dataObj.resultDataFull);
  	   											searchData(); // 删除时需要重新搜索
  	   										} else {
  	   											FailResultDataToTip(dataObj);
  	   										}
  	   										hideLoading();
  	   									},
  	   									error : function(message) {
  	   										console.log(message);
  	   										hideLoading();
  	   									}
  	   								});
  	   					}
  	   				});
  	   }
  	  
  	  
   var loadTransportMode5 = function () {
    	$("#transport_mode5").combobox({
    		  valueField: 'code',
    		  textField: 'values1',
    		  loader:function(param,success,error){
                $.ajax({
                    url:"../../scts/basic/findDictionaryByType?type=orderState_TMS&t=" + Math.random(),
                    dataType: 'json',
                    method:"GET",
                    async : false,
                    success: function(data){
                    	data.forEach(function(item){
                    		transportModeInnerHTML[item.code] = item.code;
                      	 });
                    	data.unshift({code:'',values1:$.i18n.prop('all')});
                    	success(data); //loader的success
                    } 
                });
            },
    		onLoadSuccess: comboDefault,
            onChange : searchData
    	});
    }
  	
    var comboDefault = function(){
    	$(this).combobox("setValue", $.i18n.prop('all'));
    }
    
    $("#beginTime").datebox({
    	onChange: function(date){
    		if (date == "") {
		       $("#beginTime").datebox('setValue','')
		       searchData();
			}else{
		       searchData();
			}
    	},
    	onSelect : function(beginDate) {
    		$("#endTime").datebox().datebox("calendar").calendar({
    			validator : function(endDate) {
    				return beginDate <= endDate;
    			}
    		})
    	}
    });
    
    $("#endTime").datebox({
    	onChange : function(date) {
    		if(date == "") {
    			$("#endTime").datebox('setValue','')
    			searchData();
    		} else {
    			searchData();
    		}
    	}
    });
    
    function loadAddress(){
    	$("#tipinputbegin,#tipinputend").combobox({
    		valueField : 'code',
    		textField : 'name',
    		loader : function(param,success,error) {
    			$.ajax({
    				url : '../../order/getlocation?t=' + Math.random(),
    				dataType : 'json',
    				method : 'POST',
    				async : false,
    				success : function(data){
    					var supArr = [];
    					supArr.unshift({code : '', name : $.i18n.prop('all')});
    					cityInnerHtml = {'' : $.i18n.prop('all')};
    					data.resultDataFull.forEach(function(item){
	    					supArr.push({code : item.city,name : (item.cityZjm + "-" + item.city)});
	    					cityInnerHtml[item.city] = item.cityZjm + "-" + item.city;
    					});
    					success(supArr);
    					$("#tipinputbegin,#tipinputend").combobox('setValue',"");
    				}
    			});
    		},
    		onChange : searchData
    	});
    }
    
    var iniCodekeyDown = function() {
    	
    }
    
    function addTrainno(){
    	var selectRowItems = $('#gridTable').jqGrid('getGridParam', 'selarrrow');
    	if(selectRowItems.length == 0) {
    		errorNotification({ SimpleMessage : "没有选择数据，无法操作!"});
    		return;
    	}
    	var ywIdList = [];
    	for(var i = 0 ; i < selectRowItems.length; i++) {
    		var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
    		ywIdList.push(rowData.ywId);
    	}
    	var href = "../View/ywgl/trainsPlanDetailByAdd.html?ywId=" + ywIdList;
	    showLoading("#{supplier.loading}...");
	    createNewTab( $.i18n.prop('supplier.page.detail.title'), href );
    }
     
  //加载运输方式 
    function loadTransportType(){
    	$.ajax({
	    	url : "../../sysInfo/dictionaryData/getDictionaryDataList?t=" + Math.random()+"&dicTypeCode=transportType",
	    	method : "GET",
	    	async : false,
	    	success : function(data) {
	    		transportTypeInnerHtml = {'':$.i18n.prop('all')};
	    		data.forEach(function(item){
	    			transportTypeInnerHtml[item.dicValue] = item.dicText;
	    		});
	    	}
    	});
    }
  
  
	var check = function() {
		var selectRowItems = $('#gridTable').jqGrid('getGridParam', 'selarrrow');
		if (selectRowItems.length == 0) {
			errorNotification({SimpleMessage : '请至少选择一行数据行进行操作'});// 请至少选择一行数据行进行操作
			return;
		}
		var rowData = [];
		for (var i = 0; i < selectRowItems.length; i++) {
			var data = $('#gridTable').jqGrid('getRowData', selectRowItems[i]);
			var state = data.state = stateValueObj[data.state];
			if (state != 0) {
				errorNotification({SimpleMessage : '只能审核正常的订单'
				});
				return;
			}
			rowData.push(data);
		}
		$.messager.confirm('提示','确定要审核吗?',function(r) {// 提示, 确定撤回选中的数据项吗
			if (r) {
				showLoading();
				$.ajax({
                    url: '../../order/saleCheck?t=' + Math.random(),
                    type: 'POST',
                    data: 'jsonData=' + JSON.stringify(rowData),
                    success: function(dataObj) {
                    if (isServerResultDataPass(dataObj)) {
                            correctNotification(dataObj.resultDataFull);
                            searchData();
                        } else {
                            FailResultDataToTip(dataObj);
                        }
                        hideLoading();
                    },
                    error : function(message) {
                        hideLoading();
                    }
                })
				/*$.ajax({
					url : '../../order/check?t='+ Math.random(),
					type : 'POST',
					data : "jsonData="+ JSON.stringify(rowData),
					success : function(dataObj) {
					if (isServerResultDataPass(dataObj)) {
						correctNotification(dataObj.resultDataFull);
						searchData();
					} else {
						FailResultDataToTip(dataObj);
					}
						hideLoading();
					},
					error : function(message) {
						hideLoading();
					}
				});*/
			}
		});
	}
	
	var loadCitySelector = function() {
		var city = $(".city_a_le1 a"); //城市
    	var beginCity = $("#tipinputbegin").textbox("textbox");
    	var endCity = $("#tipinputend").textbox("textbox");
    	inCity.width = "345";//城市选择框 宽
    	inCity.height = "auto"; //城市选择框高
    	inCity.id = "#in_city";  //城市选择框  父级ID
        inCity.Children = '.city_a_le1';  //城市名box
        // 初始化 城市HTML模板
        $(inCity.id).prepend(inCity._template.join(''));
        
        inCity.Hot(city);
     	//城市 导航
        var apay = $(".screen a");

        var placeThis; //当前选择标签
        apay.click(function(obj){  //城市导航
            inCity.payment($(this));z
        })

        inCity.place(beginCity); //出发地
        inCity.destination(endCity);  //目的地
        inCity.cityClick(city); //显示赋值城市
	}
	
	var isCheck = function() {
		var selectRowItems = $('#gridTable').jqGrid('getGridParam', 'selarrrow');
		if (selectRowItems.length == 0) {
			errorNotification({SimpleMessage : '请至少选择一行数据行进行操作'});// 请至少选择一行数据行进行操作
			return;
		}
		var rowData = [];
		for (var i = 0; i < selectRowItems.length; i++) {
			var data = $('#gridTable').jqGrid('getRowData', selectRowItems[i]);
			var state = data.state = stateValueObj[data.state];
			if (state != 10) {
				errorNotification({ SimpleMessage : '只能反审核确认的运单' });
				return;
			}
			rowData.push(data);
		}
		$.messager.confirm('提示','确定要反审核吗?',function(r) {// 提示, 确定撤回选中的数据项吗
			if (r) {
				showLoading();
				$.ajax({
                    url: '../../order/saleUnCheck?t=' + Math.random(),
                    type: 'POST',
                    data: 'jsonData=' + JSON.stringify(rowData),
                    success: function(dataObj) {
                        if (isServerResultDataPass(dataObj)) {
                            correctNotification(dataObj.resultDataFull);
                            searchData();
                        } else {
                            FailResultDataToTip(dataObj);
                        }
                        hideLoading();
                    },
                    error : function(message) {
                        hideLoading();
                    }
                })
				/*$.ajax({
					url : '../../order/ischeck?t='+ Math.random(),
					type : 'POST',
					data : "jsonData="+ JSON.stringify(rowData),
					success : function(dataObj) {
					if (isServerResultDataPass(dataObj)) {
						correctNotification(dataObj.resultDataFull);
						searchData();
					} else {
						FailResultDataToTip(dataObj);
					}
						hideLoading();
					},
					error : function(message) {
						hideLoading();
					}
				});*/
			}
		});
	}

	// 获取付款状态
	var getPayState = function() {
        $.ajax({
           url: '../../sysInfo/dictionary/getstate?t=' + Math.random(),
           type: 'POST',
           async: false,
           data: "tableName=" + "sheet_yw_plan_exec_pay_state",
           success: function(dataObj) {
               var data = dataObj.resultDataFull;
               data.forEach(function(item) {
                   payStateTextObj[item.dicValue] = item.dicText;
                   payStateValueObj[item.dicText] = item.dicValue;
               });
           }
        });
    }
    //getStateTextObj getStateValueObj
    // 获取收款状态
    var getState = function() {
        $.ajax({
            url: '../../sysInfo/dictionary/getstate?t=' + Math.random(),
            type: 'POST',
            async: false,
            data: "tableName=" + "sheet_yw_plan_exec_get_state",
            success: function(dataObj) {
                var data = dataObj.resultDataFull;
                data.forEach(function(item) {
                    getStateTextObj[item.dicValue] = item.dicText;
                    getStateValueObj[item.dicText] = item.dicValue;
                });
            }
        });
    }

    var importData = function() {
        //"../../jcda/ZDTruckType/exportzdtruckExcel?t="
        var url = "../../bussiness/planExec/importExcel?t=" + Math.random();
        $("#fileUpload").zyUpload({
            itemWidth: "60px", // 文件项的宽度
            itemHeight: "60px", // 文件项的高度
            url: url,
            multiple: false, // 是否可以多个文件上传
            dragDrop: true, // 是否可以拖动上传文件
            del: true, // 是否可以删除文件
            finishDel: false, // 是否在上传文件完成后删除预览
            close: true,
            fileTypeFilter: ['xls', 'xlsx'],
            remark: "<p>提示：最多导入一千条数据,只能上��xls/xlsx格式文件</p>",
            isDownModuleFile: true,
            downModuleFileUrl: "../../bussiness/planExec/exportOrderExcel?t=" + Math.random(),
            /* 外部获得的回调接口 */
            onSelect: function (files, allFiles) { // 选择文件的回调方法
            },
            onDelete: function (file, surplusFiles) { // 删除一个文件的回调方法
            },
            onSuccess: function (file) { // 文件上传成功的回调方法
            },
            onFailure: function (file) { // 文件上传失败的回调方法
            },
            onComplete: function (responseInfo) { // 上传完成的回调方法
                hideLoading();
                var dataObj = JSON.parse(responseInfo);
                if (isServerResultDataPass(dataObj)) {
                    searchData();
                    hideLoading();
                    correctNotification(dataObj.resultDataFull);
                } else {
                    FailResultDataToTip(dataObj);
                }
                $("#fileUpload").empty();
                $("#fileUpload").hide();
            }
        });
    }
	
</script>
</body>
</html>
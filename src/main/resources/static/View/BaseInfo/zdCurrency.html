<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="UTF-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1"/>
    <link id="CustomTheme" type="text/css" rel="stylesheet" href="../../Resource/css/index/customLightBlue.css" />
    <link id="EasyuiTheme" type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/easyuiLightBlue.css" />    
    <link id="JqgridTheme" type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/icon.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/moment/css/daterangepicker.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/fileUpload/css/fileUpload.css" />
    <title>#{thisPage}</title>
    <style type="text/css">
    .radioSpan {
	      position: relative;
	      border: 1px solid #95B8E7;
	      background-color: #fff;
	      vertical-align: middle;
	      display: inline-block;
	      overflow: hidden;
	      white-space: nowrap;
	      margin: 0;
	      padding: 0;
	      -moz-border-radius: 5px 5px 5px 5px;
	      -webkit-border-radius: 5px 5px 5px 5px;
	      border-radius: 5px 5px 5px 5px;
	      display:block;
	    }
    </style>
</head>
<body>
<div id="tabLocation" class="easyui-tabs">
	<div data-locale-title="title1" id="detailDiv1">
    <div id="toolbar" class="easyui-panel" style="padding: 4px; border-width: 0; border-bottom-width: 1px;">
         #{PAGE_TOOLBAR_BUTTONROLE}
    </div>
   <div class="searchParamesPanel">
        <table id="searchParamesTable">
        	<tr class="searchParamesTrShow">
        		<td class="searchParamesTdTitle">
         			&emsp;<label data-locale="curName"/>:
                </td>
                <td class="searchParamesTdControl" >
               	 <input type="text" name="curName" id="curName" class="easyui-combobox"/>
                </td>
                <td class="searchParamesTdTitle">
                	&emsp;&emsp;<label data-locale="createDate"/>:
                </td>
	         	<td class="searchParamesTdControl">
	             	<input type="text" name="beginDate" id="beginDate" class="easyui-datebox" data-options="editable:false,onSelect:onChangeDate"/>
	         	</td>
	         	<td class="searchParamesTdTitle" style="text-align:center">-</td>
	         	<td class="searchParamesTdControl" >
	             	<input type="text" name="endDate" id="endDate" class="easyui-datebox" data-options="editable:false,onSelect:onChangeDate" />
	         	</td>
        	</tr>
        </table> 
    </div>
    <div id="gridControl">
        <table id="gridTable">
        </table>
        <div id="gridPager">
        </div>
    </div>
		   <div id="editData" class="easyui-dialog" style="padding:5px;width:400px;height:180px;" title="货币档案录入"  data-options="closed:true">
		<form id="addForm" class="easyui-form" method="post">
	    	<table class="editTable">
		         <tr>
		            <td class="editRequiredTitle" >
		                	<label data-locale="curName"/>:
		            </td>
		            <td class="editControl">
		            	<input class="easyui-textbox" id="curName1" name="curName1" style="width: 157px;"/>
		            	<span style="color:red;font-size:16px;text-align:center;">*</span>
		            </td>
		        </tr>
		         <tr>
		            <td class="editRequiredTitle" >
		                	<label data-locale="curCode"/>:
		            </td>
		            <td class="editControl">
		            	<input class="easyui-textbox" id="curCode1" name="curCode1" style="width: 157px;"/>
		            	<span style="color:red;font-size:16px;text-align:center;">*</span>
		            </td>
		        </tr>
		    </table>
		</form>
		<div id="dlg-buttons" style="margin-left:120px;margin-top:20px;">
			<a href="#" class="easyui-linkbutton" iconCls="icon-ok" onclick="javascript:ok()"><label data-locale="ok"/></a>&emsp;&emsp;
			<a href="#" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#editData').dialog('close')"><label data-locale="cancel"/></a>
		</div>
	</div>
	</div>
	<input type = "hidden" id = "sn1"/>
</div>
</body>
<script type="text/javascript"	src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyuiExtend.min.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonControl.js"></script>
<script type="text/javascript" src="../../Resource/js/base/globalVariable.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonBusiness.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/jquery.jqGrid.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/upload.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/file.js"></script>
<script type="text/javascript" src="../../Resource/js/cookie/jquery.cookie.js"></script>
<script language="javascript" src="http://localhost:8000/CLodopfuncs.js"></script>
<script language="javascript" type="text/javascript">
    var lang = "zh";
     
    $(function () {
        var parms = getUrlParms();
        initkeyDown();
        moduleidAuthority = parms["moduleId"];
        lang = parms["lang"];
        loadList();
        hideLoading();
    });
    
    
    //日期搜索
    function onChangeDate(){
    	var createDate = $("#beginDate").datebox('getValue');
    	var endDate = $("#endDate").datebox('getValue');
    	if(createDate>endDate){
    		$("#endDate").textbox("setValue", "");
    	}
   		searchData();
   	}
    
    var initkeyDown = function(){
    	$('#cusName').combobox({
            inputEvents: $.extend({},$.fn.textbox.defaults.inputEvents,{
            	keyup:function(event){
            		if(event.keyCode == 13) {
           				searchData();
            		}
            	},
            	change:function(event){
            		searchData();
                }
         	})
      	})
    }
    
    var oldSetGridHeightWidth = setGridHeightWidth;
    var setGridHeightWidth = function() {
    	oldSetGridHeightWidth(5, 178);
    	oldSetGridHeightWidth(5, 128, "gridTable2");
    }
    
	
    function searchData() {
        $("#gridTable").jqGrid('setGridParam', {
            url: getSearchGridUrl(),
            datatype: 'json',
            postData: getSearchFilters(),
            page: 1
        }).trigger("reloadGrid");
    }

    var getSearchGridUrl = function () {
        return '../../zdCurrency/list?t=' + Math.random();
    }
   
    var getSearchFilters = function () {
    	var beginDate = $("#beginDate").datebox('getText');
    	var endDate = $("#endDate").datebox('getText');
    	var curName = $("#curName").datebox('getText');
    	if(endDate !=null && endDate !=""){
    		endDate = addDate(endDate,1);
    	}
    	if(curName == "" || curName == "--所有--"){
    		curName = null;
    	}
        var parmsArray =
        	 {'beginDate':beginDate,'endDate':endDate,'curName':curName};
        return parmsArray;
    }
    var loadList = function () {
    	 $("#gridTable").jqGrid({
             url: getSearchGridUrl(),
             datatype: "json",
             width: "none",
             colNames: ['','',$.i18n.prop('curName'),$.i18n.prop('curCode'),
                        $.i18n.prop('createDate'),$.i18n.prop('createByName')],
             colModel: [
 				{ name: 'sn', index: 'sn',  key: true,align: 'center', sorttype: 'int', search: false, sortable: false, width: 40, hidden: true },
 				{ name: 'withinCode', index: 'withinCode',  key: true,align: 'center', search: true, sortable: false, width: 140, hidden: true  },
 				{ name: 'curName', index: 'curName',  key: true,align: 'center', search: true, sortable: false, width: 140 },
 				{ name: 'curCode', index: 'curCode',  key: true,align: 'center', search: true, sortable: false, width: 140 },
 	           	{ name: 'createDate', index: "to_char(createDate,'yyyy-mm-dd')", align: 'center', width: 100,type:'string', sorttype: 'string', search: true},
 	           	{ name: 'createByName', index: 'createByName', align: 'center', width: 100,type:'string', sorttype: 'string', search: true}
 
             ],
             datatype:'json',  
             postData:getSearchFilters(),
             shrinkToFit: false,
             altRows: true,
             altclass: 'gridSpacingClass',
             forceFit: true,
             cellLayout: 0,
             scroll: false,
             autowidth: true,
             sortname: 'createDate',
             sortorder: "desc", 
             loadonce: false,
             mtype: "POST",
             viewrecords: true,
             rownumbers: true,
             multiselect: true,
             rowNum: 15,
             height: "100%",
             rowList: [15, 20, 30, 50],
             pager: "#gridPager",
             jsonReader: {
                 root: "rows",
                 total: "total",
                 page: "page",
                 records: "records",
                 repeatitems: false
             },
             gridComplete: function () {
                 $(".cbox").shiftSelect();
             },
             ondblClickRow: function (code) {
 				showTable(code);
             },
             loadComplete: function (xhr) {
                 
             }
         });

         $("#gridTable").jqGrid('navGrid', '#gridPager', { add: false, edit: false, del: false,search: false, refresh: true }, {}, {}, {}, { multipleSearch: true, closeOnEscape: true, closeAfterSearch: true });
         $("#gridTable").jqGrid('navButtonAdd', '#gridPager', {
             caption: $.i18n.prop('costPlan.grid.control.setColumn'),
             title: $.i18n.prop('costPlan.grid.control.setColumn'),
             onClickButton: toggleGridColumns
         });

         $("#gridTable").jqGrid('navButtonAdd', '#gridPager', {
             caption: $.i18n.prop('costPlan.grid.control.quickSearch'),
             title: $.i18n.prop('costPlan.grid.control.quickSearch'),
             onClickButton: toggleGridSearchToolbar
         });
         
         $("#gridTable").jqGrid('navButtonAdd', '#gridPager', {
             caption: $.i18n.prop('costPlan.grid.control.exportData'),
             title: $.i18n.prop('costPlan.grid.control.exportData'),
             buttonicon: "ui-icon-disk",
             onClickButton: function(){
             	ExportToExcel.call(this, {
               		 url : "../../receivables/export?t=" + Math.random() + '&customSearchFilters=' + encodeURI(getSearchFilters())
               	}); 
             }
         });
         setGridHeightWidth();
    }
    
    
    // 日期，在原有日期基础上，增加days天数，默认增加1天
    function addDate(date, days) {
        if (days == undefined || days == '') {
            days = 1;
        }
        var date = new Date(date);
        date.setDate(date.getDate() + days);
        var month = date.getMonth() + 1;
        var day = date.getDate();
        return date.getFullYear() + '-' + getFormatDate(month) + '-' + getFormatDate(day);
    }

    // 日期月份/天的显示，如果是1位数，则在前面加上'0'
    function getFormatDate(arg) {
        if (arg == undefined || arg == '') {
            return '';
        }

        var re = arg + '';
        if (re.length < 2) {
            re = '0' + re;
        }

        return re;
    }
    
    function add(){
    	cleanInput()
    	$('#editData').dialog({closed:false});
    }
    
    function ok(){
    	var curName1 = $("#curName1").textbox('getValue');
    	var curCode1 = $("#curCode1").textbox('getValue');
    	var sn = $("#sn1").val();
    	if(sn == null || sn == ""){
    		var url = "../../zdCurrency/add?t=" + Math.random();
    	}else{
    		var url = "../../zdCurrency/update?t=" + Math.random();
    	}
    	if(curName1 ==null || curName1 == ""){
    		errorNotification({ SimpleMessage : "货币名不能为空"});
			return;
    	}
    	if(curCode1 ==null || curCode1 == ""){
    		errorNotification({ SimpleMessage : "货币代号不能为空"});
			return;
    	}
    	$.messager.confirm($.i18n.prop('info'), $.i18n.prop('save'),function(r){
		    if(r){//点击确认
		    	$.post(url,{'curName':curName1,'curCode':curCode1,'SN':sn},function(data){
		    		if(data.resultCode == "0"){
	            		correctNotification(data.resultDataFull);
    	            	$('#editData').dialog({closed:true});
    	            	searchData()
	            	}else{
	            		errorNotification({ SimpleMessage : data.resultDataFull.simpleMessage});	
	            	}
		    	})
		    }
    	})
    }
    
    function update(){
    	cleanInput()
    	var ids = $('#gridTable').jqGrid('getGridParam','selarrrow');
    	var sn = $('#gridTable').jqGrid('getRowData',ids[0]).sn;
    	$("#sn1").val(sn);
    	if(ids.length>0){
    		$.post("../../zdCurrency/findBySn?t=" + Math.random(),{'SN':sn},function(data){
    			 $("#curName1").textbox("setValue", data.curName);
    			 $("#curCode1").textbox("setValue", data.curCode);
    			 $('#editData').dialog({closed:false});
    		});
    	}else{
    		errorNotification({ SimpleMessage : "请选择数据!"});
			return;
    	}
    }
    
    function del(){
		var selectRowItems = $("#gridTable").jqGrid("getGridParam", "selarrrow");
		if (selectRowItems.length == 0) {
			errorNotification({
				SimpleMessage : "请至少选择一行数据行进行操作"
			});
			return;
		}
		//首先定义一个数组
		var ids = [];
		for (var i = 0; i < selectRowItems.length; i++) {
			var rowData = $("#gridTable").jqGrid('getRowData', selectRowItems[i]);
			ids.push(rowData.sn);
		}
		$.messager.confirm('提示', '确定删除选中的数据项吗?', function(r) {
			if (r) {
				showLoading('正在加载 货币维护...');
				$.ajax({
					url :  "../../zdCurrency/deletes?t=" + Math.random(),
					data : JSON.stringify(ids),
					type : "POST",
					contentType : 'application/json;charset=utf-8',
					success : function(dataObj) {
						if (isServerResultDataPass(dataObj)) {
							correctNotification({ SimpleMessage: "删除成功"});
							searchData();
						} else {
							FailResultDataToTip(dataObj);
						}
						hideLoading();
					}
				});
			}
		});
    }
    
    function onread(){
    	searchData();
    }
    
    function cleanInput(){
    	 $("#sn1").val("");
		 $("#curName1").textbox("setValue", "");
		 $("#curCode1").textbox("setValue", "");
    }
    
	  //加载业务地点 
	var data1 = [];
    $.post('../../zdCurrency/list?t=' + Math.random(),{},function(data){
    	data1=data.rows;
    	$("#curName").combobox({
    		valueField : "SN",
			textField : "curName",
    		onSelect:searchData,
    		data:data1,
    		onLoadSuccess : function(){
			    $('#curName').combobox('setText','--所有--');
			}
    	});
    });
</script>
</html>

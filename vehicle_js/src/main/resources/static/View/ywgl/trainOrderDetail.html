<!DOCTYPE html
	PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<link id="CustomTheme" type="text/css" rel="stylesheet" href="../../Resource/css/index/customLightBlue.css" />
	<link id="EasyuiTheme" type="text/css" rel="stylesheet"
		href="../../Resource/js/easyUI/themes/easyuiLightBlue.css" />
	<link id="JqgridTheme" type="text/css" rel="stylesheet"
		href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/icon.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
	<link type="text/css" rel="stylesheet" href="../../Resource/js/fileUpload/css/fileUpload.css" />
	<link type="text/css" rel="stylesheet" href="../../View/ywgl/css/planExec.css" />
	<style type="text/css">

	</style>
	<title>#{supplier.detail.thisPage}</title>
</head>

<body style="overflow:hidden">
	<!--<div id="orderDetailChild">-->
	<!--<div id="childBtn" style="border-top:1px dotted #c5dbec;border-left:1px dotted #c5dbec;border-right:1px dotted #c5dbec;width:99.5%">-->
	<!--<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-add'" width="15" height="15" onclick="addChild('detailChildTableId')"><label data-locale="addRow"/></a>-->
	<!--<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-save'" onclick="saveChildTable()"><label data-locale="saveDetail"/></a> -->
	<!--<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:''" onclick="addNew()">新增</a>-->
	<!--<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:''" onclick="copy()">复制</a>-->
	<!--<a href="javascript:void(0)" class="easyui-linkbutton" data-options="iconCls:'icon-cancel'" onclick="removn()"><label data-locale="closeTable"/></a>-->
	<!--</div>-->
	<!--<table id="detailChildTableId"></table>-->
	<!---->
	<!--</div>-->
	<div id="toolbar" class="easyui-panel" style="padding: 4px; border-width:0; border-bottom-width:1px;">
		#{PAGE_TOOLBAR_BUTTONROLE}
	</div>
	<input type="hidden" id="sn" name="sn" />
	<form id="detailForm" class="easyui-form" method="post" data-options="novalidate:true">
		<div class="searchParamesPanel">

			<input type="hidden" id="sn" name="sn" />
			<input type="hidden" id="guid" name="guid" />
			<table class="editTable" style="margin-top:0px;">
				<tr>
					<td rowspan="1" style="text-align:center;"><label data-locale="trainOrder_cus"/></td>
					<td class="editTitle">
						<label data-locale="trainOrder_cusNo"/>:
					</td>
					<td class="editControl">
						<input id="cusNo" name="cusNo" class="easyui-combobox" style="width:153px;"
							data-options="panelWidth:'180',editable:false" readonly />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
						<!--     			<span style="color:red;font-size:16px;text-align:center;">*</span>  data-locale-missingmessage="clientCannoBeEmpty"-->
					</td>
					<td class="editTitle">
						<label data-locale="trainOrder_cusDate"/>:
					</td>
					<td class="editControl">
						<input id="businessDate" name="businessDate" class="easyui-datebox" style="width:153px;"
							data-options="panelWidth:'180'" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="traiOrder_cusServiceNumber"/>:
					</td>
					<td class="editControl">
						<input id="businessYwId" name="businessYwId" class="easyui-textbox" style="width:153px;" />
					</td>
				</tr>
				<tr>
					<td rowspan="3" style="text-align:center;"><img src="../../View/ywgl/images/icon2.png" />
						<p>发货</p>
					</td>
					<td class="editTitle">
						<label data-locale="trainOrder_planDeliveryDate"/>:
					</td>
					<td class="editControl">
						<input id="planshipmentData" class="easyui-datetimebox" name="planshipmentData"
							style="width: 153px;" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="trainOrder_shippingContact"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" id="beginLocalMan"
							data-locale-missingmessage="trainOrder_shippingContactCannotBeEmpty" name="beginLocalMan"
							autocomplete="off" style="width: 153px;" data-options="required:true" /><span
							style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="trainOrder_shippingContactNumber"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" id="beginLocalPhone"
							data-locale-missingmessage="trainOrder_shippingContactNumberCannotBeEmpty" name="beginLocalPhone"
							style="width: 153px;" data-options="required:true,validType:'telNum'" /><span
							style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="traiOrder_pointOfOrigin"/>:
					</td>
					<td class="editControl">
						<input name="beginLocalAddressCode" id="historybeginAddress" class="easyui-combobox"
							style="width: 200px;" data-options="panelWidth:'300'" />
						<input name="beginLocalAddress" style="width:198px;height:20px;display:none;"
							id="tipinputbeginAddress" />
						<input name="beginLocalCode" id="beginLocalCode" type="hidden" />
						<input name="isNewBeginAddress" style="display: none;" id="isNewBeginAddress" value="0" />
						<a href="javascript:void(0)" style="color:blue"
							id="newBeginAddress"><label data-locale="traiOrder_theNewAddress"/></a>
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						#{trainOrder_province/city/district}:
					</td>
					<td class="editControl">
						<input id='begin_district' name="beginDistrict" class='easyui-combobox'
							data-locale-missingmessage="trainOrder_beginProvinceCannotBeEmpty" data-options="panelWidth:'180'"
							style='width:100px' />
						<input id='begin_city' name="beginCity" class='easyui-combobox'
							data-locale-missingmessage="trainOrder_beginCityCannotBeEmpty" data-options="panelWidth:'180'"
							style='width:100px' />
						<input id='begin_area' name="beginArea" class='easyui-combobox'
							data-locale-missingmessage="trainOrder_beginDistrcitCannotBeEmpty" data-options="panelWidth:'180'"
							style='width:100px' />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<!--<td class="editTitle" >
            	业务地点:
            </td>
            <td class="editControl">
               	<input class="easyui-combobox" id="ywLocation" name="ywLocation" style="width:153px;"/>
               	<span style="color:red;font-size:16px;text-align:center;">*</span>
            </td>-->
				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="trainOrder_detailOfShip"/>:
					</td>
					<td class="editControl" colspan="2">
						<input class="easyui-textbox" id="beginLocalRemark" name="beginLocalRemark"
							style="width: 80%;" />
					</td>
					<td></td>
					<td class="editTitle"><label data-locale="state"/>:</td>
					<td class="editControl">
						<input class="easyui-textbox" id="state" data-options="editable:false" name="state"
							style="width: 154px;" />
					</td>
				</tr>
				<tr>
					<td rowspan="3" style="text-align:center;"><img src="../../View/ywgl/images/icon3.png" />
						<p>收货</p>
					</td>
					<td class="editTitle">
						<label data-locale="trainOrder_receiptDate"/>:
					</td>
					<td class="editControl">
						<input id="planjiaofuData" class="easyui-datetimebox"
							missingmessage="#{trainOrder_receiptDateCannotBeEmpty{" name="planjiaofuData"
							style="width: 153px;" data-options="required:true" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="trainOrder_receivingContact"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" name="endLocalMan" id="endLocalMan"
							data-locale-missingmessage="trainOrder_receivingContactCannotBeEmpty" autocomplete="off"
							style="width: 153px;" data-options="required:true" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="trainOrder_receivingContactNumber"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" name="endLocalPhone"
							data-options="required:true,validType:'telNum'"
							data-locale-missingmessage="trainOrder_receivingContactNumberConnotBeEmpty" style="width: 153px;"
							id="endLocalPhone" />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="trainOrder_goodsTo"/>:
					</td>
					<td class="editControl">
						<input name="endLocalAddressCode" id="historyendAddress" class="easyui-combobox"
							style="width: 200px;" data-options="panelWidth:'300'" />
						<input name="endLocalAddress" id="tipinputendAddress" autocomplete="off"
							style="width: 198px;height: 20px;display:none;" />
						<input name="endLocalSiteCode" id="endLocalSiteCode" type="hidden" />
						<input name="isNewEndAddress" id="isNewEndAddress" style="display:none;" value="0" />
						<a href="javascript:void(0)" style="color:blue" id="newEndAddress"><label data-locale="traiOrder_theNewAddress"/>
						</a>
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						#{trainOrder_province/city/district}:
					</td>
					<td class="editControl">
						<input id='end_district' name="endDistrict" class='easyui-combobox'
							data-locale-missingmessage="trainOrder_destinationProvince" data-options="panelWidth:'180'"
							style='width:100px' />
						<input id='end_city' name="endCity" class='easyui-combobox'
							data-locale-missingmessage="trainOrder_destinationCity" data-options="panelWidth:'180'"
							style='width:100px' />
						<input id='end_area' name="endArea" class='easyui-combobox'
							data-locale-missingmessage="trainOrder_destinationDistrict" data-options="panelWidth:'180'"
							style='width:100px' />
						<span style="color:red;font-size:16px;text-align:center;">*</span>
					</td>
					<td class="editTitle">
						<label data-locale="trainOrder_theAwb"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" name="ywId" id="ywId" data-options="editable:false"
							style="width:153px" />
					</td>
				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="trainOrder_receivingPlaceDetails"/>:
					</td>
					<td class="editControl" colspan="2">
						<input class="easyui-textbox" id="endLocalRemark" name="endLocalRemark" style="width: 80%" />
					</td>
					<td></td>
				</tr>
				<tr>
					<td style="text-align:center;" rowspan="3"><img src="../../View/ywgl/images/icon4.png" />
						<p>费用</p>
					</td>
					<td class="editTitle">
						<label data-locale="detail.vol"/>:
					</td>
					<td class="editControl">
						<input id="vol" name="vol" class="easyui-textbox" style="width:153px;"
							data-options="editable:false,panelWidth:'180'" />
					</td>
					<td class="editTitle">
						<label data-locale="detail.gwt"/>
					</td>
					<td class="editControl">
						<input id="gwt" name="gwt" class="easyui-textbox" style="width:153px;"
							data-options="editable:false,panelWidth:'180'" />
					</td>
					<td class="editTitle">
						<label data-locale="detail.qty"/>
					</td>
					<td class="editControl">
						<input id="qty" name="qty" class="easyui-textbox" style="width:153px;"
							data-options="editable:false,panelWidth:'180'" />
					</td>
				</tr>
				<tr>
					<td class="editTitle">
						<label data-locale="state"/>:
					</td>
					<td class="editControl">
						<input class="easyui-textbox" id="state" data-options="editable:false" name="state"
							style="width: 154px;" />
					</td>
					<td class="editTitle"></td>
					<td></td>
					<td class="editTitle"></td>
					<td></td>
				</tr>
			</table>

		</div>
	</form>
	<div id="gridControl">
		<table id="gridTableZero"></table>
	</div>
	<script type="text/javascript" src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
	<script type="text/javascript" src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
	<script type="text/javascript" src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
	<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyui.min.js"></script>
	<script type="text/javascript" src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
	<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyuiExtend.min.js"></script>
	<script type="text/javascript" src="../../Resource/js/base/commonControl.js"></script>
	<script type="text/javascript" src="../../Resource/js/base/globalVariable.js"></script>
	<script type="text/javascript" src="../../Resource/js/base/commonBusiness.js"></script>
	<script type="text/javascript" src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
	<script type="text/javascript" src="../../Resource/js/jqueryUI/jquery.jqGrid.min.js"></script>
	<script type="text/javascript" src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
	<script type="text/javascript" src="../../Resource/js/fileUpload/js/upload.js"></script>
	<script type="text/javascript" src="../../Resource/js/fileUpload/js/file.js"></script>
	<script type="text/javascript" src="API/AMap/js/maps.js"></script>
	<script type="text/javascript" src="../../Resource/js/cookie/jquery.cookie.js"></script>
	<script
		src="https://webapi.amap.com/maps?v=1.3&key=7defcebd378d7fcd05dbcb9298d20d2e&plugin=AMap.PolyEditor,AMap.CircleEditor,AMap.MouseTool,AMap.DistrictSearch"></script>
	<script type="text/javascript" src="http://cache.amap.com/lbs/static/addToolbar.js"></script>
	<script type="text/javascript" src="https://webapi.amap.com/demos/js/liteToolbar.js"></script>
	<script language="javascript" type="text/javascript">
		var detailRowNumber = null;
		var child = [];
		var mostlyGuid = null;
		var detailGuid = null;
		var moduleId = 0;
		var valve = 0;//用于判断增加还是修改的阀门值。0代表修改操作，1��表增加操作。
		var savedRow1 = null;
		var savedCol1 = null;
		var savedChildRow1 = null;
		var savedChildCol1 = null;
		var trainNo = null;
		var sumVol = 0;  //保存体积的和
		var sumGwt = 0; // 保存重量的和
		var sumQty = 0; //保存件数的和
		var orderDetailList = []; //订单明细数组全局变量，保存订单明细，一次性提交后台
		var orderDetail = []; //订单明细全局变量，用于在车次明细页面回显
		var pleaseChoose = "--请选择--";
		var addressChoose = "选择地址";
		var newAddress = "新的地址";
		var confirm = "确定";
		var historyAddress = "历史地址";
		var guid = null;
		var state = "";
		var businessYwId = "";
		var ywId = null;
		var unitInnerHtml = [];
		var unitValueObj = [];
		var unitTextObj = [];
		var beginidObj = {
			id: "begin",
			historyAddress: "historybeginAddress",
			tipinputAddress: "tipinputbeginAddress",
			district: "begin_district",
			city: "begin_city",
			area: "begin_area",
			localRemark: "beginLocalRemark"
		};
		var endidObj = {
			id: "end",
			historyAddress: "historyendAddress",
			tipinputAddress: "tipinputendAddress",
			district: "end_district",
			city: "end_city",
			area: "end_area",
			localRemark: "endLocalRemark"
		};
		var planBeginCityObj = {
			district: "tipinputbegin_district",
			city: "tipinputbegin_city",
		}

		var planEndCityObj = {
			district: "tipinputend_district",
			city: "tipinputend_city",
		}
		var curDate = null;
		$(function () {
			var parms = getUrlParms();
			var jsonList = [];
			var orderDetailGuid = null;
			guid = parent.guid;
			state = parent.state;
			// loadYwLocation();
			loadUnit();
			loadTransType();
			loadCus();
			loadLocation();
			initStyle();
			loadZeroList();
			initData();


			var curr_time = new Date();
			curDate = myformatter(curr_time);
			$("#planshipmentData").datebox("setValue", curDate);
			$("#planjiaofuData").datebox("setValue", curDate);
			$("#businessDate").datebox("setValue", curDate);
			//给默认值，用于zdlocation表的修改和增加
			$("#isNewBeginAddress").val("0");
			$("#isNewEndAddress").val("0");

			//     	$("#planshipmentData").datebox("calendar").calendar({
			//     		validator : function(currentDate) {
			//     			var now = new Date();
			//     			return currentDate > now;
			//     		}
			//     	});

			// $("#cusNo").combobox({ disabled: true});

			if (parent.identifier == '1') {
				$("#toolbar").hide();
				$("#addTable").hide();
			}
			if (window.parent.guid != null) {
				loadDetailMostly(window.parent.guid);
			}

			if (guid == "" || guid == null) {
				$("#planBeginDate").datebox("setValue", curDate);
				$("#payModeForInvoice").attr("checked", true);
				$("#getModeForInvoice").attr("checked", true);
				return;
			} else {
				loadDetailMostly(guid);
				searchData();
			}
		});

		$("#planshipmentData").datebox({
			onSelect: function (planshipmentDate) {
				$("#planjiaofuData").datebox().datebox("calendar").calendar({
					validator: function (jiaofudate) {
						return planshipmentDate < jiaofudate;
					}
				});
			}
		});

		$(window).load(function () {
			hideLoading();
		});
		//清空
		var add = function () {
			$("#addForm").form("clear");

		}
		//清空明细主表
		var clearDetail = function () {
			$.messager.confirm($.i18n.prop('trainOrder_tip'), '#{trainOrder_reset}?', function (r) {
				if (r) {
					$("#detailForm").form("clear");
					mostlyGuid = "";
					detailGuid = "";
					$("#gridTableZero").jqGrid('GridUnload')
					loadZeroList();
				}
			})
		}
		//新增表体
		var addTableRow = function (name) {
			loseGridFocus();
			var ids = $("#" + name).jqGrid('getDataIDs');
			var rowid = Math.max.apply(Math, ids);
			if (rowid == "-Infinity") {
				rowid = 0;
			}
			var newrowid = rowid + 1;
			var dataRow = {
				rowid: newrowid,
			};
			$("#" + name).jqGrid("addRowData", newrowid, dataRow, "last");
		}
		/* var loseGridFocus = function () {
			 if (savedRow1 && savedCol1) {
				 $('#gridTableZero').jqGrid('saveCell', savedRow1, savedCol1);
			 }
		 } */
		var loseGridChindFocus = function () {
			/* if (savedChildRow1 && savedChildCol1) {
				$('#detailChildTableId').jqGrid('saveCell', savedChildRow1, savedChildCol1);
			} */

			loseGridFocus();
		}

		//设置日期
		var time = function (date) {
			$("[name=planBeginDate]").val(date);
		}

		var initStyle = function () {
			enterTriggerEvent('searchParamesTable', 'searchData');
		};
		var oldSetGridHeightWidth = setGridHeightWidth;
		var setGridHeightWidth = function () {
			oldSetGridHeightWidth(5, 228);
			oldSetGridHeightWidth(5, 445, "gridTableZero");
		};
		var initScript = function () {
		};

		// 查询数据
		function searchData() {
			$('#gridTableZero').jqGrid('setGridParam', {
				url: getSearchGridUrl(),
				datatype: 'json',
				postData: { 'filters': '' },
				page: 1
			}).trigger('reloadGrid');
		}

		// 获取查询访问路径
		var getSearchGridUrl = function () {
			var mostlyGuid = parent.guid != '' ? parent.guid : guid;
			return '../../order/findZeroOrderDetailTwo?t=' + Math.random() + '&customSearchFilters=' + encodeURI(getSearchFilters()) + "&mostlyGuid=" + mostlyGuid;
		};

		// 获取查询条件
		var getSearchFilters = function () {
			var parmsArray = [
				{
					name: 'o.mostly_guid', value: guid, op: "eq"
				}
			];
			return formatSearchParames(parmsArray);
		};

		// 保存新增车次信息
		var save = function () {
			insert();
		};

		var insert = function () {
			loseGridFocus();
			if (!validate()) {
				return;
			}

			var orderMostlyVo = FormUtils.toJSONObject($("#detailForm"));
			var detailAllData = $("#gridTableZero").jqGrid("getRowData");
			if (orderMostlyVo.trainType == pleaseChoose) {
				errorNotification({ SimpleMessage: $.i18n.prop('trainOrder_modelMustBe') })
				return;
			}
			/*if(orderMostlyVo.ywLocation == pleaseChoose || orderMostlyVo.ywLocation == "") {
				errorNotification({ SimpleMessage: "业务地点必填" });
				return ;
			}*/
			var ids = $("#gridTableZero").jqGrid("getDataIDs");
			orderMostlyVo.details = [];
			for (var i = 0; i < detailAllData.length; i++) {
				var detail = {};
				detail.row = ids[i];
				detail.sn = detailAllData[i].rowId;
				detail.guid = detailAllData[i].guid;
				detail.goodsName = detailAllData[i].goodsName;
				detail.unit = unitValueObj[detailAllData[i].unit];
				detail.vol = detailAllData[i].vol;
				detail.gwt = detailAllData[i].gwt;
				detail.qty = detailAllData[i].qty;
				detail.contId = detailAllData[i].contId;
				orderMostlyVo.details.push(detail);
			}
			orderMostlyVo.child = child;
			orderMostlyVo.weituoType = 0;
			orderMostlyVo.trainNo = parent.trainNo;
			orderMostlyVo.ywId = $("#ywId").textbox("getValue");
			$.messager.confirm($.i18n.prop('trainOrder_tip'), '#{trainOrder_save}?', function (r) {// 提示, 确定保存数据项吗
				if (r) {
					showLoading();
					$.ajax({
						url: "../../order/addmostly?t=" + Math.random(),
						type: 'POST',
						data: "jsonData=" + encodeURI(JSON.stringify(orderMostlyVo)),
						success: function (dataObj) {
							hideLoading();
							if (isServerResultDataPass(dataObj)) {
								correctNotification({ SimpleMessage: $.i18n.prop('trainOrder_saveSuccess') });
								guid = dataObj.resultDataFull;
								loadDetailMostly(guid);
								searchData();
								window.parent.frames[0].searchData();
								//刷新父页面
								getCurrentTab().searchData();
							} else {
								FailResultDataToTip(dataObj);
							}
						},
						error: function (message) {
							hideLoading();
						}
					});
				}
			});
		}
		//修改车次信息
		var edit = function () {
			if (state != 0) {
				errorNotification({ SimpleMessage: $.i18n.prop('trainOrder_cannotEdit') });
				return;
			}
			loseGridFocus();
			var planExecVO = FormUtils.toJSONObject($("#detailForm"));
			var detailAllData = $("#gridTableZero").jqGrid("getRowData");
			var ids = $("#gridTableZero").jqGrid("getDataIDs");
			planExecVO.detail = [];
			for (var i = 0; i < detailAllData.length; i++) {
				var detail = {};
				detail.row = ids[i];
				detail.sn = detailAllData[i].rowId;
				detail.guid = detailAllData[i].guid;
				detail.goodsName = detailAllData[i].goodsName;
				detail.vol = detailAllData[i].vol;
				detail.gwt = detailAllData[i].gwt;
				detail.contId =
					detail.qty = detailAllData[i].qty;
				detail.contId = detailAllData[i].contId;
				planExecVO.detail.push(detail);
			}
			planExecVO.child = child;
			if (planExecVO.state >= 3) {
				errorNotification({ SimpleMessage: $.i18n.prop('planExec_edit_stateError') });
				return;
			}
			planExecVO.orderMostly = orderDetailList;
			$.messager.confirm($.i18n.prop('trainOrder_tip'), '#{trainOrder_save}?', function (r) {// 提示, 确定保存数据项吗
				if (r) {
					showLoading();
					$.ajax({
						url: "../../order/updateZoreOrderMostly?t=" + Math.random(),
						type: 'POST',
						data: "jsonData=" + JSON.stringify(planExecVO),
						success: function (dataObj) {
							hideLoading();
							if (isServerResultDataPass(dataObj)) {
								correctNotification(dataObj.resultDataFull);
								//刷新父页面
								getCurrentTab().searchData();
							} else {
								FailResultDataToTip(dataObj);
							}
						},
						error: function (message) {
							hideLoading();
						}
					});
				}
			});
		}

		var validate = function () {
			var validated = $("#detailForm").form('enableValidation').form('validate');
			if (!validated) {
				errorNotification({ SimpleMessage: $.i18n.prop('trainOrder_valid') });
				return false;
			}
			let vol = $("#vol").textbox("getValue");
			let gwt = $("#gwt").textbox("getValue");
			if (vol == "" && gwt == "") {
				errorNotification({ SimpleMessage: '#{trainOrder_mustOne}!' });
				return false;
			}
			return true;
		}


		//明细删除
		var delText = $.i18n.prop('trainOrder_deleteButton');
		var deleteRow = function (index, name) {
			$.messager.confirm($.i18n.prop('trainOrder_tip'), '#{trainOrder_delete}?', function (r) {
				if (r) {
					var rowData = $("#" + name).jqGrid('getRowData', index);
					var ids = $("#gridTableZero").jqGrid("getDataIDs");
					if (ids.length == 1) {
						var mainGuid = mostlyGuid
					}
					if (rowData.guid != '' && rowData.guid != undefined && rowData.guid != null) {
						showLoading("数据加载中");
						$.ajax({
							url: "../../order/deleteOrderDetail?t=" + Math.random(),
							data: { mostlyGuid: mainGuid, guid: rowData.guid },
							type: "POST",
							success: function (data) {
								if (isServerResultDataPass(data)) {
									correctNotification({
										SimpleMessage: data.resultDataFull.simpleMessage
									});
									$("#" + name).delRowData(index);

									if ($("#" + name).jqGrid("getRowData").length <= 0) {
										savedRow1 = null;
										savedCol1 = null;
									}
								} else {
									FailResultDataToTip(data);
								}
								hideLoading();
							}
						});
					} else {
						$("#" + name).delRowData(index);
						if ($("#" + name).jqGrid("getRowData").length <= 0) {
							savedRow1 = null;
							savedCol1 = null;
						}
					}
				}
			});
		}
		//子明细删除
		var childDeleteRow = function (index, name) {
			$.messager.confirm($.i18n.prop('trainOrder_tip'), '#{trainOrder_delete}?', function (r) {
				if (r) {
					var rowData = $("#" + name).jqGrid('getRowData', index);
					if (rowData.guid != '' && rowData.guid != undefined && rowData.guid != null) {
						showLoading($.i18n.prop('order.detail.child.loading'));
						$.ajax({
							url: "../../order/deleteOrderDetailChildBySn?t=" + Math.random(),
							data: { guid: rowData.guid },
							type: "POST",
							success: function (data) {
								if (isServerResultDataPass(data)) {
									correctNotification({
										SimpleMessage: data.resultDataFull.simpleMessage
									});
									$("#" + name).delRowData(index);

									if ($("#" + name).jqGrid("getRowData").length <= 0) {
										savedRow1 = null;
										savedCol1 = null;
									}
								} else {
									FailResultDataToTip(data);
								}
								hideLoading();
							}
						});
					} else {
						$("#" + name).delRowData(index);

						if ($("#" + name).jqGrid("getRowData").length <= 0) {
							savedRow1 = null;
							savedCol1 = null;
						}
					}
				}
			});
		}
		// 加载列表数据
		var loadZeroList = function () {
			$('#gridTableZero').jqGrid({
				// 	         url : getSearchGridUrl(),
				async: true,
				datatype: 'local',
				width: 'none',
				colNames: [
					"<a href='#' onclick='addTableRow(\"gridTableZero\")' id=''addTable><img src='../../Index/images/add.png' style='width: 15px;margin-right: 2px;'>#{trainOrder_newAdd}</a>", $.i18n.prop('sn'),
					$.i18n.prop('guid'), $.i18n.prop('trainOrder_withinCode'), $.i18n.prop('trainOrder_createBy'), $.i18n.prop('trainOrder_createDate'),
					$.i18n.prop('updateBy'), $.i18n.prop('updateDate'), $.i18n.prop('trainOrder_goodsName'), $.i18n.prop('trainOrder_qty'), $.i18n.prop('mostlyGuid'),
					$.i18n.prop('detail.unit'), $.i18n.prop('detail.vol'), $.i18n.prop('detail.gwt'), $.i18n.prop('trainOrder_barCodeNumber')
				],
				colModel: [
					{ name: 'delete', width: 50, index: 'delete', search: false, sortable: false, align: 'center', formatter: function (value, row, rowIndex) { return "<a style='text-decoration:underline;color:blue;' name='deleteRow' href='javascript:deleteRow(" + row.rowId + ",\"gridTableZero\")'>" + delText + "</a>"; "<a style='text-decoration:underline;color:blue;' href='javascript:deleteRow(" + row.rowId + ",\"gridTableZero\")'>" + delText + "</a>"; } },
					{ name: 'sn', index: 'o.sn', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'guid', index: 'o.guid', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'withinCode', index: 'o.within_Code', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'createBy', index: 'o.create_By', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'createDate', index: 'o.CREATE_DATE', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'updateBy', index: 'o.UPDATE_BY', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'updateDate', index: 'o.UPDATE_DATE', align: 'center', search: false, type: 'string', hidden: true },
					{ name: 'goodsName', index: 'o.goods_name', editable: true, align: 'center', sortable: false, width: 100 },
					{
						name: 'qty', index: 'o.qty', editable: true, align: 'center', sortable: false, width: 80,
						editrules: {
							integer: true,
						}
					},
					{ name: 'mostlyGuid', index: 'o.MOSTLY_GUID', align: 'center', search: true, type: 'string', hidden: true },
					{
						name: 'unit', index: 'o.UNIT', editable: true, align: 'center', sortable: false, width: 80, edittype: 'select', editoptions: { value: unitInnerHtml },
						formatter: function (value, grid, rows) {
							if (value == undefined) {
								return "";
							} else {
								return unitTextObj[value];
							}
						}
					},
					{
						name: 'vol', index: 'o.VOL', editable: true, align: 'center', sortable: false, width: 80,
						editrules: {
							number: true,
							custom: true,
							custom_func: function (value, name) {
								var reg = '^(([1-9]{1}\\d*)|([0]{1}))(\\.(\\d){0,2})?$';
								var re = new RegExp(reg);
								if (re.test(value)) {
									return [true, ''];
								} else {
									return [false, name + '#{trainOrder_numberError}!']
								}
							}
						}
					},
					{
						name: 'gwt', index: 'o.GWT', editable: true, align: 'center', sortable: false, width: 80,
						editrules: {
							number: true,
							custom: true,
							custom_func: function (value, name) {
								var reg = '^(([1-9]{1}\\d*)|([0]{1}))(\\.(\\d){0,2})?$';
								var re = new RegExp(reg);
								if (re.test(value)) {
									return [true, ''];
								} else {
									return [false, name + '#{trainOrder_numberError}!']
								}
							}
						}
					},
					{ name: 'contId', width: 80, index: 'o.cont_id', search: false, sortable: false, editable: false, align: 'center', width: 150 },
				],
				cellEdit: true,
				cellsubmit: 'clientArray',
				shrinkToFit: false,
				altRows: true,
				altclass: 'gridSpacingClass',
				forceFit: true,
				cellLayout: 0,
				scroll: true,
				autowidth: true,
				loadonce: false,
				mtype: "POST",
				viewrecords: true,
				rownumbers: true,
				rowNum: 100,
				height: "100%",
				rowList: [15, 20, 30, 50, 100],
				pager: "#gridPager",
				jsonReader: {
					root: "rows",
					total: "total",
					page: "page",
					records: "records",
					repeatitems: false
				},
				gridComplete: function () {
					$('.cbox').shiftSelect();
					if (parent.identifier == '1') {
						$("a[name='deleteRow']").hide();
					}
				},

				loadComplete: function (xhr) {
					//$("#gbox_gridTableZero").find(".ui-jqgrid-bdiv").css("height","254px");
				},
				afterSaveCell: function (rowid, cellname, value, iRow, iCol) {
					var list = $(this).jqGrid("getRowData");
					var sumVol = 0;
					var sumGwt = 0;
					var sumQty = 0;

					for (var i = 0; i < list.length; i++) {
						sumVol += Number(list[i].vol);
						sumGwt += Number(list[i].gwt);
						sumQty += Number(list[i].qty);
					}
					if (cellname == "vol") {
						//sumVol += parseInt(value);
						$("#vol").textbox('setValue', sumVol);
					} else if (cellname == "gwt") {
						//sumGwt += parseInt(value);
						$("#gwt").textbox('setValue', sumGwt);
					} else if (cellname == "qty") {
						// sumQty += parseInt(value);
						$("#qty").textbox('setValue', sumQty);
					}
				}
			});
			$('#gridTableZero').setGridParam({
				beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
					savedRow1 = iRow;
					savedCol1 = iCol;
					window.loseGridFocus();
				}
			});
			setGridHeightWidth();
		};
		//订单详情
		var showPlanDetail = function (trainno) {
			var href = '../View/ywgl/orderDetail.html?moduleId=' + moduleId + '&trainno=' + trainno;
		}

		// 用户双击跳转车次物品清单
		var showChildModule = function (trainno) { showPlanDetail(trainno); };


		// 新增、修改操作完成后调用的刷新方法
		var refreshCallerData_List = function () {
			searchData();
		};

		var initData = function () {
			// 		clearDetail();
			// 		loadYwLocation();
			readProvince();
		};

		// 获取查询条件
		var getSearchMostlyFilters = function () {
			var parameter = { trainNo: trainNo };
			return parameter;
		};
		// 获取查询访问路径
		var getSearchMostlyGridUrl = function () {
			return '../../bussiness/planExec/findMostlyList?t=' + Math.random() + '&trainNo=' + encodeURI(trainNo);
		};
		//获取mostly列表信息
		//保存订单主表信息
		var saveDetail = function () {
			loseGridFocus();
			var orderMostlyVo = FormUtils.toJSONObject($("#detailForm"));
			var detailAllData = $("#gridTableZero").jqGrid("getRowData");
			if (detailAllData.length == 0) {
				alert($.i18n.prop('trainOrder_mustBeOne'))
				return;
			}
			var ids = $("#gridTableZero").jqGrid("getDataIDs");
			orderMostlyVo.child = child;
			orderMostlyVo.details = [];
			for (var i = 0; i < detailAllData.length; i++) {
				var detail = {};
				detail.row = ids[i];
				detail.sn = detailAllData[i].rowId;
				detail.guid = detailAllData[i].guid;
				detail.goodsName = detailAllData[i].goodsName;
				detail.vol = detailAllData[i].vol;
				detail.gwt = detailAllData[i].gwt;
				detail.qty = detailAllData[i].qty;
				orderMostlyVo.details.push(detail);
			}
			orderMostlyVo.trainNo = parent.trainNo;
			orderDetail = orderMostlyVo;
			orderDetailList.push(orderMostlyVo);
			clearDetail();

		}

		function MouseOver(name) {
			var rowData = $("#gridTableZero").jqGrid('getRowData', name);
			detailRowNumber = name;
			detailGuid = rowData.guid;
			$("#orderDetailChild").show();
			listChild();
		}
		//加载订单详情子明细
		var listChild = function () {
			$("#detailChildTableId").jqGrid('GridUnload')
			$('#detailChildTableId').jqGrid({
				url: getDetailChild(),
				datatype: 'json',
				width: 'none',
				colNames: ['', 'sn',
					'创建人',
					'创建时间',
					'更新人',
					'更新时间',
					$.i18n.prop('planExec_mostly_detailChild_Guid'), $.i18n.prop('planExec_mostly_detailChild_detailGuid'),
					$.i18n.prop('planExec_mostly_detailChild_goodCode'), '子明细名称',
					'子明细体积',
					'子明细重量', '子明细数量'
				],
				colModel: [
					{ name: 'delete', width: 40, index: 'delete', align: 'center', formatter: function (value, row, rowIndex) { return "<a style='text-decoration:underline;color:blue;' href='javascript:childDeleteRow(" + row.rowId + ",\"detailChildTableId\")'>" + delText + "</a>"; } },
					{ name: 'sn', index: 'sn', key: true, align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'createBy', index: 'odc.create_By', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'createDate', index: 'odc.CREATE_DATE', lign: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'updateBy', index: 'odc.UPDATE_BY', align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
					{ name: 'updateDate', index: 'odc.UPDATE_DATE', align: 'center', search: true, type: 'string', hidden: true },
					{ name: 'guid', index: 'guid', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'detailGuid', index: 'odc.DETAIL_GUID', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'goodCode', index: 'odc.GOOD_CODE', align: 'center', sorttype: 'string', sortable: false, hidden: true },
					{ name: 'goodName', index: 'odc.GOOD_NAME', align: 'center', editable: true, edittype: 'text', width: 150, },
					{ name: 'vol', index: 'odc.VOL', align: 'center', editable: true, edittype: 'text', width: 70, },
					{ name: 'gwt', index: 'odc.GWT', align: 'center', editable: true, edittype: 'text', width: 70, },
					{ name: 'qty', index: 'odc.QTY', align: 'center', editable: true, edittype: 'text', width: 80, },
				],
				cellEdit: true,
				cellsubmit: 'clientArray',
				shrinkToFit: false,
				altRows: true,
				altclass: 'gridSpacingClass',
				forceFit: true,
				cellLayout: 0,
				scroll: false,
				autowidth: true,
				loadonce: false,
				mtype: "POST",
				viewrecords: true,
				rownumbers: true,
				rowNum: 100,
				height: "100%",
				rowList: [15, 20, 30, 50, 100],
				pager: "#gridPager",
				jsonReader: {
					root: "rows",
					total: "total",
					page: "page",
					records: "records",
					repeatitems: false
				},
				gridComplete: function () {
					$('.cbox').shiftSelect();
				},
				loadComplete: function (xhr) {

					FailResultDataToTip(xhr);
					hideLoading();
				}
			});

			$('#detailChildTableId').setGridParam({
				beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
					savedChildRow1 = iRow;
					savedChildCol1 = iCol;
				}
			});
			$("#gview_detailChildTableId").find(".ui-jqgrid-bdiv").css("height", "100px");
			setGridHeightWidth();
		}

		var getSearchOrderDetialFilters = function () {
			var parmsArray = [
				{ name: 'odc.detail_Guid', value: detailGuid, op: "eq" },
			];
			return formatSearchParames(parmsArray);
		}

		var getDetailChild = function () {
			return url = "../../order/findOrderChildBydetailGuid?t=" + Math.random() + "&customSearchFilters=" + encodeURI(getSearchOrderDetialFilters());
		}

		var addChild = function (name) {
			loseChildGridFocus();
			var ids = $("#" + name).jqGrid('getDataIDs');
			var rowid = Math.max.apply(Math, ids);
			if (rowid == "-Infinity") {
				rowid = 0;
			}
			var newrowid = rowid + 1;
			var dataRow = {
				rowid: newrowid,
			};
			$("#" + name).jqGrid("addRowData", newrowid, dataRow, "last");
		}
		//订单明细添加后，在车次明细页面回显。
		var i = 0;
		var loseChildGridFocus = function () {
			if (savedRow1 && savedCol1) {
				$('#detailChildTableId').jqGrid('saveCell', savedRow1, savedCol1);
			}
		}
		function removn() {
			$("#orderDetailChild").hide();
		}

		//占存子明细表的数据在域中
		var saveChildTable = function () {
			loseGridChindFocus();
			var childAllData = $("#detailChildTableId").jqGrid("getRowData");
			if (childAllData.length == 0) {
				alert($.i18n.prop('orderDetailOneSave'))
				return;
			} else {
				child.splice(0, child.length);//清空数组 
				for (var i = 0; i < childAllData.length; i++) {
					var childs = {};
					childs.detailRow = detailRowNumber;
					childs.sn = childAllData[i].sn;
					childs.guid = childAllData[i].guid;
					childs.goodName = childAllData[i].goodName;
					childs.vol = childAllData[i].vol;
					childs.gwt = childAllData[i].gwt;
					childs.qty = childAllData[i].qty;
					child.push(childs);
				}
			}
		}

		//绑定订单主表信息，作为修改的初始值
		var loadDetailMostly = function (guid) {
			if (guid == "") {
				$("#guid").val("");
			}
			guid = guid;
			$.ajax({
				url: '../../order/findOrderMostlyDetail?t=' + Math.random() + '&guid=' + guid,
				type: 'POST',
				data: "",
				success: function (dataObj) {
					if (isServerResultDataPass(dataObj)) {
						var mostlyJson = dataObj.resultDataFull;

						$("#cusNo").combobox('setValue', mostlyJson.CUS_NO);
						$("#cusNo").combobox('setText', mostlyJson.CUS_NAME);
						$("#cusNo").combobox("options").onSelect({
							code: mostlyJson.CUS_NO
						});

						$("#state").textbox("setValue", english(parseInt(mostlyJson.STATE)));

						$("#historybeginAddress").combobox("setValue", mostlyJson.BEGIN_LOCAL_CODE);
						$("#historyendAddress").combobox("setValue", mostlyJson.END_LOCAL_CODE);
						$("#beginLocalRemark").textbox("setValue", mostlyJson.BEGIN_LOCAL_ADDRESS);
						$("#endLocalRemark").textbox("setValue", mostlyJson.END_LOCAL_ADDRESS);

						readDistrictCityArea("begin", mostlyJson.BEGIN_LOCAL_PROVINCE, mostlyJson.BEGIN_LOCAL_CITY, mostlyJson.BEGIN_LOCAL_DISTRICT);
						readDistrictCityArea("end", mostlyJson.END_LOCAL_PROVINCE, mostlyJson.END_LOCAL_CITY, mostlyJson.END_LOCAL_DISTRICT);


						$("#businessDate").datebox("setValue", mostlyJson.BUSINESS_DATE);
						$("#businessYwId").textbox("setValue", mostlyJson.BUSINESS_YW_ID);
						$("#planshipmentData").datebox("setValue", mostlyJson.PLANSHIPMENT_DATA);
						$("#beginLocalMan").textbox("setValue", mostlyJson.BEGIN_LOCAL_MAN);
						$("#beginLocalPhone").textbox("setValue", mostlyJson.BEGIN_LOCAL_PHONE);




						$("#planjiaofuData").datebox("setValue", mostlyJson.PLANJIAOFU_DATA);
						$("#endLocalMan").textbox("setValue", mostlyJson.END_LOCAL_MAN);
						$("#endLocalPhone").textbox("setValue", mostlyJson.END_LOCAL_PHONE);
						$("#shoukuan").textbox("setValue", mostlyJson.SHOUKUAN);
						$("#fukuan").textbox("setValue", mostlyJson.FUKUAN);
						$("#vol").textbox("setValue", mostlyJson.VOL);
						$("#gwt").textbox("setValue", mostlyJson.GWT);
						$("#qty").textbox("setValue", mostlyJson.QTY);
						$("#transportTypePlan").combobox("setValue", mostlyJson.TRANSPORT_TYPE_PLAN);
						// $("#ywLocation").combobox("setValue",mostlyJson.YW_LOCATION);
						$("#guid").val(mostlyJson.GUID);
						$("#omlGuid").val(mostlyJson.omlGuid);
						$("input[name='getMode'][value='" + mostlyJson.GET_MODE + "']").attr("checked", true);
						$("input[name='payMode'][value='" + mostlyJson.PAY_MODE + "']").attr("checked", true);
						$("#ywId").textbox("setValue", mostlyJson.YW_ID);
						sumVol = mostlyJson.VOL;
						sumGwt = mostlyJson.GWT;
						sumQty = mostlyJson.QTY;
						businessYwId = $("#businessYwId").val();
						ywId = mostlyJson.YW_ID;
					} else {
						FailResultDataToTip(dataObj);
					}
					hideLoading();
				},
				error: function (message) {
					hideLoading();
				}
			});
		}


		var currentAddress = {};

		var loadTransType = function () {
			$("#transportTypePlan").combobox({
				valueField: "code",
				textField: "name",
				loader: function (param, success, error) {
					$.ajax({
						url: "../../sysInfo/dictionaryData/getDictionaryDataList?t=" + Math.random() + "&dicTypeCode=transportType",
						method: "GET",
						async: true,
						dataType: 'json',
						success: function (data) {
							var supArr = [];
							supArr.unshift({ code: '', name: pleaseChoose });
							data.forEach(function (item) {
								supArr.push({ code: item.dicValue, name: item.dicText });
							});
							success(supArr);
							$("#transportTypePlan").combobox("setValue", pleaseChoose);
						}
					});
				}
			});
		}

		function loadCus() {
			$("#cusNo").combobox({
				valueField: 'code',
				textField: 'name',
				data: [],
				onSelect: function (row) {
					$("#historybeginAddress").combobox("setValue", "");
					$("#historyendAddress").combobox("setValue", "");
					loadLocationByCus(row.code);
				}
			});
			//初始化客户数据
			$.ajax({
				url: "../../bussiness/planExec/findCusWithCurrentWithinCode?t=" + Math.random(),
				dataType: 'json',
				method: "GET",
				success: function (data) {
					$("#cusNo").combobox("loadData", data);
				}
			});
		};

		var beginCode = "";
		var endCode = "";
		var loadLocation = function () {
			$("#historybeginAddress").combobox({
				valueField: "code",
				textField: "address",
				onSelect: function (row) {
					beginCode = row.code;
					loadRoute()
					$("#beginLocalRemark").textbox("setValue", row.address);
					$("#beginLocalMan").textbox("setValue", row.linkman);
					$("#beginLocalPhone").textbox("setValue", row.linktel);
					$("#beginLocalCode").val(row.addressCode);
					readDistrictCityArea("begin", row.province, row.city, row.district);
				}
			});
			$("#historyendAddress").combobox({
				valueField: "code",
				textField: "address",
				onSelect: function (row) {
					endCode = row.code;
					loadRoute();
					$("#endLocalSiteCode").val(row.addressCode);
					$("#endLocalRemark").textbox("setValue", row.address);
					$("#endLocalMan").textbox("setValue", row.linkman);
					$("#endLocalPhone").textbox("setValue", row.linktel);
					readDistrictCityArea("end", row.province, row.city, row.district);
				}
			});
		}
		var loadLocationByCus = function (cusNo) {
			$.ajax({
				url: "../../bussiness/planExec/findLocationByCus?cusNo=" + cusNo + "&t=" + Math.random(),
				dataType: 'json',
				method: "GET",
				success: function (data) {
					$("#historybeginAddress,#historyendAddress").combobox("loadData", data);
					/* if(data.length == 0){
						if($("#tipinputbeginAddress").is(":hidden")){
							$("#newBeginAddress,#newEndAddress").click();
						}
					}else{
						if(!$("#tipinputbeginAddress").is(":hidden")){
							$("#newBeginAddress,#newEndAddress").click();
						}
					} */
				}
			});



		}


		var readProvince = function () {

			//初始化省
			$("#begin_district").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					$("#begin_city").combobox("setValue", "");
					$("#begin_area").combobox("setValue", "");
					readCity($("#begin_city"), row.name);
				},
				onLoadSuccess: function () {
				}
			});
			$("#end_district").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					$("#end_city").combobox("setValue", "");
					$("#end_area").combobox("setValue", "");
					readCity($("#end_city"), row.name);
				},
				onLoadSuccess: function () {
				}
			});

			//初始化市
			$("#begin_city").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					$("#begin_area").combobox("setValue", "");
					readArea($("#begin_area"), row.name);
				},
				onLoadSuccess: function () {
				}
			});
			$("#end_city").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					$("#end_area").combobox("setValue", "");
					readArea($("#end_area"), row.name);
				},
				onLoadSuccess: function () {
				}
			});

			//初始化区
			$("#begin_area").combobox({
				valueField: "name",
				textField: "name",
				data: [],
				onSelect: function (row) {
					//
				},
				onLoadSuccess: function () {
				}
			});
			$("#end_area").combobox({
				valueField: "name",
				textField: "name",
				onSelect: function (row) {
					//
				},
				onLoadSuccess: function () {
				}
			});

			var opts = {
				subdistrict: 1,//返回下一级行政区
				showbiz: false  //最后一级返回街道信息
			};
			var district = new AMap.DistrictSearch(opts);
			district.search("", function (status, result) {
				if (result.info != undefined) {
					var list = result.districtList[0].districtList;
					$("#begin_district,#end_district").combobox("loadData", list);
				}
			});
		};

		var readCity = function (toObj, province) {
			var opts = {
				subdistrict: 2,   //返回下一级行政区
				showbiz: false  //最后一级返回街道信息
			};
			var district = new AMap.DistrictSearch(opts);
			district.search(province, function (status, result) {
				if (result.info != undefined) {
					var cityList = result.districtList[0].districtList;
					toObj.combobox("loadData", cityList);
				}
			});

		};

		var readArea = function (toObj, city) {
			var opts = {
				subdistrict: 3,   //返回下一级行政区
				showbiz: false  //最后一级返回街道信息
			};
			var district = new AMap.DistrictSearch(opts);
			district.search(city, function (status, result) {
				if (result.info != undefined) {
					var list = [];
					list = result.districtList[0].districtList;
					toObj.combobox("loadData", list);
				}
			});
		};


		var clearCitys = function (id) {
			$("#" + id).combobox("setValue", pleaseChoose);
		}

		var comboDefault = function () {
			$(this).combobox("setValue", pleaseChoose);
		}

		var addressDefault = function (data) {
			if (data.length != 1) {
				$(this).combobox("setValue", pleaseChoose);
			} else if (data.length == 1) {
				$(this).combobox("select", data[0].code);
			}
		}

		$.extend($.fn.validatebox.defaults.rules, {
			telNum: { //既验证手机号，又验证座机号
				validator: function (value, param) {
					return /(^(0[0-9]{2,3}\-)?([2-9][0-9]{6,7})+(\-[0-9]{1,4})?$)|(^(()|(\d{3}\-))?(1[345678]\d{9})$)/.test(value);
				},
				message: $.i18n.prop('tel is incorrect format')
			},
		});

		tipinput("tipinputbeginAddress", beginidObj, $("#beginLocalRemark"));
		tipinput("tipinputendAddress", endidObj, $("#endLocalRemark"));

		function tipinput(tipinput, obj, remark) {
			AMap.plugin(['AMap.Autocomplete', 'AMap.PlaceSearch'], function () {
				var autoOptions = {
					// 使用联想输入的input的id
					input: tipinput
				};
				var autocomplete = new AMap.Autocomplete(autoOptions);

				AMap.event.addListener(autocomplete, "select", function (e) {
					var placeSearch = new AMap.PlaceSearch({
						city: e.poi.adcode,
						children: 1
					});

					placeSearch.getDetails(e.poi.id, function (status, result) {
						//获取匹配度最高的地址
						var poi = result.poiList.pois[0];
						var district = poi.pname;
						var city = poi.cityname;
						var area = poi.adname;
						remark.textbox("setValue", poi.name);
						if (remark.attr("id") == "beginLocalRemark") {
							readDistrictCityArea("begin", district, city, area);
						} else {
							readDistrictCityArea("end", district, city, area);
						}
					});

				});
			});
		}

		var readDistrictCityArea = function (id, district, city, area) {
			if (id == "begin") {
				$("#begin_district").combobox("setValue", district);
				$("#begin_district").combobox("options").onSelect({
					name: district
				});
				$("#begin_city").combobox("setValue", city);
				$("#begin_city").combobox("options").onSelect({
					name: city
				});
				$("#begin_area").combobox("setValue", area);
			} else {
				$("#end_district").combobox("setValue", district);
				$("#end_district").combobox("options").onSelect({
					name: district
				});
				$("#end_city").combobox("setValue", city);
				$("#end_city").combobox("options").onSelect({
					name: city
				});
				$("#end_area").combobox("setValue", area);
			}
		};

		// 自定义窗体
		var map = new AMap.Map('container', {
			resizeEnable: true,
			zoom: 12,
			center: [118.756376, 32.052573]
		});
		var infowindow;
		map.plugin('AMap.AdvancedInfoWindow', function () {
			infowindow = new AMap.AdvancedInfoWindow({
				panel: 'panel',
				placeSearch: true,
				asOrigin: true,
				asDestination: true
			});
		});

		var cancellation = function () {
			if (!(state >= 1 && state < 3)) {
				errorNotification({ SimpleMessage: "只能注销运输之前的运单" });
				return;
			}
			$.messager.confirm("提示", "确定要注销吗？", function (r) {
				if (r) {
					showLoading();
					$.ajax({
						url: '../../order/cancel?t=' + Math.random() + "&guid=" + guid,
						type: 'POST',
						success: function (dataObj) {
							if (isServerResultDataPass(dataObj)) {
								correctNotification(dataObj.resultDataFull);
								close();
							} else {
								FailResultDataToTip(dataObj);
							}
							hideLoading();
						},
						error: function (message) {
							hideLoading();
						}
					});
				}
			});
		}

		$("#newBeginAddress").toggle(function (param) {
			$("#" + param.currentTarget.id).text(historyAddress);
			$('#tipinputbeginAddress').val("");
			$('#historybeginAddress').next(".combo").hide();
			$('#tipinputbeginAddress').show();
			$('#isNewBeginAddress').val("1");
		}, function (param) {
			$("#" + param.currentTarget.id).text(addressChoose);
			$('#historybeginAddress').next(".combo").show();
			$('#historybeginAddress').combobox("setValue", pleaseChoose);
			$('#tipinputbeginAddress').hide();
			$('#isNewBeginAddress').val("0");
		});

		$("#newEndAddress").toggle(function (param) {
			$("#" + param.currentTarget.id).text(historyAddress);
			$('#tipinputendAddress').val("");
			$('#historyendAddress').next(".combo").hide();
			$('#tipinputendAddress').show();
			$("#isNewEndAddress").val("1");
		}, function (param) {
			$("#" + param.currentTarget.id).text(addressChoose);
			$('#historyendAddress').next(".combo").show();
			$('#historyendAddress').combobox("setValue", pleaseChoose);
			$('#tipinputendAddress').hide();
			$("#isNewEndAddress").val("0");
		});

		var close = function () {
			$.messager.confirm($.i18n.prop('trainOrder_tip'), '#{trainOrder_close}?', function (r) {
				if (r) {
					closeDialog("orderDetailTable");
				}
			})
		}

		//加载业务地点
		/*var ywlocation = $.cookie("OSUN_whcenter");
		var loadYwLocation = function() {
			$.ajax({
				url : '../../bussiness/planExec/getywlocation?t=' + Math.random(),
				type : 'POST',
				async : false,
				success : function(data){
					var data = data.resultDataFull;
					data.unshift({CODE:'','NAME':pleaseChoose});
					$("#ywLocation").combobox({
						valueField : "CODE",
						textField : "NAME",
						loader : function(params, success, error) {
							var cookLocation = ywlocation.split(",");
							var dataLocation = [];
							for(var i = 0 ; i < cookLocation.length; i++) {
								for(var j = 0 ; j < data.length; j++) {
									if(cookLocation[i] == data[j].CODE) {
										dataLocation[i] = data[j];
									}
								}
							}
							dataLocation.unshift({'CODE': '','NAME': pleaseChoose});
							success(dataLocation);
						},
						onLoadSuccess : function(){
							var currentYwLocation = ywlocation.split(",");
							if(currentYwLocation.length == 1) {
								$("#ywLocation").combobox("setValue",currentYwLocation[0]);
							} else {
								$("#ywLocation").combobox("setValue", "");
							}
						}
					});
				}
			});
		}*/

		var loadUnit = function () {
			$.ajax({
				// url: '../../bussiness/planExec/getunit?t=' + Math.random(),
				url: '../../sysInfo/dictionary/getZdDicData?t=' + Math.random()
					+ '&customSearchFilters=%7B%22groupOp%22:%22AND%22,%22rules%22:%5B%7B%22field%22:%22typeCode%22,%22op%22:%22eq%22,%22data%22:%22orderDetailUnit%22%7D%5D%7D',
				type: 'POST',
				async: false,
				success: function (dataObj) {
					// dataObj.resultDataFull.forEach(function (item) {
					// 	unitInnerHtml += item.UNITCODE + ":" + item.UNITNAME + ";";
					// 	unitValueObj[item.UNITNAME] = item.UNITCODE;
					// 	unitTextObj[item.UNITCODE] = item.UNITNAME;
					// });
					for (let i = 0; i < dataObj.rows.length; i++) {
						const element = dataObj.rows[i];
						unitInnerHtml += element.dictext + ":" + element.dictext + ";";
						unitValueObj[element.dictext] = element.dictext;
						unitTextObj[element.dictext] = element.dictext;
					}
					unitInnerHtml = unitInnerHtml.substr(0, unitInnerHtml.length - 1);
				}
			});
		}

		var addNew = function () {
			$("#detailForm").form("clear");
			$("#businessDate").datebox("setValue", curDate);
			$("#planshipmentData").datebox("setValue", curDate);
			$("#planjiaofuData").datebox("setValue", curDate);
			$("#gridTableZero").jqGrid("clearGridData");
			$("#isNewBeginAddress").val("0");
			$("#isNewEndAddress").val("0");
			$("input[name='payMode'][value='0']").attr("checked", true);
			$("input[name='getMode'][value='0']").attr("checked", true);
			loadCus();
			loadTransType();
			// loadYwLocation();
			parent.extendTab($("#guid").val());
		}

		var copy = function () {
			loseGridFocus();
			var guid = $("#guid").val();
			if (guid == null || guid == "" || guid == undefined) {
				errorNotification({ SimpleMessage: $.i18n.prop('trainOrder_saveAndCopy') });
				return;
			}
			var orderMostlyVo = FormUtils.toJSONObject($("#detailForm"));
			var detailAllData = $("#gridTableZero").jqGrid("getRowData");
			if (detailAllData.length == 0) {
				errorNotification({ SimpleMessage: $.i18n.prop('trainOrder_mustBeOne') });
				return;
			}

			var ids = $("#gridTableZero").jqGrid("getDataIDs");
			orderMostlyVo.child = child;

			orderMostlyVo.details = [];
			for (var i = 0; i < detailAllData.length; i++) {
				var detail = {};
				detail.row = ids[i];
				detail.sn = detailAllData[i].rowId;
				detail.guid = detailAllData[i].guid;
				detail.goodsName = detailAllData[i].goodsName;
				detail.unit = unitValueObj[detailAllData[i].unit];
				detail.vol = detailAllData[i].vol;
				detail.gwt = detailAllData[i].gwt;
				detail.qty = detailAllData[i].qty;
				detail.contId = detailAllData[i].contId;
				orderMostlyVo.details.push(detail);
			}
			orderMostlyVo.trainNo = parent.trainNo;
			orderMostlyVo.weituoType = 0;
			// orderMostlyVo.ywLocation = $("#ywLocation").combobox("getValue");
			orderMostlyVo.ywId = ywId;
			orderMostlyVo.planshipmentData = curDate;
			orderMostlyVo.businessDate = curDate;
			orderMostlyVo.planjiaofuData = curDate;
			$.messager.confirm($.i18n.prop('trainOrder_tip'), "#{trainOrder_copy}?", function (r) {
				if (r) {
					$.ajax({
						url: '../../order/copydetail?t=' + Math.random(),
						type: 'POST',
						async: false,
						data: 'jsonData=' + JSON.stringify(orderMostlyVo),
						success: function (dataObj) {
							hideLoading();
							if (isServerResultDataPass(dataObj)) {
								correctNotification({ SimpleMessage: $.i18n.prop('trainOrder_copySuccess') });
								guid = dataObj.resultDataFull;
								window.parent.guid = guid;
								searchData();
								loadDetailMostly(guid);
								window.parent.frames[0].searchData();
								//刷新父页面
								getCurrentTab().searchData();
							} else {
								FailResultDataToTip(dataObj);
							}
						}
					});
				}
			});
		}

		var changeCus = function (cusNo) {
			$("#cusNo").combobox("setValue", cusNo);
			$("#cusNo").combobox("options").onSelect({
				code: cusNo
			});
		}

		var changeBeginAddress = function (row) {
			$("#historybeginAddress").combobox("setValue", row.code);
			$("#historybeginAddress").combobox("options").onSelect(row);
		}

		var changeEndAddress = function (row) {
			$("#historyendAddress").combobox("setValue", row.code);
			$("#historyendAddress").combobox("options").onSelect(row);
		}

		var newAddDetail = function () {
			$("#detailForm").form("clear");
			$("#businessDate").datebox("setValue", curDate);
			$("#planshipmentData").datebox("setValue", curDate);
			$("#planjiaofuData").datebox("setValue", curDate);
			$("#searchCusNo").combobox("setValue", $("#cusNo").combobox("getValue"));
			$("#gridTable").jqGrid("clearGridData");
			$("#isNewBeginAddress").val("0");
			$("#isNewEndAddress").val("0");
			$("#gridTableZero").jqGrid("clearGridData");
		}

		function chinese(state) {
			var chinese = "";
			switch (state) {
				case "正常":
					chinese = "0"
					break;
				case "审核":
					chinese = "1"
					break;
				case "已派遣":
					chinese = "2"
					break;
				case "运输中":
					chinese = "3"
					break;
				case "运输完成":
					chinese = "4"
					break;
				case "已注销":
					chinese = "5"
					break;
				case "中途取消":
					chinese = "6"
					break;
				default:
					break;
			}
			return chinese;
		}
		function english(state) {
			var english = "";
			switch (state) {
				case 0:
					english = "正常"
					break;
				case 1:
					english = "审核"
					break;
				case 2:
					english = "派遣"
					break;
				case 3:
					english = "运输中"
					break;
				case 4:
					english = "运输完成"
					break;
				case 5:
					english = "已注销"
					break;
				case 6:
					english = "中途取消"
					break;
				default:
					break;
			}
			return english;
		}

		/**
		 * @Description 通过 地址的guid去查询线路
		 * @param
		 * @Author lao li
		 * @Date
		 * @return
		 */
		let loadRoute = function () {
			// 如果都为空，不去请求后台查询
			if (beginCode == "" || endCode == "") {
				return;
			}

			$.ajax({
				url: '../../order/queryZdRoute?t=' + Math.random(),
				type: 'POST',
				data: {
					'beginCode': beginCode,
					'endCode': endCode
				},
				success: function (dataObj) {
					let data = dataObj.resultDataFull;
					if (data == null) {
						return;
					}

					$("#routeCode").combobox({
						valueField: 'route_code',
						textField: 'route_name',
						loader: function (params, success, error) {
							success(data);
						}
					})
					// 塞默认值的方法放到最后
					if (data.length == 1) {
						$("#routeCode").combobox("setValue", data[0].route_code);
						return;
					}
				}
			})

		}
	</script>
</body>

</html>
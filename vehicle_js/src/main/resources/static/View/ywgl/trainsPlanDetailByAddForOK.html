<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<style>
#colmodgridTable{ width: 200px; height: 500px; z-index: 950; overflow: hidden; display: block; left: 0px; top: -50px;}

</style>
<head>
	<link id="CustomTheme" type="text/css" rel="stylesheet" href="../../Resource/css/index/customLightBlue.css" />
    <link id="EasyuiTheme" type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/easyuiLightBlue.css" />    
    <link id="JqgridTheme" type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/icon.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/moment/css/daterangepicker.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/fileUpload/css/fileUpload.css" />
    <link type="text/css" rel="stylesheet" href="css/tyle.css"/>
    <title></title>
</head>
<body>
<div id="toolbar" class="easyui-panel" style="padding:4px;border-width:0; border-bottom-width:1px;">
	 #{PAGE_TOOLBAR_BUTTONROLE}
</div>
<div class="searchParamesPanel">
        <table id="searchParamesTable">
          <tr class="searchParamesTrShow">
            <td class="searchParamesTdTitle"><label data-locale="timeAndStop"/>：</td>
         	<td>
     			<input name="beginTime" id="beginTime" class="easyui-datebox" data-options="editable:false" style="width:114px;"/>
       		</td>
       		<td class="searchParamesTdTitle" style="text-align:center">-</td>
         	<td>
             	<input  name="endTime" id="endTime" class="easyui-datebox" data-options="editable:false" style="width:114px;" />
       		</td>
       		<td class="searchParamesTdTitle"><label data-locale="startAddress"/>：</td>
            <td>
                <input type="text" name="beginLocalAddress" id="tipinputbegin" class="easyui-textbox" style="width:114px;"/>
            </td>
            <td class="searchParamesTdTitle"><label data-locale="StopAddress"/>：</td>
            <td>
                <input type="text" name="endLocalAddress" id="tipinputend" class="easyui-textbox" style="width:114px;"/>   
            </td>
            <td class="searchParamesTdTitle"><label data-locale="businessAddress"/>:</td>
       		<td>
       			<input type="text" class="easyui-combobox"  name="ywLocation" id="ywLocation" style="width:114px;"/>
       		</td>
       	</tr>
       	<tr>
       		<td class="searchParamesTdTitle"><label data-locale="orderNumber"/>：</td>
       		<td>
       			<input  type="text" name="trainno" id="trainno" class="easyui-textbox" style="width:114px;" />
       		</td>
       		<td class="searchParamesTdTitle"><label data-locale="costomer"/>：</td>
       		<td>
       			<input  type="text" name="cusNo" id="cusNo" class="easyui-combobox" style="width:114px;"/>
            </td>
            <td class="searchParamesTdTitle"><label data-locale="state"/>：</td>
       		<td>
       			<input  type="text" name="searchState" id="searchState" class="easyui-combobox"  style="width:114px;"/>
            </td>
          </tr>
        </table>
    </div>
	<div id="gridControl">
       <table id="gridTable">
       </table>
       <div id="gridPager">
       </div>
	</div>
	<div id="in_city" style="display: none"></div>
<script type="text/javascript" src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyuiExtend.min.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonControl.js"></script>
<script type="text/javascript" src="../../Resource/js/base/globalVariable.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonBusiness.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/jquery.jqGrid.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/upload.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/file.js"></script>
<script type="text/javascript" src="../../Resource/js/cookie/jquery.cookie.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.contextmenu.r2.js"></script>
<script language="javascript" type="text/javascript">
    var moduleId = 0;
    var originalFormData = "";
    var globalStateArray=null; // 全局状态变量
	var nowDate = new Date();
    var trainNo=null;
    var customerInnerHtml = [];
    var stateInnerHtml = [];
    var transportTypeInnerHtml = [];
    var cityInnerHtml = [];
    var contractorNameInnerHtml = [];
    var stateTextObj = {
	    '0':$.i18n.prop('normal'),
	    '1':$.i18n.prop('toExamine'),
		'2': $.i18n.prop('dispatched'),
		'3':$.i18n.prop('transportation'), 
		'4':$.i18n.prop('transportationCompletion'),
		'5':$.i18n.prop('alreadyWrittenOff'),
		'6':$.i18n.prop('halfwayOff')
    };
    
    var stateValueObj = {
    		$.i18n.prop('normal'):"0",
    	    $.i18n.prop('toExamine'):"1",
    		$.i18n.prop('dispatched'):"2",
    		$.i18n.prop('transportation'):"3", 
    		$.i18n.prop('transportationCompletion'):"4",
    		$.i18n.prop('alreadyWrittenOff'):"5",
    		$.i18n.prop('halfwayOff'):"6"
        };
    $(function() {
        var parms = getUrlParms();
        moduleId = parms['moduleId'];
        var planExecVO = {};
        var sn = null;
        var trainno = null;
        loadContractorName();
        loadYwLocation();
//         loadAddress();
        initScript();
        loadCitySelector();
        loadTransportType();
        loadState();
        getCus();
        loadTruckType();
        initData();
        initStyle();
    });

    $(window).load(function() { hideLoading(); });

    var initStyle = function() {
        enterTriggerEvent('searchParamesTable', 'searchData');
    };
    
    var oldSetGridHeightWidth = setGridHeightWidth;
    var setGridHeightWidth = function() {
    	oldSetGridHeightWidth(5,148);
    };
    
    var initScript = function() {
    	$(window).resize(function() {
    		setGridHeightWidth();
    		setToolbarHeightWidth();
    	});	
    };
    var initData = function() {
    	loadList();
    };
    
    var defaultTime = function(){
    	$("#beginTime").datebox("setValue",nowDate.toLocaleDateString());
    	$("#endTime").datebox("setValue",nowDate.toLocaleDateString());
    }
	// 查询数据
    function searchData() {
        $('#gridTable').jqGrid('setGridParam', {
        	url : getSearchGridUrl(),
        	datatype : 'json',
        	postData : { 'filters' : '' },
        	page : 1
        }).trigger('reloadGrid');
    }

	// 获取查询访问路径
    var getSearchGridUrl = function() {
        return '../../bussiness/planExec/findTrainsListing?t=' + Math.random() + '&customSearchFilters=' + encodeURI(getSearchFilters());
    };

    var getSearchOrderListFilters = function() {
		var parmsArray = [
		{ name: 'd.trainno', value: trainno, op: "eq" },
        ];
        return formatSearchParames(parmsArray);
    };
    
 	// 获取查询条件
    var getSearchFilters = function() {
 		var cusName = $("#cusNo").combobox("getValue");
 		if(cusName == $.i18n.prop('all')){
 			cusName = "";
 		}
    	var searchState = $("#searchState").combobox('getValue');
    	if (searchState == $.i18n.prop('all')) {
    		searchState="";
		}
        var plan_begin_date = "";
    	var plan_end_date = "";
    		plan_begin_date = $.trim($("#beginTime").textbox("getText"));// + " 00:00:00";
        	plan_end_date = $.trim($("#endTime").textbox("getText"));// + " 23:59:59";
        	
        var beginCity = $("#tipinputbegin").textbox('getValue');
        if(beginCity == "所有") {
        	beginCity = "";
        }
        
        var endCity = $("#tipinputend").textbox('getValue');
        if(endCity == "所有") {
        	endCity = "";
        }
        
        var ywLocation = $("#ywLocation").combobox("getValues");
        if(ywLocation == $.i18n.prop('all')) {
        	ywLocation =  "";
        }
        
        var trainno = $("#trainno").textbox("getValue");
		var parmsArray = [
			{ name: 'a.cus_no', value: cusName, op: "cn" },
			{ name: 'a.state', value: searchState, op: "eq" },
			{ name: 'a.create_date', value: plan_begin_date,op: "ge" },
			{ name: 'a.create_date', value: plan_end_date,op: "le" },
			{ name: 'a.begin_city', value: beginCity, op: 'cn'},
			{ name: 'a.yw_location', value: ywLocation, op: 'eq'},
			{ name: 'a.end_city', value: endCity, op: 'cn'},
			{ name: 'a.trainno', value: trainno, op: 'cn'}
        ];
        return formatSearchParames(parmsArray);
    };

    
    var search = function(){
    	searchData();
    }
	
	// 加载列表数据
    var loadList = function() {
        $('#gridTable').jqGrid({
            url : getSearchGridUrl(),
            datatype : 'json',
            width : 'none',
            colNames : [
            	$.i18n.prop('sn'),$.i18n.prop('guid'),$.i18n.prop('state'),$.i18n.prop('cusWeituo'),$.i18n.prop('cusNo'),$.i18n.prop('cusName'),$.i18n.prop('withinCode'),
            	$.i18n.prop('trainNo'),$.i18n.prop('planBeginDate'),$.i18n.prop('beginDate'),$.i18n.prop('endDate'),$.i18n.prop('weituoType'),
            	$.i18n.prop('transportType'),$.i18n.prop('beginCity'), $.i18n.prop('endCity'), $.i18n.prop('trainType'),$.i18n.prop('planTruckType'), 
            	$.i18n.prop('contractorName'),$.i18n.prop('contractorCode'),$.i18n.prop('truckType'),$.i18n.prop('tbPlanBeginDate'),$.i18n.prop('tbCreateDate'),
            	$.i18n.prop('trucknoq'),$.i18n.prop('trucknog'),$.i18n.prop('driverCode'),$.i18n.prop('driverName'),$.i18n.prop('driverTel'),$.i18n.prop('currentLocationDate'),
            	$.i18n.prop('currentLocation'),$.i18n.prop('carrierState'),$.i18n.prop('sumPcs'),$.i18n.prop('sumGwt'),
            	$.i18n.prop('sumVol'),$.i18n.prop('isabnormal'),$.i18n.prop('ywLocation'),$.i18n.prop('getState'),$.i18n.prop('payState'),
            	$.i18n.prop('getMode'),$.i18n.prop('payMode'),$.i18n.prop('trainnoType'),$.i18n.prop('fareData'),$.i18n.prop('createBy'),
            	$.i18n.prop('createDate')
            ],
            colModel : [
                { name: 'sn', index: 'a.sn',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
                { name: 'guid', index: 'a.guid',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
                { name: 'state', index: 'a.state',align: 'center', sorttype: 'string',stype: 'select', search: true, sortable: false, width: 60, 
                	formatter: function (value, grid, rows) { 
                		return stateTextObj[value];
            		},
            		searchoptions : {
            			value : stateInnerHtml , sopt : ['cn']
            		}
                
                },
                { name : 'cusWeituo', index: 'a.cus_weituo', key : true, align : 'center', sorttype: 'string', sortable : false,width:80},
            	{ name : 'cusName', index: 'a.cus_no', align : 'center', stype: 'select', search: true,width:130,searchoptions : { value : customerInnerHtml,sopt: ['cn','eq','ne']}},
            	{ name : 'cusNo', index: 'a.cusNo', align : 'center', stype: 'select',type: 'string', sortable : false,hidden: true ,search: true,width:80 },
            	{ name: 'withinCode', index: 'a.within_code',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'trainNo', index: 'a.trainno',  key: true,align: 'center', sorttype: 'string', search: true, sortable: false, width: 130,searchoptions : {sopt : ['cn']}},
            	{ name : 'planBeginDate', index : 'a.plan_begin_date', align : 'center', width:80,isSort : false,search : true, type : 'string',
            		searchoptions: {
            			dataInit: function(elem){
	            			jQuery(elem).click(function(){
	            				WdatePicker({
	            					onpicked:function(){jQuery(elem).change();searchData()},
	            					onclearing:function(){jQuery(elem).val("");searchData();}
	            				});
	            			});
            			},attr:{title:'Select Date'},sopt:['cn']
           			},
           			formatter:'date',
           			formatoptions:{srcformat:'Y-m-d',newformat:'Y-m-d'},
            	},
            	{ name : 'beginDate', index : 'a.begin_date', align : 'center', isSort : false,search : true, type : 'string', searchoptions : { sopt : ['cn', 'eq', 'ne']},hidden: true},
            	{ name : 'endDate', index : 'a.end_date', align : 'center', isSort : false,search : true, type : 'string', searchoptions : { sopt : ['cn', 'eq', 'ne']},hidden: true},
            	{ name: 'weituoType', index: 'a.weituo_type',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name : 'transportType', index : 'a.transport_type', align : 'center', isSort : false,stype : 'select', type: 'string', search : true ,width:80,
            		/* searchoptions : {value : { '' : $.i18n.prop('SctsUserMail_Txt_All'), 'Y' : 'Yes', 'N' : 'No' }, sopt : [ 'eq' ]}, */
            		formatter: function (value, grid, rows) { 
            			switch(value){
	            			case "0":
	            				return $.i18n.prop('Steam transportation');
	            			case "1":
	                			return $.i18n.prop('Express');
	            			case "2":
	                			return $.i18n.prop('Railway transportation');
	            			case "3":
	                			return $.i18n.prop('waterway');
	            			case "4":
	                			return $.i18n.prop('Intermodal transport');
            			}
            		},
            		searchoptions : {
            			value : transportTypeInnerHtml , sopt : ['eq']
            		}
            	},
            	{ name : 'beginCity', index : 'a.begin_city', align : 'center', width : 100, search : true,type : 'string' ,stype: 'select',
            		searchoptions : {
            			value : cityInnerHtml, sopt : ['eq']
            		}
            	},
	            { name : 'endCity', index : 'a.end_city', align : 'center', width : 80, type : 'string', search : true,stype: 'select',
            		searchoptions : {
            			value : cityInnerHtml, sopt : ['eq']
            		}	
	            },
            	{ name : 'trainType', index : 'a.train_type', align : 'center', width : 60, search : true,stype : 'select',type : 'string', searchoptions : {value : truckTypeInnerHtml, sopt : ['cn', 'eq', 'ne']} },
            	{ name: 'planTruckType', index: 'a.plan_trucktype',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name : 'contractorName', index : 'a.contractor_name', width : 220, align : 'left', isSort : false,stype : 'select', search : true,
            		searchoptions : {
            			value : contractorNameInnerHtml, sopt : ['eq']
            		}
            	},
            	{ name: 'truckType', index: 'a.truckType',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'contractorCode', index: 'a.contractor_code',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'tbPlanBeginDate', index: 'a.tb_plan_begin_date',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'tbCreateDate', index: 'a.tb_create_date',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'trucknoq', index: 'a.trucknoq',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'trucknog', index: 'a.trucknog',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'driverCode', index: 'a.driver_code',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'driverName', index: 'a.driver_name',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'driverTel', index: 'a.driver_tel',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'currentLocationDate', index: 'a.current_location_date',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'currentLocation', index: 'a.current_location',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'carrierState', index: 'a.carrier_state',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'sumPcs', index: 'a.sum_pcs',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'sumGwt', index: 'a.sum_gwt',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'sumVol', index: 'a.sum_vol',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'isabnormal', index: 'a.isabnormal',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'ywLocation', index: 'a.yw_location',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'getState', index: 'a.get_state',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'payState', index: 'a.pay_state',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'getMode', index: 'a.get_mode',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'payMode', index: 'a.pay_mode',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'trainnoType', index: 'a.trainno_type',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'fareData', index: 'a.fare_data',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'createBy', index: 'a.create_by',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
            	{ name: 'createDate', index: 'a.create_date',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true }
            	
            ],
            shrinkToFit : false,
            altRows : true,
            autoScroll: true, 
            altclass : 'gridSpacingClass',
            forceFit : true,
            cellLayout : 0,
            scroll : true,
            autowidth : true,
            sortname : 'a.create_date',
            sortorder : 'desc', 
            loadonce : false,
            mtype : 'POST',
            viewrecords : true,
            rownumbers : true,
            multiselect : true,
            subGrid : true,//开启子表格支持 
            rowNum : 15,
            height : '100%',
            rowList : [15, 20, 30, 50],
            pager : '#gridPager',
            jsonReader : {
                root : 'rows',
                total : 'total',
                page : 'page',
                records : 'records',
                repeatitems : false
            },
            gridComplete : function() {
            	setGridHeightWidth();
                $('.cbox').shiftSelect();
            },
            loadComplete : function(xhr) {
            },
            subGridRowExpanded : function(subgrid_id, row_id){//加载子表格
            	//alert("添加详细列表")
        		var rowData = $("#gridTable").jqGrid('getRowData', row_id);
        		sn = rowData.sn;
        		trainno = rowData.trainNo;
        		cusNo = rowData.cusNo;
        		var subgrid_table_id;  
                subgrid_table_id = subgrid_id + "_t";   // (3)根据subgrid_id定义对应的子表格的table的id  
                var addText = $.i18n.prop('order_detail_add');
                var delText = $.i18n.prop('order_detail_del');
                var subgrid_pager_id;  
                subgrid_pager_id = subgrid_id + "_pgr"  // (4)根据subgrid_id定义对应的子表格的pager的id  
                  
                // (5)动态添加子报表的table和pager   
                $("#" + subgrid_id).html("<table id='"+subgrid_table_id+"' class='scroll'></table><div id='"+subgrid_pager_id+"' class='scroll'></div>");  
                  
                // (6)创建jqGrid对象   
                $("#" + subgrid_table_id).jqGrid({  
                    url: '../../order/findOrderList?t=' + Math.random()+'&customSearchFilters=' + encodeURI(getSearchOrderListFilters()),  // (7)子表格数据对应的url，注意传入的contact.id参数
                    datatype: "json",  
                    colNames: [$.i18n.prop('sn'),$.i18n.prop('guid'),$.i18n.prop('withinCode'),
                	$.i18n.prop('cusNo'),$.i18n.prop('cusName'),$.i18n.prop('businessYwId'),$.i18n.prop('businessDate'),$.i18n.prop('goodsName'),
                	$.i18n.prop('unit'),$.i18n.prop('vol'), $.i18n.prop('gwt'), $.i18n.prop('qty'),$.i18n.prop('beginLocalAddress'),$.i18n.prop('endLocalAddress')],
                    colModel: [ 
						/* { name :'add',width:40 , index : 'add' ,align:'center',formatter:function(value,row,rowIndex){return "<a style='text-decoration:underline;color:blue;' href='javascript:addOpen("+row.rowId+",\"gridTable\")'>"+addText+"</a>";"<a style='text-decoration:underline;color:blue;' href='javascript:addRow("+row.rowId+",\"gridTable\")'>"+addText+"</a>";}},
						{ name :'delete',width:40 , index : 'delete' ,align:'center',formatter:function(value,row,rowIndex){return "<a style='text-decoration:underline;color:blue;' href='javascript:deleteRow("+row.rowId+",\"gridTable\")'>"+delText+"</a>";"<a style='text-decoration:underline;color:blue;' href='javascript:deleteRow("+row.rowId+",\"gridTable\")'>"+delText+"</a>";}}, */
                        { name: 'sn', index: 'sn',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
		                { name: 'GUID', index: 'GUID',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 40, hidden: true },
		                { name : 'within_Code', index: 'within_Code', key : true, align : 'center', sorttype: 'string', sortable : false,hidden: true},
		            	{ name: 'CUS_NO', index: 'CUS_NO',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false,hidden: true },
		            	{ name: 'NAME', index: 'NAME',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false},
		            	{ name: 'BUSINESS_YW_ID', index: 'BUSINESS_YW_ID',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false,width: 80},
		            	{ name: 'BUSINESS_DATE', index: 'BUSINESS_DATE',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false, width: 75},
		            	{ name : 'GOODS_NAME', index : 'GOODS_NAME', align : 'center', isSort : false,search : true, type : 'string', searchoptions : { sopt : ['cn', 'eq', 'ne']} },
		            	{ name : 'UNIT', index : 'UNIT', align : 'center', isSort : false,stype : 'select', search : true,hidden: true },
		            	{ name : 'VOL', index : 'VOL', align : 'center', width : 100, search : true,type : 'string' },
			            { name : 'GWT', index : 'GWT', align : 'center', width : 100, stype : 'select', search : true},
		            	{ name : 'QTY', index : 'QTY', align : 'center', width : 100, search : true,type : 'string', searchoptions : { sopt : ['cn', 'eq', 'ne']} },
		            	{ name: 'BEGIN_LOCAL_ADDRESS', index: 'BEGIN_LOCAL_ADDRESS',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false,width: 150},
		            	{ name: 'END_LOCAL_ADDRESS', index: 'END_LOCAL_ADDRESS',  key: true,align: 'center', sorttype: 'string', search: false, sortable: false,width: 150},
                    ],  
                    jsonReader: {   // (8)针对子表格的jsonReader设置  
                        root:"rows",  
                        records: "record",  
                        repeatitems : false  
                    },  
                    prmNames: {search: "search"},  
                    pager: subgrid_pager_id,  
                    viewrecords: true,  
                    height: "100%",  
                    rowNum: 5,
                    ondblClickRow:function(row_id){
                    	
                    },
               }
                ); 
                
                var addBtn = $("#" + subgrid_table_id).parents(".tablediv:first").find("#add");
                addBtn.parents("th").unbind("click").find("*").unbind("click");
            }
        });

        $('#gridTable').jqGrid('navGrid', '#gridPager',
        		{ add: false, edit: false, del: false, refresh: true }, {}, {}, {},
        		{ multipleSearch: true, closeOnEscape: true, closeAfterSearch: true });
        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
            caption: $.i18n.prop('PlanExec_ReorderColumns'),// 设置列
            title: 'Reorder Columns',
            onClickButton: toggleGridColumns
        });

        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
            caption: $.i18n.prop('PlanExec_QuickSearch'),// 快捷搜索
            title: 'Quick Search',
            onClickButton: toggleGridSearchToolbar
        });
        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
       		caption: $.i18n.prop('PlanExec_ExportDatas'),// 导出数据
            title: 'Export Datas',
            buttonicon: 'ui-icon-disk',
            onClickButton: function() {
          		ExportToExcel.call(this, { title:$.i18n.prop('all.vehicle.depute')});
            }
        });
        setGridHeightWidth();
    };
    
    //修改添加表格JS
    // 自定义窗体
    
	    	// 初始化车型下拉框
	    	$("#trainType").combobox({
	    		valueField : "code",
	    		textField : "name",
	    		method : "GET",
	    		loader:function(param,success,error){  
	                $.ajax({  
	                    url:"../../dictionary/findTruckType",
	                    dataType: 'json',  
	                    method:"GET",
	                    success: function(data){
	                    	success(data.resultDataFull); 
	                    } 
	                }); 
	            }
	    	});
   	 function getCus() {
   		   $("#cusNo").combobox({
   	 		  valueField: 'code',  
   	 		  textField: 'name',
   	 		  loader:function(param,success,error){  
   	             $.ajax({  
   	                 url:"../../bussiness/planExec/findCusWithCurrentWithinCode?t=" + Math.random(),
   	                 dataType: 'json',  
   	                 method:"GET",
   	                 async : false,
   	                 success: function(data){
   	                	 customerInnerHtml = {'': $.i18n.prop('all') };
   	                	 data.unshift({code:'','name':$.i18n.prop('all')});
   	                	 data.forEach(function(item){
   	                		 customerInnerHtml[item.code] = item.name;
   	                 	});
   	                 	success(data); 
   	                 } 
   	             }); 
   	         },
   	 		onLoadSuccess : comboDefault,
   	 		onChange : searchData
   	 	});
   	   }
   	var comboDefault = function(){
   	   	$(this).combobox("setValue", $.i18n.prop('all'));
   	   }
   
   //用户选择时间后马上进行查询(前) 
	    $('#beginTime').datebox({
	    	onChange: function(date){
	    		if (date == "") {
			       $("#beginTime").datebox('setValue','')
			       document.getElementById("search").click();
				}else{
			       searchData();
				}
		    },
		    onSelect : function(beginDate) {
		    	$("#endTime").datebox().datebox("calendar").calendar({
		    		validator : function(endDate) {
		    			return beginDate <= endDate;
		    		}
		    	});
		    }
		}); 
   //用户选择时间后马上进行查询(后) 
	   $('#endTime').datebox({
		   onChange: function(date){
	       if (date == "") {
		       $("#endTime").datebox('setValue','')
		       document.getElementById("search").click();
			}else{
		       searchData();
			}
	    }
	});
	   
   function loadState() {
		var state = [{'name':$.i18n.prop('all'),'code':''}];
		state.push({'name':$.i18n.prop('normal'),'code':'0'});
		state.push({'name':$.i18n.prop('toExamine'),'code':'1'});
		state.push({'name':$.i18n.prop('dispatched'),'code':'2'});
		state.push({'name':$.i18n.prop('transportation'),'code':'3'});
		state.push({'name':$.i18n.prop('transportationCompletion'),'code':'4'});
		state.push({'name':$.i18n.prop('alreadyWrittenOff'),'code':'5'});
		state.push({'name':$.i18n.prop('halfwayOff'),'code':'6'});
		$("#searchState").combobox({
			valueField : "code",
			textField : "name",
			multiple : true,
			labelSeparator : ',',
			displaySeparator : ',',
			valueSeparator : ',',
			loader : function(params, success, error) {
				success(state);
				$("#searchState").combobox("setValue", "");
			},
			formatter : function(row) {
				var opts = $(this).combobox("options");
				return '<input type="checkbox" class="combobox-checkbox">' + row[opts.textField];
			},
			onLoadSuccess : function() {
				$("#searchState").combobox("setValue", '');
				var opts = $(this).combobox("options");
				var target = this;
				var values = $(target).combobox("getValues");
				$.map(values, function(value) {
					var el = opts.finder.getEl(target,value);
					el.find('input.combobox-checkbox')._propAttr("checked", true);
				})
			},
			onSelect : function(row) {
				var opts = $(this).combobox('options');
				$("#searchState").val($(this).combobox("getValues"));
				
				var comboList = $(this).combobox("getValues");
				var comboText = $(this).combobox("getText").split(",");
				var newComboList = [];
				if (comboList != null && comboList != undefined) {
					for(var i = 0 ; i < comboList.length ; i ++){
						var code = comboList[i];
						if(code == "") {
							var el = opts.finder.getEl(this,code);
						    el.find('input.combobox-checkbox')._propAttr('checked', false);
						}
					}
					for (var i = 0; i < comboList.length; i++) {
						if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
							newComboList.push(comboList[i]);
						} else {
							if (i != 0) {
								var selectData = $(this).combobox("getData");
								for(var i = 0 ; i < selectData.length; i++) {
									var code = selectData[i].code;
									if(code != '') {
										var el = opts.finder.getEl(this, code);  
			                            el.find('input.combobox-checkbox')._propAttr('checked', false);
									}
								}
								newComboList = [ "" ];
								break;
							} 
						}
					}
				}
				if (newComboList.length <= 0) {
					newComboList = [ "" ];
				}
				$(this).combobox('setValues', newComboList);
				var el = opts.finder.getEl(this, row[opts.valueField]);
                el.find('input.combobox-checkbox')._propAttr('checked', true);
				searchData();
				
			},
			onUnselect : function(row){
				var opts = $(this).combobox('options');
				$(this).val($(this).combobox("getValues"));
				
				var comboList = $(this).combobox("getValues");
				var comboText = $(this).combobox("getText").split(",");
				var newComboList = [];
				if (comboList != null && comboList != undefined) {
					for (var i = 0; i < comboList.length; i++) {
						if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
							newComboList.push(comboList[i]);
						} else {
							if (i != 0) {
								newComboList = [ "" ];
								
								break;
							}
						}
					}
				}
				if (newComboList.length <= 0) {
					newComboList = [ "" ];
				}
				$(this).combobox('setValues', newComboList);
				var el = opts.finder.getEl(this, row[opts.valueField]);
                el.find('input.combobox-checkbox')._propAttr('checked', false);
				searchData();
			}
		});
		stateInnerHtml = {'':$.i18n.prop('all')};
		state.forEach(function(item){
			stateInnerHtml[item.code] = item.name;
		})
	}
	   
	   
	var getStateValue= function(value){
		switch(value){
			case $.i18n.prop('normal'):
				return 0;
			case $.i18n.prop('toExamine'):
						return 1;
			case $.i18n.prop('dispatched'):
						return 2;
			case $.i18n.prop('transportation'):
						return 3;
			case $.i18n.prop('transportationCompletion'):
						return 4;
			case $.i18n.prop('alreadyWrittenOff'):
				return 5;
			case $.i18n.prop('halfwayOff'):
				return 6;
		}
	} 
	
    //加载运输方式 
    function loadTransportType(){
    	$.ajax({
	    	url : "../../sysInfo/dictionaryData/getDictionaryDataList?t=" + Math.random()+"&dicTypeCode=transportType",
	    	method : "GET",
	    	async : false,
	    	success : function(data) {
	    		transportTypeInnerHtml = {'':$.i18n.prop('all')};
	    		data.forEach(function(item){
	    			transportTypeInnerHtml[item.dicValue] = item.dicText;
	    		});
	    	}
    	});
    }
    
    //加载车型
    function loadTruckType() {
    	 $.ajax({  
             url:"../../bussiness/planExec/findTruckTypeWithCurrentWithinCode?t=" + Math.random(),
             method:"GET",
             async : false,
             success: function(data){
             	truckTypeInnerHtml = {'' : $.i18n.prop('all')};
             	data.forEach(function(item){
             		truckTypeInnerHtml[item.code] = item.name;
             	});
             } 
         }); 
    }
    
    var loadAddress = function(){
    	$("#tipinputbegin,#tipinputend").combobox({
    		valueField : 'code',
    		textField : 'name',
    		loader : function(param,success,error) {
    			$.ajax({
    				url : '../../order/getlocation?t='+Math.random(),
    				dataType : 'json',
    				method : 'POST',
    				async : false,
    				success : function(data){
    					var supArr = [];
    					supArr.unshift({code : '', name : $.i18n.prop('all')});
    					cityInnerHtml = {'' : $.i18n.prop('all')};
    					data.resultDataFull.forEach(function(item){
	    					supArr.push({code : item.city,name : (item.cityZjm + "-" + item.city)});
	    					cityInnerHtml[item.city] = item.cityZjm + "-" + item.city;
    					});
    					success(supArr);
    					$("#tipinputbegin,#tipinputend").combobox('setValue',"");
    				}
    			});
    		},
    		onChange : searchData
    	});
    }
    
    var ywlocation = $.cookie("OSUN_whcenter");
	function loadYwLocation(){
		$.ajax({
			url : '../../bussiness/planExec/getywlocation?t=' + Math.random(),
			type : 'POST',
			async : false,
			success : function(data){
				var data = data.resultDataFull;
				data.unshift({CODE:'','NAME':$.i18n.prop('all')});
				$("#ywLocation").combobox({
	    			valueField : "CODE",
	    			textField : "NAME",
	    			multiple : true,
	    			labelSeparator : ',',
					displaySeparator : ',',
					valueSeparator : ',',
					loader : function(params,success,error){
						var cookLocation = ywlocation.split(",");
						var dataLocation = [];
						for(var i = 0 ; i < cookLocation.length; i++) {
							for(var j = 0 ; j < data.length; j++) {
								if(cookLocation[i] == data[j].CODE) {
									dataLocation[i] = data[j];									
								}
							}
						}
						dataLocation.unshift({'CODE': '', 'NAME': $.i18n.prop('all')});
						success(dataLocation);
					},
	    			onLoadSuccess : function(){
	    				var currentYwLocation = ywlocation.split(",");
	    				if(currentYwLocation.length == 1) {
	    					$("#ywLocation").combobox("select",currentYwLocation[0]);
	    				} else {
	    					$("#ywLocation").combobox("select","");
	    				}
	    				var opts = $(this).combobox("options");
						var target = this;
						var values = $(target).combobox("getValues");
						$.map(values, function(value) {
							var el = opts.finder.getEl(target,value);
							el.find('input.combobox-checkbox')._propAttr("checked", true);
						});
	    			},
	    			formatter : function(row) {
	    				var opts = $(this).combobox("options");
	    				return '<input type="checkbox" class="combobox-checkbox">' + row[opts.textField];
	    			},
	    			onSelect : function(row) {
	    				var opts = $(this).combobox('options');
						$(this).combobox("getValues");
						
						var comboList = $(this).combobox("getValues");
						var comboText = $(this).combobox("getText").split(",");
						var newComboList = [];
						if (comboList != null && comboList != undefined) {
							for(var i = 0 ; i < comboList.length ; i ++){
								var code = comboList[i];
								if(code == "") {
									var el = opts.finder.getEl(this,code);
								    el.find('input.combobox-checkbox')._propAttr('checked', false);
								}
							}
							for (var i = 0; i < comboList.length; i++) {
								if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
									newComboList.push(comboList[i]);
								} else {
									if (i != 0) {
										var selectData = $(this).combobox("getData");
										for(var i = 0 ; i < selectData.length; i++) {
											var code = selectData[i].CODE;
											if(code != '') {
												var el = opts.finder.getEl(this, code);  
					                            el.find('input.combobox-checkbox')._propAttr('checked', false);
											}
										}
										newComboList = [ "" ];
										break;
									}
								}
							}
						}
						if (newComboList.length <= 0) {
							newComboList = [ "" ];
						}
						$(this).combobox('setValues', newComboList);
						var el = opts.finder.getEl(this, row[opts.valueField]);
	                    el.find('input.combobox-checkbox')._propAttr('checked', true);
						searchData();
	    			},
	    			onUnselect : function(row){
						var opts = $(this).combobox('options');
						$(this).val($(this).combobox("getValues"));
						
						var comboList = $(this).combobox("getValues");
						var comboText = $(this).combobox("getText").split(",");
						var newComboList = [];
						if (comboList != null && comboList != undefined) {
							for (var i = 0; i < comboList.length; i++) {
								if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
									newComboList.push(comboList[i]);
								} else {
									if (i != 0) {
										newComboList = [ "" ];
										
										break;
									}
								}
							}
						}
						if (newComboList.length <= 0) {
							newComboList = [ "" ];
						}
						$(this).combobox('setValues', newComboList);
						var el = opts.finder.getEl(this, row[opts.valueField]);
	                    el.find('input.combobox-checkbox')._propAttr('checked', false);
						searchData();
					}
				});
				
			}
		});	 
	}
	
	var loadContractorName = function() {
		$.ajax({  
			url:"../../jcda/contractor/findAllListWithLocation?&t=" + Math.random(),
			method:"GET",
			async : false,
			success: function(data){
				contractorNameInnerHtml = {'' : $.i18n.prop('all')};
				data.forEach(function(item){
					contractorNameInnerHtml[item.name] = item.name;
				}); 	
			} 
		}); 
	}
	
	   var loadCitySelector = function() {
			var city = $(".city_a_le1 a"); //城市
	    	var beginCity = $("#tipinputbegin").textbox("textbox");
	    	var endCity = $("#tipinputend").textbox("textbox");
	    	inCity.width = "345";//城市选择框 宽
	    	inCity.height = "auto"; //城市选择框高
	    	inCity.id = "#in_city";  //城市选择框  父级ID
	        inCity.Children = '.city_a_le1';  //城市名box
	        // 初始化 城市HTML模板
	        $(inCity.id).prepend(inCity._template.join(''));
	        
	        inCity.Hot(city);
	     	//城市 导航
	        var apay = $(".screen a");

	        var placeThis; //当前选择标签
	        apay.click(function(obj){  //城市导航
	            inCity.payment($(this));
	        })

	        inCity.place(beginCity); //出发地
	        inCity.destination(endCity);  //目的地
	        inCity.cityClick(city); //显示赋值城市
		}
	   
</script>
</body>
</html>
  
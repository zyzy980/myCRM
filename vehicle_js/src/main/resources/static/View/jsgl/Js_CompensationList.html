<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <link id="CustomTheme" type="text/css" rel="stylesheet" href="../../Resource/css/index/customLightBlue.css" />
    <link id="EasyuiTheme" type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/easyuiLightBlue.css" />
    <link id="JqgridTheme" type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/icon.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/moment/css/daterangepicker.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/fileUpload/css/fileUpload.css" />
    <title>结算补差集合</title>
</head>
<body>
<div id="toolbar" class="easyui-panel" style="padding:4px;border-width:0;border-bottom-width:1px;">
    #{PAGE_TOOLBAR_BUTTONROLE}
</div>
<div class="searchParamesPanel">
    <table id="searchParamesTable">
        <tr class="searchParamesTrShow">
            <td class="searchParamesTdTitle">
                起运时间:
            </td>
            <td class="searchParamesTdControl">
                <input type="text" name="begin_date_start" id="begin_date_start" class="easyui-datebox" style="width: 100px" />
            </td>
            <td class="searchParamesTdTitle">
                -
            </td>
            <td class="searchParamesTdControl">
                <input type="text" name="begin_date_end" id="begin_date_end" class="easyui-datebox" style="width: 100px" />
            </td>
            <td width="20px;"></td>
            <td class="searchParamesTdTitle">
                起运地
            </td>
            <td class="searchParamesTdControl">
                <input type="text" name="begin_city" id="begin_city" class="easyui-combobox" style="width: 100px" />
            </td>
            <td width="20px;"></td>
            <td class="searchParamesTdTitle">
                客户:
            </td>
            <td class="searchParamesTdControl">
                <input type="text" name="cus_no" id="cus_no" class="easyui-combobox" />
            </td>
            <td width="20px;"></td>
            <td class="searchParamesTdTitle">状态:</td>
            <td class="searchParamesTdControl">
                <input type="text" name="state" id="state" class="easyui-combobox"/>
            </td>
            <td class="searchParamesTdControl">
                <input type="text" id="common_sheet_title" class="easyui-textbox" style="width: 240px" />
            </td>
        </tr>
        <tr class="searchParamesTrShow">
            <td class="searchParamesTdTitle">
                收车时间:
            </td>
            <td class="searchParamesTdControl">
                <input type="text" name="end_date_start" id="end_date_start" class="easyui-datebox" style="width: 100px" />
            </td>
            <td class="searchParamesTdTitle">
                -
            </td>
            <td class="searchParamesTdControl">
                <input type="text" name="end_date_end" id="end_date_end" class="easyui-datebox" style="width: 100px" />
            </td>
            <td width="20px;"></td>
            <td class="searchParamesTdTitle">
                目的地
            </td>
            <td class="searchParamesTdControl">
                <input type="text" name="end_city" id="end_city" class="easyui-combobox" style="width: 100px" />
            </td>
            <td width="20px;"></td>
            <td class="searchParamesTdTitle">
                承运商:
            </td>
            <td class="searchParamesTdControl">
                <input type="text" name="carrier_no" id="carrier_no" class="easyui-combobox" />
            </td>
            <td width="20px;"></td>
            <td class="searchParamesTdTitle">类型:</td>
            <td class="searchParamesTdControl">
                <input type="text" name="state" id="type" class="easyui-combobox"/>
            </td>
            <td class="searchParamesTdControl">
                <div id="divVehicle_Project"></div>
            </td>
        </tr>
    </table>
</div>
<div id="gridControl">
    <table id="gridTable"></table>
    <div id="gridPager"></div>
</div>
<div id="fileUpload" style="position: absolute; center: 50%; top: 50%;
	 width: 600px; height: 400px; margin-center: -300px; margin-top: -200px; display: none;"></div>
<script type="text/javascript" src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonControl.js"></script>
<script type="text/javascript" src="../../Resource/js/base/globalVariable.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonBusiness.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/jquery.jqGrid.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
<script type="text/javascript" src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../../Resource/js/moment/js/moment.min.js"></script>
<script type="text/javascript" src="../../Resource/js/moment/js/jquery.daterangepicker.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/upload.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/file.js"></script>
<script language="javascript" type="text/javascript">
    $(function() {
        initScript();
        initData();
        initStyle();
    });

    $(window).load(function() {
        hideLoading();
    });

    var initStyle = function() {
        enterTriggerEvent('searchParamesTable', 'searchData');
    };

    var initScript = function() {
        $("#common_sheet_title").textbox({
            prompt: 'VIN/运单号/结算号/结算批次'
        });
        $(window).resize(function() {
            setGridHeightWidth();
            setToolbarHeightWidth();
        });
    };

    // 加载数据
    var initData = function() {
        getDictionaryData([{
            //初始化数据字典
            dicTypeCode : Global_DicType.COMPENSATION_STATE,
            ADD_ALL: true,
            callback : function(callbackData) {
                window.stateMap = {};
                for(var i = 0; i < callbackData.length; i++){
                    stateMap[callbackData[i].dicvalue] = callbackData[i].dictext;
                }
                $("#state").combobox({
                    valueField: 'dicvalue',
                    textField: 'dictext',
                    panelHeight: 100,
                    editable: true,
                    onSelect:function(record){
                        searchData();
                    }
                });
                $("#state").combobox("loadData", callbackData);
            }
        },{
            //初始化数据字典
            dicTypeCode : Global_DicType.COMPENSATION_TYPE,
            ADD_ALL: true,
            callback : function(callbackData) {
                window.typeMap = {};
                for(var i = 0; i < callbackData.length; i++){
                    typeMap[callbackData[i].dicvalue] = callbackData[i].dictext;
                }
                $("#type").combobox({
                    valueField: 'dicvalue',
                    textField: 'dictext',
                    panelHeight: 100,
                    editable: true,
                    onSelect:function(record){
                        searchData();
                    }
                });
                $("#type").combobox("loadData", callbackData);
            }
        },{
            //车辆项目
            dicTypeCode : Global_DicType.Vehicle_Project,
            callback : function(callbackData) {
                window.Vehicle_ProjectList = {};
                for(var i = 0; i < callbackData.length; i++){
                    Vehicle_ProjectList[callbackData[i].dicvalue] = callbackData[i].dictext;
                }
                var formatData = { data: callbackData, needChooseAll: false, chooseAllValue: "", defaultValue: "1",
                    bindBoxName: "divVehicle_Project", bindControlPrefix: "vehicle_project", onClick:function(){
                        searchData();
                    } };
                formatDefaultRadio_Local(formatData);
            }
        },{
            //起运地 - 数据字典
            dicTypeCode: Global_DicType.CITY_ARCHIVE,
            ADD_ALL: true,
            callback: function (callbackData) {
                window.BEGIN_ADDRESSMap = {};
                window.END_ADDRESSMap = {};
                for (var i = 0; i < callbackData.length; i++) {
                    BEGIN_ADDRESSMap[callbackData[i].dicvalue] = callbackData[i].dictext;
                    END_ADDRESSMap[callbackData[i].dicvalue] = callbackData[i].dictext;
                }
                $("#begin_city,#end_city").combobox({
                    valueField: 'dicvalue',
                    textField: 'dictext',
                    panelHeight: 200,
                    editable: true,
                    onSelect:function(){
                        searchData();
                    }
                });
                $("#begin_city,#end_city").combobox("loadData", callbackData);
            }
        }]);

        getBaseData([{
            //初始化承运商档案
            dicTypeCode : Global_BaseDataKey.CR_CUSTOMER,
            callback : function(callbackData) {
                $("#cus_no").combobox({
                    valueField: 'code',
                    textField: 'name',
                    panelWidth: 250,
                    panelHeight: 150,
                    editable: true,
                    onSelect:function () {
                        searchData();
                    }
                });
                callbackData.unshift({code: "", name: "所有"});
                $("#cus_no").combobox("loadData", callbackData);
            }
        },{
            //初始化承运商档案
            dicTypeCode : Global_BaseDataKey.ZD_CARRIER,
            callback : function(callbackData) {
                $("#carrier_no").combobox({
                    valueField: 'code',
                    textField: 'name',
                    panelWidth: 250,
                    panelHeight: 150,
                    editable: true,
                    onSelect:function () {
                        searchData();
                    }
                });
                callbackData.unshift({code: "", name: "所有"});
                $("#carrier_no").combobox("loadData", callbackData);
            }
        }]);
        loadList();// 加载数据列表
    };

    // 查询数据
    function searchData() {
        $('#gridTable').jqGrid('setGridParam', {
            url: getSearchGridUrl(),
            datatype: 'json',
            postData: { 'filters': '' },
            page: 1
        }).trigger('reloadGrid');
    };

    // 获取查询URL
    var getSearchGridUrl = function() {
        var customSearchFilters = encodeURI(getSearchFilters());
        return '../../tzgl/Js_CompensationController/getListForGrid?' + Math.random() + '&customSearchFilters=' + customSearchFilters;
    };

    // 获取查询条件
    var getSearchFilters = function() {
        var end_date_end=$('#end_date_end').datebox('getValue');
        if(end_date_end!="")
            end_date_end=addDate(end_date_end,1);
        var begin_date_end=$('#begin_date_end').datebox('getValue');
        if(begin_date_end!="")
            begin_date_end=addDate(begin_date_end,1);
        var parmsArray = [
            [
                { name: 'vdr_no', value: $('#common_sheet_title').textbox('getValue'), op: 'cn' },
                { name: 'vin', value: $('#common_sheet_title').textbox('getValue'), op: 'cn' },
                { name: 'js_no', value: $('#common_sheet_title').textbox('getValue'), op: 'cn' },
                { name: 'js_batch', value: $('#common_sheet_title').textbox('getValue'), op: 'cn' }
            ],
            {name: 'receipt_date', value: $('#end_date_start').datebox('getValue'), op: 'ge'},
            {name: 'receipt_date', value: end_date_end, op: 'le'},
            {name: 'begin_date', value: $('#begin_date_start').datebox('getValue'), op: 'ge'},
            {name: 'begin_date', value: begin_date_end, op: 'le'},
            { name: 'cus_no', value: $('#cus_no').combobox('getValue'), op: 'eq' },
            { name: 'carrier_no', value: $('#carrier_no').combobox('getValue'), op: 'eq' },
            { name: 'type', value: $("#divStatus [name=type]:checked").val(), op: "eq" },
            { name: 'state', value: $("#divStatus [name=state]:checked").val(), op: "eq" }
        ];
        return formatSearchParames(parmsArray);
    };

    // 加载数据列表
    var loadList = function() {
        $('#gridTable').jqGrid({
            url: getSearchGridUrl(),
            datatype: 'json',
            width: 'none',
            colNames: ['ID','状态','类型','车辆项目','运单号','VIN','起运日期','收车日期','起运地','目的地','小车车型','运输方式','客户编号','客户名称',
                '承运商','承运商名称','经销商名称', '前合同号','前合同类型','后合同号','后合同类型','结算号','结算批次','对账单号','账单编号',
                '对上补差含税总','对上补差不含税总','税额','对下补差含税总','对下补差不含税总','税率','发票号','开票日期',
                '已开票含税总','已开票不含税总','现合同含税总','现合同不含税总','备注','补差人','补差时间','结算数据ID'
            ],
            colModel: [
                { name: 'id', index: 'id', align: 'center', sorttype: 'int', sortable: false, key: true, width: 40, hidden: true, search: false },
                { name: 'state', index: 'state', align: 'center', width: 65, search: false, sortable: false, formatter: function (value, grid, rows) {
                        return window.stateMap[value];
                    }},
                { name: 'type', index: 'type', align: 'center', width: 65, search: false, sortable: false, formatter: function (value, grid, rows) {
                        return window.typeMap[value];
                    }},
                { name: 'vehicle_project', index: 'vehicle_project', align: 'center', width: 65, search: false, sortable: false, formatter: function (value, grid, rows) {
                        return window.Vehicle_ProjectList[value];
                    }},
                { name: 'vdr_no', index: 'vdr_no', align: 'center', width: 130, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'vin', index: 'vin', align: 'center', width: 130, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'begin_date', index: 'begin_date', align: 'center', width: 100, type: 'string', search: true,
                    searchoptions: { sopt: ['le'], dataEvents: [ { type: 'click', data: {}, fn: function() { WdatePicker(); } } ] } },
                { name: 'receipt_date', index: 'receipt_date', align: 'center', width: 100, type: 'string', search: true,
                    searchoptions: { sopt: ['le'], dataEvents: [ { type: 'click', data: {}, fn: function() { WdatePicker(); } } ] } },
                { name: 'begin_city', index: 'begin_city', align: 'center', width: 90, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'end_city', index: 'end_city', align: 'center', width: 90, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'car_type', index: 'car_type', align: 'center', width: 70, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'trans_mode', index: 'trans_mode', align: 'center', width: 70, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'cus_no', index: 'cus_no', align: 'center', width: 100, type: 'string',  search: true, searchoptions: { sopt: ['cn', 'eq', 'ne']} },
                { name: 'cus_name', index: 'cus_name', align: 'center', width: 160, type: 'string',  search: true, searchoptions: { sopt: ['cn', 'eq', 'ne']} },
                { name: 'carrier_no', index: 'carrier_no', align: 'center', width: 100, type: 'string',  search: true, searchoptions: { sopt: ['cn', 'eq', 'ne']} },
                { name: 'carrier_name', index: 'carrier_name', align: 'center', width: 160, type: 'string',  search: true, searchoptions: { sopt: ['cn', 'eq', 'ne']} },
                { name: 'dealer_name', index: 'dealer_name', align: 'center', width: 180, type: 'string',  search: true, searchoptions: { sopt: ['cn', 'eq', 'ne']} },
                { name: 'befor_contract_no', index: 'befor_contract_no', align: 'center', width: 120, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'befor_contract_type', index: 'befor_contract_type', align: 'center', width: 100, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        var contract_type=rows.befor_contract_type;
                        if(contract_type==null)
                        {
                            return "";
                        }else if(contract_type=="0")
                            return "临时合同";
                        else if(contract_type=="1")
                            return "正式合同";
                        else if(contract_type=="2")
                            return "预估合同";
                        return contract_type;
                    }
                },
                { name: 'after_contract_no', index: 'after_contract_no', align: 'center', width: 120, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'after_contract_type', index: 'after_contract_type', align: 'center', width: 100, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        var contract_type=rows.after_contract_type;
                        if(contract_type==null)
                        {
                            return "";
                        }else if(contract_type=="0")
                            return "临时合同";
                        else if(contract_type=="1")
                            return "正式合同";
                        else if(contract_type=="2")
                            return "预估合同";
                        return contract_type;
                    }
                },
                { name: 'js_no', index: 'js_no', align: 'center', width: 130, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'js_batch', index: 'js_batch', align: 'center', width: 130, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'dz_sheet', index: 'dz_sheet', align: 'center', width: 90, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] },hidden:true },
                { name: 'bill_number', index: 'bill_number', align: 'center', width: 90, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'tax_up_total', index: 'tax_up_total', align: 'right', width: 120, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        return keepTwoPointData(rows.tax_up_total);
                    }},
                { name: 'ntax_up_total', index: 'ntax_up_total', align: 'right', width: 120, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        return keepTwoPointData(rows.ntax_up_total);
                    }},
                { name: 'tax_amount', index: 'tax_amount', align: 'right', width: 120, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        return keepTwoPointData(rows.tax_amount);
                    }},
                { name: 'tax_down_total', index: 'tax_down_total', align: 'right', width: 120, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        return keepTwoPointData(rows.tax_down_total);
                    }},
                { name: 'ntax_down_total', index: 'ntax_down_total', align: 'right', width: 120, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        return keepTwoPointData(rows.ntax_down_total);
                    }},
                { name: 'tax_rate', index: 'tax_rate', align: 'right', width: 80, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        var tax_rate=rows.tax_rate;
                        if(tax_rate>0)
                        {
                            tax_rate= (tax_rate*100).toString()+"%";
                        }
                        return tax_rate;
                    }
                },
                { name: 'invoice_no', index: 'invoice_no', align: 'center', width: 120, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'invoice_date', index: 'invoice_date', align: 'center', width: 120, search: true, type: 'string',
                    searchoptions: { sopt: ['ge'], dataEvents: [ { type: 'click', data: {}, fn: function() { WdatePicker(); } } ] } },
                { name: 'old_tax_amount', index: 'old_tax_amount', align: 'right', width: 100, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        return keepTwoPointData(rows.old_tax_amount);
                    }},
                { name: 'old_ntax_amount', index: 'old_ntax_amount', align: 'right', width: 100, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        return keepTwoPointData(rows.old_ntax_amount);
                    }},
                { name: 'now_tax_amount', index: 'now_tax_amount', align: 'right', width: 100, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        return keepTwoPointData(rows.now_tax_amount);
                    }},
                { name: 'now_ntax_amount', index: 'now_ntax_amount', align: 'right', width: 100, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] }
                    ,formatter: function (value, grid, rows) {
                        return keepTwoPointData(rows.now_ntax_amount);
                    }},
                { name: 'remark', index: 'remark', align: 'center', width: 160, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'create_by', index: 'create_by', align: 'center', width: 160, type: 'string', search: true, searchoptions: { sopt: ['cn', 'eq', 'ne'] } },
                { name: 'create_date', index: 'create_date', align: 'center', width: 120, search: true, type: 'string',
                    searchoptions: { sopt: ['ge'], dataEvents: [ { type: 'click', data: {}, fn: function() { WdatePicker(); } } ] } },
                { name: 'vin_id', index: 'vin_id', align: 'center', sorttype: 'int', sortable: false, width: 40, hidden: true, search: false }

            ],
            shrinkToFit: false,
            altRows: true,
            altclass: 'gridSpacingClass',
            forceFit: true,
            cellLayout: 0,
            scroll: false,
            autowidth: true,
            sortname: 'id',
            sortorder: 'desc',
            loadonce: false,
            mtype: 'POST',
            viewrecords: true,
            rownumbers: true,
            multiselect: true,
            rowNum: 15,
            height: '100%',
            rowList: [15, 20, 30, 50],
            pager: '#gridPager',
            jsonReader: {
                root: 'rows',
                total: 'total',
                page: 'page',
                records: 'records',
                repeatitems: false
            },
            gridComplete: function() {
                $('.cbox').shiftSelect();
            },
            loadComplete: function(xhr) {
                FailResultDataToTip(xhr);
            }
        });
        $('#gridTable').jqGrid('navGrid', '#gridPager',{
            add : false,
            edit : false,
            del : false,
            refresh : true
        }, {}, {}, {}, {
            multipleSearch : true,
            closeOnEscape : true,
            closeAfterSearch : true
        });
        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
            caption : $.i18n.prop('TOGGLE_GRID_COLUMNS'),
            title : 'Set Columns',
            onClickButton : toggleGridColumns
        });
        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
            caption : $.i18n.prop('TOGGLE_GRID_SEARCH_TOOLBAR'),
            title : 'Quick Search',
            onClickButton : toggleGridSearchToolbar
        });
        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
            caption: $.i18n.prop('EXPORT_TO_EXCEL'),// 导出数据
            title: '补差数据',
            buttonicon: 'ui-icon-disk',
            onClickButton: function () {
                ExportToExcel.call(this, {
                    title : "补差数据"
                });
            }
        });
        setGridHeightWidth();
    };

    function refreshCallerData() {
        searchData();
    }

</script>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link id="CustomTheme" type="text/css" rel="stylesheet" href="../../Resource/css/index/customLightBlue.css" />
    <link id="EasyuiTheme" type="text/css" rel="stylesheet"
        href="../../Resource/js/easyUI/themes/easyuiLightBlue.css" />
    <link id="JqgridTheme" type="text/css" rel="stylesheet"
        href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/icon.css" />
    <link type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
    <link type="text/css" rel="stylesheet" href="../../View/ywgl/css/trainsPlan.css" />
    <link type="text/css" rel="stylesheet" href="css/tyle.css" />
    <title>#{supplier.detail.thisPage}</title>
    <style>
        .searchParamesPanel #searchParamesTable td {
            word-break: keep-all;
            white-space: nowrap;
        }

        .tab-title {
            float: right;
            margin-bottom: -1px;
            overflow-x: hidden;
        }

        .tab-title .item-cur {
            border: 1px solid #02c5bb !important;
            color: #02c5bb !important;
            border-bottom: none;
        }

        #gridTable_1120.tablediv {
            padding: 10px;
        }

        .tab-title .item {
            /*width: 100px;*/
            /*height: 40px;*/
            /*line-height: 39px;*/
            text-align: center;
            display: block;
            float: left;
            border: 1px solid #c3d3ea;
            margin-left: 4px;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            font-size: 12px;
            color: #666;
            width: 90px;
            height: 32px;
            line-height: 32px;
            border-bottom: none;
        }

        p {
            margin: 0 0;
        }

        /*.table-con{ margin:0px 16px 16px;}*/
        .table-list {
            width: 45%;
            font-family: "微软雅黑";
            background: #fff;
        }

        .table-list tr {
            margin: 0;
            color: #666;
            /*font-size: 12px;*/
            height: 20px;
            background-color: #fff;
        }

        .table-title {
            margin: 0;
            background-color: #fff;
            /*font-size: 12px;*/
            color: #666;
            border-bottom: 1px solid #eaeaea;
            height: 20px;
        }

        .url_a {
            color: #0D9BF2 !important;
            /*text-underline: underline;*/
            text-decoration: underline
        }
    </style>
</head>

<body>
    <div id="toolbar" class="easyui-panel" style="border-width: 0; border-bottom-width: 1px;">
        #{PAGE_TOOLBAR_BUTTONROLE}

        <div class="tab-title">
            <a href="javascript:nonstopPlan('TGP');" id="nonstopPlan" class="item">
                <p class="item2">直达车次</p>
            </a>
            <a href="javascript:takeDeliveryPlan('T');" id="takeDeliveryPlan" class="item">
                <p class="item2">提货车次</p>
            </a>
            <a href="javascript:mainProgram('G');" id="mainProgram" class="item">
                <p class="item3">干线车次</p>
            </a>
            <a href="javascript:distributionPlan('P');" id="distributionPlan" class="item">
                <p class="item4">配送车次</p>
            </a>
        </div>
    </div>
    <form id="detailForm" class="easyui-form" method="post" data-options="novalidate:true">
        <div style="width: 100%; height:50px; overflow: hidden;" id="searchForDiv">
            <div style="width: 100%; height: 310px; float: left;">
                <table id="searchParamesTable">
                    <tr class="searchParamesTrShow">
                        <td class="searchParamesTdTitle"><label data-locale="timeAndStop"/>：</td>
                        <td><input name="beginTime" id="beginTime" class="easyui-datebox" data-options="editable:false"
                                style="width: 114px;" /></td>
                        <td class="searchParamesTdTitle" style="text-align: center">-</td>
                        <td><input name="endTime" id="endTime" class="easyui-datebox" data-options="editable:false"
                                style="width: 114px;" /></td>
                        <td class="searchParamesTdTitle"><label data-locale="startAddress"/>：</td>
                        <td><input name="beginLocalAddress" id="tipinputbegin" class="easyui-textbox"
                                style="width: 114px;" />
                        </td>
                        <td class="searchParamesTdTitle"><label data-locale="StopAddress"/>：</td>
                        <td><input name="endLocalAddress" id="tipinputend" class="easyui-textbox"
                                style="width: 114px;" />
                        </td>
                        <!--<td class="searchParamesTdTitle"><label data-locale="businessAddress"/>:</td>-->
                        <!--<td><input type="text" class="easyui-combobox"-->
                        <!--name="ywLocation" id="ywLocation" style="width: 114px;"-->
                        <!--data-options="value:'<label data-locale="all"/>',editable:false" /></td>-->
                    </tr>
                    <tr>
                        <td class="searchParamesTdTitle"><label data-locale="orderNumber"/>：</td>
                        <td><input type="text" name="ywId" id="ywId" class="easyui-textbox" style="width: 114px;" />
                        </td>
                        <td class="searchParamesTdTitle"><label data-locale="costomer"/>：</td>
                        <td><input type="text" name="cusNo" id="cusNo" class="easyui-combobox"
                                data-options="value:'<label data-locale="all"/>',editable:false,panelWidth:'300'" style="width: 114px;" /></td>
                        <td class="searchParamesTdTitle"><label data-locale="state"/>：</td>
                        <td>
                            <input class="easyui-combobox" name="searchState" id="searchState"
                                data-options="panelHeight:'114'" style="width:114px;" />
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </form>
    <div>
        <table id="gridTable2" style="width: 942px"></table>
    </div>
    <div>
        <table id="gridTable" style="width: 942px;"></table>
    </div>
    <div id="in_city" style="display: none"></div>
    <div class="contextMenu" id="menu" style="display: none">
        <ul>
            <li id="autoGenerateTrainno"><label data-locale="menu.autoGeneratorTrainno"/></li>
            <li id="autoTrainno"><label data-locale="menu.generatorTrainno"/></li>
        </ul>
    </div>

    <div class="contextMenu" id="menuTrain" style="display: none">
        <ul>
            <li id="generateTrainno"><label data-locale="menu.generatorTrainno"/></li>
            <li id="deleteTrainno"><label data-locale="menu.theDissolutionOfTrains"/></li>
        </ul>
    </div>
    <script type="text/javascript" src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
    <script type="text/javascript" src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
    <script type="text/javascript" src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyui.min.js"></script>
    <script type="text/javascript" src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyuiExtend.min.js"></script>
    <script type="text/javascript" src="../../Resource/js/base/commonControl.js"></script>
    <script type="text/javascript" src="../../Resource/js/base/globalVariable.js"></script>
    <script type="text/javascript" src="../../Resource/js/base/commonBusiness.js"></script>
    <script type="text/javascript" src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
    <script type="text/javascript" src="../../Resource/js/jqueryUI/jquery.jqGrid.min.js"></script>
    <script type="text/javascript" src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
    <script type="text/javascript" src="../../Resource/js/cookie/jquery.cookie.js"></script>
    <script type="text/javascript" src="../../Resource/js/jquery.contextmenu.r2.js"></script>
    <script language="javascript" type="text/javascript">

        var detailRowNumber = null;
        var child = [];
        var mostlyGuid = null;
        var detailGuid = null;
        var moduleId = 0;
        var valve = 0;//用于判断增加还是修改的阀门值。0代表修改操作，1代表增加操作。
        var savedRow1 = null;
        var savedCol1 = null;
        var savedChildRow1 = null;
        var savedChildCol1 = null;
        var trainNo = null;
        var index = 0;
        var gridTableData = [];
        var cusNoTextObj = [];
        var cusNoValueObj = [];
        var queryConditions = [];
        var routeType = 'TGP';

        var stateTextObj = {
            '0': $.i18n.prop('search.state.noTransport'),
            '1': $.i18n.prop('search.state.approved'),
            '2': $.i18n.prop('search.state.haveSent'),
            '3': $.i18n.prop('search.state.inTheTransport'),
            '4': $.i18n.prop('search.state.transportationTo'),
            '5': $.i18n.prop('search.state.transportationToComplete'),
            '6': $.i18n.prop('search.state.cancel')
        }

        var stateValueObj = {
            $.i18n.prop('search.state.noTransport'): '0',
            $.i18n.prop('search.state.approved'): '1',
            $.i18n.prop('search.state.haveSent'): '2',
            $.i18n.prop('search.state.inTheTransport'): '3',
            $.i18n.prop('search.state.transportationTo'): '4',
            $.i18n.prop('search.state.transportationToComplete'): '5',
            $.i18n.prop('search.state.cancel'): '6'
        }


        var trasportTextObj = [];

        var trasportValueObj = [];

        var getStateTextObj = {
            '0': '未处理',
            '1': '已结算',
            '5': '已收款'
        }

        var getStateValueObj = {
            '未处理': '0',
            '已结算': '1',
            '已收款': '5'
        }

        var payStateTextObj = {
            '0': '未处理',
            '1': '已结算',
            '5': '已付款'
        }

        var payStateValueObj = {
            '未处理': '0',
            '已结算': '1',
            '已付款': '5'
        }

        var weituoTypeTextObj = {
            '0': '整车',
            '1': '零担'
        }

        var weituoTypeValueObj = {
            '整车': '0',
            '零担': '1'
        }
        var ywId = null;

        $(function () {
            var parms = getUrlParms();
            var sn = parms["sn"];
            trainNo = parms["trainNo"];
            if (trainNo != null && trainNo != '' && trainNo != undefined) {
                loadListByTrainno();
            }
            ywId = decodeURI(parms["ywId"]);
            if (ywId != null && ywId != "" && ywId != undefined) {
                loadListByYwId(ywId);
            }
            var jsonList = [];
            var orderDetailGuid = null;
            $("#searchForDiv").hide();
            // loadYwLocation();
            //         loadAddress();
            loadCitySelector();
            loadTransportType();
            loadCusNo();
            loadState();
            initScript();
            //获取mostly表数据
            initData();
            initStyle();
            $("#gview_gridTable2").children("div").children("a").attr("onClick", "packUp()");
            $("#gview_gridTable").children("div").children("a").attr("onClick", "packUp2()");
            nonstopPlan();
        });



        var nonstopPlan = function (routeTypeParams) {
            console.log(routeTypeParams)
            $("#nonstopPlan").addClass('item-cur');
            $("#takeDeliveryPlan").removeClass('item-cur');
            $("#mainProgram").removeClass('item-cur');
            $("#distributionPlan").removeClass('item-cur');
            routeType = routeTypeParams;
            console.log(routeType)
            searchData2();
        }

        var takeDeliveryPlan = function (routeTypeParams) {
            $("#nonstopPlan").removeClass('item-cur');
            $("#takeDeliveryPlan").addClass('item-cur');
            $("#mainProgram").removeClass('item-cur');
            $("#distributionPlan").removeClass('item-cur');
            routeType = routeTypeParams;
            searchData2();
        }

        var mainProgram = function (routeTypeParams) {
            $("#nonstopPlan").removeClass('item-cur');
            $("#takeDeliveryPlan").removeClass('item-cur');
            $("#mainProgram").addClass('item-cur');
            $("#distributionPlan").removeClass('item-cur');
            routeType = routeTypeParams;
            searchData2();
        }

        var distributionPlan = function (routeTypeParams) {
            $("#nonstopPlan").removeClass('item-cur');
            $("#takeDeliveryPlan").removeClass('item-cur');
            $("#mainProgram").removeClass('item-cur');
            $("#distributionPlan").addClass('item-cur');
            routeType = routeTypeParams;
            searchData2();
        }

        $(window).load(function () {
            hideLoading();
        });

        var time = function (date) {
            $("[name=planBeginDate]").val(date);
        }

        var initStyle = function () {
            enterTriggerEvent('searchParamesTable', 'searchData2');
        };
        var oldSetGridHeightWidth = setGridHeightWidth;
        var setGridHeightWidth = function () {
            oldSetGridHeightWidth(10, 360, "gridTable2");
            oldSetGridHeightWidth(10, 320, "gridTable");
        };
        var tempSetGridHeightWidth = setGridHeightWidth;
        var initScript = function () {
            $(window).resize(function () {
                setGridHeightWidth();
                setToolbarHeightWidth();
            });
        };

        // 查询数据
        function searchData() {
            for (var i = 0; i < gridTableData.length; i++) {
                gridTableData[i].loadQty = 0;
                gridTableData[i].loadGwt = 0;
                gridTableData[i].loadVol = 0;
            }
            $("#gridTable").jqGrid("clearGridData");
            $('#gridTable').jqGrid('setGridParam', {
                datatype: 'local',
                data: gridTableData,
                page: 1
            }).trigger('reloadGrid');
            commonDrag();
            setGridHeightWidth();
        }

        function searchData2() {
            $('#gridTable2').jqGrid('setGridParam', {
                url: getSearchGridUrl(),
                datatype: 'json',
                postData: { 'filters': '' },
                page: 1
            }).trigger('reloadGrid');
        }

        // 获取查���访问路径
        var getSearchGridUrl = function () {
            return '../../train/trainnolist?t=' + Math.random() + '&customSearchFilters=' + encodeURI(getSearchList());
        };

        // 获取查询条件
        var getSearchFilters = function () {
            var parmsArray = [
                {
                    name: 'o.mostly_guid', value: mostlyGuid, op: "eq"
                }
            ];
            return formatSearchParames(parmsArray);
        };

        var getTrainnoSearchGridUrl = function () {
            // return "../../train/findDataByTrainno?t=" + Math.random() + '&customSearchFilters=' + encodeURI(getTrainSearchList());
            return "../../train/findDataByTrainno?t=" + Math.random() + '&customSearchFilters=' + encodeURI(getSearchList());
        }

        var getTrainSearchList = function () {
            var arr = trainNo.split(",");
            for (var i = 0; i < arr.length; i++) {
                arr[i] = "'" + arr[i] + "'";
            }

            var parmsArray = [
                { name: 'd.trainno', value: arr.join(","), op: 'in' },
                { name: 'm.route_type', value: routeType, op: 'eq' }
            ];
            return formatSearchParames(parmsArray);
        }

        var getYwIdSearchList = function () {
            var arr = ywId.split(",");
            for (var i = 0; i < arr.length; i++) {
                queryConditions.push(arr[i]);
                arr[i] = "'" + arr[i] + "'";
            }
            var parmsArray = [
                { name: 'm.yw_id', value: arr.join(","), op: 'in' },
                { name: 'm.route_type', value: routeType, op: 'eq' }
            ];
            return formatSearchParames(parmsArray);
        }

        var loadListByTrainno = function () {
            $.ajax({
                url: "../../train/findDataByTrainno?t=" + Math.random() + '&customSearchFilters=' + encodeURI(getTrainSearchList()),
                type: 'POST',
                async: false,
                success: function (dataObj) {
                    gridTableData = dataObj.rows;
                    for (var i = 0; i < gridTableData.length; i++) {
                        gridTableData[i].isDelete = "0";//不可以解散车次
                    }
                    searchData();
                }
            });
        }

        // 加载订单列表数据
        var loadList = function () {
            $('#gridTable').jqGrid({
                // data: gridTableData,
                url : getSearchGridUrl(),
                datatype: 'local',
                width: 'none',
                colNames: [
                    $.i18n.prop('state'), $.i18n.prop('sn'), $.i18n.prop('guid'), $.i18n.prop('trainAdd_orderNumber'), $.i18n.prop('createDate'), $.i18n.prop('updateBy'), $.i18n.prop('withinCode'),
                    $.i18n.prop('updateDate'), $.i18n.prop('list.trainno'), '运单号', $.i18n.prop('trainAdd_transportType'), $.i18n.prop('trainAdd_goodsNumber'), $.i18n.prop('cusNo'), $.i18n.prop('trainAdd_goodsName'),
                    '#{vol} /m³', '#{gwt} /kg', '#{qty} /件', $.i18n.prop('businessType'), $.i18n.prop('businessYwId'),
                    $.i18n.prop('businessDate'), $.i18n.prop('shipmentData'), $.i18n.prop('planjiaofuData'), $.i18n.prop('jiaofuData'),
                    $.i18n.prop('beginLocal'), $.i18n.prop('endLocalSite'), $.i18n.prop('nextLocalCode'), $.i18n.prop('contractorCode'),
                    $.i18n.prop('contractorName'), $.i18n.prop('trainAdd_shippingDate'), $.i18n.prop('trainAdd_delegateType'), $.i18n.prop('trainAdd_modeOfTransport'),
                    $.i18n.prop('transportTypeActual'), $.i18n.prop('isAbnormal'), $.i18n.prop('isDelay'), $.i18n.prop('currentLocalLng'), $.i18n.prop('currentLocalLat'),
                    $.i18n.prop('currentLocalDate'), $.i18n.prop('currentLocalAddr'), '收款状态', '付款状态',
                    $.i18n.prop('getMode'), $.i18n.prop('payMode'), $.i18n.prop('shoukuan'), $.i18n.prop('fukuan'), $.i18n.prop('ywLocation'),
                    $.i18n.prop('existDetailChild'), $.i18n.prop('existMultipleTruck'), '', '', '', '', '', '当前车次号', '', '', ''
                ],
                colModel: [
                    {
                        name: 'STATE',
                        index: 'm.state',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true,
                        formatter: function (value, grid, rows) {
                            return stateTextObj[value];
                        }
                    },
                    {
                        name: 'SN',
                        index: 'm.sn',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'GUID',
                        index: 'm.guid',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CREATE_BY',
                        index: 'm.create_by',
                        align: 'center',
                        type: 'string',
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'CREATE_DATE',
                        index: 'm.create_date',
                        align: 'center',
                        type: 'string',
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'UPDATE_BY',
                        index: 'z.update_by',
                        align: 'center',
                        type: 'string',
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'WITHIN_CODE',
                        index: 'm.WITHIN_CODE',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'UPDATE_DATE',
                        index: 'm.update_date',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'TRAINNO',
                        index: 'TRAINNO',
                        align: 'center',
                        type: 'string',
                        search: false,
                        width: 100,
                        hidden: true
                    },
                    {
                        name: 'YW_ID',
                        index: 'm.yw_id',
                        align: 'center',
                        isSort: false,
                        search: false,
                        sortable: false,
                        width: 100,
                        type: 'string'
                    },
                    {
                        name: 'ROUTE_TYPE',
                        index: 'm.route_type',
                        align: 'center',
                        isSort: false,
                        search: false,
                        sortable: false,
                        // hidden: true,
                        width: 100,
                        type: 'string'
                    },
                    {
                        name: 'CONT_ID',
                        index: 'd.cont_id',
                        aling: 'center',
                        search: false,
                        sortable: false,
                        width: 120,
                        type: 'string'
                    },
                    {
                        name: 'CUS_NO',
                        index: 'm.cus_no',
                        align: 'center',
                        isSort: false,
                        search: false,
                        sortable: false,
                        width: 120,
                        type: 'string',
                        formatter: function (value, grid, rows) {
                            return cusNoTextObj[value];
                        }
                    },
                    {
                        name: 'GOODS_NAME',
                        index: 'd.goods_name',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 90
                    },
                    {
                        name: 'VOL',
                        index: 'd.vol',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 90,
                        summaryType: 'sum',
                        summaryTpl: '<b style="color:red;font-size:22px;">{0}</b>'
                    },
                    {
                        name: 'GWT',
                        index: 'd.gwt',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 90,
                        summaryType: 'sum',
                        summaryTpl: '<b style="color:red;font-size:22px;">{0}</b>'
                    },
                    {
                        name: 'QTY',
                        index: 'd.qty',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 90,
                        summaryType: 'sum',
                        summaryTpl: '<b style="color:red;font-size:22px;">{0}</b>'
                    },
                    {
                        name: 'BUSINESS_TYPE',
                        index: 'm.business_type',
                        align: 'center',
                        isSort: false,
                        search: false,
                        sortable: false,
                        width: 40,
                        type: 'string',
                        hidden: true
                    },
                    {
                        name: 'BUSINESS_YW_ID',
                        index: 'm.business_yw_id',
                        align: 'center',
                        type: 'string',
                        search: false,
                        width: 80,
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'BUSINESS_DATE',
                        index: 'm.business_date',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 105
                    },
                    {
                        name: 'SHIPMENT_DATA',
                        index: 'm.shipment_data',
                        align: 'center',
                        isSort: false,
                        width: 80,
                        sortable: false,
                        stype: 'select',
                        search: true,
                        hidden: true
                    },
                    {
                        name: 'PLANJIAOFU_DATA',
                        index: 'm.planjiaofu_data',
                        align: 'center',
                        isSort: false,
                        width: 100,
                        search: false,
                        sortable: false,
                        type: 'string',
                        hidden: true
                    },
                    {
                        name: 'JIAOFU_DATA',
                        index: 'm.jiaofu_data',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'BEGIN_LOCAL',
                        index: 'm.begin_local',
                        align: 'center',
                        isSort: false,
                        width: 300,
                        stype: 'select',
                        sortable: false,
                        search: false
                    },
                    {
                        name: 'END_LOCAL_SITE',
                        index: 'm.end_local_site',
                        align: 'center',
                        sorttype: 'string',
                        width: 300,
                        search: false,
                        sortable: false
                    },
                    {
                        name: 'NEXT_LOCAL_CODE',
                        index: 'm.next_local_code',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CONTRACTOR_CODE',
                        index: 'm.contractor_code',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CONTRACTOR_NAME',
                        index: 'm.contractor_name',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'PLANSHIPMENT_DATA',
                        index: 'm.planshipment_data',
                        align: 'center',
                        isSort: false,
                        width: 100,
                        search: false,
                        sortable: false,
                        type: 'string'
                    },
                    {
                        name: 'WEITUO_TYPE',
                        index: 'm.weituo_type',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 80,
                        formatter: function (value, grid, rows) {
                            return weituoTypeTextObj[value];
                        }
                    },
                    {
                        name: 'TRANSPORT_TYPE_PLAN',
                        index: 'm.transport_type_plan',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 100,
                        formatter: function (value, grid, rows) {
                            return trasportTextObj[value];
                        }
                    },
                    {
                        name: 'TRANSPORT_TYPE_ACTUAL',
                        index: 'm.transport_type_actual',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CURRENT_LOCAL_ADDR',
                        index: 'm.current_local_addr',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'IS_DELAY',
                        index: 'm.is_delay',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CURRENT_LOCAL_LNG',
                        index: 'm.current_local_lng',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CURRENT_LOCAL_LAT',
                        index: 'm.current_local_lat',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CURRENT_LOCAL_DATE',
                        index: 'm.current_local_date',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'IS_ABNORMAL',
                        index: 'm.isabnormal',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'GET_STATE',
                        index: 'm.get_state',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 60,
                        formatter: function (value, grid, rows) {
                            return getStateTextObj[value];
                        },
                        hidden: true
                    },
                    {
                        name: 'PAY_STATE',
                        index: 'm.pay_state',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 60,
                        formatter: function (value, grid, rows) {
                            return payStateTextObj[value];
                        },
                        hidden: true
                    },
                    {
                        name: 'GET_MODE',
                        index: 'm.get_mode',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'PAY_MODE',
                        index: 'm.pay_mode',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'SHOUKUAN',
                        index: 'm.shoukuan',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'FUKUAN',
                        index: 'm.fukuan',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'YW_LOCATION',
                        index: 'm.yw_location',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'EXIST_DETAILCHILD',
                        index: 'm.exist_detail_child',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'EXIST_MULTIPLE_TRUCK',
                        index: 'm.exist_multiple_truck',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    { name: 'YW_LOCATION', index: 'm.yw_locatoin', hidden: true },
                    { name: 'isDelete', index: '', hidden: true },
                    { name: 'TRAINNOGUID', index: '', hidden: true },
                    { name: 'BEGIN_LOCAL_CODE', index: '', hidden: true },
                    { name: 'END_LOCAL_CODE', index: '', hidden: true },
                    { name: 'CURRENTTRAINNO', index: '', hidden: true },
                    { name: 'DETAILGUID', index: '', hidden: true },
                    { name: 'DETAILTRAINNO', index: '', hidden: true },
                    { name: 'DETAILPARENTGUID', index: '', hidden: true }
                ],
                cellEdit: true,
                cellsubmit: 'clientArray',
                shrinkToFit: false,
                altRows: true,
                altclass: 'gridSpacingClass',
                forceFit: true,
                cellLayout: 0,
                scroll: false,
                autowidth: true,
                sortname: 'create_date',
                sortorder: "desc",
                loadonce: false,
                mtype: "POST",
                viewrecords: true,
                rownumbers: true,
                multiselect: true,
                grouping: true,
                rowNum: 15,
                rowList: [100, 200, 300, 500],
                pager: "#gridPager",
                jsonReader: {
                    root: "rows",
                    total: "total",
                    page: "page",
                    records: "records",
                    repeatitems: false
                },
                caption: $.i18n.prop('trainAdd_inProduction'),
                groupingView: {
                    groupField: ['TRAINNO'],
                    groupSummary: [false, false],
                    groupColumnShow: [false, false],
                    groupText: ['<input type="checkbox" class="groupHeader"/> <b>  {0} </b>', "{0} Sum of totaly: {total}"],
                    groupCollapse: false,
                    groupOrder: ['asc']
                },
                loadComplete: function (xhr) {
                    readDraggable();
                    calculateBottomTableSum();
                    commonDrag();
                    $("tr.jqgrow", this).contextMenu('menuTrain', {
                        bindings: { //右键菜单绑定的事件
                            "generateTrainno": function (trigger) {
                                var selectRowItems = getGridParamSelarrrow($("#gridTable"));
                                if (selectRowItems.length == 0) {
                                    errorNotification({ SimpleMessage: $.i18n.prop('generatorFail') });
                                    return;
                                }
                                var list = [];
                                for (var i = 0; i < selectRowItems.length; i++) {
                                    var rowData = $("#gridTable").jqGrid('getRowData', selectRowItems[i]);
                                    list.push(rowData);
                                }
                                bottomDeleteData();
                                var rowDataArray = $("#gridTable").jqGrid('getRowData');
                                var TRAINNO = getTrainno();
                                for (var i = 0; i < list.length; i++) {
                                    list[i].TRAINNO = TRAINNO;
                                    rowDataArray.push(list[i]);
                                }
                                for (var i = 0; i < rowDataArray.length; i++) {
                                    rowDataArray[i] = gridRowDataOneToTwo(rowDataArray[i]);
                                }
                                gridTableData = rowDataArray;
                                searchData();
                            },
                            "deleteTrainno": function (trigger) {
                                bottomDeleteTrainno();
                            }
                        },
                        //重写onContextMenu和onShowMenu事件
                        onContextMenu: function (e) {//显示菜单
                            var rowId = $(e.target).closest("tr.jqgrow").attr("id");//获得RowID
                            if ($(e.target).attr("id") == "dontShow") {
                                return false;
                            } else {
                                return true;
                            }
                        },
                        onShowMenu: function (e, menu) {//显示菜单
                            return menu;
                        },
                        menuStyle: { //菜单样式
                            backgroundColor: '#fcfdfd',
                            border: '1px solid #a6c9e2',
                            maxWidth: '100px',// to be
                            width: '100%' // to have good width of the menu
                        },
                        itemHoverStyle: { //点击菜单上面的样式
                            border: '1px solid #79b7e7',
                            color: '#1d5987',
                            backgroundColor: '#d0e5f5'
                        }
                    });

                    $("#gridTable").find("input[type=checkbox].groupHeader").bind("click", function () {
                        var nextAllTr = $(this).parents("tr:first").nextAll();
                        var is_checked = $(this).is(":checked");
                        for (var i = 0; i < nextAllTr.length; i++) {
                            var obj = nextAllTr.eq(i);
                            if (/^gridTableghead/.test(obj.attr("id"))) {
                                break;
                            }
                            var checkbox = obj.find("td:first input[type=checkbox]");
                            if (is_checked) {
                                $("#gridTable").jqGrid('setSelection', obj.attr("id"));
                                if (!checkbox.is(":checked")) {
                                    checkbox.click();
                                }
                            } else {
                                if (checkbox.is(":checked")) {
                                    checkbox.click();
                                }
                            }
                        }
                    });
                }
            });
            setGridHeightWidth();
        }


        var calculateBottomTableSum = function () {
            var rows = $("#gridTable").jqGrid("getRowData");
            var trainMap = {};
            for (var i = 0; i < rows.length; i++) {
                var vo = rows[i];
                if (trainMap[vo.TRAINNO] == null) {
                    trainMap[vo.TRAINNO] = {
                        VOL: 0,
                        GWT: 0,
                        QTY: 0
                    };
                }
                if ("" + Number(vo.VOL) == "NaN") {
                    vo.VOL = 0;
                }
                if ("" + Number(vo.GWT) == "NaN") {
                    vo.GWT = 0;
                }
                if ("" + Number(vo.QTY) == "NaN") {
                    vo.QTY = 0;
                }
                trainMap[vo.TRAINNO].VOL += Number(vo.VOL);
                trainMap[vo.TRAINNO].GWT += Number(vo.GWT);
                trainMap[vo.TRAINNO].QTY += Number(vo.QTY);

            }

            var colModelArray = $("#gridTable").jqGrid("getGridParam", "colModel")

            var colspan = 0;
            var totalIndex = 0;
            for (var i = 0; i < colModelArray.length; i++) {
                if (colModelArray[i].name == "VOL") {
                    colspan = totalIndex;
                }
                if (!colModelArray[i].hidden) {
                    totalIndex++;
                }
            }
            totalIndex = totalIndex - 3 - colspan;
            for (train in trainMap) {
                var arr = $("#gridTable tr[id^=gridTableghead_]");
                for (var i = 0; i < arr.length; i++) {
                    var tr = arr.eq(i);
                    if ($.trim(tr.find("td:first b").text()) == train) {
                        tr.find("td:first").attr("colspan", colspan);
                        tr.find("td:first").nextAll("td").remove();
                        tr.append("<td style=\"text-align: center;\"><b style=\"color:red;font-weight: bold;font-size: 17px;\">" + trainMap[train].VOL + "</b>" + "</td>");
                        tr.append("<td style=\"text-align: center;\"><b style=\"color:red;font-weight: bold;font-size: 17px;\">" + trainMap[train].GWT + "</b>" + "</td>");
                        tr.append("<td style=\"text-align: center;\"><b style=\"color:red;font-weight: bold;font-size: 17px;\">" + trainMap[train].QTY + "</b>" + "</td>");
                        tr.append("<td style=\"text-align: center;\" colspan=\"" + totalIndex + "\"><td>");
                    }
                }
            }
        }

        var getGridParamSelarrrow = function (gridTable) {
            var selectRowItems = gridTable.jqGrid("getGridParam", 'selarrrow');
            return selectRowItems;
        }

        //底部数据删除
        var bottomDeleteData = function () {
            var selectRowItems = getGridParamSelarrrow($("#gridTable"));
            if (selectRowItems.length == 0) {
                errorNotification({ SimpleMessage: $.i18n.prop('generatorFail') });
                return;
            }
            for (var i = selectRowItems.length - 1; i >= 0; i--) {
                $("#gridTable").jqGrid('delRowData', selectRowItems[i]);
            }
            var arr = $("#gridTable > tbody > tr[id^=gridTableghead_]");
            for (var i = arr.length - 1; i >= 0; i--) {
                var _this = arr.eq(i);
                var id = _this.next().attr("id");
                if (/^gridTableghead/.test(id) || id == null) {
                    _this.remove();
                }
            }
            calculateBottomTableSum();
        }

        var topDataAdd = function (gridTable, arr) {
            //顶部数据新增
            for (var i = 0; i < arr.length; i++) {
                var rowData = gridRowDataOneToTwo(arr[i]);
                var ids = gridTable.jqGrid('getDataIDs');
                var rowid = Math.max.apply(Math, ids);
                if (rowid == "-Infinity")
                    rowid = 0;
                var newrowid = rowid + 1;
                gridTable.jqGrid("addRowData", newrowid, rowData);
            }
            readDraggable();
        }

        //底部table解散车次
        var bottomDeleteTrainno = function () {
            $.messager.confirm($.i18n.prop('trainAdd_tip'), '#{trainAdd_dissolve}?', function (r) {
                if (r) {
                    var selectRowItems = getGridParamSelarrrow($("#gridTable"));
                    if (selectRowItems.length == 0) {
                        errorNotification({ SimpleMessage: $.i18n.prop('generatorFail') });
                        return;
                    }
                    var arr = [];
                    var deleteArr = [];
                    for (var i = 0; i < selectRowItems.length; i++) {
                        var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
                        if (rowData.WEITUO_TYPE == '整车') {
                            errorNotification({ SimpleMessage: $.i18n.prop('trainAdd_error') });
                            return;
                        }
                        if (rowData.DETAILTRAINNO != '') {
                            deleteArr.push(rowData);
                        }
                        arr.push(rowData);
                        var index = queryConditions.indexOf(rowData.YW_ID);
                        if (index > -1) {
                            queryConditions.splice(index, 1);
                        }
                    }
                    if (deleteArr.length != 0) {
                        $.ajax({
                            url: '../../train/deleteTrain?t=' + Math.random(),
                            type: 'POST',
                            data: 'jsonData=' + JSON.stringify(deleteArr),
                            success: function (dataObj) {
                                topDataAdd($("#gridTable2"), arr);
                                bottomDeleteData();
                                loadMune($("#gridTable2")[0]);
                                commonDrag();
                            }
                        });
                    } else {
                        topDataAdd($("#gridTable2"), arr);
                        bottomDeleteData();
                        loadMune($("#gridTable2")[0]);
                        commonDrag();
                    }
                }
            })
        }

        function readDraggable() {
            //增强tr拖动效果几率

            var trs = $(".ui-jqgrid-btable > tbody > tr[id]").filter(function () {
                if (/^gridTableghead/.test($(this).attr("id"))) {
                    return false;
                }
                return true;
            });
            trs.attr("draggable", true);
        }


        function commonDrag() {
            function gridOneToTwo(e) {
                var fromObjectStr = e.dataTransfer.getData('fromObject');
                if (!fromObjectStr) {
                    return;
                }
                var fromObject = JSON.parse(fromObjectStr);
                var fromGridTable = $("#" + fromObject.parentTable);
                var fromSelectRowItems = getGridParamSelarrrow(fromGridTable);
                for (let i = 0; i < fromSelectRowItems.length; i++) {
                    for (let j = 0; j < fromSelectRowItems.length - 1; j++) {
                        if ($("#gridTable2").jqGrid('getRowData', fromSelectRowItems[i]).ROUTE_TYPE != $("#gridTable2").jqGrid('getRowData', fromSelectRowItems[j]).ROUTE_TYPE) {
                            errorNotification({ SimpleMessage: $.i18n.prop('trainAdd_toBeSeem') });
                            return;
                        }
                    }
                }
                if (fromSelectRowItems.length == 0) {
                    //tr drop的优先高于 tbody, tr触发了后者就不触发了
                    return false;
                }
                if (fromObject.parentTable != "gridTable2") {
                    //底部to底部
                    //选中数据的车次to选择数据的范围就不处理
                    var TRAINNO = null;
                    if ($(this).is("tr")) {
                        var toTrRoot = $(this);
                        if (!/^gridTableghead_/.test(toTrRoot.attr("id"))) {
                            toTrRoot = toTrRoot.prevAll("tr[id^=gridTableghead]:first");
                            ;
                        }
                        TRAINNO = toTrRoot.find("b:first").text().trim();
                        var j = 0;
                        for (var i = fromSelectRowItems.length - 1; i >= 0; i--) {
                            console.log(fromGridTable);
                            var rowData = fromGridTable.jqGrid('getRowData', fromSelectRowItems[i]);
                            if (rowData.TRAINNO == TRAINNO) {
                                j++;
                            }
                        }
                        if (j == fromSelectRowItems.length) {
                            //自己to自己不需要操作
                            return;
                        }

                    } else {
                        return;
                    }

                    var fromSelectRowDataArray = [];
                    for (var i = fromSelectRowItems.length - 1; i >= 0; i--) {
                        var rowData = fromGridTable.jqGrid('getRowData', fromSelectRowItems[i]);
                        rowData.TRAINNO = TRAINNO;
                        fromSelectRowDataArray.push(rowData);
                    }
                    for (var i = fromSelectRowItems.length - 1; i >= 0; i--) {
                        fromGridTable.jqGrid("delRowData", fromSelectRowItems[i]);
                    }
                    gridTableData = $("#gridTable").jqGrid("getRowData");
                    for (var i = 0; i < fromSelectRowDataArray.length; i++) {
                        gridTableData.push(fromSelectRowDataArray[i]);
                    }
                    for (var i = 0; i < gridTableData.length; i++) {
                        gridTableData[i] = gridRowDataOneToTwo(gridTableData[i]);
                    }
                    searchData();
                    return;
                }

                var TRAINNO = null;
                if ($(this).is("tr")) {
                    var toTrRoot = $(this);
                    if (!/^gridTableghead_/.test(toTrRoot.attr("id"))) {
                        toTrRoot = toTrRoot.prevAll("tr[id^=gridTableghead]:first");
                        ;
                    }
                    TRAINNO = toTrRoot.find("b:first").text().trim();
                } else {
                    TRAINNO = getTrainno();
                }

                var fromSelectRowDataArray = [];
                for (var i = fromSelectRowItems.length - 1; i >= 0; i--) {
                    var rowData = fromGridTable.jqGrid('getRowData', fromSelectRowItems[i]);
                    rowData.TRAINNO = TRAINNO;
                    fromSelectRowDataArray.push(rowData);
                }
                gridTableData = $("#gridTable").jqGrid("getRowData");
                for (let i = 0; i < fromSelectRowDataArray.length; i++) {
                    for (let j = 0; j < gridTableData.length; j++) {
                        if (fromSelectRowDataArray.ROUTE_TYPE != gridTableData.ROUTE_TYPE) {
                            errorNotification({ SimpleMessage: $.i18n.prop('trainAdd_toBeSeem') });
                            return;
                        }
                    }
                }
                for (var i = fromSelectRowItems.length - 1; i >= 0; i--) {
                    fromGridTable.jqGrid("delRowData", fromSelectRowItems[i]);
                }
                var newGrid = "gridTable";
                var ids = $("#" + newGrid).jqGrid('getDataIDs');
                var rowid = Math.max.apply(Math, ids);
                if (rowid == "-Infinity") {
                    rowid = 0;
                }
                gridTableData = $("#gridTable").jqGrid("getRowData");
                for (var i = 0; i < fromSelectRowDataArray.length; i++) {
                    //rowid += 1;
                    var rowData = fromSelectRowDataArray[i];
                    gridTableData.push(rowData);
                    queryConditions.push(rowData.YW_ID);
                }
                for (var i = 0; i < gridTableData.length; i++) {
                    gridTableData[i] = gridRowDataOneToTwo(gridTableData[i]);
                }
                searchData();
                e.preventDefault();
                return false;
            }


            var tempGridTable = $("#gridTable").parents(".ui-jqgrid-bdiv:first")[0];
            if (tempGridTable) {
                tempGridTable.ondrop = gridOneToTwo;
            }

            var gridTable2Parent = $("#gridTable2").parents(".ui-jqgrid-bdiv:first")[0];
            if (gridTable2Parent) {
                gridTable2Parent.ondrop = function (e) {
                    var fromObjectStr = e.dataTransfer.getData('fromObject');
                    if (!fromObjectStr) {
                        return;
                    }
                    var fromObject = JSON.parse(fromObjectStr);
                    if (fromObject.parentTable != "gridTable") {
                        return;
                    }
                    bottomDeleteTrainno();
                }
            }

            $("#gridTable2 tbody tr").each(function () {
                this.ondragstart = function (e) { //开始拖动源对象
                    e.dataTransfer.setData('fromObject', JSON.stringify({
                        parentTable: $(this).parents(".ui-jqgrid-btable:first").attr("id"),
                        thisTable: $(this).attr("id")
                    }));
                };
                this.ondrag = {};
                this.ondragend = {};
            });


            $("#gridTable tbody tr").each(function () {
                this.ondragstart = function (e) { //开始拖动源对象
                    e.dataTransfer.setData('fromObject', JSON.stringify({
                        parentTable: $(this).parents(".ui-jqgrid-btable:first").attr("id"),
                        thisTable: $(this).attr("id")
                    }));
                };
                this.ondragover = function (e) { //源对象在悬停在目标对象上时
                    e.preventDefault(); //阻止默认行为，使得drop可以触发
                }
                this.ondrop = gridOneToTwo; //源对象松手释放在了目标对象中
            });
        }


        function getSearchList() {
            var beginCity = $("#tipinputbegin").textbox("getValue");
            if (beginCity == "--所有--") {
                beginCity = "";
            }

            var endCity = $("#tipinputend").textbox("getValue");
            if (endCity == "--所有--") {
                endCity = "";
            }

            var cusNo = $("#cusNo").combobox("getValue");
            if (cusNo == "--所有--") {
                cusNo = "";
            }

            // var ywLocation = $("#ywLocation").combobox("getValues");
            // if(ywLocation == $.i18n.prop('all')) {
            // 	ywLocation = "";
            // }

            var startTime = $("#beginTime").datebox("getValue");
            var endTime = $("#endTime").datebox("getValue");

            var searchState = $("#searchState").combobox('getValue');
            if (searchState == "所有") {
                searchState = "";
            }
            var ywId = $("#ywId").textbox('getValue');
            console.log(routeType)
            var parmsArray = [
                { name: 'm.planshipment_data', value: startTime, op: "ge" },
                { name: 'm.planjiaofu_data', value: endTime, op: "le" },
                { name: 'om.begin_local_city', value: beginCity, op: "cn" },
                { name: 'om.end_local_city', value: endCity, op: "cn" },
                { name: 'm.cus_no', value: cusNo, op: 'eq' },
                { name: 'm.state', value: searchState, op: 'eq' },
                // { name: 'm.yw_location', value: ywLocation, op: 'eq'},
                { name: 'm.business_yw_id', value: ywId, op: 'cn' },
                { name: 'm.yw_id', value: queryConditions, op: 'ni' },
                { name: 'm.route_type', value: routeType, op: 'eq' }
            ];
            return formatSearchParames(parmsArray);
        }

        //第二个表格
        var loadList2 = function () {
            $('#gridTable2').jqGrid({
                url: getSearchGridUrl(),
                datatype: 'json',
                width: 'none',
                colNames: [
                    $.i18n.prop('state'), $.i18n.prop('sn'), $.i18n.prop('guid'), $.i18n.prop('createBy'), $.i18n.prop('createDate'), $.i18n.prop('updateBy'), $.i18n.prop('withinCode'),
                    $.i18n.prop('updateDate'), $.i18n.prop('trainAdd_orderNumber'), $.i18n.prop('trainAdd_transportType'), $.i18n.prop('trainAdd_goodsNumber'), $.i18n.prop('cusNo'), $.i18n.prop('trainAdd_goodsName'), '#{vol} /m³', '#{gwt} /KG', '#{qty} /件', $.i18n.prop('businessType'), $.i18n.prop('businessYwId'),
                    $.i18n.prop('businessDate'), $.i18n.prop('shipmentData'), $.i18n.prop('planjiaofuData'), $.i18n.prop('jiaofuData'),
                    $.i18n.prop('beginLocal'), $.i18n.prop('endLocalSite'), $.i18n.prop('nextLocalCode'), $.i18n.prop('contractorCode'),
                    $.i18n.prop('contractorName'), $.i18n.prop('trainAdd_shippingDate'), $.i18n.prop('trainAdd_delegateType'), $.i18n.prop('trainAdd_modeOfTransport'),
                    $.i18n.prop('transportTypeActual'), $.i18n.prop('isAbnormal'), $.i18n.prop('isDelay'), $.i18n.prop('currentLocalLng'), $.i18n.prop('currentLocalLat'),
                    $.i18n.prop('currentLocalDate'), $.i18n.prop('currentLocalAddr'), '收款状态', '付款状态',
                    $.i18n.prop('getMode'), $.i18n.prop('payMode'), $.i18n.prop('shoukuan'), $.i18n.prop('fukuan'), $.i18n.prop('ywLocation'),
                    $.i18n.prop('existDetailChild'), $.i18n.prop('existMultipleTruck'), '', '', '', '当前车次号', '', ''
                ],
                colModel: [
                    /*{ name: '', index: '', align: 'center', search: false, sortable: false, width: 60,
                        formatter : function(value, grid, rows) {
                            // "<a style='text-decoration:underline;color:blue;' name='deleteRow' href='javascript:deleteRow("+row.rowId+",\"gridTable\")'>"+delText+"</a>";"<a style='text-decoration:underline;color:blue;' name='deleteRow' href='javascript:deleteRow("+row.rowId+",\"gridTable\")'>"+delText+"</a>";}},
                            return "<a style='text-decoration: underline; color: blue;' href='javascript:breakUp(\"" + rows.DETAILGUID + "\", \"" + rows.DETAILPARENTGUID + "\")'>拆分</a>"
                            // '<span><a href="javascript:void(0)" onclick="breakUp(' + rows.DETAILGUID + ' , ' + rows.DETAILPARENTGUID + ')">拆分</a></span>'
                        }
                    },*/
                    {
                        name: 'STATE',
                        index: 'm.state',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true,
                        formatter: function (value, grid, rows) {
                            return stateTextObj[value];
                        }
                    },
                    {
                        name: 'SN',
                        index: 'm.sn',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'GUID',
                        index: 'm.guid',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CREATE_BY',
                        index: 'm.create_by',
                        align: 'center',
                        type: 'string',
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'CREATE_DATE',
                        index: 'm.create_date',
                        align: 'center',
                        type: 'string',
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'UPDATE_BY',
                        index: 'z.update_by',
                        align: 'center',
                        type: 'string',
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'WITHIN_CODE',
                        index: 'm.WITHIN_CODE',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'UPDATE_DATE',
                        index: 'm.update_date',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'YW_ID',
                        index: 'm.yw_id',
                        align: 'center',
                        isSort: false,
                        search: true,
                        type: 'string',
                        width: 100
                    },
                    {
                        name: 'ROUTE_TYPE',
                        index: 'm.route_type',
                        align: 'left',
                        isSort: false,
                        search: true,
                        type: 'string',
                        width: 100
                    },
                    { name: 'CONT_ID', index: 'o.cont_id', align: 'center', search: false, type: 'string', width: 120 },
                    {
                        name: 'CUS_NO',
                        index: 'm.cus_no',
                        align: 'center',
                        isSort: false,
                        search: true,
                        width: 120,
                        type: 'string',
                        formatter: function (value, grid, rows) {
                            return cusNoTextObj[value];
                        }
                    },
                    {
                        name: 'GOODS_NAME',
                        index: 'd.goods_name',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 80
                    },
                    {
                        name: 'VOL',
                        index: 'd.vol',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 80
                    },
                    {
                        name: 'GWT',
                        index: 'd.gwt',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 80
                    },
                    {
                        name: 'QTY',
                        index: 'd.qty',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 80
                    },
                    {
                        name: 'BUSINESS_TYPE',
                        index: 'm.business_type',
                        align: 'center',
                        isSort: false,
                        search: true,
                        width: 40,
                        type: 'string',
                        hidden: true
                    },
                    {
                        name: 'BUSINESS_YW_ID',
                        index: 'm.business_yw_id',
                        align: 'center',
                        type: 'string',
                        search: false,
                        width: 80,
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'BUSINESS_DATE',
                        index: 'm.business_date',
                        align: 'center',
                        type: 'string',
                        search: false,
                        sortable: false,
                        width: 105
                    },
                    {
                        name: 'SHIPMENT_DATA',
                        index: 'm.shipment_data',
                        align: 'center',
                        isSort: false,
                        width: 80,
                        stype: 'select',
                        search: true,
                        hidden: true
                    },
                    {
                        name: 'PLANJIAOFU_DATA',
                        index: 'm.planjiaofu_data',
                        align: 'center',
                        isSort: false,
                        width: 100,
                        search: true,
                        type: 'string',
                        hidden: true
                    },
                    {
                        name: 'JIAOFU_DATA',
                        index: 'm.jiaofu_data',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'BEGIN_LOCAL',
                        index: 'm.begin_local',
                        align: 'center',
                        isSort: false,
                        width: 300,
                        stype: 'select'
                    },
                    {
                        name: 'END_LOCAL_SITE',
                        index: 'm.end_local_site',
                        align: 'center',
                        sorttype: 'string',
                        width: 300,
                        search: false,
                        sortable: false
                    },
                    {
                        name: 'NEXT_LOCAL_CODE',
                        index: 'm.next_local_code',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CONTRACTOR_CODE',
                        index: 'm.contractor_code',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CONTRACTOR_NAME',
                        index: 'm.contractor_name',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'PLANSHIPMENT_DATA',
                        index: 'm.planshipment_data',
                        align: 'center',
                        isSort: false,
                        width: 100,
                        search: true,
                        type: 'string'
                    },
                    {
                        name: 'WEITUO_TYPE',
                        index: 'm.weituo_type',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 80,
                        formatter: function (value, grid, rows) {
                            return weituoTypeTextObj[value];
                        }
                    },
                    {
                        name: 'TRANSPORT_TYPE_PLAN',
                        index: 'm.transport_type_plan',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 100,
                        formatter: function (value, grid, rows) {
                            return trasportTextObj[value];
                        }
                    },
                    {
                        name: 'TRANSPORT_TYPE_ACTUAL',
                        index: 'm.transport_type_actual',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CURRENT_LOCAL_ADDR',
                        index: 'm.current_local_addr',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'IS_DELAY',
                        index: 'm.is_delay',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CURRENT_LOCAL_LNG',
                        index: 'm.current_local_lng',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CURRENT_LOCAL_LAT',
                        index: 'm.current_local_lat',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'CURRENT_LOCAL_DATE',
                        index: 'm.current_local_date',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'IS_ABNORMAL',
                        index: 'm.isabnormal',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'GET_STATE',
                        index: 'm.get_state',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 60,
                        formatter: function (value, grid, rows) {
                            return getStateTextObj[value];
                        },
                        hidden: true
                    },
                    {
                        name: 'PAY_STATE',
                        index: 'm.pay_state',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 60,
                        formatter: function (value, grid, rows) {
                            return payStateTextObj[value];
                        },
                        hidden: true
                    },
                    {
                        name: 'GET_MODE',
                        index: 'm.get_mode',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'PAY_MODE',
                        index: 'm.pay_mode',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'SHOUKUAN',
                        index: 'm.shoukuan',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'FUKUAN',
                        index: 'm.fukuan',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'YW_LOCATION',
                        index: 'm.yw_location',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        hidden: true
                    },
                    {
                        name: 'EXIST_DETAILCHILD',
                        index: 'm.exist_detail_child',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    {
                        name: 'EXIST_MULTIPLE_TRUCK',
                        index: 'm.exist_multiple_truck',
                        align: 'center',
                        sorttype: 'string',
                        search: false,
                        sortable: false,
                        width: 40,
                        hidden: true
                    },
                    { name: 'YW_LOCATION', index: 'm.yw_location', hidden: true },
                    { name: 'BEGIN_LOCAL_CODE', index: '', hidden: true },
                    { name: 'END_LOCAL_CODE', index: '', hidden: true },
                    { name: 'CURRENTTRAINNO', index: '', hidden: true },
                    { name: 'DETAILGUID', index: '', hidden: true },
                    { name: 'DETAILPARENTGUID', index: '', hidden: true }
                ],
                shrinkToFit: false,
                altRows: true,
                autoScroll: true,
                altclass: 'gridSpacingClass',
                forceFit: true,
                cellLayout: 0,
                scroll: true,
                autowidth: true,
                sortname: 'm.create_date',
                sortorder: "desc",
                loadonce: false,
                mtype: "POST",
                viewrecords: true,
                rownumbers: true,
                multiselect: true,
                rowNum: 15,
                rowList: [100, 200, 300, 500],
                pager: "#gridPager",
                jsonReader: {
                    root: "rows",
                    total: "total",
                    page: "page",
                    records: "records",
                    repeatitems: false
                },
                caption: $.i18n.prop('trainAdd_express'),
                gridComplete: function () {
                    $(".cbox").shiftSelect();
                },
                loadComplete: function (xhr) {
                    loadMune(this);
                    commonDrag();
                    readDraggable();
                }
            });
            setGridHeightWidth();
        }

        //获取车次

        function getTrainno() {
            /*var rowData = $("#gridTable2").jqGrid('getRowData');
            var ywLocation = null;
            for(var i = 0 ; i < rowData.length; i++) {
                ywLocation = rowData[i].YW_LOCATION;
                if(ywLocation != "") {
                    break;
                }
            }
    
            //如果业务地点为空时，就默认业务地点为深圳总部
            if(ywLocation == null) {
                ywLocation = "GCJ";
            }*/
            var ywLocation = $.cookie("OSUN_whcenter");

            var trainno = "";
            $.ajax({
                url: '../../bussiness/planExec/getTrainno?t=' + Math.random() + "&ywLocation=" + ywLocation,
                type: 'POST',
                async: false,
                success: function (data) {
                    trainno = data.resultDataFull;
                }
            });
            return trainno;
        }

        var gridRowDataOneToTwo = function (rowData) {
            rowData.STATE = stateValueObj[rowData.STATE];
            rowData.CUS_NO = cusNoValueObj[rowData.CUS_NO];
            rowData.GET_STATE = getStateValueObj[rowData.GET_STATE];
            rowData.PAY_STATE = payStateValueObj[rowData.PAY_STATE];
            rowData.TRANSPORT_TYPE_PLAN = trasportValueObj[rowData.TRANSPORT_TYPE_PLAN];
            rowData.WEITUO_TYPE = weituoTypeValueObj[rowData.WEITUO_TYPE];
            return rowData;
        }

        var loadMune = function (gridTableObj) {
            $("tr.jqgrow", gridTableObj).contextMenu('menu', {
                bindings: { //右键菜单绑定的事件
                    "autoTrainno": function (trigger) {
                        var selectRowItems = getGridParamSelarrrow($("#gridTable2"));
                        if (selectRowItems.length == 0) {
                            errorNotification({ SimpleMessage: $.i18n.prop('generatorFail') });
                            return;
                        }
                        ;
                        var trainno = getTrainno();
                        gridTableData = $("#gridTable").jqGrid("getRowData");
                        for (var i = 0; i < selectRowItems.length; i++) {
                            for (let j = 1; j < selectRowItems.length; j++) {
                                if ($("#gridTable2").jqGrid('getRowData', selectRowItems[i]).ROUTE_TYPE != $("#gridTable2").jqGrid('getRowData', selectRowItems[j]).ROUTE_TYPE) {
                                    errorNotification({ SimpleMessage: $.i18n.prop('trainAdd_toBeSeem') });
                                    return;
                                }
                            }
                            var rowData = $("#gridTable2").jqGrid('getRowData', selectRowItems[i]);
                            // 比较所有的分段运输类型，如果有不同的就不让生成车次
                            rowData.TRAINNO = trainno;
                            gridTableData.push(rowData);
                            queryConditions.push(rowData.YW_ID);
                        }
                        for (var i = 0; i < gridTableData.length; i++) {
                            gridTableData[i] = gridRowDataOneToTwo(gridTableData[i]);
                        }
                        for (var i = selectRowItems.length - 1; i >= 0; i--) {
                            $("#gridTable2").jqGrid('delRowData', selectRowItems[i]);
                        }
                        searchData();
                    },
                    "autoGenerateTrainno": function (trigger) {
                        openCheckedWinow();
                    },
                    //重写onContextMenu和onShowMenu事件
                    onContextMenu: function (e) {//显示菜单
                        var rowId = $(e.target).closest("tr.jqgrow").attr("id");//获得RowID
                        if ($(e.target).attr("id") == "dontShow") {
                            return false;
                        } else {
                            return true;
                        }
                    },
                    onShowMenu: function (e, menu) {//显示菜单
                        return menu;
                    },
                    menuStyle: { //菜单样式
                        backgroundColor: '#fcfdfd',
                        border: '1px solid #a6c9e2',
                        maxWidth: '100px',// to be
                        width: '100%' // to have good width of the menu
                    },
                    itemHoverStyle: { //点击菜单上面的样式
                        border: '1px solid #79b7e7',
                        color: '#1d5987',
                        backgroundColor: '#d0e5f5'
                    }
                }
            });
        }

        var initData = function () {
            loadList();
            loadList2();
        };

        //车型下拉信息
        $("#trainType").combobox({
            valueField: "code",
            textField: "name",
            method: "GET",
            loader: function (param, success, error) {
                $.ajax({
                    url: "../../dictionary/findTruckType",
                    dataType: 'json',
                    method: "GET",
                    success: function (data) {
                        success(data.resultDataFull);
                    }
                });
            }
        });

        function MouseOver(name) {
            var rowData = $("#gridTable").jqGrid('getRowData', name);
            detailRowNumber = name;
            detailGuid = rowData.guid;
            $("#orderDetailChild").show();
            $(".ui-jqgrid-bdiv").css("height", "230px");
            listChild();

        }

        //切换选项卡
        var selectDetail = function (guid) {
            loadDetailMostly(guid);
        }
        var gridReplace = function (oldGgrid, newGrid, element) {
            var selectRowItems = $("#" + oldGgrid).jqGrid("getGridParam", "selarrrow");

            var rowDataList = [];

            if (selectRowItems.length <= 0) {
                var rowData = generalRowData(element.target.cells);
                rowDataList.push(rowData);
            } else {
                for (var i = 0; i < selectRowItems.length; i++) {
                    var rowData = $("#" + oldGgrid).jqGrid('getRowData', selectRowItems[i]);
                    rowDataList.push(rowData);
                }
            }

            var ids = $("#" + newGrid).jqGrid('getDataIDs');
            var rowid = Math.max.apply(Math, ids);
            if (rowid == "-Infinity") {
                rowid = 0;
            }

            for (var i = 0; i < rowDataList.length; i++) {
                var newrowid = rowid + (i + 1);
                var dataRow = rowDataList[i];
                dataRow.rowid = newrowid,
                    $("#" + newGrid).jqGrid("addRowData", newrowid, dataRow, "last");
                $("#" + oldGgrid).delRowData(rowDataList[i].rowid);

            }
        }
        var topHover = function () {

        }

        var downHover = function () {

        }

        var generalRowData = function (cells) {
            var rowData = {};
            for (var i = 0; i < cells.length; i++) {
                var id = $(cells[i].outerHTML).attr("aria-describedby");
                id = id.substring(id.indexOf("_") + 1, id.length);
                rowData[id] = cells[i].outerText;
            }
            return rowData;
        }

        var add = function () {
            loseGridFocus();
            var rowData = $("#gridTable").jqGrid("getRowData");
            var map = {};
            for (var i = 0; i < rowData.length; i++) {
                var detailTrainno = rowData[i].DETAILTRAINNO;
                if (detailTrainno == "") {
                    var loadQty = rowData[i].loadQty;
                    var loadGwt = rowData[i].loadGwt;
                    var loadVol = rowData[i].loadVol;
                    if (parseInt(loadQty) == 0 && parseInt(loadGwt) == 0 && parseInt(loadVol) == 0) {
                        errorNotification({ SimpleMessage: $.i18n.prop('trainAdd_wayBill') + rowData[i].YW_ID + $.i18n.prop('trainAdd_mustBeOne') });
                        return;
                    }
                    var initQty = rowData[i].QTY;
                    var initGwt = rowData[i].GWT;
                    var initVol = rowData[i].VOL;
                    if (parseInt(loadQty) > parseInt(initQty)) {
                        errorNotification({ SimpleMessage: $.i18n.prop('trainAdd_wayBill') + rowData[i].YW_ID + $.i18n.prop('trainAdd_qtyError') });
                        return;
                    }

                    if (parseInt(loadGwt) > parseInt(initGwt)) {
                        errorNotification({ SimpleMessage: $.i18n.prop('trainAdd_wayBill') + rowData[i].YW_ID + $.i18n.prop('trainAdd_gwtError') });
                        return;
                    }

                    if (parseInt(loadVol) > parseInt(initVol)) {
                        errorNotification({ SimpleMessage: $.i18n.prop('trainAdd_wayBill') + rowData[i].YW_ID + $.i18n.prop('trainAdd_volError') });
                        return;
                    }
                }
                var ai = rowData[i];
                if (!map[ai.TRAINNO]) {
                    map[ai.TRAINNO] = [ai];
                } else {
                    map[ai.TRAINNO].push(ai);
                }
                rowData[i] = gridRowDataOneToTwo(rowData[i]);
            }
            if (rowData.length == 0) {
                errorNotification({ SimpleMessage: $.i18n.prop('saveFail') });
                return;
            }
            /* $.messager.confirm($.i18n.prop('messege.confirm'), '#{message.message}?', function(r) {// 提示, 确定保存数据项吗
                if (r) {
                    $.ajax({
                        url : '../../train/addtrain?t='+Math.random(),
                        type : 'POST',
                        data :"jsonData="+JSON.stringify(map),
                        success : function(dataObj) {
                            if (isServerResultDataPass(dataObj)) {
                                correctNotification(dataObj.resultDataFull);
                                gridTableData = [];
                                searchData();
                                searchData2();
                            } else {
                                FailResultDataToTip(dataObj);
                            }
                            hideLoading();
                        },
                        error : function(message) {
                            hideLoading();
                        }
                    });
                }
            }); */
            openDetail(map);
        }

        document.addEventListener("dragenter", function (event) {
        });

        document.addEventListener("dragover", function (event) {
            event.preventDefault();
        });

        $("#beginTime").datebox({
            onChange: function (date) {
                if (date == "") {
                    $("#beginTime").datebox('setValue', '')
                    searchData2();
                } else {
                    searchData2();
                }
            },
            onSelect: function (beginDate) {
                $("#endTime").datebox().datebox("calendar").calendar({
                    validator: function (endDate) {
                        return beginDate <= endDate;
                    }
                });
            }
        });

        $("#endTime").datebox({
            onChange: function (date) {
                if (date == "") {
                    $("#endTime").datebox("setValue", "")
                    searchData2();
                } else {
                    searchData2();
                }
            }
        });

        function loadAddress() {
            $("#tipinputbegin,#tipinputend").combobox({
                valueField: 'code',
                textField: 'name',
                loader: function (param, success, error) {
                    $.ajax({
                        url: '../../order/getlocation?t=' + Math.random(),
                        dataType: 'json',
                        method: 'POST',
                        async: true,
                        success: function (data) {
                            var supArr = [];
                            supArr.unshift({ code: '', name: $.i18n.prop('all') });
                            data.resultDataFull.forEach(function (item) {
                                supArr.push({ code: item.city, name: (item.cityZjm + "-" + item.city) });
                            });
                            success(supArr);
                            $("#tipinputbegin,#tipinputend").combobox('setValue', "");
                        }
                    });
                },
                onChange: searchData2
            });
        }

        var loadCusNo = function () {
            $.ajax({
                url: "../../bussiness/planExec/findCusWithCurrentWithinCode?t=" + Math.random(),
                dataType: 'json',
                method: "GET",
                async: false,
                success: function (data) {
                    data.unshift({ code: '', name: $.i18n.prop('all') });
                    data.forEach(function (item) {
                        cusNoTextObj[item.code] = item.name;
                        cusNoValueObj[item.name] = item.code;
                    });
                    //车次明细-客户下拉框
                    $("#cusNo").combobox({
                        valueField: 'code',
                        textField: 'name',
                        data: data,
                        onChange: searchData2
                    });
                }
            });
        }

        var loadState = function () {
            var state = [{ 'name': $.i18n.prop('all'), 'code': '' }];
            state.push({ 'name': $.i18n.prop('search.state.normal'), 'code': '0' });
            state.push({ 'name': $.i18n.prop('search.state.approved'), 'code': '1' });
            state.push({ 'name': $.i18n.prop('search.state.haveSent'), 'code': '2' });
            state.push({ 'name': $.i18n.prop('search.state.inTheTransport'), 'code': '3' });
            state.push({ 'name': $.i18n.prop('search.state.transportationTo'), 'code': '4' });
            state.push({ 'name': $.i18n.prop('search.state.transportationToComplete'), 'code': '5' });
            state.push({ 'name': $.i18n.prop('search.state.cancel'), 'code': '6' });
            $("#searchState").combobox({
                valueField: "code",
                textField: "name",
                multiple: true,
                labelSeparator: ',',
                displaySeparator: ',',
                valueSeparator: ',',
                loader: function (params, success, error) {
                    success(state);
                    $("#searchState").combobox("setValue", "");
                },
                formatter: function (row) {
                    var opts = $(this).combobox("options");
                    return '<input type="checkbox" class="combobox-checkbox">' + row[opts.textField];
                },
                onLoadSuccess: function () {
                    var opts = $(this).combobox("options");
                    var target = this;
                    var values = $(target).combobox("getValues");
                    $.map(values, function (value) {
                        var el = opts.finder.getEl(target, value);
                        el.find('input.combobox-checkbox')._propAtte("checked", true);
                    })
                },
                onSelect: function (row) {
                    var opts = $(this).combobox('options');
                    $("#searchState").val($(this).combobox("getValues"));

                    var comboList = $(this).combobox("getValues");
                    var comboText = $(this).combobox("getText").split(",");
                    var newComboList = [];
                    if (comboList != null && comboList != undefined) {
                        for (var i = 0; i < comboList.length; i++) {
                            var code = comboList[i];
                            if (code == "") {
                                var el = opts.finder.getEl(this, code);
                                el.find('input.combobox-checkbox')._propAttr('checked', false);
                            }
                        }
                        for (var i = 0; i < comboList.length; i++) {
                            if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
                                newComboList.push(comboList[i]);
                            } else {
                                if (i != 0) {
                                    var selectData = $(this).combobox("getData");
                                    for (var i = 0; i < selectData.length; i++) {
                                        var code = selectData[i].code;
                                        if (code != '') {
                                            var el = opts.finder.getEl(this, code);
                                            el.find('input.combobox-checkbox')._propAttr('checked', false);
                                        }
                                    }
                                    newComboList = [""];
                                    break;
                                }
                            }
                        }
                    }
                    if (newComboList.length <= 0) {
                        newComboList = [""];
                    }
                    $(this).combobox('setValues', newComboList);
                    var el = opts.finder.getEl(this, row[opts.valueField]);
                    el.find('input.combobox-checkbox')._propAttr('checked', true);
                    searchData();

                },
                onUnselect: function (row) {
                    var opts = $(this).combobox('options');
                    $(this).val($(this).combobox("getValues"));

                    var comboList = $(this).combobox("getValues");
                    var comboText = $(this).combobox("getText").split(",");
                    var newComboList = [];
                    if (comboList != null && comboList != undefined) {
                        for (var i = 0; i < comboList.length; i++) {
                            if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
                                newComboList.push(comboList[i]);
                            } else {
                                if (i != 0) {
                                    newComboList = [""];

                                    break;
                                }
                            }
                        }
                    }
                    if (newComboList.length <= 0) {
                        newComboList = [""];
                    }
                    $(this).combobox('setValues', newComboList);
                    var el = opts.finder.getEl(this, row[opts.valueField]);
                    el.find('input.combobox-checkbox')._propAttr('checked', false);
                    searchData();
                }
            });
            stateInnerHtml = { '': $.i18n.prop('all') };
            state.forEach(function (item) {
                stateInnerHtml[item.code] = item.name;
            })
        }

        var hideIndex = 0; //代表隐藏
        var searchFor = function () {
            if (hideIndex == 0) {
                $("#searchForDiv").show();
                oldSetGridHeightWidth(10, 370, "gridTable");
                hideIndex = 1;
            } else {
                $("#searchForDiv").hide();
                oldSetGridHeightWidth(10, 320, "gridTable");
                hideIndex = 0;
            }
        }

        var packUp = function () {
            var span = $("#gview_gridTable2").children("div").children("a").find("span").attr("class");
            if (span == "ui-icon ui-icon-circle-triangle-n") {
                //  表示显示当前表格 ,点击后隐藏，设置下方表格高度
                setGridHeightWidth = function () {
                    oldSetGridHeightWidth(10, 528, "gridTable2");
                    oldSetGridHeightWidth(10, 120, "gridTable");
                }
            } else {
                setGridHeightWidth = tempSetGridHeightWidth;
            }
            setGridHeightWidth();
        }

        var packUp2 = function () {
            var span = $("#gview_gridTable").children("div").children("a").find("span").attr("class");
            if (span == "ui-icon ui-icon-circle-triangle-n") {
                setGridHeightWidth = function () {
                    oldSetGridHeightWidth(10, 120, "gridTable2");
                    oldSetGridHeightWidth(10, 528, "gridTable");
                }
            } else {
                setGridHeightWidth = tempSetGridHeightWidth;
            }
            setGridHeightWidth();
        }

        /*var ywlocation = $.cookie("OSUN_whcenter");
        function loadYwLocation(){
            $.ajax({
                url : '../../bussiness/planExec/getywlocation?t=' + Math.random(),
                type : 'POST',
                async : false,
                success : function(data){
                    var data = data.resultDataFull;
                    data.unshift({CODE:'','NAME':$.i18n.prop('all')});
                    $("#ywLocation").combobox({
                        valueField : "CODE",
                        textField : "NAME",
                        multiple : true,
                        labelSeparator : ',',
                        displaySeparator : ',',
                        valueSeparator : ',',
                        loader : function(params,success,error){
                            var cookLocation = ywlocation.split(",");
                            var dataLocation = [];
                            for(var i = 0 ; i < cookLocation.length; i++) {
                                for(var j = 0 ; j < data.length; j++) {
                                    if(cookLocation[i] == data[j].CODE) {
                                        dataLocation[i] = data[j];
                                    }
                                }
                            }
                            dataLocation.unshift({'CODE': '', 'NAME': $.i18n.prop('all')});
                            success(dataLocation);
                        },
                        onLoadSuccess : function(){
                            var currentYwLocation = ywlocation.split(",");
                            if(currentYwLocation.length == 1) {
                                $("#ywLocation").combobox("select",currentYwLocation[0]);
                            } else {
                                $("#ywLocation").combobox("select","");
                            }
                            var opts = $(this).combobox("options");
                            var target = this;
                            var values = $(target).combobox("getValues");
                            $.map(values, function(value) {
                                var el = opts.finder.getEl(target,value);
                                el.find('input.combobox-checkbox')._propAttr("checked", true);
                            });
                        },
                        formatter : function(row) {
                            var opts = $(this).combobox("options");
                            return '<input type="checkbox" class="combobox-checkbox">' + row[opts.textField];
                        },
                        onSelect : function(row) {
                            var opts = $(this).combobox('options');
                            $(this).combobox("getValues");
    
                            var comboList = $(this).combobox("getValues");
                            var comboText = $(this).combobox("getText").split(",");
                            var newComboList = [];
                            if (comboList != null && comboList != undefined) {
                                for(var i = 0 ; i < comboList.length ; i ++){
                                    var code = comboList[i];
                                    if(code == "") {
                                        var el = opts.finder.getEl(this,code);
                                        el.find('input.combobox-checkbox')._propAttr('checked', false);
                                    }
                                }
                                for (var i = 0; i < comboList.length; i++) {
                                    if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
                                        newComboList.push(comboList[i]);
                                    } else {
                                        if (i != 0) {
                                            var selectData = $(this).combobox("getData");
                                            for(var i = 0 ; i < selectData.length; i++) {
                                                var code = selectData[i].CODE;
                                                if(code != '') {
                                                    var el = opts.finder.getEl(this, code);
                                                    el.find('input.combobox-checkbox')._propAttr('checked', false);
                                                }
                                            }
                                            newComboList = [ "" ];
                                            break;
                                        }
                                    }
                                }
                            }
                            if (newComboList.length <= 0) {
                                newComboList = [ "" ];
                            }
                            $(this).combobox('setValues', newComboList);
                            var el = opts.finder.getEl(this, row[opts.valueField]);
                            el.find('input.combobox-checkbox')._propAttr('checked', true);
                            searchData2();
                        },
                        onUnselect : function(row){
                            var opts = $(this).combobox('options');
                            $(this).val($(this).combobox("getValues"));
    
                            var comboList = $(this).combobox("getValues");
                            var comboText = $(this).combobox("getText").split(",");
                            var newComboList = [];
                            if (comboList != null && comboList != undefined) {
                                for (var i = 0; i < comboList.length; i++) {
                                    if (comboList[i].indexOf("--") == -1 && comboList[i] != "") {
                                        newComboList.push(comboList[i]);
                                    } else {
                                        if (i != 0) {
                                            newComboList = [ "" ];
    
                                            break;
                                        }
                                    }
                                }
                            }
                            if (newComboList.length <= 0) {
                                newComboList = [ "" ];
                            }
                            $(this).combobox('setValues', newComboList);
                            var el = opts.finder.getEl(this, row[opts.valueField]);
                            el.find('input.combobox-checkbox')._propAttr('checked', false);
                            searchData2();
                        }
                    });
    
                }
            });
        }*/

        var loadCitySelector = function () {
            var city = $(".city_a_le1 a"); //城市
            var beginCity = $("#tipinputbegin").textbox("textbox");
            var endCity = $("#tipinputend").textbox("textbox");
            inCity.width = "345";//城市选择框 宽
            inCity.height = "auto"; //城市选择框高
            inCity.id = "#in_city";  //城市选择框  父级ID
            inCity.Children = '.city_a_le1';  //城市名box
            // 初始化 城市HTML模板
            $(inCity.id).prepend(inCity._template.join(''));

            inCity.Hot(city);
            //城市 导航
            var apay = $(".screen a");

            var placeThis; //当前选择标签
            apay.click(function (obj) {  //城市导航
                inCity.payment($(this));
            })

            inCity.place(beginCity); //���发地
            inCity.destination(endCity);  //目的地
            inCity.cityClick(city); //显示赋值城市
        }

        var openDetail = function (map) {

            window.tempMap = map;
            window.FAtable = $("#gridTable").jqGrid("getRowData");

            var href = "../View/ywgl/trainsToAdjust.html";
            showLoading("#{supplier.loading}...");
            openDialog({
                title: $.i18n.prop('trainAdd_trainsToAdjust'),
                id: "trainsToAdjust",
                width: 1200,
                height: 300,
                isResize: true,
                href: href,
                closable: true
            })
        }

        var loadListByYwId = function (ywId) {
            $.ajax({
                url: "../../train/trainnolist?t=" + Math.random() + '&customSearchFilters=' + encodeURI(getYwIdSearchList()),
                type: 'POST',
                async: false,
                success: function (dataObj) {
                    var trainno = getTrainno();
                    for (var i = 0; i < dataObj.rows.length; i++) {
                        dataObj.rows[i].TRAINNO = trainno;
                    }
                    gridTableData = dataObj.rows;
                    searchData();
                }
            });
        }

        // detailGuid 当前运单明细的id
        var breakUp = function (detailGuid, detailParentGuid) {
            openBreakUpWindow(detailGuid, detailParentGuid);
        }

        var openBreakUpWindow = function (detailGuid, detailParentGuid) {
            var href = '../View/ywgl/breakUpDetail.html?t=' + Math.random() + "&detailGuid=" + detailGuid + "&detailParentGuid=" + detailParentGuid;
            showLoading("#{supplier.loading}...");
            openDialog({
                title: "拆分运单明细",
                id: "breakUpOrder",
                width: 500,
                height: 300,
                isResize: true,
                href: href,
                closable: true
            });
        }

        var openCheckedWinow = function () {
            var href = '../View/ywgl/checkedWindow.html?t=' + Math.random();
            showLoading("#{supplier.loading}...");
            openDialog({
                title: $.i18n.prop('trainAdd_selectGeneration'),
                id: "breakUpOrder",
                width: 400,
                height: 300,
                isResize: true,
                href: href,
                closable: true
            });
        }

        //自动生成车次逻辑
        var autoGenerator = function (conditions) {
            var rowDataArray = $("#gridTable2").jqGrid("getRowData");
            if (rowDataArray.length == 0) {
                errorNotification({ SimpleMessage: $.i18n.prop('trainAdd_generationTrainsError') });
                return;
            }
            var detailList = [];
            for (var i = 0; i < rowDataArray.length; i++) {
                var rowData = rowDataArray[i];
                var rootArray = null;
                for (var j = 0; j < detailList.length; j++) {
                    var vo = detailList[j][0];
                    if (/0/.test(conditions) && vo.BEGIN_LOCAL != rowData.BEGIN_LOCAL) {
                        continue;
                    }
                    if (/1/.test(conditions) && vo.END_LOCAL_SITE != rowData.END_LOCAL_SITE) {
                        continue;
                    }
                    if (/2/.test(conditions) && vo.PLANSHIPMENT_DATA != rowData.PLANSHIPMENT_DATA) {
                        continue;
                    }
                    if (/3/.test(conditions) && vo.END_LOCAL_SITE != rowData.END_LOCAL_SITE) {
                        continue;
                    }
                    if (/4/.test(conditions) && vo.END_LOCAL_SITE != rowData.END_LOCAL_SITE) {
                        continue;
                    }
                    rootArray = detailList[j];
                }
                if (rootArray != null) {
                    rootArray.push(rowData);
                } else {
                    detailList.push([rowData]);
                }
            }
            for (var key in detailList) {
                var mapList = detailList[key];
                var trainno = getTrainno();
                for (var j = 0; j < mapList.length; j++) {
                    mapList[j].TRAINNO = trainno;
                    gridTableData.push(mapList[j]);
                    queryConditions.push(mapList[j].YW_ID);
                }
            }
            for (var i = 0; i < gridTableData.length; i++) {
                gridTableData[i] = gridRowDataOneToTwo(gridTableData[i]);
            }
            searchData2();
            searchData();
        }

        //加载运输方式
        function loadTransportType() {
            $.ajax({
                url: "../../jcda/ZdCus/queryDictionary?t=" + Math.random() + "&kind=transportType",
                method: "GET",
                async: false,
                success: function (dataObj) {
                    let data = dataObj.resultDataFull;
                    data.forEach(function (item) {
                        trasportTextObj[item.dicValue] = item.dicText;
                        trasportValueObj[item.dicText] = item.dicValue;
                    });
                }
            });
        }
    </script>
</body>

</html>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN""http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <link id="CustomTheme" type="text/css" rel="stylesheet" href="../../Resource/css/index/customLightBlue.css"/>
    <link id="EasyuiTheme" type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/easyuiLightBlue.css"/>
    <link id="JqgridTheme" type="text/css" rel="stylesheet"
          href="../../Resource/js/jqueryUI/theme/jqgridLightBlue/jquery-ui-1.10.4.custom.css"/>
    <link type="text/css" rel="stylesheet" href="../../Resource/js/easyUI/themes/icon.css"/>
    <link type="text/css" rel="stylesheet" href="../../Resource/js/moment/css/daterangepicker.css"/>
    <link type="text/css" rel="stylesheet" href="../../Resource/js/jqueryUI/theme/ui.jqgrid.css"/>
    <link type="text/css" rel="stylesheet" href="../../Resource/js/fileUpload/css/fileUpload.css"/>
    <title>#{trainsManager_Title}</title>
    <style>
        .searchParamesPanel #searchParamesTable td {
            word-break: keep-all;
            white-space: nowrap;
        }

        .tab-title {
            float: right;
            margin-bottom: -1px;
            overflow-x: hidden;
        }

        .tab-title .item-cur {
            border: 1px solid #02c5bb !important;
            color: #02c5bb !important;
            border-bottom: none;
        }

        .tab-title .item {
            /*width: 100px;*/
            /*height: 40px;*/
            /*line-height: 39px;*/
            text-align: center;
            display: block;
            float: left;
            border: 1px solid #c3d3ea;
            margin-left: 4px;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            font-size: 12px;
            color: #666;
            width: 90px;
            height: 32px;
            line-height: 32px;
            border-bottom: none;
        }

        p {
            margin: 0 0;
        }

        /*.table-con{ margin:0px 16px 16px;}*/
        .table-list {
            width: 45%;
            font-family: "微软雅黑";
            background: #fff;
            margin: 5px;
        }

        .table-list tr {
            margin: 0;
            color: #666; /*font-size: 12px;*/
            height: 20px;
            background-color: #fff;
        }

        .table-title {
            margin: 0;
            background-color: #fff; /*font-size: 12px;*/
            color: #666;
            border-bottom: 1px solid #eaeaea;
            height: 20px;
        }

        .url_a {
            color: #0D9BF2 !important;
            /*text-underline: underline;*/
            text-decoration: underline
        }
    </style>
</head>
<body>
<div id="toolbar" class="easyui-panel" style="border-width:0; border-bottom-width:1px;">
    #{PAGE_TOOLBAR_BUTTONROLE}
    <div class="tab-title">
        <a href="javascript:queryAll();" id="queryAll" class="item"><p class="item1"><label data-locale="wayBill_all"/></p></a>
        <a href="javascript:takeDeliveryPlan('T');" id="takeDeliveryPlan" class="item"><p class="item2">
            <label data-locale="wayBill_takePlan"/></p></a>
        <a href="javascript:mainProgram('G');" id="mainProgram" class="item"><p class="item3"><label data-locale="wayBill_main"/></p></a>
        <a href="javascript:distributionPlan('P');" id="distributionPlan" class="item"><p class="item4">
            <label data-locale="wayBill_distribution"/></p></a>
        <a href="javascript:pickup('TGP');" id="pickup" class="item"><p class="item5"><label data-locale="wayBill_pickup"/></p></a>
    </div>
</div>
<div class="searchParamesPanel">
    <table id="searchParamesTable">
        <tr class="searchParamesTrShow">
            <td class="searchParamesTdTitle"><label data-locale="wayBillForm_theAwb"/>:</td>
            <td class="searchParamesTdControl">
                <input name="yw_id" id="yw_id" class="easyui-textbox" style="width:105px"/>
            </td>
            <td class="searchParamesTdTitle"><label data-locale="wayBillForm_cus"/>:</td>
            <td class="searchParamesTdControl">
                <input name="cus_no" id="cus_no" data-options="panelWidth:'300'" class="easyui-combobox" style="width:105px"/>
            </td>
            <td class="searchParamesTdTitle"><label data-locale="wayBillForm_state"/>:</td>
            <td class="searchParamesTdControl">
                <input name="state" id="state" class="easyui-combobox" style="width:100px"/>
            </td>
            <td class="searchParamesTdTitle"><label data-locale="wayBillForm_begin"/>:</td>
            <td class="searchParamesTdControl">
                <input name="begin_local" id="begin_local" class="easyui-combobox" style="width:105px"/>
            </td>
            <td class="searchParamesTdTitle"><label data-locale="wayBillForm_end"/>:</td>
            <td class="searchParamesTdControl">
                <input name="end_local_site" id="end_local_site" class="easyui-combobox" style="width:105px"/>
            </td>

            <td class="searchParamesTdTitle"><label data-locale="wayBillForm_planBeginDateStart"/>:</td>
            <td class="searchParamesTdControl">
                <input name="planshipment_data1" id="planshipment_data1" class="easyui-datebox"
                       data-options="editable:false" style="width:100px"/>
            </td>
            <td class="searchParamesTdTitle"><label data-locale="wayBillForm_planBeginDateEnd"/>:</td>
            <td class="searchParamesTdControl">
                <input name="planshipment_data2" id="planshipment_data2" class="easyui-datebox"
                       data-options="editable:false" style="width:100px"/>
            </td>


        </tr>
    </table>
</div>
<div id="gridControl">
    <table id="gridTable"></table>
    <div id="gridPager"></div>
</div>
<div id="fileUpload"
     style="position:absolute;left:50%;top:50%;width:600px;height:400px;margin-left:-300px;margin-top:-200px;display:none;"></div>

<form id="formExportFile" target="_blank" method="post" style="display: none"></form>

<script type="text/javascript" src="../../Resource/js/My97DatePicker/WdatePicker.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery.i18n.properties.js"></script>
<script type="text/javascript" src="../../Resource/js/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../../Resource/js/easyUI/jquery.easyuiExtend.min.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonControl.js"></script>
<script type="text/javascript" src="../../Resource/js/base/globalVariable.js"></script>
<script type="text/javascript" src="../../Resource/js/base/commonBusiness.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/i18n/grid.locale-cn.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/jquery.jqGrid.min.js"></script>
<script type="text/javascript" src="../../Resource/js/jqueryUI/plugins/grid.setcolumns.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/upload.js"></script>
<script type="text/javascript" src="../../Resource/js/fileUpload/js/file.js"></script>
<script language="javascript" type="text/javascript">
    var moduleId = 0;
    var cusNoInnerHtml = [];
    var stateTextObj = [];
    var routeType = '';
    var savedChildRow1 = "";
    var savedChildCol1 = "";
    var selectRowData = [];
    var fatherRowDate = [];

    $(function () {
        var parms = getUrlParms();
        moduleId = parms['moduleId'];
        initScript();
        loadState();
        initStyle();
        initData();


        $("#queryAll").addClass('item-cur');
    });

    $(window).load(function () {
        hideLoading();
    });

    var initStyle = function () {
        $.ajax({
            url: "../../jcda/ZdCus/findAllList?t=" + Math.random(),
            type: 'get',
            async: true,
            contentType: 'application/json;charset=utf-8',
            success: function (res) {
                var opts = [{Value: "", Text: $.i18n.prop('wayBillForm_pleaseChoose')}];
                var datas = res.resultDataFull;
                if (datas && datas.length > 0) {
                    for (var i = 0; i < datas.length; i++) {
                        opts.push({Value: datas[i].code, Text: datas[i].shortname});
                        cusNoInnerHtml[datas[i].code] = datas[i].shortname;
                    }
                }
                $('#cus_no').combobox({
                    data: opts,
                    valueField: 'Value',
                    textField: 'Text',
                    editable: false,
                    onSelect: searchData
                });
            }
        });
        $.ajax({
            url: "../../sysInfo/dictionaryData/getDictionaryDataList?dicTypeCode=sheet_yw_order_detail_state&t=" + Math.random(),
            type: 'get',
            async: true,
            contentType: 'application/json;charset=utf-8',
            success: function (datas) {
                var opts = [{Value: "", Text: $.i18n.prop('wayBillForm_pleaseChoose')}];
                if (datas && datas.length > 0) {
                    for (var i = 0; i < datas.length; i++) {
                        opts.push({Value: datas[i].dicValue, Text: datas[i].dicText});
                    }
                }
                $('#state').combobox({
                    data: opts,
                    valueField: 'Value',
                    textField: 'Text',
                    editable: false,
                    onSelect: searchData
                });
            }
        });

        $.ajax({
            url: "../../jcda/Zd_Location/findList?t=" + Math.random(),
            type: 'get',
            async: true,
            contentType: 'application/json;charset=utf-8',
            success: function (res) {
                var opts = [{Value: "", Text: $.i18n.prop('wayBillForm_pleaseChoose')}];
                var datas = res.resultDataFull;
                if (datas && datas.length > 0) {
                    for (var i = 0; i < datas.length; i++) {
                        opts.push({Value: datas[i].code, Text: datas[i].name});
                    }
                }
                $('#begin_local').combobox({
                    data: opts,
                    valueField: 'Value',
                    textField: 'Text',
                    panelWidth: 270,
                    onSelect: searchData
                });
                $('#end_local_site').combobox({
                    data: opts,
                    valueField: 'Value',
                    textField: 'Text',
                    panelWidth: 270,
                    onSelect: searchData
                });
            }
        });


        enterTriggerEvent('searchParamesTable', 'searchData');
    };
    var oldSetGridHeightWidth = setGridHeightWidth;
    var setGridHeightWidth = function () {
        oldSetGridHeightWidth(5, 140);
    };
    var initScript = function () {
        var v = 0;
        $(window).resize(function () {
            if (v == 0) {
                setTimeout(function () {
                    setGridHeightWidth();
                    v = 0;
                }, 200)
                v = 1;
            }
            setGridHeightWidth();
            setToolbarHeightWidth();
        });
    };

    var setGridCombobox = function (options) {
        var html = "";
        var json = $("#" + options.id).combobox("getData");
        for (var i = 0, ilen = json.length; i < ilen; i++) {
            html += "<option value='" + json[i].Value + "'>" + json[i].Text + "</option>";
        }
        $("#" + options.gridid).html(html);
    }

    var initData = function () {

        loadList();// 加载列表数据
    };

    // 查询数据
    function searchData() {
        $('#gridTable').jqGrid('setGridParam', {
            url: getSearchGridUrl(),
            datatype: 'json',
            postData: {'filters': ''},
            page: 1
        }).trigger('reloadGrid');
        selectRowData = [];
        fatherRowDate = [];
    }

    // 获取查询访问路径
    var getSearchGridUrl = function () {
        return '../../wayBill/getList?t=' + Math.random() + '&customSearchFilters=' + encodeURI(getSearchFilters());
    };

    // 获取查询条件
    var getSearchFilters = function () {

        var ywId = $("#yw_id").val();

        var cusNo = $("#cus_no").combobox("getValue");
        if (cusNo == "") {
            cusNo = '';
        }

        var state = $("#state").combobox('getValue');
        if (state == "") {
            state = "";
        }

        var beginLocal = $("#begin_local").combobox("getValue");
        if (beginLocal == "") {
            beginLocal = "";
        }

        var endLocal = $("#end_local_site").combobox("getValue");
        if (endLocal == "") {
            endLocal = "";
        }
        var parmsArray = [
            {name: 'B.route_type', value: routeType, op: 'eq'},
            {name: 'B.yw_id', value: ywId, op: 'cn'},
            {name: 'B.cus_no', value: cusNo, op: 'eq'},
            {name: 'A.state', value: state, op: 'eq'},
            {name: 'B.business_date', value: $("#planshipment_data1").combobox("getValue"), op: 'ge'},
            {name: 'B.business_date', value: $("#planshipment_data2").combobox("getValue")? $("#planshipment_data2").combobox("getValue")+' 23:59:59': '', op: 'le'},
            {name: 'C.begin_local_code', value: beginLocal, op: 'eq'},
            {name: 'C.end_local_code', value: endLocal, op: 'eq'}

        ];
        return formatSearchParames(parmsArray);
    };

    //用户选择时间后马上进行查询(前) 
    $('#planshipment_data1').datebox({
    	onChange: function(date){
    		if (date == "") {
		       $("#planshipment_data1").datebox('setValue','')
		       document.getElementById("searchData").click();
			}else{
		       searchData();
			}
    	},
    	onSelect : function(beginDate) {
    		$("#planshipment_data2").datebox().datebox("calendar").calendar({
    			validator : function(endDate) {
    				return beginDate <= endDate;
    			}
    		});
    	}
    }); 
   //用户选择时间后马上进行查询(后) 
   $('#planshipment_data2').datebox({
	   onChange: function(date){
       if (date == "") {
	       $("#planshipment_data2").datebox('setValue','')
	       document.getElementById("searchData").click();
		}else{
	       searchData();
		}
    }});

    var loseGridChindFocus = function () {
        if (savedChildRow1 && savedChildCol1) {
            $('#gridTable').jqGrid('saveCell', savedChildRow1, savedChildCol1);
        }
    }


    // 加载列表数据
    var loadList = function () {
        $('#gridTable').jqGrid({
            url: getSearchGridUrl(),
            datatype: 'json',
            width: 'none',
            colNames: [
                '','', '', '', '', $.i18n.prop('wayBillList_contId'), $.i18n.prop('wayBillForm_state'),$.i18n.prop('wayBill_routeType'), $.i18n.prop('wayBillForm_cus'), $.i18n.prop('wayBillForm_entrustTheTime'), $.i18n.prop('wayBillForm_Entrust'),/*$.i18n.prop('wayBillForm_orderNumber'),*/
                $.i18n.prop('wayBillForm_theAwb'), $.i18n.prop('wayBillForm_planBeginDate'), $.i18n.prop('wayBillForm_number'), '#{wayBillForm_gwt} /KG', '#{wayBillForm_vol} /m³',
                $.i18n.prop('wayBillList_begin'), $.i18n.prop('wayBillList_end'), $.i18n.prop('wayBillList_contractor'), $.i18n.prop('wayBillList_truck'), $.i18n.prop('wayBillList_driver'), $.i18n.prop('wayBillList_scheduledAdmissionTime')
            ],
            colModel: [
                {
                    name: 'STATE', index: '', align: 'center', hidden: true,
                    formatter: function (value, gird, rows) {
                        return rows.STATE_NAME;
                    }
                },
                {
                  name: 'TRAINNO', index: '' , align: 'center', hidden: true
                },
                {
                    name: 'MOSTLY_GUID',
                    index: 'a.',
                    key: true,
                    align: 'center',
                    isSort: true,
                    sorttype: 'string',
                    search: true,
                    sortable: true,
                    hidden: true
                },
                {
                    name: 'DETAIL_GUID',
                    index: '',
                    align: 'center',
                    isSort: true,
                    sorttype: 'string',
                    search: true,
                    sortable: true,
                    hidden: true
                },
                {
                    name: 'SN',
                    index: 'sn',
                    align: 'center',
                    isSrot: true,
                    sorttype: 'string',
                    search: true,
                    sortable: true,
                    hidden: true
                },
                {
                    name: 'CONT_ID',
                    index: 'A.cont_id',
                    align: 'center',
                    isSort: true,
                    sorttype: 'string',
                    search: false,
                    
                    hidden: true
                },
                {
                    name: 'STATE_NAME',
                    index: 'e.dictext',
                    align: 'center',
                    isSort: true,
                    sorttype: 'string',
                    width: 80,
                    search: true,
                    sortable: true,
                    hidden: false,
                    formatter: function (value, grid, rows) {
                        let detailGuid = rows.DETAIL_GUID.split(',');
                        let state = rows.STATE_NAME;
                        if (detailGuid.length > 1 || state == '审核' || state == '正常') {
                            return value;
                        } else {
                            return '<a href="javascript:void(0);" class="url_a" onclick="openDetail(\'' + rows.TRAINNO + '\',\'' + rows.MOSTLY_GUID + '\', \'' + rows.DETAIL_GUID + '\')">' + rows.STATE_NAME + '</a>';
                        }
                    },
                },
                { name: 'ROUTE_TYPE', index: 'b.route_type', width: 100, align: 'left', hidden: false,  search: false},
                {
                    name: 'CUS_NO',
                    index: 'B.cus_no',
                    align: 'left',
                    isSort: false,
                    sorttype: 'string',
                    width: 80,
                    search: false,
                    
                    hidden: false,
                    formatter: function (value, grid, rows) {
                        return cusNoInnerHtml[value];
                    }
                },
                {
                    name: 'BUSINESS_DATE',
                    index: 'b.business_date',
                    align: 'left',
                    isSort: false,
                    sorttype: 'string',
                    width: 125,
                    search: false,
                    
                    hidden: false
                },
                {
                    name: 'BUSINESS_YW_ID',
                    index: 'b.business_yw_id',
                    align: 'center',
                    isSort: false,
                    sorttype: 'string',
                    width: 120,
                    search: false,
                    
                    hidden: false
                },
                {
                    name: 'YW_ID',
                    index: 'b.yw_id',
                    align: 'center',
                    isSort: false,
                    sorttype: 'string',
                    width: 120,
                    search: false,
                    
                    hidden: false
                },
                {
                    name: 'PLANSHIPMENT_DATA',
                    index: 'b.PLANSHIPMENT_DATA',
                    align: 'center',
                    isSort: false,
                    sorttype: 'string',
                    width: 125,
                    search: false,
                    
                    hidden: false
                },
                {
                    name: 'QTY',
                    index: 'b.qty',
                    align: 'right',
                    isSort: false,
                    sorttype: 'string',
                    width: 60,
                    search: false,
                    
                    hidden: false
                },
                {
                    name: 'GWT',
                    index: 'b.gwt',
                    align: 'right',
                    isSort: false,
                    sorttype: 'string',
                    width: 60,
                    search: false,
                    
                    hidden: false
                },
                {
                    name: 'VOL',
                    index: 'b.vol',
                    align: 'right',
                    isSort: false,
                    sorttype: 'string',
                    width: 60,
                    search: false,
                    
                    hidden: false
                },
                {
                    name: 'BEGIN_LOCAL_ALL',
                    index: '',
                    align: 'left',
                    isSort: false,
                    search: false,
                    
                    hidden: false,
                    width: 200,
                    formatter : function(value, grid, rows){
                        return value.split('-')[1];
                    },
                },
                {
                    name: 'END_LOCAL_ALL',
                    index: '',
                    align: 'left',
                    isSort: false,
                    search: false,
                    
                    hidden: false,
                    width: 200,
                    formatter : function(value, grid, rows){
                        return value.split('-')[1];
                    },
                },
                {
                    name: 'CONTRACTOR_ALL',
                    index: '',
                    align: 'left',
                    isSort: false,
                    search: false,
                    
                    hidden: false,
                    width: 200
                },
                {
                    name: 'TRUCKNOQ',
                    index: '',
                    align: 'center',
                    isSort: false,
                    search: false,
                    
                    hidden: false,
                    width: 70
                },
                {
                    name: 'DRIVER_NAME',
                    index: '',
                    align: 'center',
                    isSort: false,
                    search: false,
                    
                    hidden: false,
                    width: 70
                },
                {
                    name: 'TB_PLAN_BEGIN_DATE',
                    index: '',
                    align: 'center',
                    isSort: false,
                    search: false,
                    
                    hidden: false,
                    width: 120
                }

            ],
            shrinkToFit: false,
            altRows: true,
            altclass: 'gridSpacingClass',
            forceFit: true,
            cellLayout: 0,
            scroll: false,
            autowidth: true,
            // sortname :'b.yw_id',
            subGrid: true,//开启子表格支持
            sortorder: 'desc',
            loadonce: false,
            mtype: 'POST',
            viewrecords: true,
            rownumbers: true,
            multiselect: true,
            rowNum: 15,
            height: '100%',
            rowList: [15, 20, 30, 50],
            pager: '#gridPager',
            jsonReader: {
                root: 'rows',
                total: 'total',
                page: 'page',
                records: 'records',
                repeatitems: false
            },
            gridComplete: function () {
                $('.cbox').shiftSelect();
                var rowData = $("#gridTable").jqGrid('getRowData');
                for (let i = 0; i < rowData.length; i++) {
                    let data = rowData[i];
                    $("#jqg_gridTable_" + data.MOSTLY_GUID).bind('click', function () {
                        allChecked(data.MOSTLY_GUID);
                    })
                }
            },
            ondblClickRow: function (code) {
                /*//双击触发跳转订单子明细列表
                var rowData = $("#gridTable").jqGrid('getRowData',code);
                var mostlyGuid = rowData.mainGuid;
                var href = '../View/ywgl/orderDetailChild.html?moduleId=' + moduleId + '&detail_guid=' + mostlyGuid;
                openDialog({ title : $.i18n.prop('orderList_Title'), id : 'orderDetailChild', width : 1000, height : 300, isResize : true, href : href, closable : true });*/
            },
            loadComplete: function (xhr) {
                $('.gridViewPicLink').tooltip({
                    position: 'bottom',
                    content: $(this).attr('title'),
                    onShow: function () {
                        $(this).tooltip('tip').css({backgroundColor: '#FCF8E3', borderColor: '#FAEBCC'});
                    }
                });
                FailResultDataToTip(xhr);
            },
            subGridRowExpanded: function (subgrid_id, row_id) {//加载子表格
                //alert("添加详细列表")
                let rowData = $("#gridTable").jqGrid('getRowData', row_id);
                let mostlyGuid = rowData.MOSTLY_GUID;
                //  通过 mostly_guid 去查 detail
                // $("#" + subgrid_id) 全部拼接在这个id后面
                let allCheck = $("#jqg_gridTable_" + rowData.MOSTLY_GUID).is(':checked');


                // 去查 detail
                $.ajax({
                    url: '../../wayBill/getDetailList?t=' + Math.random(),
                    type: 'POST',
                    data: 'mostlyGuid=' + rowData.MOSTLY_GUID,
                    success: function (dataObj) {
                        var content = '<div class="table-con">'
                        content += '<table class="table-list" border="0" cellspacing="0" cellpadding="4">'; // 定义一个table
                        content += '<tbody>';
                        content += '<tr>';
                        content += '<td width="6%" align="left" class="table-title"></td>'
                        content += '<td width="10%" align="left" class="table-title">#{wayBillForm_state}</td>';
                        content += '<td width="15%" align="left" class="table-title">#{wayBillDetailList_goodsName}</td>';
                        content += '<td width="10%" align="left" class="table-title">#{wayBillForm_number}</td>';
                        content += '<td width="10%" align="left" class="table-title">#{wayBillForm_gwt} /KG</td>';
                        content += '<td width="12%" align="left" class="table-title">#{wayBillForm_vol} /m³</td>';
                        content += '<td width="12%" align="left" class="table-title">#{wayBillList_truck}</td>';
                        content += '<td width="10%" align="left" class="table-title">#{wayBillList_driver}</td>';
                        content += '<td width="15%" align="left" class="table-title">#{wayBillList_scheduledAdmissionTime}</td>';
                        content += '</tr>';
                        if (isServerResultDataPass(dataObj)) {
                            let data = dataObj.resultDataFull;
                            let index = 0;
                            for (let i = 0; i < data.length; i++) {
                                let state = data[i].state == null ? "" : stateTextObj[data[i].state];
                                let goodsName = data[i].goodsName == null ? "" : data[i].goodsName;
                                let qty = data[i].qty == null ? "" : data[i].qty;
                                let gwt = data[i].gwt == null ? "" : data[i].gwt;
                                let vol = data[i].vol == null ? "" : data[i].vol;
                                let truck = data[i].sjTrucknoq == null ? "" : data[i].sjTrucknoq;
                                let driverName = data[i].driverName == null ? "" : data[i].driverName;
                                let beginDate = data[i].planBeginDate == null ? "" : data[i].planBeginDate;
                                content += '<tr>';
                                content += '<td align="left"><label><input type="checkbox" onclick="validateChecked(\'' + row_id + '\');" name="' + rowData.MOSTLY_GUID + '" data-state="' + state + '" id="tab_' + rowData.MOSTLY_GUID + '_' + index + '" value="' + data[i].guid + '"/></label></td>'
                                content += '<td align="left">' + state + '</td>';
                                content += '<td align="left">' + goodsName + '</td>';
                                content += '<td align="left">' + qty + '</td>';
                                content += '<td align="left">' + gwt + '</td>';
                                content += '<td align="left">' + vol + '</td>';
                                content += '<td align="left">' + truck + '</td>';
                                content += '<td align="left">' + driverName + '</td>';
                                content += '<td align="left">' + beginDate + '</td>';
                                content += '</tr>';
                                index++;
                            }
                        }
                        content += '</tbody>';
                        content += '</table>';
                        content += '</div>';
                        $("#" + subgrid_id).html(content);
                    },
                    complete: function () {
                        if (allCheck) {
                            $("[name='" + rowData.MOSTLY_GUID + "']").attr("checked", 'true');//全选
                        }
                    }
                });

            }
        });
        $('#gridTable').setGridParam({
            beforeEditCell: function (rowid, cellname, value, iRow, iCol) {
                savedChildRow1 = iRow;
                savedChildCol1 = iCol;
            }
        });

        $("#gridTable").jqGrid('navGrid', '#gridPager', { add: false, edit: false, del: false, refresh: true, search: false }, {}, {}, {}, { multipleSearch: false, closeOnEscape: true, closeAfterSearch: true });
        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
            caption: $.i18n.prop('wayBill_column'),// 设置列
            title: 'Reorder Columns',
            onClickButton: toggleGridColumns
        });

        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
            caption: $.i18n.prop('wayBillList_quickSearch'),// 快捷搜索
            title: 'Quick Search',
            onClickButton: function () {
                toggleGridSearchToolbar();
                var options = [];
                options.id = "state";
                options.gridid = "gs_state_name";
                setGridCombobox(options);

                options.id = "cus_no";
                options.gridid = "gs_cus_name";
                setGridCombobox(options);

                options.id = "begin_local";
                options.gridid = "gs_begin_local";
                setGridCombobox(options);

                options.id = "end_local_site";
                options.gridid = "gs_end_local_site";
                setGridCombobox(options);
            }
        });
        $('#gridTable').jqGrid('navButtonAdd', '#gridPager', {
            caption: $.i18n.prop('wayBillList_exportData'),// 导出数据
            title: 'Export Datas',
            buttonicon: 'ui-icon-disk',
            onClickButton: function () {
                ExportToExcel.call(this, {url: '../../ywgl/TrainsManager/exportExcel?t=' + Math.random()});
            }
        });
        setGridHeightWidth();
    };


    function addTrainno() {
        var selectRowItems = $('#gridTable').jqGrid('getGridParam', 'selarrrow');
        if (selectRowItems.length == 0) {
            errorNotification({SimpleMessage: $.i18n.prop('trainsManager_no_select_data')});
            return;
        }
        var ywIdList = [];
        for (var i = 0; i < selectRowItems.length; i++) {
            var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
            ywIdList.push(rowData.yw_id);
        }

        var href = "../View/ywgl/trainsPlanDetailByAdd.html?ywId=" + encodeURI(ywIdList);
        showLoading($.i18n.prop('trainsManager_trainno_plan_create'));
        createNewTab($.i18n.prop('trainsManager_trainno_plan_create'), href);
    }

    function send() {
        //派遣按钮
        var cont_idList = ""; // 定义一个传值字符串，逗号分隔
        var selectRowItems = $('#gridTable').jqGrid('getGridParam', 'selarrrow');

       for (let i = 0; i < selectRowData.length; i++) {
           const element = selectRowData[i];
           
           if(fatherRowDate.length > 0){
                let index = fatherRowDate.indexOf(element);
                if(index === -1){
                    let index1 = selectRowData.indexOf(element);
                    selectRowData.splice(index1,1);
                }
           }
       }



        for (let i = 0; i < selectRowItems.length; i++) {
            selectRowData.push(selectRowItems[i]);
            selectRowData = Array.from(new Set(selectRowData))
        }
        var routeTypeList = [];


        //判断父表格的状态是否为审核状态
        for (let i = 0; i < selectRowData.length; i++) {
            const element = selectRowData[i];
            var rowData = $("#gridTable").jqGrid("getRowData", element);
            routeTypeList.push(rowData.ROUTE_TYPE);
            /*var rowData = $("#gridTable").jqGrid("getRowData", element);
            if(rowData.STATE !== '审核'){
                errorNotification({SimpleMessage: $.i18n.prop('trainsManager_select_start') + (i + 1) + $.i18n.prop('trainsManager_row_uncheck')});
                return;
            }*/
        }

        //备份一份当前所选中的父表格
        fatherRowDate = selectRowItems;


        // 如果一级列表为空，就看二级列表是否有数据，如果二级列表没有数据，就提示错误
        if (selectRowItems.length <= 0) {
            // 需要截取 '-' 以后的数据
            let checked = $("input[type='checkbox']:checked");
            if (checked.length == 0) {
                errorNotification({SimpleMessage: $.i18n.prop('trainsManager_unchecked')});//  没有选择数据，不能进行操作
                return;
            } else {

                // 首先判断 状态是否为审核状态，如果��是，直接返回
                let checkboxState = $("input[type='checkbox']:checked").map(function(index, elem) {
                    return $(elem).attr('data-state');
                }).get().join(',');
                while(checkboxState.indexOf("on,") != -1) {
                    checkboxState = checkboxState.replace("on", "");
                }
                let stateS = checkboxState.split(",");
                for(let i = 0 ; i < stateS.length; i++) {
                    if(stateS[i] != "审核") {
                        errorNotification({ simpleMessage: $.i18n.prop('wayBill_noExamine')});
                        return;
                    }
                }

                let checkboxValue = $("input[type='checkbox']:checked").map(function (index, elem) {
                    return $(elem).val();
                }).get().join(',');
                while (checkboxValue.indexOf("on,") != -1) {
                    checkboxValue = checkboxValue.replace("on,", "");
                }
                cont_idList = checkboxValue;
            }
        } else {
            for (var i = 0; i < selectRowItems.length; i++) {
                var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
                if(rowData.STATE !== '审核'){
                    errorNotification({SimpleMessage: $.i18n.prop('trainsManager_select_start') + (i + 1) + $.i18n.prop('trainsManager_row_uncheck')});
                    return;
                }

                cont_idList += rowData.DETAIL_GUID + ",";
            }

            let checkboxState = $("input[type='checkbox']:checked").map(function(index, elem) {
                return $(elem).attr('data-state');
            }).get().join(',');
            while(checkboxState.indexOf("on,") != -1) {
                checkboxState = checkboxState.replace("on", "");
            }
            let stateS = checkboxState.split(",");
            if(stateS != '') {
                for(let i = 0 ; i < stateS.length; i++) {
                    if(stateS[i] != "审核") {
                        errorNotification({ simpleMessage: $.i18n.prop('wayBill_noExamine')});
                        return;
                    }
                }
            }

            let checkboxValue = $("input[type='checkbox']:checked").map(function (index, elem) {
                return $(elem).val();
            }).get().join(',');
            while (checkboxValue.indexOf("on,") != -1) {
                checkboxValue = checkboxValue.replace("on,", "");
            }
            if (checkboxValue != "on") {
                cont_idList += checkboxValue + ",";
            }
        }
        // 处理 cont_idList 的数据
        let str = cont_idList.split(",");
        let contIdList = "";
        for (let i = 0; i < str.length; i++) {
            let newStr = "";
            if (str[i].indexOf('-') != -1) {
                newStr = str[i].substring(0, str[i].indexOf('-'));
            } else {
                newStr = str[i];
            }

            contIdList += newStr + ",";
        }

        if(contIdList.length === 0){
            errorNotification({SimpleMessage: $.i18n.prop('trainsManager_unchecked')});
            return;
        }

        // 判断所选择的父表格的在途运输类型是否相同
        routeTypeList = Array.from(new Set(routeTypeList))
        if (routeTypeList.length !== 1){
            errorNotification({SimpleMessage: $.i18n.prop('routeType must be same')});
            return;
        }

        var href = "../View/ywgl/dispatchsend.html?order_no=" + encodeURI(contIdList)
            + "&routeType=" + routeType
            + "&selectRouteType=" + routeTypeList[0]
            + "&t=" + Math.random();

        openDialog({
            title: $.i18n.prop('trainsManager_order_sends'),
            id: 'planExecDetail',
            width: 500,
            height: 400,
            isResize: true,
            href: href,
            closable: true
        });
    }

    function reback() {
        loseGridChindFocus();
        var snList = "";
        //派遣撤回按钮
        var selectRowItems = $('#gridTable').jqGrid('getGridParam', 'selarrrow');
        if (selectRowItems.length <= 0) {
            let checked = $("input[type='checkbox']:checked");
            if (checked.length == 0) {
                errorNotification({SimpleMessage: $.i18n.prop('trainsManager_unchecked')});//  没有选择数据，不能进行操作
                return;
            } else {
                let checkboxValue = $("input[type='checkbox']:checked").map(function (index, elem) {
                    return $(elem).val();
                }).get().join(',');
                while (checkboxValue.indexOf("on,") != -1) {
                    checkboxValue = checkboxValue.replace("on,", "");
                }
                snList = checkboxValue;
            }
        } else {
            for (var i = 0; i < selectRowItems.length; i++) {
                var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
                var state = rowData.STATE;
                if (state != '已计划派遣') {
                    errorNotification({SimpleMessage: $.i18n.prop('trainsManager_select_start') + (i + 1) + $.i18n.prop('trainsManager_row_uncheck')});
                    return;
                }
                snList += rowData.SN + ",";
            }

            let checkboxValue = $("input[type='checkbox']:checked").map(function (index, elem) {
                return $(elem).val();
            }).get().join(',');
            while (checkboxValue.indexOf(",on") != -1) {
                checkboxValue = checkboxValue.replace(",on", "");
            }
            while (checkboxValue.indexOf("on,") != -1) {
                checkboxValue = checkboxValue.replace("on,", "");
            }
            if (checkboxValue != "on") {
                snList += checkboxValue + ",";
            }
        }

        // 处理 cont_idList 的数据
        let str = snList.split(",");
        let contIdList = [];
        for (let i = 0; i < str.length; i++) {
            let newStr = "";
            if (str[i].indexOf('-') != -1) {
                newStr = str[i].substring(str[i].indexOf('-') + 1, str[i].length);
            } else {
                newStr = str[i];
            }
            if (newStr != "") {
                contIdList.push({sn: newStr});
            }

        }

        /* for(var i = 0 ; i < selectRowItems.length; i++) {
             var rowData = $("#gridTable").jqGrid("getRowData", selectRowItems[i]);
             var state = rowData.state;
             if(state != 2) {
                 errorNotification({ SimpleMessage : $.i18n.prop('trainsManager_select_start')+(i+1)+$.i18n.prop('trainsManager_no_send_state') });
                 return;
             }
             snList.push({sn:rowData.sn});
         }*/

        $.messager.confirm($.i18n.prop('trainsManager_alert'), $.i18n.prop('trainsManager_reback'), function (r) {
            if (r) {
                showLoading($.i18n.prop('trainsManager_rebacking'));
                $.ajax({
                    url: "../../train/reBackTrain?t=" + Math.random(),
                    type: 'POST',
                    contentType: 'application/json;charset=utf-8',
                    data: JSON.stringify(contIdList),
                    success: function (dataObj) {
                        hideLoading();
                        if (isServerResultDataPass(dataObj)) {
                            correctNotification(dataObj.resultDataFull);
                            searchData();
                        } else {
                            FailResultDataToTip(dataObj);
                        }
                    },
                    error: function (message) {
                        hideLoading();
                    }
                });
            }
        });
    }

    /*<a href="javascript:queryAll();" id="queryAll" class="item"><p class="item1">所有</p></a>
    <a href="javascript:takeDeliveryPlan('');" id="takeDeliveryPlan" class="item"><p class="item2">提货计划</p></a>
    <a href="javascript:mainProgram('');" id="mainProgram" class="item"><p class="item3">干线计划</p></a>
    <a href="javascript:distributionPlan('');" id="distributionPlan" class="item"><p class="item4">配送计划</p></a>*/

    var queryAll = function () {
        $("#queryAll").addClass('item-cur');
        $("#pickup").removeClass('item-cur');
        $("#takeDeliveryPlan").removeClass('item-cur');
        $("#mainProgram").removeClass('item-cur');
        $("#distributionPlan").removeClass('item-cur');
        routeType = "";
        selectRowData = [];
        searchData();
    }

    var takeDeliveryPlan = function (routeTypeParams) {
        $("#queryAll").removeClass('item-cur');
        $("#pickup").removeClass('item-cur');
        $("#takeDeliveryPlan").addClass('item-cur');
        $("#mainProgram").removeClass('item-cur');
        $("#distributionPlan").removeClass('item-cur');
        routeType = routeTypeParams;
        selectRowData = [];
        searchData();
    }

    var mainProgram = function (routeTypeParams) {
        $("#queryAll").removeClass('item-cur');
        $("#pickup").removeClass('item-cur');
        $("#takeDeliveryPlan").removeClass('item-cur');
        $("#mainProgram").addClass('item-cur');
        $("#distributionPlan").removeClass('item-cur');
        routeType = routeTypeParams;
        selectRowData = [];
        searchData();
    }

    var distributionPlan = function (routeTypeParams) {
        $("#queryAll").removeClass('item-cur');
        $("#pickup").removeClass('item-cur');
        $("#takeDeliveryPlan").removeClass('item-cur');
        $("#mainProgram").removeClass('item-cur');
        $("#distributionPlan").addClass('item-cur');
        routeType = routeTypeParams;
        selectRowData = [];
        searchData();
    }

    var pickup = function (routeTypeParams) {
        $("#queryAll").removeClass('item-cur');
        $("#takeDeliveryPlan").removeClass('item-cur');
        $("#mainProgram").removeClass('item-cur');
        $("#distributionPlan").removeClass('item-cur');
        $("#pickup").addClass("item-cur");
        routeType = routeTypeParams;
        selectRowData = [];
        searchData();

    }

    var allChecked = function (name) {
        let allCheck = $("#jqg_gridTable_" + name).is(':checked');
        if (allCheck) {
            $("[name='" + name + "']").attr("checked", 'true');//全选
        } else {
            $("[name='" + name + "']").removeAttr("checked");//全选
        }
    }

    var validateChecked = function (row_id) {

        var data =  $("#gridTable").jqGrid('getRowData', row_id);;
        var name = data.MOSTLY_GUID;

        let allCheckNum = $("[name='" + name + "']").length;
        let checkedNum = $("[name='" + name + "']:checked").length;
        if (allCheckNum == checkedNum) {
            $("#jqg_gridTable_" + name).attr('checked', 'true');
            $("#" + name).addClass('ui-state-highlight');
            $("#" + name).attr("aria-selected", 'true');
        } else {
            $("#jqg_gridTable_" + name).removeAttr('checked');
            // $("#jqg_gridTable_" + name).click();
            $("#" + name).removeClass('ui-state-highlight');
            $("#" + name).removeAttr("aria-selected");
        }

        //子表格全部取消
        if(checkedNum === 0){
            var index = selectRowData.indexOf(row_id);
            if (index > -1) {
                selectRowData.splice(index, 1);
            }
        }else{ //子表格还存在勾选状态
            selectRowData.push(row_id);
        }

        //去重
        selectRowData = Array.from(new Set(selectRowData));
    }

    var loadState = function () {
        $.ajax({
            url: "../../sysInfo/dictionary/getstate?t=" + Math.random(),
            type: "POST",
            async: false,
            data: "tableName=" + "sheet_yw_order_detail_state",
            success: function (dataObj) {
                var data = dataObj.resultDataFull;
                data.unshift({dicText: '--所有--', dicValue: ''});
                data.forEach(function (item) {
                    stateTextObj[item.dicValue] = item.dicText;
                });
            }
        });
    }

    var openDetail = function (trainNo,mostlyGuid, detailGuid) {
        var href = "../View/ztgl/TrainDetail.html?detail_guid=" + detailGuid + "&t=" + Math.random() + "&identifier=" + 1 + '&type=' + 1 + '&trainNo=' + trainNo;
        showLoading($.i18n.prop('Loading'));
        openDialog({
            title: $.i18n.prop('TrainDetail'),
            id: 'TrainDetail',
            width: 1150,
            height: 600,
            isResize: true,
            href: href,
            closable: true
        });
    }


</script>
</body>
</html>

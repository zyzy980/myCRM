

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link type="text/css" rel="stylesheet" href="../Resource/js/easyUI/themes/icon.css" />
    <link type="text/css" rel="stylesheet" href="../Resource/js/jqueryUI/theme/ui.jqgrid.css" />
    <link type="text/css" rel="stylesheet" href="../Resource/js/moment/css/daterangepicker.css" />
    <link type="text/css" rel="stylesheet" href="../Resource/js/locationChoose/css.css" />
    <link type="text/css" rel="stylesheet" href="../Resource/css/index/customBlue.css" />
    <link type="text/css" rel="stylesheet" href="../Resource/js/easyUI/themes/easyuiBlue.css" />
    <link type="text/css" rel="stylesheet" href="../Resource/js/easyUI/themes/icon.css" />
    <link type="text/css" rel="stylesheet" href="../Resource/js/jqueryUI/theme/jqgridBlue/jquery-ui-1.10.4.custom.css" />
    <title>运单轨迹</title>
    <style type="text/css">
        html, body
        {
            height: 100%;
        }
        .anchorBL{
        	display: none;
        }
        .BMap_noprint{
        	display: none;
        }
    </style>
</head>
<body>
    <!--<div id="DivState" style="z-index: 2000; position: absolute; top: 10px; right: 70px;
        border: 0px gray solid; padding: 10px; width: 250px; color: white; background-color: black;
        font-weight: bolder; opacity: 0.5;">
        <div>
            <div style="height: 30px; padding: 0 10px; display: flex; flex-direction: row; flex-wrap: nowrap;
                justify-content: space-around;">
                <div style="align-items: center; flex-grow: 1">
                    今日订单：<span>9382</span>
                </div>
                <div style="align-items: center; flex-grow: 1; text-align: right; cursor: pointer;"
                    onclick="refeash()">
                    刷新
                </div>
            </div>
            <div style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around;">
                <div style="align-items: center;">
                    <div style="width: 50px; height: 50px; border: 2px solid #3c8dbc; border-radius: 50%;">
                        <div style="height: 100%; width: 100%; line-height: 50px; font-size: 17px; text-align: center;">
                            7
                        </div>
                    </div>
                    <div style="text-align: center;">
                        未发运
                    </div>
                </div>
                <div style="align-items: center;">
                    <div style="width: 50px; height: 50px; border: 2px solid #605ca8; border-radius: 50%;">
                        <div style="height: 100%; width: 100%; line-height: 50px; font-size: 17px; text-align: center;">
                            120
                        </div>
                    </div>
                    <div style="text-align: center;">
                        已发运
                    </div>
                </div>
                <div style="align-items: center;">
                    <div style="width: 50px; height: 50px; border: 2px solid #00a65a; border-radius: 50%;">
                        <div style="height: 100%; width: 100%; line-height: 50px; font-size: 17px; text-align: center;">
                            87
                        </div>
                    </div>
                    <div style="text-align: center;">
                        已交付
                    </div>
                </div>
            </div>
            <div style="display: flex; flex-direction: row; flex-wrap: nowrap; justify-content: space-around;
                margin-top: 5px;">
                <div style="align-items: center;">
                    <div style="width: 50px; height: 50px; border: 2px solid #f39c12; border-radius: 50%;">
                        <div style="height: 100%; width: 100%; line-height: 50px; font-size: 17px; text-align: center;">
                            5
                        </div>
                    </div>
                    <div style="text-align: center;">
                        有延期风险
                    </div>
                </div>
                <div style="align-items: center;">
                    <div style="width: 50px; height: 50px; border: 2px solid #f56954; border-radius: 50%;">
                        <div style="height: 100%; width: 100%; line-height: 50px; font-size: 17px; text-align: center;">
                            3
                        </div>
                    </div>
                    <div style="text-align: center;">
                        已延期
                    </div>
                </div>
                <div style="align-items: center;">
                    <div style="width: 50px; height: 50px; border: 2px solid #ff851b; border-radius: 50%;">
                        <div style="height: 100%; width: 100%; line-height: 50px; font-size: 17px; text-align: center;">
                            1
                        </div>
                    </div>
                    <div style="text-align: center;">
                        在途异常
                    </div>
                </div>
            </div>
        </div>
        <div id="aaa">
        </div>
    </div>
    <div style="width: 100%; height: 100%; -webkit-transition: all 0.5s ease-in-out;
        transition: all 0.5s ease-in-out;" id="trainTrackMap">
    </div>
    <div id="showMode" style="z-index: 2000; position: absolute; top: 10px; left: 70px;
        border: 0px gray solid; padding: 10px; width: 165px; color: white; background-color: black;
        font-weight: bolder; opacity: 0.5;">
        <div class="searchParamesPanel">
            <input type="radio" checked="true" id="showModeOrderHeatmap" name="showModeOrder" /><label
                for="showModeOrderHeatmap">订单热力图</label>
            <input type="radio" id="showModeOrderTrcuk" name="showModeOrder"><label for="showModeOrderTrcuk">在途车辆</label>
        </div>
    </div>-->
</body>
<script type="text/javascript" src="../Resource/js/jquery-2.0.0.min.js"></script>
<script type="text/javascript" src="../Resource/js/jquery.i18n.properties.js"></script>
<script type="text/javascript" src="../Resource/js/jquery-migrate-1.2.1.min.js"></script>
<script type="text/javascript" src="../Resource/js/easyUI/jquery.easyui.min.js"></script>
<script type="text/javascript" src="../Resource/js/easyUI/easyui-lang-zh_CN.js"></script>
<script type="text/javascript" src="../Resource/js/base/commonControl.js?version=20171107"></script>
<script type="text/javascript" src="../Resource/js/base/globalVariable.js?version=20171106"></script>
<script type="text/javascript" src="../Resource/js/base/commonBusiness.js?version=20171106"></script>
<script type="text/javascript" src="../Resource/js/jsLinq/linq.js"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=6eea93095ae93db2c77be9ac910ff311"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js"></script>
<script type="text/javascript" src="../Resource/js/echarts/echarts.min.js"></script>
<script type="text/javascript">
    /*var mapStyle = [
        {
            "featureType": "all",
            "elementType": "all",
            "stylers": {
                "lightness": 10,
                "saturation": -100
            }
        }
    ];

    var map;
    var heatmapOverlay;
    var showType = "heatmap";
    $(function () {
        initScript();
        //initData();
        ReportSUBCONTRACTOR_NAMELoad();
    });

    var initScript = function () {
        if (!isSupportCanvas()) {
            alert('热力图目前只支持有canvas支持的浏览器,您所使用的浏览器不能使用热力图功能~');
        }

        map = new BMap.Map("trainTrackMap");
//                map.setMapStyle({
//                    styleJson: mapStyle
//                });
        map.centerAndZoom("北京", 5);
        map.addControl(new BMap.NavigationControl());
        map.addControl(new BMap.ScaleControl());
        map.addControl(new BMap.OverviewMapControl());
        map.addControl(new BMap.MapTypeControl());
        map.enableScrollWheelZoom();
        map.addEventListener("load", function (e) {
            initHeatmap();
        });

        /!* $('input:radio[name="showModeOrder"]').change(function () {
            if ($(this).attr("id") == "showModeOrderHeatmap") {
                map.centerAndZoom("北京", 5);
                map.clearOverlays();
                initHeatmap();
            } else {
                showType = "truckmap";
                closeHeatmap();
                loadCarList();
            }
        }); *!/

        hideLoading();
    }

    var refeash = function () {
        if (showType == "heatmap") {
            openHeatmap();
        } else {
            loadCarList();
        }
        ReportSUBCONTRACTOR_NAMELoad();
    }

    //详细的参数,可以查看heatmap.js的文档 https://github.com/pa7/heatmap.js/blob/master/README.md  
    // http://blog.csdn.net/guang_mang/article/details/71237961
    // http://blog.csdn.net/zjuwwj/article/details/53374947
    //参数说明如下:  
    /!* visible 热力图是否显示,默认为true
    * opacity 热力的透明度,1-100  
    * radius 势力图的每个点的半径大小  
    * gradient  {JSON} 热力图的渐变区间 . gradient如下所示  
    *  {  
    .2:'rgb(0, 255, 255)',  
    .5:'rgb(0, 110, 255)',  
    .8:'rgb(100, 0, 255)'  
    }  
    其中 key 表示插值的位置, 0~1.  
    value 为颜色值.  
    *!/
    var initHeatmap = function () {
        heatmapOverlay = new BMapLib.HeatmapOverlay({ "radius": 20, "visible": true
        });
        map.addOverlay(heatmapOverlay);
        $.post('../ServiceHandler/InTra/OrderTrack.ashx?' + Math.random(), { action: "YwOrder_GetOrdersLocal" }, function (data_) {
            var data = JSON.parse(data_);
            if (isServerResultDataPass(data)) {
                var pointArray = data.ResultDataFull;
                if (pointArray.length <= 0) {
                    return;
                }
                var points = [];
                for (var i = 0; i < pointArray.length; i++) {
                    points.push({ "lng": pointArray[i].LONGITUDE, "lat": pointArray[i].LATITUDE, "count": pointArray[i].COUNT });
                }

                heatmapOverlay.setDataSet({ data: points, max: 10 });
                openHeatmap();
            }
        });
    }

    //判断浏览区是否支持canvas  
    function isSupportCanvas() {
        var elem = document.createElement('canvas');
        return !!(elem.getContext && elem.getContext('2d'));
    }

    function setGradient() {
        /!*格式如下所示:
        {  
        0:'rgb(102, 255, 0)',  
        .5:'rgb(255, 170, 0)',  
        1:'rgb(255, 0, 0)'  
        }*!/
        var gradient = {};
        var colors = document.querySelectorAll("input[type='color']");
        colors = [].slice.call(colors, 0);
        colors.forEach(function (ele) {
            gradient[ele.getAttribute("data-key")] = ele.value;
        });
        heatmapOverlay.setOptions({ "gradient": gradient });
    }

    function openHeatmap() {
        heatmapOverlay.show();
    }

    function closeHeatmap() {
        heatmapOverlay.hide();
    }

    //6、承运商运量分布
    var ReportSUBCONTRACTOR_NAMELoad = function () {
        // create the panel
        $("#aaa").append('<div><div id="pic6" style="height:370px; "></div></div>');
        
        
        var dataObj = {"CutNumber":300,"ResultCode":0,"ResultDataFull":[{"COUNTNUM":1.0,"SUBCONTRACTOR_NAME":"方通"},{"COUNTNUM":11.0,"SUBCONTRACTOR_NAME":"其他"}],"ResultDataUi":""};
        
        //$.getJSON("../ServiceHandler/Chart/IndexChart.ashx", { action: "GetReportSUBCONTRACTOR_NAME" }, function (dataObj) {

            if (isServerResultDataPass(dataObj)) {
                var stateType = [];
                var dataList = [];
                for (var i = 0; i < dataObj.ResultDataFull.length; i++) {
                    stateType.push(dataObj.ResultDataFull[i].SUBCONTRACTOR_NAME);
                    dataList.push(dataObj.ResultDataFull[i].COUNTNUM);
                }

                var myCharts1 = echarts.init(document.getElementById('pic6'));
                var dataMap = {};
                function dataFormatter(obj) {
                    var pList = stateType;
                    var temp = obj[2011];
                    var max = 0;
                    var sum = 0;
                    for (var i = 0, l = temp.length; i < l; i++) {
                        max = Math.max(max, temp[i]);
                        sum += temp[i];
                        obj[2011][i] = {
                            name: pList[i],
                            value: temp[i]
                        }
                    }
                    obj[2011 + 'max'] = Math.floor(max / 100) * 100;
                    obj[2011 + 'sum'] = sum;

                    return obj;
                }
                dataMap.dataFinancial = dataFormatter({
                    //max : 3200,
                    2011: dataList

                });
                var option = {
                    baseOption: {
                        timeline: {
                            show: false
                        },
                        title: { text: '承运商运量分布', x: 'center' },
                        legend: {
                            show: false,
                            x: 'right',
                            data: ['数量'],
                            selected: {

                            }
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {            // 坐标轴指示器，坐标轴触发有效
                                type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                            },
                            formatter: function (params) {
                                var tar = params["0"].data;
                                return tar.name + '<br/>' + "数量" + ' : ' + tar.value;
                            }
                        },
                        grid: {
                            top: 80,
                            bottom: 100,
                            containLabel: true
                        },
                        xAxis: [
                            {
                                'type': 'category',
                                'axisLabel': { 'interval': 0 },
                                'data': stateType,
                                splitLine: { show: true }
                            }
                        ],
                        yAxis: [
                            {
                                type: 'value',
                                name: '数量'
                            }
                        ],
                        series: [{
                            name: '数量',
                            type: 'bar',
                            label: {
                                normal: {
                                    show: true,
                                    position: 'inside'
                                }
                            },
                            data: dataMap.dataFinancial['2011']
                        }]
                    }
                };

                myCharts1.setOption(option);

                myCharts1.on('click', function (param) {
                    var name = param.name;
                    alert(name);
                    // window.location.href = " ";
                });
            } else { FailResultDataToTip(dataObj); }
        //});
    }

    var potionArray = [];
    var loadCarList = function () {
        map.clearOverlays();
        var dataObj = {"CutNumber":300,"ResultCode":4,"ResultDataFull":{"ShowMoreMessage":true,"AutoHide":false,"SimpleMessage":"订单分布查询-获取当前所有在途车辆发生未知异常","MoreMessage":"SELECT v.SN,v.WITHIN_CODE,v.YW_ID,v.SPEED,v.DIRECTION,v.ADDRESS,v.TRAINNO_ID,to_char(v.DATE_TIME,'yyyy-MM-dd hh24:mm:ss') DATE_TIME,v.LO,v.LA,v.TRUCK_NO,v.GPSNO,v.CARRIERCODE,v.AREA,\r\nv.CARONLINE, y.DRIVER_TEL,y.DRIVER_BYNAME from VIEW_TRUCK_ONLINE v LEFT JOIN YW_PLAN_EXEC y ON v.TRAINNO_ID = y.TRAINNO_ID\r\n where v.SN=any(select max(SN) from VIEW_TRUCK_ONLINE WHERE DATE_TIME IS NOT NULL group by TRAINNO_ID ) and v.within_code='YEAR' and v.CarOnLine='Y'  order by v.caronline DESC","OtherMessage":null},"ResultDataUi":""};
        
        //$.getJSON("../ServiceHandler/InTra/OrderTrack.ashx", { action: "YwOrder_GetTruckLocal" }, function (dataObj) {
            if (isServerResultDataPass(dataObj)) {
                var onlineObj = dataObj.ResultDataFull;
                potionArray = onlineObj;
                for (var i = 0; i < dataObj.ResultDataFull.length; i++) {
                    var truckPosition = dataObj.ResultDataFull[i];
                    var icon = new BMap.Icon("../Resource/images/truck.png", new BMap.Size(47, 47));
                    var point = new BMap.Point(truckPosition.LO, truckPosition.LA);
                    var marker = new BMap.Marker(point, { icon: icon });
                    marker.addEventListener("click", function () {
                        getWarningInfo($(this)[0]);
                    });
                    map.addOverlay(marker);
                    map.centerAndZoom(point, 7);
                }
            } else {
                FailResultDataToTip(dataObj);
            }
            hideLoading();
        //});
    }

    function getWarningInfo(pointDom) {
        var potion = Enumerable.From(potionArray)
                        .Where(function (i) { return (i.LA == pointDom.point.lat && i.LO == pointDom.point.lng); })
                        .ToArray();
        var content = "";
        if (potion) {
            var dataObj = potion[0];
            content += "<table style='font-size:12px; color:#666666;width:100%;'>";
            content += "<tr><td> <b>" + dataObj.TRUCK_NO + "-" + dataObj.DRIVER_BYNAME + ":" + dataObj.DRIVER_TEL + "</b></td></tr>";
            content += "<tr><td> <hr style='color:#f0efef;'/></td></tr>";
            content += "<tr><td> 时间：" + dataObj.DATE_TIME + "</td></tr>";
            content += "<tr><td> 地点：" + dataObj.ADDRESS + "</td></tr>";
            var windowSize = {
                width: 250,
                height: 100
            }
            content += "</table>";
            var infowindow = new BMap.InfoWindow(content, windowSize);
            pointDom.openInfoWindow(infowindow);
        }
    }*/
</script>
</html>
